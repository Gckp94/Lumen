# Risk Profile: Story 1.3 - File Selection & Data Loading

Date: 2026-01-10
Reviewer: Quinn (Test Architect)

## Executive Summary

- **Total Risks Identified:** 12
- **Critical Risks:** 0
- **High Risks:** 0
- **Medium Risks:** 2
- **Risk Score:** 74/100 (Moderate risk)

This is a **moderate-risk story** involving file I/O operations, background threading, and multiple file format support. The primary risks relate to performance requirements for large files and multi-format complexity. No critical security risks due to use of native file dialogs and trusted file loading libraries.

## Risk Matrix

| Risk ID | Description | Probability | Impact | Score | Priority |
|---------|-------------|-------------|--------|-------|----------|
| TECH-001 | Multiple file format handling complexity | Medium (2) | Medium (2) | 4 | Medium |
| PERF-001 | Large file load time (100k rows <3s) | Medium (2) | Medium (2) | 4 | Medium |
| PERF-002 | UI thread blocking during file operations | Low (1) | High (3) | 3 | Low |
| TECH-002 | QThread lifecycle management | Low (1) | High (3) | 3 | Low |
| DATA-001 | Corrupted file detection | Low (1) | Medium (2) | 2 | Low |
| DATA-002 | CSV character encoding issues | Medium (2) | Low (1) | 2 | Low |
| DATA-003 | Empty file/sheet handling | Medium (2) | Low (1) | 2 | Low |
| SEC-001 | Malicious Excel file content | Low (1) | Medium (2) | 2 | Low |
| OPS-001 | Missing file I/O dependencies | Low (1) | Medium (2) | 2 | Low |
| OPS-002 | File permission access issues | Medium (2) | Low (1) | 2 | Low |
| BUS-001 | Confusing error messages | Medium (2) | Low (1) | 2 | Low |
| TECH-003 | Excel engine selection (openpyxl/xlrd) | Low (1) | Low (1) | 1 | Minimal |

## Detailed Risk Analysis

### TECH-001: Multiple File Format Handling Complexity (Score: 4 - Medium)

**Description:** The FileLoader must support four file formats (.xlsx, .xls, .csv, .parquet), each requiring different libraries and handling. Format detection, engine selection, and consistent DataFrame output across formats adds complexity.

**Probability:** Medium (2) - Different formats have different quirks and edge cases
**Impact:** Medium (2) - Wrong format handling could lead to data misinterpretation

**Affected Components:**
- `src/core/file_loader.py` - `load()` method
- File extension detection logic

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Use explicit engine selection based on extension | Dev |
| Preventive | Centralize format detection in single method | Dev |
| Detective | Log format detection and engine used | Dev |
| Corrective | Wrap format-specific errors in FileLoadError | Dev |

**Testing Requirements:**
- Unit test each supported format independently
- Test format detection logic
- Test error handling for each format's failure modes

**Residual Risk:** Low - With proper abstraction and testing, format handling is manageable

---

### PERF-001: Large File Load Time (Score: 4 - Medium)

**Description:** AC8 requires loading 100k rows in under 3 seconds. This NFR could be challenging depending on file format, disk speed, and DataFrame construction overhead.

**Probability:** Medium (2) - 100k rows is significant; performance varies by format
**Impact:** Medium (2) - Exceeding time limit degrades user experience

**Affected Components:**
- `src/core/file_loader.py` - `load()` method
- `src/core/file_load_worker.py` - background loading

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Use pandas' optimized readers with appropriate engines | Dev |
| Preventive | Avoid unnecessary type inference where possible | Dev |
| Detective | Profile load times during development | Dev |
| Detective | Log load duration for monitoring | Dev |

**Testing Requirements:**
- Performance test with 100k row test file
- Compare performance across formats
- Verify UI remains responsive during load

**Residual Risk:** Low - pandas is highly optimized; 100k rows typically loads quickly

---

### PERF-002: UI Thread Blocking (Score: 3 - Low)

**Description:** File I/O operations must run in QThread to prevent UI freezing. Incorrect thread implementation could block the main thread.

**Probability:** Low (1) - QThread pattern is well-documented
**Impact:** High (3) - Frozen UI is unacceptable user experience

**Affected Components:**
- `src/core/file_load_worker.py` - QThread implementation
- `src/tabs/data_input.py` - worker invocation

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Follow documented QThread pattern with signals | Dev |
| Preventive | Never call blocking I/O from main thread | Dev |
| Detective | Widget test verifies worker signals emit correctly | QA |

**Testing Requirements:**
- Widget test that worker emits progress/finished/error signals
- Manual verification that UI remains responsive

**Residual Risk:** Minimal - Standard QThread pattern with proper signal usage

---

### TECH-002: QThread Lifecycle Management (Score: 3 - Low)

**Description:** QThread workers must be properly managed to avoid memory leaks, dangling references, or crashes from accessing deleted objects.

**Probability:** Low (1) - Following Qt patterns prevents issues
**Impact:** High (3) - Memory leaks or crashes are severe

**Affected Components:**
- `src/core/file_load_worker.py`
- `src/tabs/data_input.py` - worker lifecycle

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Store worker reference to prevent garbage collection | Dev |
| Preventive | Use deleteLater() or proper cleanup on completion | Dev |
| Preventive | Disable buttons during load to prevent multiple workers | Dev |

**Testing Requirements:**
- Verify worker cleanup after completion
- Test rapid consecutive loads don't cause issues

**Residual Risk:** Minimal - Standard Qt memory management

---

### DATA-001: Corrupted File Detection (Score: 2 - Low)

**Description:** Files may be corrupted, truncated, or malformed. The loader should detect and report these issues gracefully.

**Probability:** Low (1) - Corrupted files are rare in typical usage
**Impact:** Medium (2) - Could cause confusing errors or partial data load

**Affected Components:**
- `src/core/file_loader.py`
- Exception handling

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Catch pandas parsing exceptions | Dev |
| Corrective | Wrap in FileLoadError with user-friendly message | Dev |

**Testing Requirements:**
- Test with truncated/malformed files
- Verify error message clarity

**Residual Risk:** Minimal - pandas handles most corruption cases

---

### DATA-002: CSV Character Encoding Issues (Score: 2 - Low)

**Description:** CSV files may use various encodings (UTF-8, Latin-1, Windows-1252). Incorrect encoding detection could cause garbled text or errors.

**Probability:** Medium (2) - Non-UTF-8 encodings are common in financial data
**Impact:** Low (1) - Usually affects display of special characters only

**Affected Components:**
- `src/core/file_loader.py` - CSV loading

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Use UTF-8 as default, common fallbacks on error | Dev |
| Corrective | Report encoding issues in error message | Dev |

**Testing Requirements:**
- Test CSV with various encodings
- Verify graceful handling of encoding errors

**Residual Risk:** Minimal - Most trading data is ASCII-compatible

---

### DATA-003: Empty File/Sheet Handling (Score: 2 - Low)

**Description:** Users may select files with no data or Excel sheets with no rows. The application should handle this gracefully.

**Probability:** Medium (2) - User error is common
**Impact:** Low (1) - Confusing but not harmful

**Affected Components:**
- `src/core/file_loader.py`
- Success/error feedback UI

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Detective | Check DataFrame row count after load | Dev |
| Corrective | Show appropriate message for empty data | Dev |

**Testing Requirements:**
- Test empty CSV file
- Test Excel with empty sheet

**Residual Risk:** Minimal - Simple validation check

---

### SEC-001: Malicious Excel File Content (Score: 2 - Low)

**Description:** Excel files can contain macros, external links, or formulas that could be security concerns. However, pandas reads data only and doesn't execute macros.

**Probability:** Low (1) - pandas doesn't execute VBA macros
**Impact:** Medium (2) - If macros were executed, could be serious

**Affected Components:**
- `src/core/file_loader.py` - Excel loading

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Use pandas/openpyxl which read data only | Dev |
| Detective | Document that macros are not executed | Dev |

**Testing Requirements:**
- Verify Excel with macros loads data without executing

**Residual Risk:** Minimal - pandas data-only approach is safe

---

### OPS-001: Missing File I/O Dependencies (Score: 2 - Low)

**Description:** File loading requires openpyxl (xlsx), xlrd (xls), and pyarrow (parquet). Missing dependencies cause runtime errors.

**Probability:** Low (1) - Dependencies in pyproject.toml
**Impact:** Medium (2) - Format-specific loading would fail

**Affected Components:**
- `pyproject.toml`
- `src/core/file_loader.py`

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Include all dependencies in pyproject.toml | Dev |
| Detective | Test installation in clean environment | QA |

**Testing Requirements:**
- Verify all formats load in fresh environment

**Residual Risk:** Minimal - Proper dependency management

---

### OPS-002: File Permission Access Issues (Score: 2 - Low)

**Description:** User may select files they don't have read permission for, or files locked by other applications.

**Probability:** Medium (2) - Common with Excel files open in Excel
**Impact:** Low (1) - Clear error case

**Affected Components:**
- `src/core/file_loader.py`
- Error messaging

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Corrective | Catch PermissionError and show clear message | Dev |

**Testing Requirements:**
- Test with locked/inaccessible file

**Residual Risk:** Minimal - Standard error handling

---

### BUS-001: Confusing Error Messages (Score: 2 - Low)

**Description:** AC7 requires "plain English" error messages. Technical exceptions could leak through if not properly wrapped.

**Probability:** Medium (2) - Many potential error paths
**Impact:** Low (1) - Confusing but user can retry

**Affected Components:**
- `src/core/file_loader.py`
- `src/core/exceptions.py`
- Error display UI

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Map common exceptions to user-friendly messages | Dev |
| Preventive | Use error message table from architecture docs | Dev |
| Detective | Review all error paths for user-friendliness | QA |

**Testing Requirements:**
- Test each error condition produces friendly message
- Review error messages in integration testing

**Residual Risk:** Minimal - Error message mapping is straightforward

---

### TECH-003: Excel Engine Selection (Score: 1 - Minimal)

**Description:** Different Excel formats require different engines (openpyxl for xlsx, xlrd for xls). Incorrect selection causes failures.

**Probability:** Low (1) - Extension-based selection is reliable
**Impact:** Low (1) - Clear error if wrong engine

**Affected Components:**
- `src/core/file_loader.py`

**Mitigation:**
| Strategy | Action | Owner |
|----------|--------|-------|
| Preventive | Use explicit engine parameter based on extension | Dev |

**Residual Risk:** Minimal

---

## Risk Distribution

### By Category
- **Technical:** 3 risks (2 medium)
- **Performance:** 2 risks (1 medium)
- **Data:** 3 risks (0 medium)
- **Security:** 1 risk (0 medium)
- **Operational:** 2 risks (0 medium)
- **Business:** 1 risk (0 medium)

### By Component
- **src/core/file_loader.py:** 9 risks
- **src/core/file_load_worker.py:** 3 risks
- **src/tabs/data_input.py:** 2 risks
- **src/core/exceptions.py:** 1 risk

## Risk-Based Testing Strategy

### Priority 1: Medium Risk Tests
- **TECH-001:** Test all four file formats load correctly
- **PERF-001:** Performance test with 100k row file

### Priority 2: Low Risk Tests
- **PERF-002, TECH-002:** Verify QThread signals and lifecycle
- **DATA-001, DATA-002, DATA-003:** Test edge cases (corrupt, encoding, empty)
- **OPS-002, BUS-001:** Verify error messages for common failures

### Priority 3: Minimal Risk Tests
- **TECH-003:** Verify engine selection (covered by format tests)

## Risk Acceptance Criteria

### Must Fix Before Production
- None - no critical or high risks identified

### Can Deploy with Mitigation
- **PERF-001:** Monitor actual load times; optimize if needed
- **TECH-001:** Comprehensive format testing provides confidence

### Accepted Risks
- **SEC-001:** pandas doesn't execute macros; data-only reading is safe
- **DATA-002:** UTF-8 default covers majority of use cases

## Monitoring Requirements

Post-deployment monitoring:
- Log file load durations for performance tracking
- Log format detection and engine selection
- Track error message frequency to identify common issues

## Risk Review Triggers

Review and update risk profile when:
- Adding support for new file formats
- Performance issues reported with large files
- New error patterns emerge from user feedback

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 0
    medium: 2
    low: 8
  highest:
    id: TECH-001
    score: 4
    title: 'Multiple file format handling complexity'
  recommendations:
    must_fix: []
    monitor:
      - 'Log file load durations for performance tracking'
      - 'Track error frequency to identify common issues'
```

---

Risk profile: docs/qa/assessments/1.3-risk-20260110.md
