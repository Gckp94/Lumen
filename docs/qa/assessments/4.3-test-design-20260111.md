# Test Design: Story 4.3

Date: 2026-01-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 28
- Unit tests: 14 (50%)
- Integration tests: 6 (21%)
- E2E tests: 0 (0%)
- Widget tests: 8 (29%)
- Priority distribution: P0: 8, P1: 14, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: Four-column grid (Metric | Baseline | Filtered | Delta)

| ID             | Level       | Priority | Test                                           | Justification                                   |
|----------------|-------------|----------|------------------------------------------------|------------------------------------------------|
| 4.3-UNIT-001   | Unit        | P1       | `set_values()` extracts all 24 metric values   | Pure data extraction logic                      |
| 4.3-UNIT-002   | Unit        | P1       | `clear()` returns grid to baseline-only state  | State reset logic                               |
| 4.3-UNIT-003   | Unit        | P1       | None baseline shows "—" in all columns         | Edge case handling                              |
| 4.3-UNIT-004   | Unit        | P1       | None filtered shows "—" in filtered/delta      | Edge case handling                              |
| 4.3-WIDGET-001 | Widget      | P1       | Grid renders 4 columns per row                 | Visual structure verification                   |
| 4.3-WIDGET-002 | Widget      | P1       | All 24 metrics appear in grid                  | Component completeness                          |
| 4.3-INT-001    | Integration | P1       | `metrics_updated` signal triggers grid update  | Signal/slot flow                                |
| 4.3-INT-002    | Integration | P1       | ComparisonGrid integrates into PnLStatsTab     | Tab integration                                 |

### AC2: Collapsible sections by metric group

| ID             | Level       | Priority | Test                                           | Justification                                   |
|----------------|-------------|----------|------------------------------------------------|------------------------------------------------|
| 4.3-WIDGET-003 | Widget      | P1       | Grid displays 5 section headers                | Section structure                               |
| 4.3-WIDGET-004 | Widget      | P1       | Section collapse hides all rows in section     | Toggle functionality                            |
| 4.3-WIDGET-005 | Widget      | P1       | Section expand shows all rows in section       | Toggle functionality                            |
| 4.3-WIDGET-006 | Widget      | P2       | Collapsed state persists across updates        | State management                                |
| 4.3-UNIT-005   | Unit        | P2       | `toggle_section()` updates internal state      | State logic                                     |

### AC3: Delta formatting by type (pp, $, ratio, days)

| ID             | Level       | Priority | Test                                           | Justification                                   |
|----------------|-------------|----------|------------------------------------------------|------------------------------------------------|
| 4.3-UNIT-006   | Unit        | P0       | Win rate delta formats as "+X.Xpp"/"-X.Xpp"    | Core delta formatting - percentage points      |
| 4.3-UNIT-007   | Unit        | P0       | PnL delta formats as "+$X,XXX"/"-$X,XXX"       | Core delta formatting - dollars                |
| 4.3-UNIT-008   | Unit        | P1       | DD duration delta formats as "+X days"/"-X days"| Duration formatting                            |
| 4.3-UNIT-009   | Unit        | P1       | R:R ratio delta formats as "+X.XX"/"-X.XX"     | Ratio formatting                               |
| 4.3-UNIT-010   | Unit        | P1       | Trade count delta formats as "+XXX"/"-XXX"     | Integer formatting                             |
| 4.3-UNIT-011   | Unit        | P1       | String DD duration ("Not recovered") shows "—" | Non-numeric edge case                          |
| 4.3-UNIT-012   | Unit        | P2       | Zero delta formats without sign                | Edge case                                       |

### AC4: Color coding based on improvement definitions

| ID             | Level       | Priority | Test                                           | Justification                                   | Mitigates |
|----------------|-------------|----------|------------------------------------------------|------------------------------------------------|-----------|
| 4.3-UNIT-013   | Unit        | P0       | Higher-is-better metrics: positive delta = SIGNAL_CYAN | Core improvement logic                   | BUS-001   |
| 4.3-UNIT-014   | Unit        | P0       | Higher-is-better metrics: negative delta = SIGNAL_CORAL | Core improvement logic                  | BUS-001   |
| 4.3-UNIT-015   | Unit        | P0       | Lower-is-better metrics: negative delta = SIGNAL_CYAN | Inverted improvement logic               | BUS-001   |
| 4.3-UNIT-016   | Unit        | P0       | Lower-is-better metrics: positive delta = SIGNAL_CORAL | Inverted improvement logic              | BUS-001   |
| 4.3-UNIT-017   | Unit        | P0       | num_trades always uses TEXT_SECONDARY          | Neutral metric handling                         | BUS-001   |
| 4.3-UNIT-018   | Unit        | P1       | Zero delta uses TEXT_SECONDARY                 | No change = neutral color                       |
| 4.3-INT-003    | Integration | P0       | Grid displays correct colors for sample data   | End-to-end color verification                   | BUS-001   |

### AC5: Azeret Mono for numeric values (per Dev Notes)

| ID             | Level       | Priority | Test                                           | Justification                                   |
|----------------|-------------|----------|------------------------------------------------|------------------------------------------------|
| 4.3-WIDGET-007 | Widget      | P2       | Numeric columns use Fonts.DATA font            | Font consistency                                |
| 4.3-WIDGET-008 | Widget      | P2       | Metric name column uses Fonts.UI font          | Font consistency                                |

### Cross-AC Integration Tests

| ID             | Level       | Priority | Test                                           | Justification                                   |
|----------------|-------------|----------|------------------------------------------------|------------------------------------------------|
| 4.3-INT-004    | Integration | P1       | Filter applied updates comparison grid         | Full workflow                                   |
| 4.3-INT-005    | Integration | P1       | Filter removed clears filtered/delta columns   | Workflow reset                                  |
| 4.3-INT-006    | Integration | P2       | Multiple filter changes update grid correctly  | Repeated workflow                               |

## Risk Coverage

| Risk ID  | Test IDs Mitigating                                    |
|----------|--------------------------------------------------------|
| BUS-001  | 4.3-UNIT-013 through 4.3-UNIT-017, 4.3-INT-003        |
| TECH-001 | 4.3-WIDGET-001 through 4.3-WIDGET-008                 |
| TECH-003 | 4.3-UNIT-003, 4.3-UNIT-004, 4.3-UNIT-011, 4.3-UNIT-012|
| DATA-001 | 4.3-UNIT-001, 4.3-WIDGET-002                          |

## Recommended Execution Order

1. **P0 Unit tests (fail fast on critical logic)**
   - 4.3-UNIT-006, 4.3-UNIT-007 (delta formatting)
   - 4.3-UNIT-013 through 4.3-UNIT-017 (improvement direction)

2. **P0 Integration tests**
   - 4.3-INT-003 (color verification with real data)

3. **P1 Unit tests**
   - 4.3-UNIT-001 through 4.3-UNIT-005 (value extraction/state)
   - 4.3-UNIT-008 through 4.3-UNIT-012 (remaining formatting)
   - 4.3-UNIT-018 (zero delta)

4. **P1 Widget tests**
   - 4.3-WIDGET-001 through 4.3-WIDGET-005 (structure and toggle)

5. **P1 Integration tests**
   - 4.3-INT-001, 4.3-INT-002 (signal/tab integration)
   - 4.3-INT-004, 4.3-INT-005 (filter workflow)

6. **P2 tests as time permits**
   - 4.3-WIDGET-006 through 4.3-WIDGET-008
   - 4.3-UNIT-005, 4.3-UNIT-012
   - 4.3-INT-006

## Test File Locations

| Test File                               | Test IDs                                |
|-----------------------------------------|-----------------------------------------|
| `tests/unit/test_comparison_grid.py`    | 4.3-UNIT-001 through 4.3-UNIT-018      |
| `tests/widget/test_comparison_grid.py`  | 4.3-WIDGET-001 through 4.3-WIDGET-008  |
| `tests/integration/test_filter_workflow.py` | 4.3-INT-001 through 4.3-INT-006    |

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for logic, widget for UI, integration for flows)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (BUS-001 tests are P0)
- [x] Test IDs follow naming convention (4.3-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent

## Detailed Test Specifications

### Unit Test: Improvement Direction (BUS-001 Mitigation)

```python
# tests/unit/test_comparison_grid.py

HIGHER_IS_BETTER = [
    "win_rate", "ev", "edge", "kelly", "fractional_kelly", "expected_growth",
    "avg_winner", "median_winner", "rr_ratio",
    "flat_stake_pnl", "kelly_pnl",
    "max_consecutive_wins",
    "avg_loser", "median_loser",  # Higher = less negative = better
]

LOWER_IS_BETTER = [
    "max_consecutive_losses", "max_loss_pct",
    "flat_stake_max_dd", "flat_stake_max_dd_pct", "flat_stake_dd_duration",
    "kelly_max_dd", "kelly_max_dd_pct", "kelly_dd_duration",
]

NEUTRAL = ["num_trades"]

@pytest.mark.parametrize("metric", HIGHER_IS_BETTER)
def test_higher_is_better_positive_delta_is_improvement(metric):
    """Positive delta on higher-is-better metric should return SIGNAL_CYAN."""
    color = _get_delta_color(metric, delta=1.0)
    assert color == Colors.SIGNAL_CYAN

@pytest.mark.parametrize("metric", LOWER_IS_BETTER)
def test_lower_is_better_negative_delta_is_improvement(metric):
    """Negative delta on lower-is-better metric should return SIGNAL_CYAN."""
    color = _get_delta_color(metric, delta=-1.0)
    assert color == Colors.SIGNAL_CYAN

def test_num_trades_always_neutral():
    """num_trades should always use TEXT_SECONDARY regardless of delta."""
    assert _get_delta_color("num_trades", delta=100) == Colors.TEXT_SECONDARY
    assert _get_delta_color("num_trades", delta=-100) == Colors.TEXT_SECONDARY
    assert _get_delta_color("num_trades", delta=0) == Colors.TEXT_SECONDARY
```

### Widget Test: Section Toggle

```python
# tests/widget/test_comparison_grid.py

def test_section_collapse_hides_rows(qtbot):
    """Collapsing a section should hide all its rows."""
    grid = ComparisonGrid()
    qtbot.addWidget(grid)
    
    # Get initial visible row count for core_statistics section
    initial_rows = grid._get_visible_rows("core_statistics")
    assert initial_rows > 0
    
    # Collapse section
    grid.toggle_section("core_statistics")
    
    # Verify rows are hidden
    assert grid._get_visible_rows("core_statistics") == 0

def test_section_expand_shows_rows(qtbot):
    """Expanding a collapsed section should show all its rows."""
    grid = ComparisonGrid()
    qtbot.addWidget(grid)
    
    # Collapse then expand
    grid.toggle_section("core_statistics")
    grid.toggle_section("core_statistics")
    
    # Verify rows are visible again
    assert grid._get_visible_rows("core_statistics") > 0
```

## Notes

- No E2E tests specified: All functionality can be adequately covered by unit/widget/integration tests
- Widget tests require qtbot fixture from pytest-qt
- Integration tests should use mock TradingMetrics objects with known values for deterministic assertions
