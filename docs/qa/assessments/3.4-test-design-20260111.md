# Test Design: Story 3.4

Date: 2026-01-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 16 (67%)
- Integration tests: 5 (21%)
- Widget tests: 3 (12%)
- Priority distribution: P0: 8, P1: 10, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: Calculate: Flat Stake PnL, Max DD ($), Max DD (%), DD Duration

| ID             | Level       | Priority | Test                                        | Justification                                      |
|----------------|-------------|----------|---------------------------------------------|----------------------------------------------------|
| 3.4-UNIT-001   | Unit        | P0       | Basic equity curve calculation              | Core algorithm - pure calculation logic            |
| 3.4-UNIT-002   | Unit        | P0       | Max DD ($) calculation accuracy             | Core metric - verify absolute dollar amount        |
| 3.4-UNIT-003   | Unit        | P0       | Max DD (%) calculation accuracy             | Core metric - verify percentage calculation        |
| 3.4-UNIT-004   | Unit        | P0       | DD Duration (recovered) returns int         | Core metric - verify day count                     |
| 3.4-UNIT-005   | Unit        | P0       | DD Duration (not recovered) returns string  | Core metric - verify "Not recovered" output        |
| 3.4-UNIT-006   | Unit        | P1       | Known test data from Dev Notes              | Regression test with verified expected values      |
| 3.4-UNIT-007   | Unit        | P1       | Multiple drawdowns - use worst by %         | Algorithm correctness for complex scenarios        |
| 3.4-UNIT-008   | Unit        | P1       | Division by zero guard (peak = 0)           | Risk mitigation DATA-001                           |

**Mitigates Risks:** DATA-001, TECH-001

---

### AC2: Create equity calculation module (`src/core/equity.py`)

| ID             | Level       | Priority | Test                                        | Justification                                      |
|----------------|-------------|----------|---------------------------------------------|----------------------------------------------------|
| 3.4-UNIT-009   | Unit        | P1       | EquityCalculator class instantiation        | Module structure verification                      |
| 3.4-UNIT-010   | Unit        | P1       | calculate_flat_stake() returns DataFrame    | API contract verification                          |
| 3.4-UNIT-011   | Unit        | P1       | DataFrame has required columns              | Schema validation (trade_num, pnl, equity, peak, drawdown) |
| 3.4-UNIT-012   | Unit        | P2       | calculate_flat_stake_metrics() returns dict | API contract for full metrics                      |
| 3.4-INT-001    | Integration | P1       | MetricsCalculator calls EquityCalculator    | Component integration verification                 |

**Mitigates Risks:** TECH-002

---

### AC3: Store equity curve in app state for charts

| ID             | Level       | Priority | Test                                        | Justification                                      |
|----------------|-------------|----------|---------------------------------------------|----------------------------------------------------|
| 3.4-INT-002    | Integration | P1       | AppState.flat_stake_equity_curve populated  | State management verification                      |
| 3.4-INT-003    | Integration | P2       | equity_curve_updated signal emitted         | Signal chain verification                          |

---

### AC4: Display "Not recovered" if drawdown ongoing

| ID             | Level       | Priority | Test                                        | Justification                                      |
|----------------|-------------|----------|---------------------------------------------|----------------------------------------------------|
| 3.4-UNIT-013   | Unit        | P0       | "Not recovered" string type in metrics      | Verify string return type                          |
| 3.4-WIDG-001   | Widget      | P1       | DD Duration displays "Not recovered"        | UI rendering verification                          |
| 3.4-WIDG-002   | Widget      | P2       | "Not recovered" displays in coral color     | Visual styling verification                        |

**Mitigates Risks:** TECH-002, OPS-001

---

### AC5: Recalculate on flat_stake change

| ID             | Level       | Priority | Test                                        | Justification                                      |
|----------------|-------------|----------|---------------------------------------------|----------------------------------------------------|
| 3.4-INT-004    | Integration | P0       | flat_stake passed through signal chain      | Data flow verification                             |
| 3.4-INT-005    | Integration | P1       | Metrics update on flat_stake change         | End-to-end recalculation flow                      |
| 3.4-WIDG-003   | Widget      | P2       | MetricsGrid updates on metrics change       | UI refresh verification                            |

---

### Edge Cases & Error Handling

| ID             | Level       | Priority | Test                                        | Justification                                      |
|----------------|-------------|----------|---------------------------------------------|----------------------------------------------------|
| 3.4-UNIT-014   | Unit        | P1       | Empty gains Series returns empty DataFrame  | Edge case - no trades                              |
| 3.4-UNIT-015   | Unit        | P2       | Single trade - no drawdown possible         | Edge case - minimum data                           |
| 3.4-UNIT-016   | Unit        | P2       | All winners - drawdown always 0             | Edge case - no losses                              |

**Mitigates Risks:** DATA-002

---

### Performance Tests

| ID             | Level       | Priority | Test                                        | Justification                                      |
|----------------|-------------|----------|---------------------------------------------|----------------------------------------------------|
| 3.4-PERF-001   | Unit        | P0       | 100k trades calculation < 200ms             | Performance requirement from architecture          |

**Mitigates Risks:** PERF-001

---

## Risk Coverage Matrix

| Risk ID   | Test IDs                                    | Coverage |
|-----------|---------------------------------------------|----------|
| DATA-001  | 3.4-UNIT-008                                | Direct   |
| DATA-002  | 3.4-UNIT-014, 3.4-UNIT-015, 3.4-UNIT-016    | Direct   |
| PERF-001  | 3.4-PERF-001                                | Direct   |
| TECH-001  | 3.4-UNIT-004, 3.4-UNIT-005, 3.4-UNIT-006, 3.4-UNIT-007 | Direct   |
| TECH-002  | 3.4-UNIT-013, 3.4-WIDG-001                  | Direct   |
| OPS-001   | 3.4-WIDG-002                                | Direct   |

---

## Recommended Test Implementation

### tests/unit/test_equity.py (NEW)

```python
import pytest
import pandas as pd
from src.core.equity import EquityCalculator

class TestEquityCalculatorFlatStake:
    """Tests for flat stake equity calculations."""

    @pytest.fixture
    def calculator(self):
        return EquityCalculator()

    # 3.4-UNIT-001: Basic equity curve calculation
    def test_flat_stake_basic(self, calculator):
        gains = pd.Series([5.0, 3.0, -4.0, -2.0, 8.0])
        result = calculator.calculate_flat_stake(gains, stake=1000.0)
        assert result["equity"].iloc[-1] == pytest.approx(100.0, abs=0.01)

    # 3.4-UNIT-014: Empty gains Series
    def test_flat_stake_empty_series(self, calculator):
        gains = pd.Series([], dtype=float)
        result = calculator.calculate_flat_stake(gains, stake=1000.0)
        assert len(result) == 0

    # 3.4-UNIT-015: Single trade
    def test_flat_stake_single_trade(self, calculator):
        gains = pd.Series([5.0])
        result = calculator.calculate_flat_stake(gains, stake=1000.0)
        assert len(result) == 1
        assert result["equity"].iloc[0] == pytest.approx(50.0)

    # 3.4-UNIT-016: All winners - no drawdown
    def test_flat_stake_all_winners(self, calculator):
        gains = pd.Series([5.0, 3.0, 2.0, 4.0])
        result = calculator.calculate_flat_stake(gains, stake=1000.0)
        assert (result["drawdown"] == 0).all()


class TestDrawdownMetrics:
    """Tests for drawdown metric calculations."""

    @pytest.fixture
    def calculator(self):
        return EquityCalculator()

    # 3.4-UNIT-002: Max DD ($)
    def test_max_dd_dollars(self, calculator):
        gains = pd.Series([5.0, -10.0, 3.0])
        metrics = calculator.calculate_flat_stake_metrics(gains, stake=1000.0)
        # Peak at 50, drops to -50, max_dd = 100
        assert metrics["max_dd"] == pytest.approx(100.0, abs=0.01)

    # 3.4-UNIT-003: Max DD (%)
    def test_max_dd_pct(self, calculator):
        gains = pd.Series([5.0, 3.0, -4.0, -2.0])
        metrics = calculator.calculate_flat_stake_metrics(gains, stake=1000.0)
        # Peak at 80, drops to 20, dd = 60, pct = 60/80 = 75%
        assert metrics["max_dd_pct"] == pytest.approx(75.0, abs=0.01)

    # 3.4-UNIT-004: DD Duration recovered
    def test_dd_duration_recovered(self, calculator):
        gains = pd.Series([5.0, 3.0, -4.0, -2.0, 8.0, -6.0, 4.0, 3.0])
        metrics = calculator.calculate_flat_stake_metrics(gains, stake=1000.0)
        assert isinstance(metrics["dd_duration"], int)

    # 3.4-UNIT-005: DD Duration not recovered
    def test_dd_duration_not_recovered(self, calculator):
        gains = pd.Series([5.0, -10.0, 3.0])
        metrics = calculator.calculate_flat_stake_metrics(gains, stake=1000.0)
        assert metrics["dd_duration"] == "Not recovered"

    # 3.4-UNIT-006: Dev Notes test data
    def test_dev_notes_sample_data(self, calculator):
        """Verify against sample data from story Dev Notes."""
        gains = pd.Series([5.0, 3.0, -4.0, -2.0, 8.0, -6.0, 4.0, 3.0])
        metrics = calculator.calculate_flat_stake_metrics(gains, stake=1000.0)
        assert metrics["pnl"] == pytest.approx(110.0, abs=0.01)
        assert metrics["max_dd"] == pytest.approx(60.0, abs=0.01)

    # 3.4-UNIT-008: Division by zero guard
    def test_max_dd_pct_peak_zero(self, calculator):
        """When peak is 0 or negative, max_dd_pct should be None."""
        gains = pd.Series([-5.0, -3.0])  # All losers, peak never > 0
        metrics = calculator.calculate_flat_stake_metrics(gains, stake=1000.0)
        assert metrics["max_dd_pct"] is None


class TestPerformance:
    """Performance tests for equity calculations."""

    @pytest.fixture
    def calculator(self):
        return EquityCalculator()

    # 3.4-PERF-001: 100k trades < 200ms
    def test_performance_100k_trades(self, calculator):
        import time
        import numpy as np

        np.random.seed(42)
        gains = pd.Series(np.random.uniform(-10, 15, 100_000))

        start = time.perf_counter()
        calculator.calculate_flat_stake_metrics(gains, stake=1000.0)
        elapsed = (time.perf_counter() - start) * 1000

        assert elapsed < 200, f"Calculation took {elapsed:.1f}ms, expected < 200ms"
```

### tests/unit/test_metrics.py (ADD)

```python
# 3.4-INT-001: MetricsCalculator integration
def test_flat_stake_metrics_populated():
    """Flat stake metrics populated when stake provided."""
    # Setup with sample data and flat_stake parameter
    # Verify TradingMetrics.flat_stake_* fields are not None

def test_flat_stake_none_when_no_stake():
    """Flat stake metrics are None when no stake provided."""
    # Setup without flat_stake parameter
    # Verify TradingMetrics.flat_stake_* fields are None

def test_flat_stake_none_when_empty_data():
    """Flat stake metrics are None with empty trade data."""
    # Setup with empty DataFrame and flat_stake
    # Verify graceful handling
```

### tests/widget/test_metrics_grid.py (ADD)

```python
# 3.4-WIDG-001: DD Duration displays "Not recovered"
def test_dd_duration_displays_not_recovered(qtbot):
    """DD Duration 'Not recovered' displays correctly."""
    from src.ui.components.metrics_grid import MetricsGrid
    from src.core.models import TradingMetrics

    grid = MetricsGrid()
    qtbot.addWidget(grid)
    metrics = TradingMetrics(
        num_trades=10, win_rate=50.0, avg_winner=5.0, avg_loser=-5.0,
        rr_ratio=1.0, ev=0.0, kelly=0.0,
        flat_stake_pnl=100.0,
        flat_stake_max_dd=50.0,
        flat_stake_max_dd_pct=25.0,
        flat_stake_dd_duration="Not recovered",
    )
    grid.update_metrics(metrics)
    # Verify display text

# 3.4-WIDG-002: Coral color for "Not recovered"
def test_dd_duration_not_recovered_coral_color(qtbot):
    """DD Duration 'Not recovered' displays in coral color."""
    # Verify color styling matches Colors.SIGNAL_CORAL

# 3.4-WIDG-003: MetricsGrid updates
def test_metrics_grid_displays_flat_stake_metrics(qtbot):
    """Grid includes all 4 flat stake metrics."""
    grid = MetricsGrid()
    qtbot.addWidget(grid)
    assert "flat_stake_pnl" in grid._cards
    assert "flat_stake_max_dd" in grid._cards
    assert "flat_stake_max_dd_pct" in grid._cards
    assert "flat_stake_dd_duration" in grid._cards
```

---

## Recommended Execution Order

1. **P0 Unit tests** (fail fast - 8 tests)
   - 3.4-UNIT-001 through 3.4-UNIT-005 (core calculations)
   - 3.4-UNIT-013 ("Not recovered" type)
   - 3.4-INT-004 (signal chain)
   - 3.4-PERF-001 (performance gate)

2. **P1 Unit tests** (7 tests)
   - 3.4-UNIT-006 through 3.4-UNIT-011
   - 3.4-UNIT-014

3. **P1 Integration tests** (3 tests)
   - 3.4-INT-001, 3.4-INT-002, 3.4-INT-005

4. **P1 Widget tests** (1 test)
   - 3.4-WIDG-001

5. **P2 tests** (5 tests)
   - 3.4-UNIT-012, 3.4-UNIT-015, 3.4-UNIT-016
   - 3.4-INT-003
   - 3.4-WIDG-002, 3.4-WIDG-003

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for calculations, integration for flow, widget for UI)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention (3.4-LEVEL-SEQ)
- [x] Scenarios are atomic and independent
- [x] All identified risks have test coverage

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 24
  by_level:
    unit: 16
    integration: 5
    widget: 3
  by_priority:
    p0: 8
    p1: 10
    p2: 6
  coverage_gaps: []
```

---

Test design matrix: docs/qa/assessments/3.4-test-design-20260111.md
P0 tests identified: 8
