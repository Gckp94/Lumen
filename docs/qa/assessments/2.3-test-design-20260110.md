# Test Design: Story 2.3 - First-Trigger Toggle

Date: 2026-01-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 26
- Unit tests: 9 (35%)
- Integration tests: 12 (46%)
- E2E tests: 0 (0%)
- Widget tests: 5 (19%)
- Priority distribution: P0: 4, P1: 14, P2: 8

## Test Pyramid Justification

This story is primarily UI component + core logic integration. E2E tests are unnecessary because:
1. Toggle is a self-contained UI control with clear signal contracts
2. All critical paths can be validated through widget + integration tests
3. Performance NFR tested directly via benchmarks

---

## Test Scenarios by Acceptance Criteria

### AC1: "First Trigger Only" toggle switch in filter controls

| ID            | Level  | Priority | Test                                         | Justification                       |
|---------------|--------|----------|----------------------------------------------|-------------------------------------|
| 2.3-WIDG-001  | Widget | P1       | ToggleSwitch component exists and renders    | Component creation verification     |
| 2.3-WIDG-002  | Widget | P1       | ToggleSwitch initial state respects `initial=True` | State initialization           |
| 2.3-WIDG-003  | Widget | P1       | ToggleSwitch initial state respects `initial=False` | State initialization          |
| 2.3-INT-001   | Integration | P1   | FilterPanel contains first_trigger_toggle widget | Component integration          |

### AC2: Toggle ON: apply filtered first trigger algorithm, show first trigger count

| ID            | Level  | Priority | Test                                               | Justification                    |
|---------------|--------|----------|---------------------------------------------------|----------------------------------|
| 2.3-UNIT-001  | Unit   | P0       | apply_filtered returns one row per ticker-date     | Core algorithm correctness       |
| 2.3-UNIT-002  | Unit   | P1       | apply_filtered on pre-filtered data works correctly | Algorithm with subset data      |
| 2.3-UNIT-003  | Unit   | P1       | apply_filtered uses same sort order as apply()     | Consistency verification        |
| 2.3-INT-002   | Integration | P0   | Toggle ON shows first trigger data                 | End-to-end toggle behavior      |
| 2.3-INT-003   | Integration | P1   | Toggle ON updates row count in bottom bar          | Status message verification     |
| 2.3-INT-004   | Integration | P1   | Toggle ON + filters applies both transformations   | Combined logic flow             |

### AC3: Toggle OFF: show all rows matching filters

| ID            | Level  | Priority | Test                                           | Justification                      |
|---------------|--------|----------|------------------------------------------------|------------------------------------|
| 2.3-INT-005   | Integration | P0   | Toggle OFF shows all data (no filters)         | Basic toggle off behavior          |
| 2.3-INT-006   | Integration | P1   | Toggle OFF shows all filtered rows (with filters) | Filter-only mode                |
| 2.3-INT-007   | Integration | P1   | Toggle OFF updates bottom bar message          | Status message verification        |

### AC4: Chart updates immediately on toggle (< 200ms)

| ID            | Level  | Priority | Test                                           | Justification                      |
|---------------|--------|----------|------------------------------------------------|------------------------------------|
| 2.3-PERF-001  | Integration | P0   | Toggle response < 200ms for 100k rows          | NFR performance requirement        |
| 2.3-PERF-002  | Integration | P2   | apply_filtered < 200ms for 100k rows           | Component-level performance        |

### AC5: Visual indicator when toggle ON (stellar-blue highlight)

| ID            | Level  | Priority | Test                                           | Justification                      |
|---------------|--------|----------|------------------------------------------------|------------------------------------|
| 2.3-WIDG-004  | Widget | P1       | ToggleSwitch uses SIGNAL_BLUE when checked     | Visual styling verification        |
| 2.3-WIDG-005  | Widget | P2       | ToggleSwitch uses BG_BORDER when unchecked     | Visual styling verification        |

### AC6: Edge cases handled (no matches, no first triggers)

| ID            | Level  | Priority | Test                                           | Justification                      |
|---------------|--------|----------|------------------------------------------------|------------------------------------|
| 2.3-UNIT-004  | Unit   | P1       | apply_filtered with empty DataFrame returns empty | Edge case handling              |
| 2.3-INT-008   | Integration | P2   | No data loaded: toggle disabled                | Edge case UX                       |
| 2.3-INT-009   | Integration | P2   | Zero matches after filter: appropriate message | Edge case UX                       |
| 2.3-INT-010   | Integration | P2   | Zero first triggers: appropriate message       | Edge case UX                       |
| 2.3-INT-011   | Integration | P2   | Missing column_mapping: toggle disabled        | Dependency handling                |

---

## Additional Test Scenarios (Cross-AC)

### Signal/State Management

| ID            | Level  | Priority | Test                                           | Justification                      |
|---------------|--------|----------|------------------------------------------------|------------------------------------|
| 2.3-UNIT-005  | Unit   | P1       | ToggleSwitch.toggled signal emits correct bool | Signal contract verification       |
| 2.3-UNIT-006  | Unit   | P1       | setChecked() does not emit toggled signal      | API contract (no double-emit)      |
| 2.3-INT-012   | Integration | P1   | Toggle updates AppState.first_trigger_enabled  | State synchronization              |

### Data Integrity

| ID            | Level  | Priority | Test                                           | Justification                      | Mitigates |
|---------------|--------|----------|------------------------------------------------|------------------------------------|-----------|
| 2.3-UNIT-007  | Unit   | P1       | apply_filtered returns DataFrame copy, not view | Data isolation (TECH-002)         | TECH-002  |
| 2.3-UNIT-008  | Unit   | P2       | apply_filtered preserves all columns           | Data completeness                  |           |
| 2.3-UNIT-009  | Unit   | P2       | apply_filtered logs row counts at DEBUG level  | Observability                      |           |

---

## Test Scenarios Summary Table

| ID            | Level       | Priority | AC   | Description                                      | Mitigates |
|---------------|-------------|----------|------|--------------------------------------------------|-----------|
| 2.3-UNIT-001  | Unit        | P0       | AC2  | apply_filtered returns one row per ticker-date   |           |
| 2.3-UNIT-002  | Unit        | P1       | AC2  | apply_filtered on pre-filtered data              |           |
| 2.3-UNIT-003  | Unit        | P1       | AC2  | apply_filtered sort order consistency            |           |
| 2.3-UNIT-004  | Unit        | P1       | AC6  | apply_filtered with empty DataFrame              |           |
| 2.3-UNIT-005  | Unit        | P1       | -    | toggled signal emits correct bool                |           |
| 2.3-UNIT-006  | Unit        | P1       | -    | setChecked() no signal emission                  |           |
| 2.3-UNIT-007  | Unit        | P1       | -    | apply_filtered returns copy                      | TECH-002  |
| 2.3-UNIT-008  | Unit        | P2       | -    | apply_filtered preserves columns                 |           |
| 2.3-UNIT-009  | Unit        | P2       | -    | apply_filtered DEBUG logging                     |           |
| 2.3-WIDG-001  | Widget      | P1       | AC1  | ToggleSwitch renders                             |           |
| 2.3-WIDG-002  | Widget      | P1       | AC1  | ToggleSwitch initial=True                        |           |
| 2.3-WIDG-003  | Widget      | P1       | AC1  | ToggleSwitch initial=False                       |           |
| 2.3-WIDG-004  | Widget      | P1       | AC5  | SIGNAL_BLUE when checked                         |           |
| 2.3-WIDG-005  | Widget      | P2       | AC5  | BG_BORDER when unchecked                         |           |
| 2.3-INT-001   | Integration | P1       | AC1  | FilterPanel has toggle widget                    |           |
| 2.3-INT-002   | Integration | P0       | AC2  | Toggle ON shows first trigger data               |           |
| 2.3-INT-003   | Integration | P1       | AC2  | Toggle ON updates bottom bar                     |           |
| 2.3-INT-004   | Integration | P1       | AC2  | Toggle ON + filters combined                     |           |
| 2.3-INT-005   | Integration | P0       | AC3  | Toggle OFF shows all data                        |           |
| 2.3-INT-006   | Integration | P1       | AC3  | Toggle OFF with filters                          |           |
| 2.3-INT-007   | Integration | P1       | AC3  | Toggle OFF updates bottom bar                    |           |
| 2.3-INT-008   | Integration | P2       | AC6  | No data: toggle disabled                         |           |
| 2.3-INT-009   | Integration | P2       | AC6  | Zero filter matches message                      |           |
| 2.3-INT-010   | Integration | P2       | AC6  | Zero first triggers message                      |           |
| 2.3-INT-011   | Integration | P2       | AC6  | Missing column_mapping: disabled                 |           |
| 2.3-INT-012   | Integration | P1       | -    | Toggle updates AppState                          | TECH-001  |
| 2.3-PERF-001  | Integration | P0       | AC4  | Toggle < 200ms for 100k rows                     | PERF-001  |
| 2.3-PERF-002  | Integration | P2       | AC4  | apply_filtered < 200ms                           | PERF-001  |

---

## Risk Coverage Matrix

| Risk ID   | Test IDs                          | Coverage |
|-----------|-----------------------------------|----------|
| PERF-001  | 2.3-PERF-001, 2.3-PERF-002        | ✓ Full   |
| TECH-001  | 2.3-INT-012                       | ✓ Full   |
| TECH-002  | 2.3-UNIT-007                      | ✓ Full   |
| DATA-001  | 2.3-UNIT-004, 2.3-INT-008/09/10   | ✓ Full   |
| TECH-003  | (covered by integration test suite) | Partial |
| OPS-001   | (build/lint will detect)          | Implicit |

---

## Test File Mapping

| Test File                                        | Test IDs                                    |
|--------------------------------------------------|---------------------------------------------|
| `tests/widget/test_toggle_switch.py`             | 2.3-WIDG-001 through 2.3-WIDG-005, 2.3-UNIT-005, 2.3-UNIT-006 |
| `tests/unit/test_first_trigger.py`               | 2.3-UNIT-001 through 2.3-UNIT-004, 2.3-UNIT-007 through 2.3-UNIT-009 |
| `tests/widget/test_filter_panel.py`              | 2.3-INT-001                                 |
| `tests/integration/test_first_trigger_toggle.py` | 2.3-INT-002 through 2.3-INT-012             |
| `tests/integration/test_performance.py`          | 2.3-PERF-001, 2.3-PERF-002                  |

---

## Recommended Execution Order

1. **P0 Unit tests** - `2.3-UNIT-001` (fail fast on algorithm)
2. **P0 Integration tests** - `2.3-INT-002`, `2.3-INT-005` (core toggle behavior)
3. **P0 Performance test** - `2.3-PERF-001` (NFR validation)
4. **P1 Unit tests** - Remaining unit tests
5. **P1 Widget tests** - All widget tests
6. **P1 Integration tests** - Remaining integration tests
7. **P2 tests** - Edge cases, visual styling, secondary performance

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for logic, integration for flows)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (performance NFR is P0)
- [x] Test IDs follow `{epic}.{story}-{LEVEL}-{SEQ}` convention
- [x] Scenarios are atomic and independent
- [x] All identified risks have mitigating tests

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 26
  by_level:
    unit: 9
    widget: 5
    integration: 12
    e2e: 0
  by_priority:
    p0: 4
    p1: 14
    p2: 8
  coverage_gaps: []
```

---

Test design matrix: docs/qa/assessments/2.3-test-design-20260110.md
P0 tests identified: 4
