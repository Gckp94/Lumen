# Risk Profile: Story 1.6

Date: 2026-01-10
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 0
- High Risks: 2
- Risk Score: 78/100 (calculated)

## Risk Distribution

### By Category

- Technical: 2 risks (0 critical)
- Security: 0 risks (0 critical)
- Performance: 2 risks (0 critical)
- Data: 3 risks (0 critical)
- Business: 1 risk (0 critical)
- Operational: 0 risks (0 critical)

### By Component

- MetricsCalculator: 5 risks
- MetricCard/MetricsPanel: 1 risk
- AppState: 1 risk
- Infrastructure: 1 risk

## Risk Matrix

| Risk ID   | Description                                  | Probability | Impact     | Score | Priority |
|-----------|----------------------------------------------|-------------|------------|-------|----------|
| BUS-001   | Incorrect EV calculation misleads strategy   | Medium (2)  | High (3)   | 6     | High     |
| TECH-001  | Complex calculation logic in MetricsCalculator | Medium (2) | High (3)   | 6     | High     |
| DATA-001  | Division by zero in R:R ratio calculation    | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-002  | Kelly criterion miscalc leads to over-betting | Low (1)    | High (3)   | 3     | Low      |
| PERF-001  | Performance req < 100ms for 100k rows        | Low (1)    | Medium (2) | 2     | Low      |
| DATA-003  | Floating point precision in percentages      | Low (1)    | Low (1)    | 1     | Minimal  |
| TECH-002  | AppState type hint integration               | Low (1)    | Low (1)    | 1     | Minimal  |
| PERF-002  | Memory with large gain arrays                | Low (1)    | Low (1)    | 1     | Minimal  |

## High Risks Requiring Attention

### 1. BUS-001: Incorrect EV Calculation Misleads Strategy Assessment

**Score: 6 (High)**

**Probability**: Medium - EV formula has multiple dependencies (win_rate, avg_winner, avg_loser). If any upstream value is wrong, EV propagates the error. The formula `(win_rate/100 * avg_winner) + ((1 - win_rate/100) * avg_loser)` requires correct decimal conversion.

**Impact**: High - Traders use EV to assess whether a strategy has positive expectancy. A miscalculated EV could lead to:
- Abandoning profitable strategies (false negative)
- Pursuing unprofitable strategies (false positive)
- Incorrect position sizing decisions

**Mitigation**:
- Comprehensive unit tests with known expected values
- Test with hand-calculated examples from domain experts
- Validate formula matches standard trading EV calculation
- Edge case testing (100% win rate, 0% win rate)

**Testing Focus**: Unit tests for EV calculation with multiple scenarios

---

### 2. TECH-001: Complex Calculation Logic in MetricsCalculator

**Score: 6 (High)**

**Probability**: Medium - Seven interconnected metrics with dependency chain:
```
gains → winners_mask/losers_mask → counts → win_rate
                                         → avg_winner/avg_loser → rr_ratio → kelly
                                                                           → ev
```
Each step in the chain can introduce errors.

**Impact**: High - All seven metrics are displayed to users for trading decisions. A bug in early calculations cascades to downstream metrics.

**Mitigation**:
- Unit test each metric in isolation
- Unit test complete calculation with known datasets
- Test calculation order independence where applicable
- Code review focusing on formula correctness
- Reference implementation comparison

**Testing Focus**: Comprehensive unit test suite with isolated and integrated tests

## Medium Risks

### DATA-001: Division by Zero in R:R Ratio Calculation

**Score: 4 (Medium)**

**Probability**: Medium - Occurs when `avg_loser` is 0 or None:
- All trades are winners (avg_loser = None)
- All losing trades have exactly 0% loss (avg_loser = 0)

**Impact**: Medium - Runtime error would crash calculation, but story design handles this by returning None for rr_ratio.

**Mitigation**:
- Explicit None/zero check before division
- Return None for rr_ratio when avg_loser is None or 0
- Unit tests for all-winners and zero-loss edge cases

**Testing Focus**: Edge case tests for division scenarios

## Low and Minimal Risks

### DATA-002: Kelly Criterion Miscalculation

**Score: 3 (Low)**

Kelly depends on win_rate and rr_ratio. If rr_ratio is wrong or zero, Kelly formula `win_rate/100 - ((1 - win_rate/100) / rr_ratio)` can produce:
- Division by zero (rr_ratio = 0)
- Unrealistic values (negative Kelly suggests don't trade)

**Mitigation**: Guard clause for rr_ratio validity, cap Kelly at reasonable bounds for display.

### PERF-001: Performance Requirement

**Score: 2 (Low)**

100ms for 100k rows is achievable with vectorized pandas operations. Story design uses `gains[winners_mask].tolist()` which is O(n).

**Mitigation**: Performance test marked with `@pytest.mark.slow`, avoid Python loops over rows.

### DATA-003, TECH-002, PERF-002: Minimal Risks

**Score: 1 each**

These are standard implementation concerns with low probability and impact:
- Floating point precision: Python floats are sufficient for percentage display
- AppState type hints: Runtime-optional, only affects static analysis
- Memory for gain arrays: Standard Python behavior, scales linearly

## Risk Mitigation Summary

### Must Fix Before Production

- None at critical level

### Recommended Mitigations

| Risk ID   | Mitigation Strategy                              | Owner | Status    |
|-----------|--------------------------------------------------|-------|-----------|
| BUS-001   | Unit tests with hand-calculated expected values  | Dev   | Via tests |
| TECH-001  | Isolated + integrated unit test suite            | Dev   | Via tests |
| DATA-001  | Explicit None/zero guards in code                | Dev   | In design |
| DATA-002  | Guard clause for rr_ratio validity               | Dev   | In design |
| PERF-001  | Performance test with 100k rows                  | Dev   | Via tests |

### Accepted Risks

- DATA-003, TECH-002, PERF-002: Minimal risk, standard implementation practices sufficient

## Monitoring Requirements

Post-deployment monitoring for:
- Error rates in metrics calculation (logging already specified)
- Performance metrics for large datasets
- User-reported calculation discrepancies

## Risk Review Triggers

Review and update risk profile when:
- Additional metrics added (Epic 3 extends to 25 metrics)
- Performance requirements change
- New edge cases discovered in production

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 1
    low: 4
  highest:
    id: BUS-001
    score: 6
    title: "Incorrect EV calculation misleads strategy"
  recommendations:
    must_fix: []
    monitor:
      - "Add logging for metrics calculation completion"
      - "Track calculation errors in production"
```

---

Risk profile: docs/qa/assessments/1.6-risk-20260110.md
