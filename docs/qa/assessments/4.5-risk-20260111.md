# Risk Profile: Story 4.5 - Distribution Histograms

Date: 2026-01-11
Reviewer: Quinn (Test Architect)

## Executive Summary

- **Total Risks Identified:** 7
- **Critical Risks:** 0
- **High Risks:** 0
- **Medium Risks:** 2
- **Low Risks:** 3
- **Minimal Risks:** 2
- **Risk Score:** 84/100 (Low Risk)

## Risk Matrix

| Risk ID | Description | Probability | Impact | Score | Priority |
|---------|-------------|-------------|--------|-------|----------|
| TECH-001 | PyQtGraph bar overlay z-order rendering | Medium (2) | Medium (2) | 4 | Medium |
| DATA-001 | Empty/None data handling in gains lists | Medium (2) | Medium (2) | 4 | Medium |
| TECH-002 | Freedman-Diaconis auto-binning edge cases | Medium (2) | Low (1) | 2 | Low |
| PERF-001 | Large dataset histogram calculation lag | Low (1) | Medium (2) | 2 | Low |
| DATA-002 | NaN/Inf values in float data | Low (1) | Medium (2) | 2 | Low |
| TECH-003 | Mouse tooltip hit detection accuracy | Low (1) | Low (1) | 1 | Minimal |
| OPS-001 | pytest-qt widget test fixture complexity | Low (1) | Low (1) | 1 | Minimal |

## Medium Risks Requiring Attention

### TECH-001: PyQtGraph Bar Overlay Z-Order Rendering

**Score: 4 (Medium)**
**Category:** Technical

**Probability:** Medium - PyQtGraph z-ordering can be tricky when overlaying multiple BarGraphItems on the same plot. The order of `addItem()` calls determines render order.

**Impact:** Medium - Visual bug where filtered bars appear behind baseline bars would confuse users but not affect underlying data accuracy.

**Mitigation:**
- Add baseline BarGraphItem first, then filtered BarGraphItem (later items render on top)
- Use narrower width for filtered bars (0.6 vs 0.8) to ensure visibility
- Widget tests to verify visual layering

**Testing Focus:**
- Widget test: Verify filtered bars appear on top of baseline
- Manual verification: Visual inspection with overlapping data

**Residual Risk:** Low - PyQtGraph z-ordering is deterministic once understood

---

### DATA-001: Empty/None Data Handling in Gains Lists

**Score: 4 (Medium)**
**Category:** Data

**Probability:** Medium - Users may filter to empty result sets, or baseline/filtered data may be None during loading states.

**Impact:** Medium - Crashes, display errors, or misleading visualizations would disrupt user workflow and trust.

**Mitigation:**
- Defensive checks in `set_baseline()` and `set_filtered()` methods
- `_calculate_bins()` must return empty arrays for empty input
- `clear()` method to gracefully reset visualization
- Emit `render_failed` signal on unexpected data issues

**Testing Focus:**
- Unit tests: `set_baseline(None)`, `set_filtered(None)`, empty lists
- Unit tests: `_calculate_bins([])` returns empty arrays
- Unit tests: `render_failed` signal emits on invalid data

**Residual Risk:** Low - Comprehensive unit tests will catch edge cases

---

## Low Risks

### TECH-002: Freedman-Diaconis Auto-Binning Edge Cases

**Score: 2 (Low)**
**Category:** Technical

**Description:** The auto-binning algorithm using Freedman-Diaconis rule may produce suboptimal results for edge case data distributions (single value, extreme outliers, identical values).

**Mitigation:**
- Fallback to default bin width (1.0) when IQR is 0
- Minimum bin count of 5, maximum of 50
- Unit tests for edge cases

---

### PERF-001: Large Dataset Histogram Calculation Lag

**Score: 2 (Low)**
**Category:** Performance

**Description:** If `winner_gains` or `loser_gains` contains thousands of values, `np.histogram()` calculation could cause UI thread lag.

**Mitigation:**
- NumPy histogram is highly optimized (unlikely to lag with typical data sizes)
- Consider async calculation if profiling shows issues
- Data is already in memory from TradingMetrics; no I/O delay

---

### DATA-002: NaN/Inf Values in Float Data

**Score: 2 (Low)**
**Category:** Data

**Description:** Float gain values might contain NaN or Inf from upstream calculation errors.

**Mitigation:**
- Filter out NaN/Inf values before histogram calculation
- Log warning when invalid values detected
- Mean/median calculations should handle NaN gracefully

---

## Minimal Risks

### TECH-003: Mouse Tooltip Hit Detection Accuracy

**Score: 1 (Minimal)**
**Category:** Technical

**Description:** Tooltip hit detection may be slightly off when hovering near bar edges.

**Mitigation:** Use bar bounds comparison with tolerance. Low impact if tooltip appears for adjacent bar.

---

### OPS-001: pytest-qt Widget Test Fixture Complexity

**Score: 1 (Minimal)**
**Category:** Operational

**Description:** Widget tests require `qtbot` fixture from pytest-qt, adding test infrastructure complexity.

**Mitigation:** pytest-qt is already used in project (per existing test patterns). Follow established patterns.

---

## Risk Distribution

### By Category
- Technical: 3 risks (0 critical)
- Data: 2 risks (0 critical)
- Performance: 1 risk (0 critical)
- Operational: 1 risk (0 critical)

### By Component
- DistributionHistogram widget: 5 risks
- Binning algorithm: 1 risk
- Test infrastructure: 1 risk

## Risk-Based Testing Strategy

### Priority 1: Medium Risk Tests
- Unit tests for empty/None data handling (DATA-001)
- Widget tests for bar overlay z-order (TECH-001)
- Unit tests for `render_failed` signal emission

### Priority 2: Low Risk Tests
- Unit tests for auto-binning edge cases (TECH-002)
- Unit tests for NaN/Inf filtering (DATA-002)

### Priority 3: Minimal Risk Tests
- Widget tests for tooltip positioning (TECH-003)

## Risk Acceptance Criteria

### Must Fix Before Production
- None (no critical or high risks)

### Can Deploy with Mitigation
- TECH-001: Ensure bar ordering in implementation
- DATA-001: Defensive checks in data methods

### Accepted Risks
- PERF-001: Accepted for typical data sizes; monitor if issues arise
- TECH-003: Minor UX issue; acceptable if tooltip works most of the time

## Monitoring Requirements

Post-deployment monitoring for:
- Error logs for `render_failed` signal emissions
- User feedback on histogram visualization accuracy
- Performance metrics if histogram dialog opens slowly

## Gate Integration

**Risk-based gate determination:**
- No risks with score ≥ 9 → Does not force FAIL
- No risks with score ≥ 6 → Does not force CONCERNS
- Maximum score = 4 → Gate can be PASS with proper mitigations
