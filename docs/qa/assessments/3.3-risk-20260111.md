# Risk Profile: Story 3.3

Date: 2026-01-11
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0
- High Risks: 0
- Medium Risks: 2
- Low Risks: 1
- Minimal Risks: 4
- Risk Score: 88/100 (Low Risk)

## Risk Matrix

| Risk ID   | Description                              | Probability | Impact     | Score | Priority |
|-----------|------------------------------------------|-------------|------------|-------|----------|
| TECH-001  | Streak algorithm correctness             | Low (1)     | Medium (2) | 2     | Low      |
| DATA-001  | Chronological sorting dependency         | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-002  | Edge cases (empty/single/all-same)       | Low (1)     | Low (1)    | 1     | Minimal  |
| TECH-003  | Max loss % sign convention in display    | Low (1)     | Low (1)    | 1     | Minimal  |
| PERF-001  | Run-length encoding performance          | Low (1)     | Low (1)    | 1     | Minimal  |
| TECH-004  | Stop loss integration with max_loss_pct  | Low (1)     | Medium (2) | 2     | Low      |
| DATA-002  | None handling in MetricsGrid display     | Low (1)     | Low (1)    | 1     | Minimal  |

## Medium Risks Requiring Attention

### DATA-001: Chronological Sorting Dependency

**Score: 4 (Medium)**

**Probability**: Medium - The story requires data to be sorted chronologically before streak calculation. If MetricsCalculator receives unsorted data, streak metrics will be meaningless.

**Impact**: Medium - Users would see incorrect streak counts, potentially affecting trading decisions. No data corruption, but misleading metrics.

**Mitigation**:
- Strategy: Preventive
- Actions:
  - Add optional `date_col` and `time_col` parameters to `MetricsCalculator.calculate()`
  - Sort DataFrame by date/time before streak calculation when columns provided
  - Document that data must be pre-sorted if columns not provided
  - Verify baseline_df is already sorted after first-trigger processing
- Testing Requirements:
  - Unit test: verify sorting affects streak results
  - Unit test: unsorted vs sorted data produces different streaks
- Residual Risk: Low - After implementing sorting, risk is mitigated
- Owner: Dev
- Timeline: During implementation

### TECH-001: Streak Algorithm Correctness

**Score: 2 (Low)**

**Probability**: Low - The run-length encoding algorithm is well-documented in the story with reference implementation. The approach is standard.

**Impact**: Medium - Incorrect streak calculations would mislead users about their trading patterns.

**Mitigation**:
- Strategy: Preventive + Detective
- Actions:
  - Use reference implementation from story Dev Notes
  - Implement comprehensive unit tests with known expected values
  - Test edge cases explicitly
- Testing Requirements:
  - Unit test with sample data: trades 1-3 win streak = 3
  - Unit test with sample data: trades 7-9 loss streak = 3
  - Unit test alternating pattern: max = 1 for both
- Residual Risk: Minimal - Thorough testing eliminates risk
- Owner: Dev
- Timeline: During implementation

## Low Risks

### TECH-004: Stop Loss Integration

**Score: 2 (Low)**

**Probability**: Low - The existing `AdjustmentParams.calculate_adjusted_gains()` already applies stop_loss before gain calculations. The integration is automatic.

**Impact**: Medium - If stop_loss doesn't properly cap max_loss_pct, users could see losses exceeding their set stop.

**Mitigation**:
- Strategy: Verification
- Actions:
  - Verify existing data flow: adjustment_params → calculate_adjusted_gains → loser_gains
  - Confirm max_loss_pct is calculated from adjusted (capped) gains
  - Add unit test specifically for stop_loss capping max_loss_pct
- Testing Requirements:
  - Unit test: max_loss_pct with stop_loss < worst trade
  - Verify max_loss_pct never exceeds stop_loss when active
- Residual Risk: Minimal - Existing architecture handles this correctly
- Owner: Dev
- Timeline: During testing

## Minimal Risks

### TECH-002: Edge Cases in Empty/Single Trade

**Score: 1 (Minimal)**

**Probability**: Low - Standard edge cases that are explicitly documented in story.

**Impact**: Low - Minor display issues, None values shown appropriately.

**Mitigation**: Comprehensive unit tests for all edge cases listed in story.

### TECH-003: Max Loss % Sign Convention

**Score: 1 (Minimal)**

**Probability**: Low - Existing `MetricCard.update_value()` already implements color coding for negative values.

**Impact**: Low - Cosmetic only, no data impact.

**Mitigation**: Widget test to verify coral color for negative max_loss_pct.

### PERF-001: Run-Length Encoding Performance

**Score: 1 (Minimal)**

**Probability**: Low - Algorithm is O(n) and fully vectorized with pandas.

**Impact**: Low - Only affects calculation time, typical trade counts are small.

**Mitigation**: None needed; algorithm is already optimal.

### DATA-002: None Handling in Display

**Score: 1 (Minimal)**

**Probability**: Low - Existing MetricsGrid pattern handles None fields.

**Impact**: Low - Display shows "--" or similar for None values.

**Mitigation**: Widget test to verify None handling.

## Risk Distribution

### By Category

- Technical (TECH): 4 risks (0 critical, 0 high, 2 low/medium)
- Data (DATA): 2 risks (1 medium, 1 minimal)
- Performance (PERF): 1 risk (1 minimal)
- Security: 0 risks
- Business: 0 risks
- Operational: 0 risks

### By Component

- Backend (MetricsCalculator): 5 risks
- Frontend (MetricsGrid): 2 risks
- Database: 0 risks
- Infrastructure: 0 risks

## Detailed Risk Register

| Risk ID   | Category    | Title                                | P   | I   | Score | Mitigation Strategy | Owner | Status    |
|-----------|-------------|--------------------------------------|-----|-----|-------|---------------------|-------|-----------|
| DATA-001  | Data        | Chronological sorting dependency     | 2   | 2   | 4     | Add sorting params  | Dev   | Open      |
| TECH-001  | Technical   | Streak algorithm correctness         | 1   | 2   | 2     | Unit tests          | Dev   | Open      |
| TECH-004  | Technical   | Stop loss integration                | 1   | 2   | 2     | Verify flow         | Dev   | Open      |
| TECH-002  | Technical   | Edge case handling                   | 1   | 1   | 1     | Unit tests          | Dev   | Open      |
| TECH-003  | Technical   | Display sign convention              | 1   | 1   | 1     | Widget test         | Dev   | Open      |
| PERF-001  | Performance | Algorithm performance                | 1   | 1   | 1     | None needed         | Dev   | Accepted  |
| DATA-002  | Data        | None handling in UI                  | 1   | 1   | 1     | Widget test         | Dev   | Open      |

## Risk-Based Testing Strategy

### Priority 1: Medium Risk Tests

- **DATA-001**: Test chronological sorting effect on streaks
  - Unsorted data produces different results than sorted
  - Verify sort_values called when date_col/time_col provided

- **TECH-001**: Algorithm correctness tests
  - Sample data with known expected streaks
  - Verify run-length encoding produces correct groups

### Priority 2: Low Risk Tests

- **TECH-004**: Stop loss integration
  - max_loss_pct respects stop_loss cap
  - Verify adjustment_params flow

### Priority 3: Minimal Risk Tests

- Edge cases (empty, single, all-winners, all-losers, alternating)
- Display formatting (negative color, None handling)

## Risk Acceptance Criteria

### Must Fix Before Production

- None - no critical or high risks identified

### Can Deploy with Mitigation

- DATA-001: Implement sorting with date/time params OR document pre-sorted requirement
- TECH-001: Comprehensive unit test coverage

### Accepted Risks

- PERF-001: Algorithm performance accepted as-is (O(n) vectorized is optimal)

## Monitoring Requirements

Post-deployment monitoring for:

- None required - this is a display-only feature with no external dependencies

## Risk Review Triggers

Review and update risk profile when:

- Streak algorithm implementation differs from reference
- Chronological sorting approach changes
- Additional streak-related metrics added

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 0
    medium: 2
    low: 1
  highest:
    id: DATA-001
    score: 4
    title: 'Chronological sorting dependency'
  recommendations:
    must_fix: []
    monitor:
      - 'Verify data is sorted before streak calculation'
      - 'Add unit tests for sorting edge cases'
```

---

Risk profile: docs/qa/assessments/3.3-risk-20260111.md
