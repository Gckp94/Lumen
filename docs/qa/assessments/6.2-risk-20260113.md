# Risk Profile: Story 6.2

Date: 2026-01-13
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 0
- High Risks: 2
- Risk Score: 76/100 (calculated)

## Risk Matrix

| Risk ID   | Description                                    | Probability | Impact     | Score | Priority |
|-----------|------------------------------------------------|-------------|------------|-------|----------|
| PERF-001  | 100k row processing exceeds 500ms threshold    | Medium (2)  | High (3)   | 6     | High     |
| TECH-001  | Bin operator edge cases cause incorrect assignments | Medium (2) | High (3)  | 6     | High     |
| DATA-001  | Win rate calculation incorrect for edge cases  | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-002  | PyQtGraph horizontal bar rendering issues      | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-002  | NaN propagation in metric calculations         | Low (1)     | High (3)   | 3     | Low      |
| TECH-003  | Signal debouncing causes UI lag or missed updates | Low (1)   | Medium (2) | 2     | Low      |
| OPS-001   | Empty state transitions not smooth             | Low (1)     | Low (1)    | 1     | Minimal  |
| TECH-004  | Gradient color calculation edge cases          | Low (1)     | Low (1)    | 1     | Minimal  |

## High Risks Requiring Attention

### PERF-001: 100k Row Processing Performance

**Score: 6 (High)**
**Probability**: Medium - Vector operations in pandas can be fast, but improper implementation (e.g., iterating rows) could easily exceed threshold
**Impact**: High - Explicit AC9 requirement of <500ms; failure means acceptance criteria not met
**Affected Components**:
- `BinningEngine.assign_bins()`
- `BinningEngine.calculate_bin_metrics()`

**Mitigation**:
- Use vectorized pandas operations exclusively (no `.iterrows()` or `.apply()` with Python functions)
- Use `np.select()` or `pd.cut()` for bin assignment
- Pre-compute conditions as boolean masks before applying
- Add performance test as part of CI pipeline

**Testing Focus**:
- Performance test with 100k synthetic DataFrame
- Benchmark each operator type separately
- Profile memory usage for large datasets

---

### TECH-001: Bin Operator Edge Cases

**Score: 6 (High)**
**Probability**: Medium - Multiple operators with overlapping logic; edge cases like boundary values, multiple bin matches, and empty data are common failure points
**Impact**: High - Incorrect bin assignment invalidates all downstream metrics and charts

**Affected Components**:
- `BinningEngine.assign_bins()`
- All bin operator handlers (`<`, `>`, `range`, `nulls`)

**Edge Cases to Address**:
1. Boundary values: What happens at exactly the threshold? (`< 10` vs `<= 10`)
2. Overlapping bins: `< 20` and `> 10` both match value 15 - first match wins per spec
3. Range edge cases: Does `range(10, 20)` include 10? Include 20? (Story says `value1 <= value <= value2`)
4. All nulls column: Every row assigned to "Nulls" bin
5. No matching bins: All rows become "Uncategorized"
6. Empty DataFrame: Should return empty Series without errors

**Mitigation**:
- Document exact boundary behavior in BinningEngine docstrings
- Implement explicit "first match wins" logic with clear iteration order
- Add comprehensive unit tests for each edge case
- Use assertion checks for bin definition validation

**Testing Focus**:
- Unit tests for each operator at exact boundary values
- Unit test for overlapping bin definitions
- Unit test for empty DataFrame handling

## Medium Risks

### DATA-001: Win Rate Calculation Edge Cases

**Score: 4 (Medium)**
**Probability**: Medium - Division by zero, empty bins, and all-negative bins are realistic scenarios
**Impact**: Medium - Incorrect win rates mislead user analysis

**Details**:
- Win rate formula: `(rows where metric_col > 0) / total rows * 100`
- Edge cases: bin with 0 rows, bin with all zeros, bin with all negatives

**Mitigation**:
- Return `None`/`NaN` for empty bins (not 0%)
- Add explicit handling for bins with 0 qualifying rows (0% win rate, not error)
- Document behavior in method docstring

**Testing Focus**:
- Test bin with 0 trades
- Test bin with all losing trades
- Test bin with all winning trades

---

### TECH-002: PyQtGraph Horizontal Bar Rendering

**Score: 4 (Medium)**
**Probability**: Medium - PyQtGraph is primarily designed for scientific plotting; horizontal bar charts with custom styling may require workarounds
**Impact**: Medium - Chart may not match design spec or have visual glitches

**Details**:
- Dev Notes suggest alternative: custom QWidget with QPainter
- Gradient coloring requires per-bar brush customization
- Text labels alongside bars need careful positioning

**Mitigation**:
- Prototype both approaches (PyQtGraph vs QPainter) early
- Consider existing chart patterns in codebase (check for precedent)
- Implement fallback styling if gradient coloring proves complex

**Testing Focus**:
- Widget tests for chart creation with various bin counts
- Visual verification of gradient colors
- Scrolling behavior with many bins

## Low Risks

### DATA-002: NaN Propagation in Metrics

**Score: 3 (Low)**
**Probability**: Low - Pandas handles NaN well by default, but custom aggregations can propagate unexpectedly
**Impact**: High - Silent data corruption in displayed metrics

**Mitigation**:
- Use `skipna=True` explicitly in aggregations
- Test with DataFrames containing NaN values

---

### TECH-003: Signal Debouncing Issues

**Score: 2 (Low)**
**Probability**: Low - Standard Qt timer pattern; well-documented in Dev Notes
**Impact**: Medium - Either excessive recalculations (no debounce) or missed updates (over-debounce)

**Mitigation**:
- Use standard 300ms debounce as specified
- Ensure timer is single-shot and restarted on each trigger

---

### OPS-001: Empty State Transitions

**Score: 1 (Minimal)**
**Probability**: Low - EmptyState component exists and is documented
**Impact**: Low - Minor UX issue if transition is jarring

---

### TECH-004: Gradient Color Calculation

**Score: 1 (Minimal)**
**Probability**: Low - Algorithm is straightforward (linear interpolation)
**Impact**: Low - Visual-only; incorrect colors don't affect data

## Risk Distribution

### By Category

| Category    | Count | High+ Risks |
|-------------|-------|-------------|
| Technical   | 4     | 1           |
| Performance | 1     | 1           |
| Data        | 2     | 0           |
| Operational | 1     | 0           |
| Security    | 0     | 0           |
| Business    | 0     | 0           |

### By Component

| Component              | Risks |
|------------------------|-------|
| BinningEngine          | 4     |
| BinChartPanel          | 3     |
| Signal/State handling  | 1     |

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests

| Risk    | Test Type   | Test Scenarios                              |
|---------|-------------|---------------------------------------------|
| PERF-001| Performance | 100k rows, multiple bin configurations      |
| TECH-001| Unit        | Boundary values, overlapping bins, edge cases |

### Priority 2: Medium Risk Tests

| Risk    | Test Type   | Test Scenarios                              |
|---------|-------------|---------------------------------------------|
| DATA-001| Unit        | Empty bins, all-losing bins, division safety |
| TECH-002| Widget      | Chart rendering, gradient colors, scrolling |

### Priority 3: Low Risk Tests

- Integration tests for signal flow
- Widget tests for empty state display

## Risk Acceptance Criteria

### Must Fix Before Production

- All performance tests passing under 500ms threshold
- All bin assignment edge cases covered with tests

### Can Deploy with Mitigation

- Minor gradient color inaccuracies (visual only)
- Suboptimal chart rendering library choice (functional but not ideal)

### Accepted Risks

- None currently accepted; all risks have mitigation strategies

## Monitoring Requirements

Post-deployment monitoring for:
- Chart rendering time in production (if analytics available)
- User-reported bin assignment issues

## Risk Review Triggers

Review and update risk profile when:
- Performance issues reported on large datasets
- New bin operators added
- Chart library changed

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 2
    low: 4
  highest:
    id: PERF-001
    score: 6
    title: "100k row processing exceeds 500ms threshold"
  recommendations:
    must_fix:
      - "Implement vectorized bin assignment using np.select or pd.cut"
      - "Add performance test for 100k rows as part of test suite"
      - "Comprehensive unit tests for bin operator edge cases"
    monitor:
      - "Chart rendering performance on large bin counts"
```

---

Risk profile: docs/qa/assessments/6.2-risk-20260113.md
