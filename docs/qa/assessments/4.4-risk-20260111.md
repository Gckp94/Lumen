# Risk Profile: Story 4.4 - PnL Equity Charts

Date: 2026-01-11
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 0
- High Risks: 0
- Medium Risks: 3
- Low Risks: 5
- Risk Score: 83/100 (Low Risk)

## Risk Matrix

| Risk ID   | Description                                    | Probability | Impact     | Score | Priority |
|-----------|------------------------------------------------|-------------|------------|-------|----------|
| PERF-001  | 10k+ points rendering exceeds 500ms target     | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-001  | FillBetweenItem API differs from expectations  | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001  | DataFrame column mismatch breaks chart         | Low (1)     | High (3)   | 3     | Low      |
| TECH-002  | Line chart crosshair behavior differs scatter  | Medium (2)  | Low (1)    | 2     | Low      |
| DATA-002  | None/empty data handling causes crash          | Low (1)     | Medium (2) | 2     | Low      |
| BUS-001   | Visual confusion between baseline/filtered     | Low (1)     | Medium (2) | 2     | Low      |
| TECH-003  | Signal connection timing on tab switch         | Low (1)     | Medium (2) | 2     | Low      |
| PERF-002  | Drawdown fill computation slows large datasets | Low (1)     | Low (1)    | 1     | Minimal  |

## Critical Risks Requiring Immediate Attention

None identified. All risks are Medium or lower priority.

## Medium Priority Risks

### 1. PERF-001: Performance Target May Be Missed

**Score: 4 (Medium)**
**Probability**: Medium - PyQtGraph line charts handle large datasets well with OpenGL, but 10k+ points with two series plus optional drawdown fill adds complexity
**Impact**: Medium - Degraded user experience with slow charts, but not data loss

**Mitigation**:
- Use OpenGL acceleration (already enabled in project)
- Disable antialiasing for performance
- Use PlotDataItem with `connect='finite'` for efficient rendering
- Test with representative data sizes during development

**Testing Focus**: Explicit performance test with 10k and 83k points, timing assertions

---

### 2. TECH-001: FillBetweenItem API for Drawdown Visualization

**Score: 4 (Medium)**
**Probability**: Medium - FillBetweenItem requires two curve objects, not raw data arrays; peak curve must be computed and maintained separately
**Impact**: Medium - Drawdown feature may require rework if API misunderstood

**Mitigation**:
- Create separate PlotDataItem for peak curve (hidden from legend)
- Update both equity and peak curves when data changes
- Verify FillBetweenItem updates properly on data refresh

**Testing Focus**: Unit tests for drawdown visibility toggle, visual verification

---

### 3. DATA-001: DataFrame Column Mismatch

**Score: 3 (Low)**
**Probability**: Low - DataFrame structure is well-documented in Dev Notes from EquityCalculator
**Impact**: High - Chart fails to render if expected columns missing

**Mitigation**:
- Validate DataFrame columns before plotting
- Log warning if expected columns missing
- Graceful fallback to clearing chart on invalid data

**Testing Focus**: Unit tests with malformed DataFrames, None values

## Risk Distribution

### By Category

- Technical (TECH): 3 risks (0 critical)
- Performance (PERF): 2 risks (0 critical)
- Data (DATA): 2 risks (0 critical)
- Business (BUS): 1 risk (0 critical)
- Security (SEC): 0 risks
- Operational (OPS): 0 risks

### By Component

- EquityChart widget: 6 risks
- PnLStatsTab integration: 2 risks
- Signal/slot connections: 1 risk

## Detailed Risk Register

### TECH-001: FillBetweenItem API Differs from Expectations
- **Category**: Technical
- **Affected Components**: EquityChart drawdown visualization
- **Detection Method**: Code review of PyQtGraph FillBetweenItem docs
- **Mitigation Strategy**: Preventive
- **Actions**:
  - Create hidden PlotDataItem for peak curve
  - FillBetweenItem references curve1 (equity) and curve2 (peak)
  - Update fill when either curve changes
- **Testing Requirements**: Unit tests for drawdown toggle, widget tests for visual
- **Residual Risk**: Low - PyQtGraph API is stable
- **Owner**: Dev
- **Timeline**: During Task 4 implementation

### TECH-002: Line Chart Crosshair Behavior Differs from Scatter
- **Category**: Technical
- **Affected Components**: EquityChart crosshair
- **Detection Method**: Pattern comparison with ChartCanvas
- **Mitigation Strategy**: Preventive
- **Actions**:
  - Reuse same InfiniteLine approach from ChartCanvas
  - Adjust coordinate label format for equity context ("Trade: X, Equity: $Y.YY")
- **Testing Requirements**: Widget tests for crosshair visibility
- **Residual Risk**: Low - Pattern already proven in ChartCanvas
- **Owner**: Dev
- **Timeline**: Task 2

### TECH-003: Signal Connection Timing on Tab Switch
- **Category**: Technical
- **Affected Components**: PnLStatsTab, EquityChart
- **Detection Method**: Experience from Story 4.3 insights
- **Mitigation Strategy**: Preventive
- **Actions**:
  - Initialize charts from state in `_initialize_from_state()`
  - Refresh on showEvent for tab visibility changes
- **Testing Requirements**: Integration tests for signal flow
- **Residual Risk**: Low - Pattern from previous stories
- **Owner**: Dev
- **Timeline**: Task 9

### PERF-001: 10k+ Points Rendering Target
- **Category**: Performance
- **Affected Components**: EquityChart
- **Detection Method**: Acceptance criteria AC6
- **Mitigation Strategy**: Preventive
- **Actions**:
  - Enable OpenGL (`pg.setConfigOptions(useOpenGL=True)`)
  - Disable antialiasing for better performance
  - Use efficient PlotDataItem settings
- **Testing Requirements**: Performance tests with timing assertions
- **Residual Risk**: Low - PyQtGraph handles this well with OpenGL
- **Owner**: Dev
- **Timeline**: Task 13 verification

### PERF-002: Drawdown Fill Computation Performance
- **Category**: Performance
- **Affected Components**: EquityChart drawdown feature
- **Detection Method**: Analysis of FillBetweenItem behavior
- **Mitigation Strategy**: Detective
- **Actions**:
  - Peak curve already computed by EquityCalculator
  - Monitor performance with drawdown enabled
- **Testing Requirements**: Performance test with drawdown enabled
- **Residual Risk**: Minimal - Data already computed upstream
- **Owner**: Dev
- **Timeline**: Task 13

### DATA-001: DataFrame Column Mismatch
- **Category**: Data
- **Affected Components**: EquityChart.set_baseline(), set_filtered()
- **Detection Method**: Defensive programming review
- **Mitigation Strategy**: Preventive
- **Actions**:
  - Validate expected columns (`trade_num`, `equity`, `peak`) exist
  - Log warning and clear chart if columns missing
  - Handle KeyError gracefully
- **Testing Requirements**: Unit tests with invalid DataFrames
- **Residual Risk**: Low - Clear contract from EquityCalculator
- **Owner**: Dev
- **Timeline**: Task 5

### DATA-002: None/Empty Data Handling
- **Category**: Data
- **Affected Components**: EquityChart data methods
- **Detection Method**: Defensive programming review
- **Mitigation Strategy**: Preventive
- **Actions**:
  - Guard clauses for None DataFrames
  - Handle empty DataFrames by clearing series
  - Log debug message for tracking
- **Testing Requirements**: Unit tests for None and empty cases
- **Residual Risk**: Low - Standard defensive pattern
- **Owner**: Dev
- **Timeline**: Task 5

### BUS-001: Visual Confusion Between Curves
- **Category**: Business
- **Affected Components**: EquityChart legend, curve styling
- **Detection Method**: UX review
- **Mitigation Strategy**: Preventive
- **Actions**:
  - Distinct colors: stellar-blue (baseline), plasma-cyan (filtered)
  - Legend with clear labels "Baseline" and "Filtered"
  - Consistent 2px line width for both
- **Testing Requirements**: Widget tests verify colors, manual visual QA
- **Residual Risk**: Low - Color scheme is established project standard
- **Owner**: Dev
- **Timeline**: Task 1

## Risk-Based Testing Strategy

### Priority 1: Performance Tests
- PERF-001: Test 10k point rendering < 500ms
- PERF-001: Test 83k point rendering (stretch goal)
- PERF-002: Test with drawdown enabled

### Priority 2: Data Handling Tests
- DATA-001: Test with missing columns
- DATA-002: Test with None DataFrame
- DATA-002: Test with empty DataFrame

### Priority 3: Integration Tests
- TECH-003: Signal flow from AppState to charts
- Filter addition/removal updates charts correctly

### Priority 4: Visual/Interaction Tests
- TECH-001: Drawdown fill appears correctly
- TECH-002: Crosshair tracks mouse position
- BUS-001: Colors match specification

## Risk Acceptance Criteria

### Must Fix Before Production
- None - no critical risks identified

### Can Deploy with Mitigation
- PERF-001: If slightly over 500ms, document as known limitation
- All medium risks with proper testing coverage

### Accepted Risks
- PERF-002: Minimal impact, acceptable as-is

## Monitoring Requirements

Post-deployment monitoring for:
- Chart rendering performance via debug logging
- Error rates for data handling edge cases

## Risk Review Triggers

Review and update risk profile when:
- Performance issues reported by users
- New data sources with different DataFrame structures
- Changes to PyQtGraph version

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 0
    medium: 3
    low: 5
  highest:
    id: PERF-001
    score: 4
    title: '10k+ points rendering may exceed 500ms target'
  recommendations:
    must_fix: []
    monitor:
      - 'Performance logging for large dataset rendering'
      - 'Error tracking for DataFrame validation failures'
```

---

Risk profile: docs/qa/assessments/4.4-risk-20260111.md
