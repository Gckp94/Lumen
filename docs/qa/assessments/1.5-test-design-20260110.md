# Test Design: Story 1.5 - First Trigger Baseline

Date: 2026-01-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 14 (58%)
- Widget tests: 5 (21%)
- Integration tests: 5 (21%)
- Priority distribution: P0: 8, P1: 10, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: First Trigger Algorithm with Mapped Column Names

*Apply first trigger algorithm using mapped column names: Group by ticker + date, Sort by time within groups, Keep first row per group*

| ID            | Level | Priority | Test Description                                   | Justification                        | Mitigates |
|---------------|-------|----------|---------------------------------------------------|--------------------------------------|-----------|
| 1.5-UNIT-001  | Unit  | P0       | First trigger returns one row per ticker-date     | Core algorithm correctness           | -         |
| 1.5-UNIT-002  | Unit  | P0       | Earliest time within group is selected            | Sort verification                    | DATA-001  |
| 1.5-UNIT-003  | Unit  | P1       | Multiple tickers same date handled correctly      | Group boundary verification          | -         |
| 1.5-UNIT-004  | Unit  | P1       | Same ticker multiple dates handled correctly      | Group boundary verification          | -         |

### AC2: Baseline DataFrame Stored in App State

*Baseline DataFrame stored in app state*

| ID            | Level       | Priority | Test Description                                   | Justification                        | Mitigates |
|---------------|-------------|----------|---------------------------------------------------|--------------------------------------|-----------|
| 1.5-UNIT-005  | Unit        | P0       | AppState.baseline_df is set after calculation     | State management correctness         | -         |
| 1.5-UNIT-006  | Unit        | P0       | AppState.has_data returns True with data          | Property correctness                 | -         |
| 1.5-UNIT-007  | Unit        | P1       | AppState.has_data returns False initially         | Initial state verification           | -         |
| 1.5-UNIT-008  | Unit        | P1       | AppState signals emit on state changes            | Signal correctness                   | TECH-001  |
| 1.5-INT-001   | Integration | P1       | data_loaded signal emitted after first trigger    | Cross-component communication        | TECH-001  |

### AC3: Display Baseline Message

*Display: "Baseline: {n:,} first triggers from {total:,} total rows"*

| ID            | Level  | Priority | Test Description                                   | Justification                        | Mitigates |
|---------------|--------|----------|---------------------------------------------------|--------------------------------------|-----------|
| 1.5-WIDG-001  | Widget | P0       | BaselineInfoCard displays correct message format  | UI correctness                       | -         |
| 1.5-WIDG-002  | Widget | P1       | Numbers use thousands separator formatting        | Number formatting                    | -         |
| 1.5-WIDG-003  | Widget | P1       | update_counts() updates display correctly         | Dynamic update                       | -         |

### AC4: Styled Info Card

*Styled info card with stellar-blue left border*

| ID            | Level  | Priority | Test Description                                   | Justification                        | Mitigates |
|---------------|--------|----------|---------------------------------------------------|--------------------------------------|-----------|
| 1.5-WIDG-004  | Widget | P1       | Card has #4A9EFF left border color                | Visual styling                       | -         |
| 1.5-WIDG-005  | Widget | P2       | Card uses BG_ELEVATED background                  | Design system adherence              | -         |

### AC5: Edge Case Handling

*Edge case handling (single row, missing time, duplicates)*

| ID            | Level | Priority | Test Description                                   | Justification                        | Mitigates |
|---------------|-------|----------|---------------------------------------------------|--------------------------------------|-----------|
| 1.5-UNIT-009  | Unit  | P0       | Empty DataFrame returns empty DataFrame           | Edge case - empty input              | -         |
| 1.5-UNIT-010  | Unit  | P0       | Single row DataFrame returns that row             | Edge case - minimal input            | -         |
| 1.5-UNIT-011  | Unit  | P0       | Null times sorted first within groups             | Edge case - missing time             | DATA-001  |
| 1.5-UNIT-012  | Unit  | P1       | Duplicate times keep first occurrence             | Edge case - duplicate times          | DATA-002  |
| 1.5-UNIT-013  | Unit  | P2       | All same ticker-date returns single row           | Edge case - uniform data             | -         |
| 1.5-UNIT-014  | Unit  | P2       | Columns preserved in output                       | Schema preservation                  | -         |

### AC6: Performance Requirement

*Algorithm completes in < 500ms for 100k rows*

| ID            | Level       | Priority | Test Description                                   | Justification                        | Mitigates |
|---------------|-------------|----------|---------------------------------------------------|--------------------------------------|-----------|
| 1.5-INT-002   | Integration | P0       | First trigger < 500ms for 100k rows               | NFR compliance                       | PERF-001  |
| 1.5-INT-003   | Integration | P2       | Memory stays reasonable during processing         | Resource management                  | TECH-002  |

### Cross-Cutting / Integration

| ID            | Level       | Priority | Test Description                                   | Justification                        | Mitigates |
|---------------|-------------|----------|---------------------------------------------------|--------------------------------------|-----------|
| 1.5-INT-004   | Integration | P1       | Full flow: load file -> first trigger -> state    | End-to-end workflow                  | -         |
| 1.5-INT-005   | Integration | P2       | AppState accessible from multiple tabs            | Component wiring                     | TECH-003  |

## Risk Coverage Matrix

| Risk ID   | Test Coverage                              | Status    |
|-----------|-------------------------------------------|-----------|
| PERF-001  | 1.5-INT-002                               | Covered   |
| DATA-001  | 1.5-UNIT-002, 1.5-UNIT-011                | Covered   |
| DATA-002  | 1.5-UNIT-012                              | Covered   |
| TECH-001  | 1.5-UNIT-008, 1.5-INT-001                 | Covered   |
| TECH-002  | 1.5-INT-003                               | Covered   |
| TECH-003  | 1.5-INT-005                               | Covered   |
| OPS-001   | Verified via make typecheck               | External  |

## Test Implementation Mapping

### Unit Tests (`tests/unit/test_first_trigger.py`)

```python
# 1.5-UNIT-001: First trigger returns one row per ticker-date
def test_first_trigger_basic():
    """First trigger returns one row per ticker-date."""

# 1.5-UNIT-002: Earliest time within group is selected
def test_first_trigger_selects_earliest_time():
    """Earliest time within group is selected."""

# 1.5-UNIT-003: Multiple tickers same date handled correctly
def test_first_trigger_multiple_tickers_same_date():
    """Multiple tickers same date handled correctly."""

# 1.5-UNIT-004: Same ticker multiple dates handled correctly
def test_first_trigger_same_ticker_multiple_dates():
    """Same ticker multiple dates handled correctly."""

# 1.5-UNIT-009: Empty DataFrame returns empty DataFrame
def test_first_trigger_empty():
    """Empty DataFrame returns empty DataFrame."""

# 1.5-UNIT-010: Single row DataFrame returns that row
def test_first_trigger_single_row():
    """Single row DataFrame returns that row."""

# 1.5-UNIT-011: Null times sorted first within groups
def test_first_trigger_null_times():
    """Null times sorted first within groups."""

# 1.5-UNIT-012: Duplicate times keep first occurrence
def test_first_trigger_duplicate_times():
    """Duplicate times keeps first occurrence."""

# 1.5-UNIT-013: All same ticker-date returns single row
def test_first_trigger_all_same_group():
    """All same ticker-date returns single row."""

# 1.5-UNIT-014: Columns preserved in output
def test_first_trigger_preserves_columns():
    """Columns preserved in output."""
```

### Unit Tests (`tests/unit/test_app_state.py`)

```python
# 1.5-UNIT-005: AppState.baseline_df is set after calculation
def test_app_state_baseline_df_set():
    """AppState.baseline_df is set correctly."""

# 1.5-UNIT-006: AppState.has_data returns True with data
def test_app_state_has_data_true():
    """has_data returns True when baseline_df and column_mapping set."""

# 1.5-UNIT-007: AppState.has_data returns False initially
def test_app_state_has_data_false():
    """has_data returns False when no data loaded."""

# 1.5-UNIT-008: AppState signals emit on state changes
def test_app_state_signals_emit(qtbot):
    """Signals emit correctly."""
```

### Widget Tests (`tests/widget/test_baseline_info_card.py`)

```python
# 1.5-WIDG-001: BaselineInfoCard displays correct message format
def test_baseline_card_displays_message(qtbot):
    """Card displays correct formatted message."""

# 1.5-WIDG-002: Numbers use thousands separator formatting
def test_baseline_card_thousands_separator(qtbot):
    """Numbers use thousands separator."""

# 1.5-WIDG-003: update_counts() updates display correctly
def test_baseline_card_update_counts(qtbot):
    """update_counts() updates display."""

# 1.5-WIDG-004: Card has #4A9EFF left border color
def test_baseline_card_has_blue_border(qtbot):
    """Card has stellar-blue left border."""

# 1.5-WIDG-005: Card uses BG_ELEVATED background
def test_baseline_card_background(qtbot):
    """Card uses BG_ELEVATED background."""
```

### Integration Tests (`tests/integration/`)

```python
# 1.5-INT-001: data_loaded signal emitted after first trigger
def test_data_loaded_signal_emitted(qtbot):
    """data_loaded signal emitted after first trigger."""

# 1.5-INT-002: First trigger < 500ms for 100k rows
@pytest.mark.slow
def test_first_trigger_performance():
    """Performance: < 500ms for 100k rows."""

# 1.5-INT-003: Memory stays reasonable during processing
@pytest.mark.slow
def test_first_trigger_memory():
    """Memory stays reasonable during processing."""

# 1.5-INT-004: Full flow: load file -> first trigger -> state
def test_full_load_workflow(qtbot, tmp_path):
    """Complete file load -> first trigger -> baseline flow."""

# 1.5-INT-005: AppState accessible from multiple tabs
def test_app_state_tab_access(qtbot):
    """AppState accessible from multiple tabs."""
```

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on algorithm correctness)
   - 1.5-UNIT-001, 1.5-UNIT-005, 1.5-UNIT-006, 1.5-UNIT-009, 1.5-UNIT-010, 1.5-UNIT-011
2. **P0 Widget tests** (UI correctness)
   - 1.5-WIDG-001
3. **P0 Integration tests** (NFR compliance)
   - 1.5-INT-002
4. **P1 tests** (core functionality)
   - 1.5-UNIT-002, 1.5-UNIT-003, 1.5-UNIT-004, 1.5-UNIT-007, 1.5-UNIT-008, 1.5-UNIT-012
   - 1.5-WIDG-002, 1.5-WIDG-003, 1.5-WIDG-004
   - 1.5-INT-001, 1.5-INT-004
5. **P2 tests** (as time permits)
   - 1.5-UNIT-013, 1.5-UNIT-014
   - 1.5-WIDG-005
   - 1.5-INT-003, 1.5-INT-005

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for logic, widget for UI, integration for flow)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention (1.5-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] Risk mitigations are addressed

## Test Data Requirements

### Unit Tests
- Small synthetic DataFrames (5-10 rows)
- Edge case DataFrames (empty, single row, null values)

### Widget Tests
- No data dependencies (test widget in isolation)

### Integration/Performance Tests
- 100k row synthetic dataset with:
  - ~50 unique tickers
  - ~250 unique dates
  - Realistic time distribution
  - Random gain_pct values

## External Verification

Run after implementation:
- `make lint` - Code style
- `make typecheck` - Type annotations (verifies OPS-001 mitigation)
- `make test` - All tests pass
- `make test -- -m slow` - Performance tests specifically
