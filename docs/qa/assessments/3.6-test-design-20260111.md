# Test Design: Story 3.6

Date: 2026-01-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 6 (33%)
- Widget tests: 9 (50%)
- Integration tests: 3 (17%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 4, P1: 8, P2: 6

**Strategy Rationale:** This story is primarily UI-focused with one algorithmic component (bin calculation). The test pyramid favors unit tests for the algorithm and widget tests for component behavior. No E2E tests needed as this is a display-only feature with no user input or data persistence.

## Test Scenarios by Acceptance Criteria

### AC1: Display winner/loser distribution statistics (count, range, mean, median, std)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.6-WGT-001 | Widget | P0 | DistributionCard displays count value correctly | Core display functionality |
| 3.6-WGT-002 | Widget | P0 | DistributionCard displays range (min to max) correctly | Core display functionality |
| 3.6-WGT-003 | Widget | P1 | DistributionCard displays mean value with % suffix | Display formatting |
| 3.6-WGT-004 | Widget | P1 | DistributionCard displays median value with % suffix | Display formatting |
| 3.6-WGT-005 | Widget | P1 | DistributionCard displays std dev value with % suffix | Display formatting |
| 3.6-WGT-006 | Widget | P0 | DistributionCard.clear() shows em-dash for all values | Empty state handling |
| 3.6-INT-001 | Integration | P1 | PnLStatsTab populates winner card from TradingMetrics | Data flow verification |
| 3.6-INT-002 | Integration | P1 | PnLStatsTab populates loser card from TradingMetrics | Data flow verification |

### AC2: Winner card with plasma-cyan border, loser card with solar-coral border

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.6-WGT-007 | Widget | P0 | Winner card has SIGNAL_CYAN border color | Visual requirement |
| 3.6-WGT-008 | Widget | P1 | Loser card has SIGNAL_CORAL border color | Visual requirement |
| 3.6-WGT-009 | Widget | P2 | Winner card header text says "Winners" | Label correctness |
| 3.6-WGT-010 | Widget | P2 | Loser card header text says "Losers" | Label correctness |

### AC3: "View Histogram" link (histograms in Epic 4)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.6-WGT-011 | Widget | P1 | Clicking View Histogram emits signal | Signal mechanism |
| 3.6-WGT-012 | Widget | P2 | View Histogram link has pointing hand cursor | UX requirement |
| 3.6-INT-003 | Integration | P2 | View Histogram click logs debug message | Placeholder verification |

### AC4: Calculate suggested bin size

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.6-UNIT-001 | Unit | P1 | calculate_suggested_bins returns 5-50 range for normal data | Algorithm correctness |
| 3.6-UNIT-002 | Unit | P1 | calculate_suggested_bins returns 10 for empty list | Edge case handling |
| 3.6-UNIT-003 | Unit | P1 | calculate_suggested_bins returns 10 for single value | Edge case handling |
| 3.6-UNIT-004 | Unit | P0 | calculate_suggested_bins returns 10 for identical values (IQR=0) | Mitigates DATA-001 |
| 3.6-UNIT-005 | Unit | P2 | calculate_suggested_bins respects minimum cap of 5 | Boundary condition |
| 3.6-UNIT-006 | Unit | P2 | calculate_suggested_bins respects maximum cap of 50 | Boundary condition |

## Risk Coverage Mapping

| Risk ID | Test IDs | Coverage |
|---------|----------|----------|
| DATA-001 | 3.6-UNIT-002, 3.6-UNIT-003, 3.6-UNIT-004 | Full |
| DATA-002 | 3.6-WGT-006, 3.6-INT-001, 3.6-INT-002 | Full |
| TECH-001 | 3.6-WGT-011, 3.6-INT-003 | Full |
| TECH-002 | Manual verification (Task 9) | Partial |
| PERF-001 | Not tested (theoretical risk) | Accepted |
| BUS-001 | Manual verification (Task 9) | Partial |

## Detailed Test Specifications

### Unit Tests (tests/unit/test_metrics.py)

```python
class TestCalculateSuggestedBins:
    """Tests for histogram bin size calculation."""

    def test_suggested_bins_normal_data(self):  # 3.6-UNIT-001
        """Normal distribution data gives reasonable bin count."""
        data = list(np.random.normal(5, 2, 100))
        bins = calculate_suggested_bins(data)
        assert 5 <= bins <= 50

    def test_suggested_bins_empty_list(self):  # 3.6-UNIT-002
        """Empty list returns default of 10."""
        bins = calculate_suggested_bins([])
        assert bins == 10

    def test_suggested_bins_single_value(self):  # 3.6-UNIT-003
        """Single value returns default."""
        bins = calculate_suggested_bins([5.0])
        assert bins == 10

    def test_suggested_bins_identical_values(self):  # 3.6-UNIT-004
        """All identical values returns default (IQR=0)."""
        bins = calculate_suggested_bins([5.0, 5.0, 5.0, 5.0])
        assert bins == 10

    def test_suggested_bins_minimum_cap(self):  # 3.6-UNIT-005
        """Result is at least 5."""
        data = [1.0, 1.1]
        bins = calculate_suggested_bins(data)
        assert bins >= 5

    def test_suggested_bins_maximum_cap(self):  # 3.6-UNIT-006
        """Result is at most 50."""
        data = list(range(10000))
        bins = calculate_suggested_bins(data)
        assert bins <= 50
```

### Widget Tests (tests/widget/test_distribution_card.py)

```python
class TestDistributionCard:
    """Widget tests for DistributionCard component."""

    def test_winner_card_has_cyan_border(self, qtbot):  # 3.6-WGT-007
        """Winner card displays with cyan border."""
        card = DistributionCard(DistributionCard.WINNER)
        qtbot.addWidget(card)
        style = card.styleSheet()
        assert Colors.SIGNAL_CYAN in style

    def test_loser_card_has_coral_border(self, qtbot):  # 3.6-WGT-008
        """Loser card displays with coral border."""
        card = DistributionCard(DistributionCard.LOSER)
        qtbot.addWidget(card)
        style = card.styleSheet()
        assert Colors.SIGNAL_CORAL in style

    def test_update_stats_displays_count(self, qtbot):  # 3.6-WGT-001
        """Count value is displayed correctly."""
        card = DistributionCard(DistributionCard.WINNER)
        qtbot.addWidget(card)
        card.update_stats(count=100, min_val=0.5, max_val=25.0,
                         mean=5.5, median=4.2, std=3.1)
        # Assert count displayed
        assert "100" in card._get_display_text()

    def test_update_stats_displays_range(self, qtbot):  # 3.6-WGT-002
        """Range (min to max) is displayed correctly."""
        card = DistributionCard(DistributionCard.WINNER)
        qtbot.addWidget(card)
        card.update_stats(count=100, min_val=0.5, max_val=25.0,
                         mean=5.5, median=4.2, std=3.1)
        # Assert range displayed
        assert "0.50%" in card._get_display_text()
        assert "25.00%" in card._get_display_text()

    def test_clear_shows_em_dash(self, qtbot):  # 3.6-WGT-006
        """Clear method shows em dash for all values."""
        card = DistributionCard(DistributionCard.WINNER)
        qtbot.addWidget(card)
        card.update_stats(count=100, min_val=1.0, max_val=10.0,
                         mean=5.0, median=4.5, std=2.0)
        card.clear()
        # Verify em dash shown
        count_label = card.findChild(QLabel, "countLabel")
        assert count_label.text() == "\u2014"  # em-dash

    def test_view_histogram_signal_emitted(self, qtbot):  # 3.6-WGT-011
        """Clicking View Histogram emits signal."""
        card = DistributionCard(DistributionCard.WINNER)
        qtbot.addWidget(card)
        with qtbot.waitSignal(card.view_histogram_clicked, timeout=1000):
            link = card._histogram_link
            link.mousePressEvent(None)

    def test_view_histogram_link_cursor(self, qtbot):  # 3.6-WGT-012
        """View Histogram link has pointing hand cursor."""
        card = DistributionCard(DistributionCard.WINNER)
        qtbot.addWidget(card)
        assert card._histogram_link.cursor().shape() == Qt.CursorShape.PointingHandCursor
```

### Integration Tests (tests/widget/test_pnl_stats.py)

```python
def test_pnl_stats_tab_has_distribution_cards(qtbot, app_state):  # 3.6-INT-001/002
    """PnLStatsTab contains winner and loser distribution cards."""
    tab = PnLStatsTab(app_state)
    qtbot.addWidget(tab)
    assert hasattr(tab, "_winner_dist_card")
    assert hasattr(tab, "_loser_dist_card")
    assert isinstance(tab._winner_dist_card, DistributionCard)
    assert isinstance(tab._loser_dist_card, DistributionCard)

def test_distribution_cards_update_on_metrics(qtbot, app_state, sample_trades):
    """Distribution cards update when metrics are calculated."""
    tab = PnLStatsTab(app_state)
    qtbot.addWidget(tab)
    app_state.set_data(sample_trades, column_mapping)
    qtbot.waitUntil(lambda: tab._winner_dist_card._count is not None, timeout=2000)
    assert tab._winner_dist_card._count > 0 or tab._loser_dist_card._count > 0
```

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on algorithm)
   - 3.6-UNIT-004 (IQR=0 edge case)

2. **P0 Widget tests** (core display)
   - 3.6-WGT-001, 3.6-WGT-002, 3.6-WGT-006, 3.6-WGT-007

3. **P1 Unit tests**
   - 3.6-UNIT-001, 3.6-UNIT-002, 3.6-UNIT-003

4. **P1 Widget tests**
   - 3.6-WGT-003, 3.6-WGT-004, 3.6-WGT-005, 3.6-WGT-008, 3.6-WGT-011

5. **P1 Integration tests**
   - 3.6-INT-001, 3.6-INT-002

6. **P2 tests** (as time permits)
   - 3.6-UNIT-005, 3.6-UNIT-006, 3.6-WGT-009, 3.6-WGT-010, 3.6-WGT-012, 3.6-INT-003

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent

## Manual Testing Requirements (Task 9)

In addition to automated tests, the following require manual verification:

1. Visual inspection of winner card cyan border appearance
2. Visual inspection of loser card coral border appearance
3. Layout alignment of side-by-side cards
4. "View Histogram" link underline on hover
5. Debug log message appears when link clicked
6. Cards clear properly when no data loaded

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 6
    widget: 9
    integration: 3
    e2e: 0
  by_priority:
    p0: 4
    p1: 8
    p2: 6
  coverage_gaps: []
```

---

Test design matrix: docs/qa/assessments/3.6-test-design-20260111.md
P0 tests identified: 4
