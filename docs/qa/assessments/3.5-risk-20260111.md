# Risk Profile: Story 3.5 - Compounded Kelly Metrics

Date: 2026-01-11
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 8
- Critical Risks: 1
- High Risks: 2
- Risk Score: 63/100 (calculated)

## Critical Risks Requiring Immediate Attention

### 1. DATA-001: Incorrect Kelly Compounding Could Mislead Trading Decisions

**Score: 9 (Critical)**
**Probability**: Medium (2) - Complex algorithm with multiple calculation steps
**Impact**: High (3) - Users rely on Kelly metrics to size positions; incorrect values could lead to significant financial losses

**Mitigation**:
- Implement comprehensive unit tests with manually verified expected values
- Include test data from Dev Notes with known calculations
- Cross-validate against reference implementations
- Add precision assertions to verify numerical accuracy

**Testing Focus**:
- Unit tests for compounding algorithm correctness
- Boundary value tests for edge cases
- Test with known Kelly scenarios from financial literature

## High Risks

### 2. TECH-001: Blown Account Detection Logic Complexity

**Score: 6 (High)**
**Probability**: Medium (2) - Edge case handling across multiple states
**Impact**: High (3) - Failed detection could show misleading equity curve or crash

**Mitigation**:
- Explicit equity <= 0 check at each iteration
- Set remaining equity to 0 and halt processing
- Return "Blown" string indicator clearly
- Unit test specific blown scenarios

### 3. TECH-002: Negative Kelly Handling

**Score: 6 (High)**
**Probability**: Medium (2) - Requires proper flow control to short-circuit calculation
**Impact**: High (3) - Calculating with negative Kelly produces nonsensical results

**Mitigation**:
- Early return with warning when kelly_pct < 0
- Return None for all Kelly metrics
- Clear warning in logs
- UI should gracefully handle None values

## Risk Distribution

### By Category

- Technical (TECH): 3 risks (0 critical, 2 high)
- Data (DATA): 2 risks (1 critical)
- Performance (PERF): 1 risk (medium)
- Business (BUS): 1 risk (low)
- Operational (OPS): 1 risk (medium)

### By Component

- EquityCalculator: 4 risks
- MetricsCalculator: 2 risks
- MetricsGrid UI: 1 risk
- AppState: 1 risk

## Detailed Risk Register

| Risk ID   | Description                                       | Probability | Impact     | Score | Priority |
|-----------|---------------------------------------------------|-------------|------------|-------|----------|
| DATA-001  | Incorrect Kelly compounding misleads users        | Medium (2)  | High (3)   | 6     | Critical |
| TECH-001  | Blown account detection fails                     | Medium (2)  | High (3)   | 6     | High     |
| TECH-002  | Negative Kelly not handled correctly              | Medium (2)  | High (3)   | 6     | High     |
| DATA-002  | Floating point precision in compounding           | Medium (2)  | Medium (2) | 4     | Medium   |
| PERF-001  | Slow calculation for large trade datasets         | Low (1)     | Medium (2) | 2     | Low      |
| OPS-001   | State management with multiple equity curves      | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-003  | 3-tuple return type breaks existing callers       | Medium (2)  | Medium (2) | 4     | Medium   |
| BUS-001   | "Blown" status may alarm/confuse users            | Low (1)     | Low (1)    | 1     | Minimal  |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests (DATA-001)

- Test Kelly compounding with known input/output pairs
- Verify position_size = equity * kelly_fraction * kelly_pct / 100
- Verify trade_pnl = position_size * (gain_pct / 100)
- Test final PnL = final_equity - start_capital
- Use sample data from Dev Notes with expected values

### Priority 2: High Risk Tests (TECH-001, TECH-002)

- Test blown account at various trade positions
- Verify equity set to 0 after blown
- Verify dd_duration = "Blown" when account blows
- Test negative Kelly returns None metrics + warning
- Test negative Kelly early exit (no calculation attempted)

### Priority 3: Medium Risk Tests (DATA-002, OPS-001, TECH-003)

- Test precision with small fractional Kelly values
- Test state updates with kelly_equity_curve signal
- Test MetricsCalculator returns 3-tuple correctly
- Test data_input.py handles new return type

### Priority 4: Low Risk Tests

- Performance test with 100k+ trades (should complete < 200ms)
- Test "Blown" displays appropriately in UI

## Risk Acceptance Criteria

### Must Fix Before Production

- DATA-001: All Kelly calculations must match expected values
- TECH-001: Blown account must be detected and handled
- TECH-002: Negative Kelly must return None/warning

### Can Deploy with Mitigation

- DATA-002: Document precision limitations if any
- OPS-001: Ensure signal/slot connections work

### Accepted Risks

- BUS-001: "Blown" is accurate terminology; documentation will clarify
- PERF-001: Low probability; architecture designed for efficiency

## Monitoring Requirements

Post-deployment monitoring for:
- Error logs for "Account blown" warnings
- Error logs for "Negative Kelly" warnings
- UI rendering of Kelly metrics section
- Recalculation triggers on input changes

## Risk Review Triggers

Review and update risk profile when:
- Kelly calculation formula changes
- New edge cases discovered in testing
- User feedback indicates confusion
- Performance issues reported with large datasets
