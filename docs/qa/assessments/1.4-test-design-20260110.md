# Test Design: Story 1.4 - Column Configuration Panel

Date: 2026-01-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total Test Scenarios:** 35
- **Unit Tests:** 18 (51%)
- **Integration Tests:** 4 (11%)
- **Widget Tests:** 13 (37%)
- **Priority Distribution:** P0: 8, P1: 17, P2: 10

### Test Level Rationale

Story 1.4 has significant **pure logic** (pattern matching, validation) suited for unit tests, **UI behavior** requiring widget tests, and **component interaction** requiring integration tests.

## Test Scenarios by Acceptance Criteria

---

### AC1: Auto-detection for required columns with case-insensitive pattern matching

**Testable Requirements:**
- Pattern matching against predefined patterns
- Case-insensitive matching
- Substring matching

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-UNIT-001 | Unit | P0 | `auto_detect()` returns complete mapping for standard column names | Core business logic | TECH-001 |
| 1.4-UNIT-002 | Unit | P0 | `auto_detect()` is case-insensitive ("TICKER", "Ticker", "ticker") | Core business logic | TECH-001 |
| 1.4-UNIT-003 | Unit | P1 | `auto_detect()` uses substring matching ("my_ticker_col" matches "ticker") | Pattern matching accuracy | TECH-001 |
| 1.4-UNIT-004 | Unit | P1 | `_match_column()` returns first matching column for multiple matches | Deterministic behavior | TECH-001 |
| 1.4-UNIT-005 | Unit | P1 | `auto_detect()` returns status "detected" for exact pattern match | Status accuracy | TECH-001 |
| 1.4-UNIT-006 | Unit | P2 | `auto_detect()` returns status "guessed" for substring match | Status accuracy | BUS-001 |

---

### AC2: Auto-detection for optional Win/Loss column

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-UNIT-007 | Unit | P1 | `auto_detect()` includes win_loss when matching column found | Optional column handling | - |
| 1.4-UNIT-008 | Unit | P1 | `auto_detect()` returns win_loss=None when no matching column | Graceful degradation | - |

---

### AC3: Success summary when all required detected

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-UNIT-009 | Unit | P1 | `DetectionResult.all_required_detected` is True when all required found | Data model correctness | - |
| 1.4-UNIT-010 | Unit | P1 | `DetectionResult.all_required_detected` is False when any missing | Data model correctness | - |
| 1.4-WIDG-001 | Widget | P1 | Success panel displayed when all required columns detected | UI flow correctness | - |
| 1.4-WIDG-002 | Widget | P2 | Success panel shows "Edit Mappings" button | UI completeness | - |

---

### AC4: Blocking configuration panel when missing

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-WIDG-003 | Widget | P0 | Config panel shown when any required column missing | Core workflow | DATA-003 |
| 1.4-WIDG-004 | Widget | P0 | Continue button disabled when required columns missing | Validation enforcement | DATA-003 |

---

### AC5: Column configuration panel with status indicators

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-WIDG-005 | Widget | P1 | Panel has 4 required dropdowns (ticker, date, time, gain) | UI structure | - |
| 1.4-WIDG-006 | Widget | P1 | Panel has optional Win/Loss dropdown | UI structure | - |
| 1.4-WIDG-007 | Widget | P2 | Status indicator shows checkmark (✓) for detected columns | Visual feedback | BUS-001 |
| 1.4-WIDG-008 | Widget | P2 | Status indicator shows warning (⚠) for guessed columns | Visual feedback | BUS-001 |
| 1.4-WIDG-009 | Widget | P2 | Status indicator shows X (✗) for missing columns | Visual feedback | BUS-001 |

---

### AC6: Preview shows first 3 values

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-WIDG-010 | Widget | P2 | Preview label shows values from selected column | User verification | TECH-001 |
| 1.4-WIDG-011 | Widget | P2 | Preview updates when dropdown selection changes | Reactive UI | - |
| 1.4-UNIT-011 | Unit | P2 | Preview truncates to first 3 values | Display logic | - |

---

### AC7: Win/Loss derived from Gain % with breakeven handling

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-WIDG-012 | Widget | P1 | "Derive Win/Loss" checkbox toggles Win/Loss dropdown visibility | State management | TECH-003 |
| 1.4-WIDG-013 | Widget | P1 | Breakeven checkbox visible only when deriving | State management | TECH-003 |
| 1.4-UNIT-012 | Unit | P1 | ColumnMapping.win_loss_derived defaults to False | Data model correctness | - |
| 1.4-UNIT-013 | Unit | P1 | ColumnMapping.breakeven_is_win defaults to False | Data model correctness | - |

---

### AC8: Validation - all required fields mapped, no duplicates

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-UNIT-014 | Unit | P0 | `validate()` returns empty list for valid mapping | Core validation | DATA-003 |
| 1.4-UNIT-015 | Unit | P0 | `validate()` returns error for missing required column | Core validation | DATA-003 |
| 1.4-UNIT-016 | Unit | P0 | `validate()` returns error for invalid win_loss column | Core validation | DATA-003 |
| 1.4-UNIT-017 | Unit | P1 | Duplicate column selection returns validation error | Core validation | DATA-003 |

---

### AC9: Persist mappings to cache

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-UNIT-018 | Unit | P1 | `save_mapping()` creates JSON file in `.lumen_cache/` | Persistence | - |
| 1.4-INT-001 | Integration | P1 | `load_mapping()` retrieves previously saved mapping | Persistence roundtrip | - |
| 1.4-INT-002 | Integration | P1 | `load_mapping()` returns None for non-existent file | Graceful degradation | DATA-001 |
| 1.4-INT-003 | Integration | P2 | `load_mapping()` returns None for corrupted JSON | Error handling | DATA-001 |

---

### AC10: On Continue, store mappings and proceed

| ID | Level | Priority | Test Description | Justification | Mitigates |
|----|-------|----------|------------------|---------------|-----------|
| 1.4-INT-004 | Integration | P1 | Continue click triggers `save_mapping()` and emits signal | Workflow integration | TECH-002 |

---

## Risk Coverage Matrix

| Risk ID | Tests Covering | Coverage Level |
|---------|----------------|----------------|
| TECH-001 | 1.4-UNIT-001 through 006, 1.4-WIDG-010 | Comprehensive |
| TECH-002 | 1.4-INT-004 | Basic |
| TECH-003 | 1.4-WIDG-012, 1.4-WIDG-013 | Adequate |
| DATA-001 | 1.4-INT-002, 1.4-INT-003 | Adequate |
| DATA-002 | 1.4-UNIT-015 (validation catches stale mapping) | Indirect |
| DATA-003 | 1.4-UNIT-014 through 017, 1.4-WIDG-003, 004 | Comprehensive |
| BUS-001 | 1.4-UNIT-006, 1.4-WIDG-007 through 009 | Adequate |

## Recommended Test Execution Order

### Phase 1: P0 Critical Tests (Fail Fast)
1. 1.4-UNIT-001: Auto-detect standard columns
2. 1.4-UNIT-002: Case-insensitive matching
3. 1.4-UNIT-014: Validation success
4. 1.4-UNIT-015: Validation missing column
5. 1.4-UNIT-016: Validation invalid win_loss
6. 1.4-WIDG-003: Config panel shown when missing
7. 1.4-WIDG-004: Continue disabled when invalid

### Phase 2: P1 Core Tests
8-24. All P1 tests in order

### Phase 3: P2 Secondary Tests
25-35. All P2 tests as time permits

## Test File Mapping

| Test File | Tests | Purpose |
|-----------|-------|---------|
| `tests/unit/test_column_mapper.py` | UNIT-001 through 006, 011, 018 | ColumnMapper class |
| `tests/unit/test_models.py` | UNIT-009 through 010, 012-017 | Data models |
| `tests/widget/test_column_config_panel.py` | WIDG-001 through 013 | UI components |
| `tests/integration/test_column_flow.py` | INT-001 through 004 | Component integration |

## Detailed Test Specifications

### Unit Test: 1.4-UNIT-001
```python
def test_auto_detect_standard_columns():
    """Auto-detect returns complete mapping for standard column names."""
    mapper = ColumnMapper()
    columns = ["ticker", "date", "time", "gain_pct"]
    result = mapper.auto_detect(columns)

    assert result.mapping is not None
    assert result.all_required_detected is True
    assert result.mapping.ticker == "ticker"
    assert result.mapping.date == "date"
    assert result.mapping.time == "time"
    assert result.mapping.gain_pct == "gain_pct"
```

### Unit Test: 1.4-UNIT-002
```python
def test_auto_detect_case_insensitive():
    """Auto-detect is case-insensitive."""
    mapper = ColumnMapper()
    columns = ["TICKER", "Date", "TIME", "Gain_Pct"]
    result = mapper.auto_detect(columns)

    assert result.mapping is not None
    assert result.mapping.ticker == "TICKER"
    assert result.mapping.date == "Date"
```

### Unit Test: 1.4-UNIT-014
```python
def test_column_mapping_validate_success():
    """Validate returns empty list for valid columns."""
    mapping = ColumnMapping(
        ticker="ticker", date="date", time="time", gain_pct="gain_pct"
    )
    errors = mapping.validate(["ticker", "date", "time", "gain_pct"])
    assert errors == []
```

### Unit Test: 1.4-UNIT-015
```python
def test_column_mapping_validate_missing():
    """Validate returns errors for missing columns."""
    mapping = ColumnMapping(
        ticker="ticker", date="date", time="time", gain_pct="gain_pct"
    )
    errors = mapping.validate(["ticker", "date"])  # missing time, gain_pct
    assert len(errors) == 2
    assert any("time" in e for e in errors)
    assert any("gain_pct" in e for e in errors)
```

### Widget Test: 1.4-WIDG-003
```python
def test_config_panel_shown_when_missing(qtbot: QtBot):
    """Config panel shown when any required column missing."""
    tab = DataInputTab()
    qtbot.addWidget(tab)

    # Simulate detection with missing column
    detection = DetectionResult(
        mapping=None,
        statuses={"ticker": "detected", "date": "detected", "time": "missing", "gain_pct": "detected"},
        all_required_detected=False
    )
    tab._show_column_result(detection)

    config_panel = tab.findChild(ColumnConfigPanel)
    assert config_panel is not None
    assert config_panel.isVisible()
```

### Widget Test: 1.4-WIDG-012
```python
def test_derive_checkbox_toggles_winloss(qtbot: QtBot):
    """Derive Win/Loss checkbox toggles Win/Loss dropdown visibility."""
    panel = ColumnConfigPanel()
    qtbot.addWidget(panel)

    checkbox = panel.findChild(QCheckBox, "derive_winloss_checkbox")
    winloss_combo = panel.findChild(QComboBox, "winloss_combo")

    # Initially unchecked, combo visible
    assert winloss_combo.isVisible()

    # Check the box, combo hides
    checkbox.setChecked(True)
    assert not winloss_combo.isVisible()

    # Uncheck, combo shows again
    checkbox.setChecked(False)
    assert winloss_combo.isVisible()
```

## Quality Checklist

- [x] Every AC has test coverage (10/10 covered)
- [x] Test levels are appropriate (unit for logic, widget for UI)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention ({epic}.{story}-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent

## Coverage Gaps

None identified - all 10 acceptance criteria have test coverage.

## Notes for Implementation

1. **Widget tests require pytest-qt** - Ensure `qtbot` fixture available
2. **Integration tests may need temp directory** - Use `tmp_path` fixture for cache tests
3. **Story 1.3 dependency** - Integration test 1.4-INT-004 requires Story 1.3's signal to exist
4. **Preview tests need sample DataFrame** - Create fixture with sample data
