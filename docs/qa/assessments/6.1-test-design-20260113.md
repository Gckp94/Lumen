# Test Design: Story 6.1 - Data Binning Tab Foundation

Date: 2026-01-13
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 8 (33%)
- Integration tests: 0 (0%)
- Widget tests: 14 (58%)
- Manual tests: 2 (8%)
- Priority distribution: P0: 4, P1: 12, P2: 8

## Test Level Rationale

This story is UI-focused with minimal business logic. The test distribution reflects:
- **Unit tests**: Time parsing, operator validation, numeric column detection
- **Widget tests**: Tab creation, signal connections, UI interactions (primary focus)
- **Integration tests**: None needed - no external systems or complex data flows
- **Manual tests**: Usability and design compliance checks

## Test Scenarios by Acceptance Criteria

### AC1: Tab appears in main window after "Monte Carlo"

| ID           | Level  | Priority | Test                                      | Justification                          |
|--------------|--------|----------|-------------------------------------------|----------------------------------------|
| 6.1-WIDG-001 | Widget | P0       | DataBinningTab creates without error      | Basic instantiation verification       |
| 6.1-WIDG-002 | Widget | P1       | Tab registered in MainWindow tab bar      | Tab integration point                  |
| 6.1-WIDG-003 | Widget | P1       | Tab position is after Monte Carlo         | Order requirement                      |

#### Test Details

**6.1-WIDG-001: Tab Creation**
```
Given: AppState exists
When: DataBinningTab is instantiated with AppState
Then: No exceptions raised AND widget is valid QWidget
```

**6.1-WIDG-002: Tab Registration**
```
Given: MainWindow is created
When: _setup_tabs() completes
Then: Tab bar contains "Data Binning" tab
```

**6.1-WIDG-003: Tab Position**
```
Given: MainWindow with tabs created
When: Inspecting tab order
Then: "Data Binning" index > "Monte Carlo" index
```

---

### AC2: Column dropdown populated with numeric columns

| ID           | Level  | Priority | Test                                           | Justification                       |
|--------------|--------|----------|------------------------------------------------|-------------------------------------|
| 6.1-UNIT-001 | Unit   | P0       | Numeric column filtering returns correct types | Pure logic, no Qt dependency        |
| 6.1-WIDG-004 | Widget | P1       | Dropdown populated on data_loaded signal       | Signal-UI integration               |
| 6.1-WIDG-005 | Widget | P1       | Dropdown excludes non-numeric columns          | Filter validation                   |
| 6.1-WIDG-006 | Widget | P2       | Dropdown empty state when no data loaded       | Edge case handling                  |

#### Test Details

**6.1-UNIT-001: Numeric Column Filtering**
```
Given: DataFrame with columns [ticker(str), date(datetime), gain_pct(float), volume(int), flag(bool)]
When: Filtering for numeric columns
Then: Returns ['gain_pct', 'volume'] (excludes string, datetime, bool)
```

**6.1-WIDG-004: Dropdown Population**
```
Given: DataBinningTab created with AppState
When: data_loaded signal emitted with sample DataFrame
Then: Column dropdown contains numeric column names
```

**6.1-WIDG-005: Non-Numeric Exclusion**
```
Given: DataFrame with mixed column types
When: data_loaded signal emitted
Then: Dropdown only shows int64, float64, int32, float32 columns
```

**6.1-WIDG-006: Empty State**
```
Given: DataBinningTab created with AppState
When: No data loaded (raw_df is None)
Then: Dropdown is disabled with no items
```

---

### AC3: Bin configuration UI allows adding/removing bins

| ID           | Level  | Priority | Test                                           | Justification                       |
|--------------|--------|----------|------------------------------------------------|-------------------------------------|
| 6.1-WIDG-007 | Widget | P0       | Add Bin button creates new BinConfigRow        | Core functionality                  |
| 6.1-WIDG-008 | Widget | P0       | Remove button deletes user-defined bin row     | Core functionality                  |
| 6.1-WIDG-009 | Widget | P1       | Multiple bins can be added sequentially        | Multi-bin workflow                  |
| 6.1-WIDG-010 | Widget | P2       | UI updates correctly after bin removal         | Visual consistency                  |

#### Test Details

**6.1-WIDG-007: Add Bin**
```
Given: DataBinningTab with bin panel visible
When: "Add Bin" button clicked
Then: New BinConfigRow widget appears in panel
      AND total user-defined bins increased by 1
```

**6.1-WIDG-008: Remove Bin**
```
Given: DataBinningTab with 2 user-defined bins
When: Remove (X) button clicked on first bin
Then: That bin row is removed
      AND remaining bins shift up
      AND total user-defined bins decreased by 1
```

**6.1-WIDG-009: Multiple Adds**
```
Given: DataBinningTab with 0 user-defined bins
When: "Add Bin" clicked 5 times
Then: 5 BinConfigRow widgets exist
      AND each has unique identity
```

**6.1-WIDG-010: UI After Removal**
```
Given: 3 user-defined bins
When: Middle bin removed
Then: Layout has no gaps
      AND remaining bins properly ordered
```

---

### AC4: Bin operators supported (Less than, Greater than, Range)

| ID           | Level  | Priority | Test                                           | Justification                       |
|--------------|--------|----------|------------------------------------------------|-------------------------------------|
| 6.1-UNIT-002 | Unit   | P1       | Less than operator validation                  | Operator logic                      |
| 6.1-UNIT-003 | Unit   | P1       | Greater than operator validation               | Operator logic                      |
| 6.1-UNIT-004 | Unit   | P1       | Range operator validation (min < max)          | Range logic with validation         |
| 6.1-WIDG-011 | Widget | P1       | Operator dropdown shows all three options      | UI completeness                     |
| 6.1-WIDG-012 | Widget | P1       | Range operator shows two value inputs          | Dynamic UI                          |
| 6.1-WIDG-013 | Widget | P2       | Single-value operators show one input          | Dynamic UI                          |

#### Test Details

**6.1-UNIT-002: Less Than Validation**
```
Given: Operator "Less than" with value 100
When: Validating bin definition
Then: Valid bin definition object created
      AND captures values < 100
```

**6.1-UNIT-003: Greater Than Validation**
```
Given: Operator "Greater than" with value 50
When: Validating bin definition
Then: Valid bin definition object created
      AND captures values > 50
```

**6.1-UNIT-004: Range Validation**
```
Given: Operator "Range" with values 10 and 50
When: Validating bin definition
Then: Valid if min <= max
      AND captures values 10 <= x <= 50

Given: Operator "Range" with values 50 and 10 (inverted)
When: Validating bin definition
Then: Either auto-swap OR validation error with message
```

**6.1-WIDG-011: Operator Dropdown**
```
Given: BinConfigRow widget
When: Operator dropdown expanded
Then: Shows "Less than (<)", "Greater than (>)", "Range (X-Y)"
```

**6.1-WIDG-012: Range Two Inputs**
```
Given: BinConfigRow with operator set to "Range"
When: Observing value inputs
Then: Two value fields visible (min, max)
```

**6.1-WIDG-013: Single Value Input**
```
Given: BinConfigRow with operator "Less than" OR "Greater than"
When: Observing value inputs
Then: Single value field visible
```

---

### AC5: Time format parsing (HHMMSS to HH:MM:SS)

| ID           | Level  | Priority | Test                                           | Justification                       |
|--------------|--------|----------|------------------------------------------------|-------------------------------------|
| 6.1-UNIT-005 | Unit   | P1       | Parse 093000 to 09:30:00                       | Happy path parsing                  |
| 6.1-UNIT-006 | Unit   | P1       | Parse edge cases (000000, 235959)              | Boundary values                     |
| 6.1-UNIT-007 | Unit   | P2       | Handle invalid input gracefully                | Error handling                      |
| 6.1-UNIT-008 | Unit   | P2       | Already formatted input passes through         | Idempotent behavior                 |

#### Test Details

**6.1-UNIT-005: Standard Parsing**
```
Given: Input value 93000 (integer)
When: parse_time_input called
Then: Returns "09:30:00"

Given: Input value "093000" (string)
When: parse_time_input called
Then: Returns "09:30:00"
```

**6.1-UNIT-006: Boundary Parsing**
```
Given: Input 0
When: parse_time_input called
Then: Returns "00:00:00"

Given: Input 235959
When: parse_time_input called
Then: Returns "23:59:59"
```

**6.1-UNIT-007: Invalid Input**
```
Given: Input 999999 (invalid time)
When: parse_time_input called
Then: Returns error OR clamps to 23:59:59

Given: Input -1
When: parse_time_input called
Then: Returns error OR handles gracefully
```

**6.1-UNIT-008: Already Formatted**
```
Given: Input "09:30:00" (already formatted)
When: parse_time_input called
Then: Returns "09:30:00" unchanged
```

---

### AC6: Nulls bin automatically included

| ID           | Level  | Priority | Test                                           | Justification                       |
|--------------|--------|----------|------------------------------------------------|-------------------------------------|
| 6.1-WIDG-014 | Widget | P1       | Nulls bin present on panel creation            | Default behavior                    |
| 6.1-WIDG-015 | Widget | P1       | Nulls bin cannot be removed                    | Non-removable requirement           |

#### Test Details

**6.1-WIDG-014: Nulls Bin Present**
```
Given: DataBinningTab created
When: Bin configuration panel initialized
Then: "Nulls" bin row exists
      AND appears in bin list
```

**6.1-WIDG-015: Nulls Non-Removable**
```
Given: Nulls bin row in panel
When: Attempting to remove
Then: No remove button visible on Nulls row
      OR remove button disabled/hidden
```

---

### AC7: UI follows Lumen design language

| ID           | Level  | Priority | Test                                           | Justification                       |
|--------------|--------|----------|------------------------------------------------|-------------------------------------|
| 6.1-MANU-001 | Manual | P2       | Colors match BG_SURFACE, BG_ELEVATED           | Design compliance                   |
| 6.1-MANU-002 | Manual | P2       | Fonts match Fonts.UI, Fonts.DATA               | Design compliance                   |

#### Test Details

**6.1-MANU-001: Color Compliance**
```
Given: DataBinningTab rendered
When: Inspecting visual appearance
Then: Backgrounds use Colors.BG_SURFACE (#141420), Colors.BG_ELEVATED (#1E1E2C)
      AND borders use Colors.BG_BORDER (#2A2A3A)
      AND text uses Colors.TEXT_PRIMARY (#F4F4F8)
```

**6.1-MANU-002: Font Compliance**
```
Given: DataBinningTab rendered
When: Inspecting typography
Then: Labels use Fonts.UI (Geist)
      AND data values use Fonts.DATA (Azeret Mono)
```

---

### AC8: Tab integrates with AppState

| ID           | Level  | Priority | Test                                           | Justification                       |
|--------------|--------|----------|------------------------------------------------|-------------------------------------|
| 6.1-WIDG-016 | Widget | P1       | data_loaded signal triggers column update      | Signal integration                  |
| 6.1-WIDG-017 | Widget | P2       | adjustment_params_changed received             | Signal integration                  |

#### Test Details

**6.1-WIDG-016: data_loaded Integration**
```
Given: DataBinningTab connected to AppState
When: AppState.data_loaded emitted with DataFrame
Then: Column dropdown updates
      AND shows numeric columns from DataFrame
```

**6.1-WIDG-017: adjustment_params_changed**
```
Given: DataBinningTab connected to AppState
When: AppState.adjustment_params_changed emitted
Then: Tab receives signal without error
      (Behavior defined in Story 6.2)
```

---

## Risk Coverage

| Risk ID   | Mitigating Tests                                         |
|-----------|----------------------------------------------------------|
| TECH-001  | 6.1-WIDG-001, 6.1-WIDG-002                               |
| TECH-002  | 6.1-WIDG-016, 6.1-WIDG-017                               |
| TECH-003  | 6.1-WIDG-007, 6.1-WIDG-008, 6.1-WIDG-009, 6.1-WIDG-010   |
| DATA-001  | 6.1-UNIT-005, 6.1-UNIT-006, 6.1-UNIT-007, 6.1-UNIT-008   |
| DATA-002  | 6.1-UNIT-001                                             |
| BUS-001   | 6.1-MANU-001, 6.1-MANU-002                               |
| OPS-001   | All tests                                                |

## Recommended Execution Order

### Phase 1: Foundation (P0 - Fail Fast)
1. 6.1-WIDG-001: Tab creates without error
2. 6.1-UNIT-001: Numeric column filtering
3. 6.1-WIDG-007: Add bin works
4. 6.1-WIDG-008: Remove bin works

### Phase 2: Core Functionality (P1)
5. 6.1-WIDG-002, 6.1-WIDG-003: Tab registration and position
6. 6.1-WIDG-004, 6.1-WIDG-005: Dropdown population
7. 6.1-UNIT-002 through 6.1-UNIT-006: Operator and time parsing
8. 6.1-WIDG-011 through 6.1-WIDG-017: UI interactions and signals

### Phase 3: Completeness (P2)
9. 6.1-WIDG-006, 6.1-WIDG-010, 6.1-WIDG-013: Edge cases
10. 6.1-UNIT-007, 6.1-UNIT-008: Error handling
11. 6.1-MANU-001, 6.1-MANU-002: Design compliance

## Quality Checklist

- [x] Every AC has test coverage (AC1-8 covered)
- [x] Test levels are appropriate (unit for logic, widget for UI)
- [x] No duplicate coverage across levels
- [x] Critical paths have primary coverage (P0 tests)
- [x] Risk mitigations addressed (all 8 risks mapped)
- [x] Test IDs follow naming convention (6.1-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent

## Test File Locations

Per story specification and project conventions:
- Unit tests: `tests/unit/test_bin_config.py`
- Widget tests: `tests/widget/test_data_binning.py`

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 24
  by_level:
    unit: 8
    integration: 0
    widget: 14
    manual: 2
  by_priority:
    p0: 4
    p1: 12
    p2: 8
  coverage_gaps: []
```

---

Test design matrix: docs/qa/assessments/6.1-test-design-20260113.md
P0 tests identified: 4
