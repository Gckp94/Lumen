# Test Design: Story 2.6 - Interactive Chart Controls

Date: 2026-01-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 28
- Unit tests: 14 (50%)
- Widget tests: 11 (39%)
- Integration tests: 2 (7%)
- Performance tests: 1 (4%)
- Priority distribution: P0: 6, P1: 15, P2: 7

## Test Scenarios by Acceptance Criteria

---

### AC 1: Scroll wheel zoom, left-click drag pan, right-click drag zoom selection

**Core functionality**: Three distinct mouse interaction modes for chart navigation.

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.6-UNIT-001 | Unit | P1 | ViewBox mouse enabled on both axes | Configuration verification | - |
| 2.6-UNIT-002 | Unit | P1 | ViewBox wheelScaleFactor configured | Zoom sensitivity setting | - |
| 2.6-UNIT-003 | Unit | P1 | ViewBox mouse mode set to PanMode | Left-drag configuration | - |
| 2.6-WDGT-001 | Widget | P0 | Scroll wheel changes zoom level | Core interaction test | - |
| 2.6-WDGT-002 | Widget | P1 | Scroll wheel zoom centered on cursor | UX requirement | - |
| 2.6-WDGT-003 | Widget | P1 | Left-drag pans view horizontally and vertically | Core interaction test | - |
| 2.6-WDGT-004 | Widget | P0 | Right-drag creates zoom selection rectangle | Core interaction test, high risk | TECH-001 |
| 2.6-WDGT-005 | Widget | P1 | Context menu disabled during right-drag | Prevents conflict | TECH-001 |

---

### AC 2: Double-click to reset view

**Core functionality**: Quick reset to show all data points.

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.6-UNIT-004 | Unit | P2 | Double-click handler exists | Method presence | - |
| 2.6-WDGT-006 | Widget | P1 | Double-click resets view to auto-range | Core interaction test | - |
| 2.6-WDGT-007 | Widget | P2 | Double-click after zoom restores full data view | Edge case verification | - |

---

### AC 3: Crosshair with coordinate display (moon-gray dashed lines)

**Core functionality**: Visual aid for data inspection with coordinate readout.

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.6-UNIT-005 | Unit | P1 | Crosshair vertical line created with dashed style | Style verification | - |
| 2.6-UNIT-006 | Unit | P1 | Crosshair horizontal line created with dashed style | Style verification | - |
| 2.6-UNIT-007 | Unit | P1 | Crosshair uses TEXT_SECONDARY (#9898A8) color | Theme compliance | - |
| 2.6-UNIT-008 | Unit | P1 | Coordinate label format "X: {int}, Y: {float:.2f}" | Output format | TECH-003 |
| 2.6-WDGT-008 | Widget | P1 | Crosshair hidden initially | Initial state | - |
| 2.6-WDGT-009 | Widget | P1 | Crosshair visible when mouse over chart | Visibility toggle | - |
| 2.6-WDGT-010 | Widget | P1 | Crosshair hides when mouse leaves chart | Visibility toggle | - |
| 2.6-WDGT-011 | Widget | P2 | Crosshair position tracks mouse accurately | UX verification | TECH-003, PERF-002 |

---

### AC 4: Axis controls: Y/X min/max inputs, "Auto Fit" button

**Core functionality**: Manual axis range control with auto-fit reset.

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.6-UNIT-009 | Unit | P1 | AxisControlPanel initializes with 4 spin boxes | Component structure | - |
| 2.6-UNIT-010 | Unit | P1 | Auto Fit button emits `auto_fit_clicked` signal | Signal connection | - |
| 2.6-UNIT-011 | Unit | P0 | `set_range()` updates values without emitting signal | Prevents signal loop | TECH-002 |
| 2.6-UNIT-012 | Unit | P1 | Value change emits `range_changed` after 150ms debounce | Debounce behavior | TECH-002 |
| 2.6-WDGT-012 | Widget | P1 | Spin box value change updates after debounce | User interaction | - |
| 2.6-WDGT-013 | Widget | P1 | Auto Fit button click triggers signal | User interaction | - |
| 2.6-INT-001 | Integration | P0 | Panel range change updates chart view | Component integration | TECH-002 |
| 2.6-INT-002 | Integration | P1 | Chart range change updates panel inputs | Bidirectional sync | TECH-002 |

---

### AC 5: "Show Grid" toggle

**Core functionality**: Optional grid overlay for data alignment.

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.6-UNIT-013 | Unit | P2 | `set_grid_visible(True)` sets `_show_grid` to True | State management | - |
| 2.6-UNIT-014 | Unit | P2 | `set_grid_visible(False)` sets `_show_grid` to False | State management | - |
| 2.6-WDGT-014 | Widget | P2 | Grid checkbox toggles grid visibility | User interaction | - |
| 2.6-WDGT-015 | Widget | P2 | Grid off by default | Initial state | - |

---

### AC 6: Pan/zoom at 60fps for 83k points

**Core functionality**: Performance requirement for large datasets.

#### Scenarios

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.6-PERF-001 | Performance | P0 | Chart maintains 60fps during pan with 83k points | Critical NFR | PERF-001, OPS-001 |

---

## Risk Coverage Matrix

| Risk ID | Risk Title | Mitigating Tests |
|---------|------------|------------------|
| PERF-001 | 60fps with 83k points | 2.6-PERF-001 |
| TECH-001 | Right-click context menu conflict | 2.6-WDGT-004, 2.6-WDGT-005 |
| TECH-002 | Bidirectional signal loop | 2.6-UNIT-011, 2.6-UNIT-012, 2.6-INT-001, 2.6-INT-002 |
| TECH-003 | Coordinate mapping accuracy | 2.6-UNIT-008, 2.6-WDGT-011 |
| PERF-002 | Mouse move event overhead | 2.6-WDGT-011 |
| OPS-001 | OpenGL unavailability | 2.6-PERF-001 (documents requirement) |

---

## Test File Mapping

| Test File | Test IDs | Level |
|-----------|----------|-------|
| `tests/unit/test_chart_canvas_crosshair.py` | 2.6-UNIT-005 to 2.6-UNIT-008 | Unit |
| `tests/unit/test_chart_canvas.py` | 2.6-UNIT-001 to 2.6-UNIT-004 | Unit |
| `tests/unit/test_axis_control_panel.py` | 2.6-UNIT-009 to 2.6-UNIT-012 | Unit |
| `tests/unit/test_chart_canvas.py` | 2.6-UNIT-013, 2.6-UNIT-014 | Unit |
| `tests/widget/test_chart_canvas.py` | 2.6-WDGT-001 to 2.6-WDGT-011, 2.6-WDGT-014, 2.6-WDGT-015 | Widget |
| `tests/widget/test_axis_control_panel.py` | 2.6-WDGT-012, 2.6-WDGT-013 | Widget |
| `tests/integration/test_feature_explorer.py` | 2.6-INT-001, 2.6-INT-002 | Integration |
| `tests/integration/test_performance.py` | 2.6-PERF-001 | Performance |

---

## Recommended Execution Order

### Phase 1: P0 Tests (Fail Fast) - 6 tests

1. `2.6-UNIT-011` - set_range() signal blocking (prevents loops)
2. `2.6-WDGT-001` - Scroll wheel zoom
3. `2.6-WDGT-004` - Right-drag zoom selection
4. `2.6-INT-001` - Panel-chart integration
5. `2.6-PERF-001` - 60fps performance

### Phase 2: P1 Tests (Core Functionality) - 15 tests

1. Unit tests: 2.6-UNIT-001 to 2.6-UNIT-010, 2.6-UNIT-012
2. Widget tests: 2.6-WDGT-002, 2.6-WDGT-003, 2.6-WDGT-005 to 2.6-WDGT-013
3. Integration test: 2.6-INT-002

### Phase 3: P2 Tests (Secondary Validation) - 7 tests

1. 2.6-UNIT-004, 2.6-UNIT-013, 2.6-UNIT-014
2. 2.6-WDGT-007, 2.6-WDGT-011, 2.6-WDGT-014, 2.6-WDGT-015

---

## Test Implementation Notes

### Widget Test Setup

```python
@pytest.fixture
def chart_with_data(qtbot, sample_trades):
    """Chart canvas with sample data loaded."""
    canvas = ChartCanvas()
    qtbot.addWidget(canvas)
    canvas.update_data(sample_trades, "gain_pct")
    return canvas
```

### Performance Test Mark

```python
@pytest.mark.slow
def test_chart_pan_zoom_60fps(large_dataset_path):
    """Mark slow tests for selective execution."""
    ...
```

### Signal Testing Pattern

```python
def test_signal_not_emitted_on_set_range(qtbot):
    """Use signal spy to verify no emission."""
    panel = AxisControlPanel()
    qtbot.addWidget(panel)

    signals_received = []
    panel.range_changed.connect(lambda *args: signals_received.append(args))

    panel.set_range(0, 100, -10, 10)
    qtbot.wait(200)  # Wait past debounce

    assert len(signals_received) == 0
```

---

## Quality Checklist

- [x] Every AC has test coverage (AC1: 8, AC2: 3, AC3: 8, AC4: 8, AC5: 4, AC6: 1)
- [x] Test levels are appropriate (unit for logic, widget for interactions)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (P0 for NFRs and high-risk items)
- [x] Test IDs follow naming convention ({epic}.{story}-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] All identified risks have mitigating tests

---

## Coverage Gaps

None identified. All 6 acceptance criteria have comprehensive test coverage.

---

## Test Data Requirements

| Test Category | Data Requirement |
|---------------|------------------|
| Unit tests | No external data (isolated components) |
| Widget tests | `sample_trades` fixture (100-1000 rows) |
| Integration tests | `sample_trades` fixture |
| Performance tests | `large_dataset` fixture (83,000+ rows) |
