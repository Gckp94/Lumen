# Test Design: Story 4.2

Date: 2026-01-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 8 (44%)
- Widget tests: 7 (39%)
- Integration tests: 3 (17%)
- Priority distribution: P0: 0, P1: 12, P2: 6

**Rationale**: This is a UI display component with no revenue-critical, security, or compliance implications. All tests are P1 (core user journey) or P2 (secondary features). Delta calculation correctness is P1 as it affects user decision-making.

## Test Scenarios by Acceptance Criteria

### AC1: Fixed ribbon at top of PnL Stats tab

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-INT-001 | Integration | P1 | Ribbon positioned at top of PnL Stats layout | Multi-component integration, layout order critical |
| 4.2-WIDGET-001 | Widget | P2 | ComparisonRibbon renders as QFrame with correct height | Component instantiation verification |

### AC2: Display 4 metrics: Trades, Win Rate, EV, Kelly

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-UNIT-001 | Unit | P1 | METRICS constant contains ["trades", "win_rate", "ev", "kelly"] | Configuration verification, pure constant check |
| 4.2-WIDGET-002 | Widget | P1 | Ribbon contains 4 RibbonCard widgets | Component structure verification |
| 4.2-WIDGET-003 | Widget | P1 | Each card displays correct metric label | UI display correctness |

### AC3: Large filtered value, delta indicator, baseline reference

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-WIDGET-004 | Widget | P1 | RibbonCard.update() displays filtered value prominently | Core display functionality |
| 4.2-WIDGET-005 | Widget | P1 | Delta indicator shows arrow (up/down) with formatted value | Visual feedback accuracy |
| 4.2-WIDGET-006 | Widget | P1 | Baseline reference shows "Baseline: X.XX" format | Reference value display |

### AC4: Delta colors: plasma-cyan (improvement), solar-coral (decline), moon-gray (neutral)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-UNIT-002 | Unit | P1 | Positive delta returns SIGNAL_CYAN color | Color mapping logic - isolated test |
| 4.2-UNIT-003 | Unit | P1 | Negative delta returns SIGNAL_CORAL color | Color mapping logic - isolated test |
| 4.2-UNIT-004 | Unit | P1 | Zero delta returns TEXT_SECONDARY color | Color mapping logic - isolated test |
| 4.2-WIDGET-007 | Widget | P2 | Delta indicator widget applies correct color to text | Color rendering verification |

### AC5: Empty state: "no filter applied"

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-UNIT-005 | Unit | P2 | clear() method resets card internal state | Pure state management |
| 4.2-WIDGET-008 | Widget | P2 | Empty state displays "dash" with "(no filter applied)" | UI state verification |

### AC6: Validation verify calculation logic

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-UNIT-006 | Unit | P1 | _calculate_delta for trades returns absolute difference | Core calculation logic |
| 4.2-UNIT-007 | Unit | P1 | _calculate_delta for win_rate returns pp difference | Core calculation logic |
| 4.2-UNIT-008 | Unit | P1 | _calculate_delta handles None values gracefully | Edge case handling |

### Signal Integration (Cross-cutting)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-INT-002 | Integration | P1 | metrics_updated signal triggers ribbon update | Signal/slot flow verification |
| 4.2-INT-003 | Integration | P1 | Ribbon clears when filtered_metrics is None | State transition through signal |

## Risk Coverage

| Risk ID | Score | Mitigating Tests |
|---------|-------|------------------|
| DATA-001 | 4 | 4.2-UNIT-006, 4.2-UNIT-007, 4.2-UNIT-008 |
| DATA-002 | 2 | 4.2-UNIT-008, 4.2-WIDGET-008, 4.2-INT-003 |
| BUS-001 | 2 | 4.2-UNIT-002, 4.2-UNIT-003, 4.2-UNIT-004, 4.2-WIDGET-007 |
| TECH-001 | 1 | 4.2-INT-001, Manual verification |
| PERF-001 | 1 | Manual verification during Task 11 |
| OPS-001 | 1 | Code review |

## Detailed Test Specifications

### Unit Tests (tests/unit/test_comparison_ribbon.py)

```python
# 4.2-UNIT-001: METRICS constant verification
def test_metrics_constant_contains_required_metrics():
    """Verify METRICS = ['trades', 'win_rate', 'ev', 'kelly']"""
    assert ComparisonRibbon.METRICS == ["trades", "win_rate", "ev", "kelly"]

# 4.2-UNIT-002: Positive delta color
def test_calculate_delta_positive_returns_cyan():
    """Positive delta should return SIGNAL_CYAN for improvement"""
    # filtered > baseline for any metric
    delta, color = _calculate_delta(filtered=100, baseline=80, metric="trades")
    assert delta == 20
    assert color == Colors.SIGNAL_CYAN

# 4.2-UNIT-003: Negative delta color
def test_calculate_delta_negative_returns_coral():
    """Negative delta should return SIGNAL_CORAL for decline"""
    delta, color = _calculate_delta(filtered=80, baseline=100, metric="trades")
    assert delta == -20
    assert color == Colors.SIGNAL_CORAL

# 4.2-UNIT-004: Zero delta color
def test_calculate_delta_zero_returns_secondary():
    """Zero delta should return TEXT_SECONDARY for neutral"""
    delta, color = _calculate_delta(filtered=100, baseline=100, metric="trades")
    assert delta == 0
    assert color == Colors.TEXT_SECONDARY

# 4.2-UNIT-005: Clear state
def test_ribbon_card_clear_resets_state():
    """clear() should reset internal state to empty values"""
    card = RibbonCard("trades")
    card.update(filtered_value=100, baseline_value=80, format_spec=",d")
    card.clear()
    # Verify internal state reset

# 4.2-UNIT-006: Trades delta calculation
def test_calculate_delta_trades_absolute():
    """Trades delta = filtered - baseline (absolute difference)"""
    delta, _ = _calculate_delta(filtered=150, baseline=100, metric="trades")
    assert delta == 50  # absolute, not percentage

# 4.2-UNIT-007: Win rate delta calculation
def test_calculate_delta_win_rate_percentage_points():
    """Win rate delta in percentage points"""
    delta, _ = _calculate_delta(filtered=0.70, baseline=0.65, metric="win_rate")
    assert delta == 0.05  # 5 percentage points

# 4.2-UNIT-008: None handling
def test_calculate_delta_handles_none():
    """Delta calculation handles None values gracefully"""
    delta, color = _calculate_delta(filtered=None, baseline=100, metric="trades")
    assert delta is None or delta == 0
    assert color == Colors.TEXT_SECONDARY
```

### Widget Tests (tests/widget/test_comparison_ribbon.py)

```python
# 4.2-WIDGET-001: Component instantiation
def test_comparison_ribbon_creates_qframe(qtbot):
    """ComparisonRibbon is a QFrame with BG_ELEVATED background"""
    ribbon = ComparisonRibbon()
    qtbot.addWidget(ribbon)
    assert isinstance(ribbon, QFrame)

# 4.2-WIDGET-002: Contains 4 cards
def test_ribbon_contains_four_cards(qtbot):
    """Ribbon should have 4 RibbonCard child widgets"""
    ribbon = ComparisonRibbon()
    qtbot.addWidget(ribbon)
    cards = ribbon.findChildren(RibbonCard)
    assert len(cards) == 4

# 4.2-WIDGET-003: Card labels
def test_ribbon_cards_display_correct_labels(qtbot):
    """Each card shows its metric label"""
    ribbon = ComparisonRibbon()
    qtbot.addWidget(ribbon)
    labels = [card.metric_label.text() for card in ribbon._cards]
    assert "Trades" in labels or "trades" in [l.lower() for l in labels]

# 4.2-WIDGET-004: Update displays filtered value
def test_ribbon_update_shows_filtered_values(qtbot):
    """update() displays filtered values in cards"""
    ribbon = ComparisonRibbon()
    qtbot.addWidget(ribbon)
    baseline = TradingMetrics(num_trades=100, win_rate=0.60, ev=0.02, kelly=0.10)
    filtered = TradingMetrics(num_trades=150, win_rate=0.65, ev=0.03, kelly=0.12)
    ribbon.update(baseline, filtered)
    # Verify filtered values displayed

# 4.2-WIDGET-005: Delta indicator format
def test_ribbon_shows_delta_with_arrow(qtbot):
    """Delta shows arrow indicator (up/down) with value"""
    ribbon = ComparisonRibbon()
    qtbot.addWidget(ribbon)
    # Test that delta text contains arrow characters

# 4.2-WIDGET-006: Baseline reference
def test_ribbon_shows_baseline_reference(qtbot):
    """Baseline reference displayed below delta"""
    ribbon = ComparisonRibbon()
    qtbot.addWidget(ribbon)
    # Verify "Baseline:" text present

# 4.2-WIDGET-007: Color application
def test_ribbon_delta_applies_semantic_colors(qtbot):
    """Delta indicator text has correct color applied"""
    ribbon = ComparisonRibbon()
    qtbot.addWidget(ribbon)
    # Verify stylesheet or palette contains expected colors

# 4.2-WIDGET-008: Empty state display
def test_ribbon_clear_shows_empty_state(qtbot):
    """clear() shows dash with 'no filter applied' text"""
    ribbon = ComparisonRibbon()
    qtbot.addWidget(ribbon)
    ribbon.clear()
    # Verify "â€”" and "(no filter applied)" visible
```

### Integration Tests (tests/integration/test_filter_workflow.py)

```python
# 4.2-INT-001: Layout position
def test_ribbon_at_top_of_pnl_stats_tab(qtbot, app_state):
    """ComparisonRibbon is first widget in PnL Stats layout"""
    tab = PnLStatsTab(app_state)
    qtbot.addWidget(tab)
    # Verify ribbon is at index 0 or 1 (after section header)

# 4.2-INT-002: Signal triggers update
def test_metrics_updated_signal_triggers_ribbon_update(qtbot, app_state):
    """metrics_updated signal causes ribbon to update"""
    tab = PnLStatsTab(app_state)
    qtbot.addWidget(tab)
    baseline = TradingMetrics(num_trades=100, win_rate=0.60, ev=0.02, kelly=0.10)
    filtered = TradingMetrics(num_trades=150, win_rate=0.65, ev=0.03, kelly=0.12)

    with qtbot.waitSignal(app_state.metrics_updated, timeout=1000):
        app_state.metrics_updated.emit(baseline, filtered)

    # Verify ribbon displays updated values

# 4.2-INT-003: Clear on None filtered
def test_ribbon_clears_when_no_filtered_metrics(qtbot, app_state):
    """Ribbon shows empty state when filtered_metrics is None"""
    tab = PnLStatsTab(app_state)
    qtbot.addWidget(tab)

    app_state.metrics_updated.emit(baseline, None)

    # Verify ribbon shows empty state
```

## Recommended Execution Order

1. **P1 Unit tests** (4.2-UNIT-001 through 4.2-UNIT-007) - Fail fast on calculation errors
2. **P1 Widget tests** (4.2-WIDGET-002 through 4.2-WIDGET-006) - Verify component behavior
3. **P1 Integration tests** (4.2-INT-001 through 4.2-INT-003) - Validate signal flow
4. **P2 Unit tests** (4.2-UNIT-005, 4.2-UNIT-008) - Edge cases
5. **P2 Widget tests** (4.2-WIDGET-001, 4.2-WIDGET-007, 4.2-WIDGET-008) - Polish

## Coverage Gaps

None identified. All 6 acceptance criteria have test coverage:

| AC | Tests Covering |
|----|----------------|
| AC1 | 4.2-INT-001, 4.2-WIDGET-001 |
| AC2 | 4.2-UNIT-001, 4.2-WIDGET-002, 4.2-WIDGET-003 |
| AC3 | 4.2-WIDGET-004, 4.2-WIDGET-005, 4.2-WIDGET-006 |
| AC4 | 4.2-UNIT-002, 4.2-UNIT-003, 4.2-UNIT-004, 4.2-WIDGET-007 |
| AC5 | 4.2-UNIT-005, 4.2-WIDGET-008 |
| AC6 | 4.2-UNIT-006, 4.2-UNIT-007, 4.2-UNIT-008 |

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
