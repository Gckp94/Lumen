# Test Design: Story 1.7 - Parquet Caching

Date: 2026-01-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

| Metric               | Count | Percentage |
|----------------------|-------|------------|
| **Total scenarios**  | 18    | 100%       |
| Unit tests           | 12    | 67%        |
| Integration tests    | 4     | 22%        |
| E2E tests            | 0     | 0%         |
| Performance tests    | 2     | 11%        |

| Priority | Count |
|----------|-------|
| P0       | 4     |
| P1       | 10    |
| P2       | 4     |

**Rationale:** This story is primarily about backend caching logic with minimal UI impact. The test pyramid heavily favors unit tests for the CacheManager class, with integration tests validating the FileLoadWorker integration. No E2E tests are required as the feature is invisible to users except for a status message.

---

## Test Scenarios by Acceptance Criteria

### AC1: Save DataFrame to `.lumen_cache/` as Parquet

| ID           | Level | Priority | Test                                | Justification                      | Risk Mitigated |
|--------------|-------|----------|-------------------------------------|------------------------------------|----------------|
| 1.7-UNIT-001 | Unit  | P1       | save_to_cache() creates Parquet file | Pure file write operation          | -              |
| 1.7-UNIT-002 | Unit  | P1       | save_to_cache() overwrites existing  | Ensures cache update works         | -              |
| 1.7-UNIT-003 | Unit  | P2       | Cache directory created on init      | Verifies setup behavior            | TECH-002       |

---

### AC2: Filename is MD5 hash of file path + sheet name

| ID           | Level | Priority | Test                                     | Justification                    | Risk Mitigated |
|--------------|-------|----------|------------------------------------------|----------------------------------|----------------|
| 1.7-UNIT-004 | Unit  | P1       | _get_cache_key() consistent hash         | Same input → same output         | -              |
| 1.7-UNIT-005 | Unit  | P1       | _get_cache_key() differs for sheets      | Different sheets → different keys | TECH-001       |
| 1.7-UNIT-006 | Unit  | P2       | _get_cache_key() differs for files       | Different files → different keys | TECH-001       |

---

### AC3: Check for valid cache (exists and newer than source)

| ID           | Level | Priority | Test                                       | Justification                      | Risk Mitigated |
|--------------|-------|----------|--------------------------------------------|------------------------------------|----------------|
| 1.7-UNIT-007 | Unit  | P0       | is_cache_valid() False when no cache       | Core validation logic              | -              |
| 1.7-UNIT-008 | Unit  | P0       | is_cache_valid() False when source newer   | Invalidation is critical           | DATA-002       |
| 1.7-UNIT-009 | Unit  | P0       | is_cache_valid() True when cache newer     | Cache hit detection                | -              |
| 1.7-INT-001  | Int   | P1       | Source modification invalidates cache      | Tests mtime comparison in workflow | DATA-002       |

---

### AC4: Cache hit loads from Parquet, shows message

| ID           | Level | Priority | Test                                    | Justification                        | Risk Mitigated |
|--------------|-------|----------|----------------------------------------|--------------------------------------|----------------|
| 1.7-UNIT-010 | Unit  | P1       | get_cached() returns DataFrame         | Core cache retrieval                 | -              |
| 1.7-INT-002  | Int   | P1       | cache_hit signal emitted on cache hit  | UI integration point                 | -              |

---

### AC5: Cache miss loads from source, saves to cache

| ID           | Level | Priority | Test                                    | Justification                        | Risk Mitigated |
|--------------|-------|----------|----------------------------------------|--------------------------------------|----------------|
| 1.7-UNIT-011 | Unit  | P1       | get_cached() returns None when invalid | Triggers source load path            | -              |
| 1.7-INT-003  | Int   | P0       | First load creates cache               | End-to-end cache creation            | -              |
| 1.7-INT-004  | Int   | P1       | Second load uses cache                 | Validates full cache workflow        | -              |

---

### AC6: Performance - cache load < 500ms

| ID           | Level | Priority | Test                                    | Justification                        | Risk Mitigated |
|--------------|-------|----------|----------------------------------------|--------------------------------------|----------------|
| 1.7-PERF-001 | Perf  | P1       | Cache load < 500ms for 100k rows       | Explicit performance requirement     | PERF-002       |
| 1.7-PERF-002 | Perf  | P2       | Cache save < 1s for 100k rows          | Non-blocking save requirement        | PERF-001       |

---

### AC7: Handle corrupt cache by deleting and reloading

| ID           | Level | Priority | Test                                    | Justification                        | Risk Mitigated |
|--------------|-------|----------|----------------------------------------|--------------------------------------|----------------|
| 1.7-UNIT-012 | Unit  | P0       | get_cached() handles corrupt file      | Critical fallback behavior           | DATA-001       |

---

### AC8: Cache excluded from git

| ID           | Level | Priority | Test                                    | Justification                        | Risk Mitigated |
|--------------|-------|----------|----------------------------------------|--------------------------------------|----------------|
| -            | Manual| P2       | Verify .gitignore contains entry       | Static config check, not automated   | -              |

---

## Risk Coverage Matrix

| Risk ID   | Risk Title                          | Test Coverage                           |
|-----------|-------------------------------------|-----------------------------------------|
| DATA-001  | Cache corruption undetected         | 1.7-UNIT-012                            |
| DATA-002  | Cache-source timing race condition  | 1.7-UNIT-008, 1.7-INT-001               |
| PERF-001  | Cache save blocking UI thread       | 1.7-PERF-002                            |
| PERF-002  | Cache load exceeds 500ms target     | 1.7-PERF-001                            |
| TECH-001  | MD5 hash collision                  | 1.7-UNIT-005, 1.7-UNIT-006              |
| TECH-002  | Cache directory creation failure    | 1.7-UNIT-003                            |
| OPS-001   | Unbounded cache growth              | Manual monitoring (no automated test)   |

---

## Test Implementation Details

### Unit Tests: `tests/unit/test_cache_manager.py`

```python
# Test Structure
class TestCacheKey:
    def test_consistent_hash(tmp_path): ...           # 1.7-UNIT-004
    def test_differs_for_sheets(tmp_path): ...        # 1.7-UNIT-005
    def test_differs_for_files(tmp_path): ...         # 1.7-UNIT-006

class TestCacheValidity:
    def test_false_when_no_cache(tmp_path): ...       # 1.7-UNIT-007
    def test_false_when_source_newer(tmp_path): ...   # 1.7-UNIT-008
    def test_true_when_cache_newer(tmp_path): ...     # 1.7-UNIT-009

class TestCacheOperations:
    def test_get_returns_dataframe(tmp_path): ...     # 1.7-UNIT-010
    def test_get_returns_none_invalid(tmp_path): ...  # 1.7-UNIT-011
    def test_get_handles_corrupt(tmp_path): ...       # 1.7-UNIT-012
    def test_save_creates_file(tmp_path): ...         # 1.7-UNIT-001
    def test_save_overwrites_existing(tmp_path): ...  # 1.7-UNIT-002
    def test_directory_created_on_init(tmp_path): ... # 1.7-UNIT-003

class TestPerformance:
    @pytest.mark.slow
    def test_load_under_500ms(tmp_path): ...          # 1.7-PERF-001
    @pytest.mark.slow
    def test_save_under_1s(tmp_path): ...             # 1.7-PERF-002
```

### Integration Tests: `tests/integration/test_file_load_workflow.py`

```python
class TestCacheWorkflow:
    def test_first_load_creates_cache(): ...          # 1.7-INT-003
    def test_second_load_uses_cache(): ...            # 1.7-INT-004
    def test_source_modification_invalidates(): ...   # 1.7-INT-001
    def test_cache_hit_signal_emitted(): ...          # 1.7-INT-002
```

---

## Recommended Execution Order

1. **P0 Unit Tests** (fail fast on core logic):
   - 1.7-UNIT-007: is_cache_valid() False when no cache
   - 1.7-UNIT-008: is_cache_valid() False when source newer
   - 1.7-UNIT-009: is_cache_valid() True when cache newer
   - 1.7-UNIT-012: get_cached() handles corrupt file

2. **P0 Integration Tests**:
   - 1.7-INT-003: First load creates cache

3. **P1 Unit Tests**:
   - All remaining unit tests

4. **P1 Integration/Performance Tests**:
   - 1.7-INT-001, 1.7-INT-002, 1.7-INT-004
   - 1.7-PERF-001 (marked @slow)

5. **P2 Tests** (as time permits):
   - 1.7-UNIT-003, 1.7-UNIT-006, 1.7-PERF-002

---

## Manual Verification Checklist

Per Task 9 in the story, these manual verifications complement automated tests:

- [ ] Load Excel file → verify cache file created in `.lumen_cache/`
- [ ] Close/reopen app, load same file → verify "Loaded from cache" message
- [ ] Modify source Excel → reload → verify loads from source (cache invalidated)
- [ ] Manually corrupt .parquet file → reload → verify graceful fallback
- [ ] Verify `.gitignore` contains `.lumen_cache/` entry

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (67% unit, shift-left)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention (1.7-LEVEL-SEQ)
- [x] Scenarios are atomic and independent
- [x] All identified risks have test coverage

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 12
    integration: 4
    e2e: 0
    performance: 2
  by_priority:
    p0: 4
    p1: 10
    p2: 4
  coverage_gaps: []
```

---

Test design matrix: docs/qa/assessments/1.7-test-design-20260110.md
P0 tests identified: 4
