# Test Design: Story 3.5 - Compounded Kelly Metrics

Date: 2026-01-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 32
- Unit tests: 20 (63%)
- Integration tests: 6 (19%)
- Widget tests: 6 (19%)
- Priority distribution: P0: 12, P1: 14, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: Calculate Compounded Kelly PnL, Max DD ($), Max DD (%), DD Duration

#### Unit Tests - EquityCalculator.calculate_kelly()

| ID           | Level | Priority | Test                                      | Justification                                    |
|--------------|-------|----------|-------------------------------------------|--------------------------------------------------|
| 3.5-UNIT-001 | Unit  | P0       | Basic Kelly equity curve calculation      | Core algorithm correctness                       |
| 3.5-UNIT-002 | Unit  | P0       | Kelly compounding verifies equity grows   | Validate compounding formula                     |
| 3.5-UNIT-003 | Unit  | P0       | Position size = equity * fraction * pct   | Position sizing accuracy                         |
| 3.5-UNIT-004 | Unit  | P0       | Trade PnL = position_size * gain_pct/100  | Trade calculation accuracy                       |
| 3.5-UNIT-005 | Unit  | P1       | Empty DataFrame returns empty result      | Edge case - no trades                            |
| 3.5-UNIT-006 | Unit  | P1       | Single trade produces correct result      | Edge case - minimum trades                       |
| 3.5-UNIT-007 | Unit  | P1       | Peak tracking updates correctly           | Drawdown calculation prerequisite                |
| 3.5-UNIT-008 | Unit  | P1       | Drawdown calculated from peak             | Drawdown accuracy                                |

#### Unit Tests - EquityCalculator.calculate_kelly_metrics()

| ID           | Level | Priority | Test                                      | Justification                                    |
|--------------|-------|----------|-------------------------------------------|--------------------------------------------------|
| 3.5-UNIT-009 | Unit  | P0       | Kelly PnL = final_equity - start_capital  | Financial accuracy                               |
| 3.5-UNIT-010 | Unit  | P0       | Max DD ($) returns correct dollar amount  | Drawdown metric accuracy                         |
| 3.5-UNIT-011 | Unit  | P0       | Max DD (%) = max_dd / peak * 100          | Percentage calculation                           |
| 3.5-UNIT-012 | Unit  | P1       | DD Duration returns int days when recovered| Recovery tracking                                |
| 3.5-UNIT-013 | Unit  | P1       | DD Duration returns "Not recovered" string | Non-recovery state                               |

#### Unit Tests - TradingMetrics Model

| ID           | Level | Priority | Test                                      | Justification                                    |
|--------------|-------|----------|-------------------------------------------|--------------------------------------------------|
| 3.5-UNIT-014 | Unit  | P1       | TradingMetrics has kelly_pnl field        | Model structure                                  |
| 3.5-UNIT-015 | Unit  | P1       | TradingMetrics has kelly_max_dd field     | Model structure                                  |
| 3.5-UNIT-016 | Unit  | P1       | TradingMetrics has kelly_max_dd_pct field | Model structure                                  |
| 3.5-UNIT-017 | Unit  | P1       | TradingMetrics has kelly_dd_duration field| Model structure                                  |
| 3.5-UNIT-018 | Unit  | P2       | TradingMetrics.empty() includes Kelly None| Default state                                    |

---

### AC2: Reuse Equity Module from Story 3.4

| ID           | Level       | Priority | Test                                      | Justification                                    |
|--------------|-------------|----------|-------------------------------------------|--------------------------------------------------|
| 3.5-INT-001  | Integration | P1       | calculate_kelly chains to calculate_drawdown_metrics | Module reuse verification               |
| 3.5-INT-002  | Integration | P2       | Kelly uses same EquityCalculator instance | Architecture compliance                          |

---

### AC3: Handle Negative Kelly (warning), Blown Account

#### Unit Tests - Negative Kelly

| ID           | Level | Priority | Test                                      | Justification                                    |
|--------------|-------|----------|-------------------------------------------|--------------------------------------------------|
| 3.5-UNIT-019 | Unit  | P0       | Negative Kelly returns None for all metrics| Critical guard                                   |
| 3.5-UNIT-020 | Unit  | P0       | Negative Kelly returns warning flag       | Warning propagation                              |
| 3.5-UNIT-021 | Unit  | P1       | Negative Kelly logs warning message       | Observability                                    |

#### Unit Tests - Blown Account

| ID           | Level | Priority | Test                                      | Justification                                    |
|--------------|-------|----------|-------------------------------------------|--------------------------------------------------|
| 3.5-UNIT-022 | Unit  | P0       | Equity <= 0 sets dd_duration to "Blown"   | Blown detection                                  |
| 3.5-UNIT-023 | Unit  | P0       | Blown account sets remaining equity to 0  | State correctness after blown                    |
| 3.5-UNIT-024 | Unit  | P1       | Blown account stops processing trades     | No calculations after blown                      |
| 3.5-UNIT-025 | Unit  | P1       | Blown account logs warning with trade #   | Observability                                    |

---

### AC4: Store Equity Curve for Charts

| ID           | Level       | Priority | Test                                      | Justification                                    |
|--------------|-------------|----------|-------------------------------------------|--------------------------------------------------|
| 3.5-INT-003  | Integration | P1       | MetricsCalculator returns 3-tuple         | API contract                                     |
| 3.5-INT-004  | Integration | P1       | Kelly equity curve stored in AppState     | State management                                 |
| 3.5-INT-005  | Integration | P2       | kelly_equity_curve_updated signal emits   | Signal propagation                               |
| 3.5-UNIT-026 | Unit        | P2       | Kelly equity curve has required columns   | DataFrame structure                              |

---

### AC5: Recalculate on start_capital or fractional_kelly Change

| ID           | Level       | Priority | Test                                      | Justification                                    |
|--------------|-------------|----------|-------------------------------------------|--------------------------------------------------|
| 3.5-INT-006  | Integration | P1       | Parameter change triggers recalculation   | Reactivity                                       |
| 3.5-WIDG-001 | Widget      | P2       | start_capital change updates Kelly metrics| UI reactivity                                    |
| 3.5-WIDG-002 | Widget      | P2       | fractional_kelly change updates metrics   | UI reactivity                                    |

---

### Widget Tests - MetricsGrid Display

| ID           | Level  | Priority | Test                                       | Justification                                    |
|--------------|--------|----------|--------------------------------------------|--------------------------------------------------|
| 3.5-WIDG-003 | Widget | P1       | MetricsGrid displays Kelly PnL             | UI renders metric                                |
| 3.5-WIDG-004 | Widget | P1       | Kelly DD Duration shows "X days" format    | Display formatting                               |
| 3.5-WIDG-005 | Widget | P1       | "Not recovered" displays in coral color    | Visual indicator                                 |
| 3.5-WIDG-006 | Widget | P1       | "Blown" displays in coral color            | Visual indicator                                 |

---

## Risk Coverage

| Risk ID   | Risk Description                          | Mitigating Tests                                |
|-----------|-------------------------------------------|------------------------------------------------|
| DATA-001  | Incorrect Kelly compounding               | 3.5-UNIT-001 through 013                       |
| TECH-001  | Blown account detection fails             | 3.5-UNIT-022 through 025                       |
| TECH-002  | Negative Kelly not handled                | 3.5-UNIT-019 through 021                       |
| DATA-002  | Floating point precision                  | 3.5-UNIT-002, 003, 009                         |
| OPS-001   | State management complexity               | 3.5-INT-004, 005                               |
| TECH-003  | 3-tuple return breaks callers             | 3.5-INT-003                                    |

---

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on critical logic)
   - 3.5-UNIT-001 through 004, 009-011, 019-020, 022-023
2. **P1 Unit tests** (core functionality)
   - 3.5-UNIT-005 through 008, 012-017, 021, 024-025
3. **P1 Integration tests**
   - 3.5-INT-001, 003-004, 006
4. **P1 Widget tests**
   - 3.5-WIDG-003 through 006
5. **P2 tests** (as time permits)
   - Remaining tests

---

## Test Data Requirements

### Known Input/Output for Verification (from Dev Notes)

**Test Set 1: Basic Compounding**
```
start_capital = $10,000
base_kelly = 10%
fractional_kelly = 50% (effective_kelly = 5%)

| Trade # | Gain % | Expected Equity |
|---------|--------|-----------------|
| 1       | +10.0  | $10,050.00      |
| 2       | +5.0   | $10,075.13      |
| 3       | -15.0  | $9,999.57       |
| 4       | +8.0   | $10,039.57      |
| 5       | +6.0   | $10,069.69      |

Expected Kelly PnL: $69.69
Expected Max DD ($): $75.56
Expected Max DD (%): 0.75%
Expected DD Duration: "Not recovered"
```

**Test Set 2: Blown Account**
```
start_capital = $1,000
effective_kelly = 50%
gains = [+20%, -100%, -100%]

Expected dd_duration: "Blown"
```

**Test Set 3: Negative Kelly**
```
kelly_pct = -5.0 (negative expectancy)

Expected: All Kelly metrics = None
Expected: warning = "negative_kelly"
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for logic, integration for flow, widget for UI)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (financial calculations = P0)
- [x] Test IDs follow naming convention {epic}.{story}-{LEVEL}-{SEQ}
- [x] Scenarios are atomic and independent
- [x] Risk mitigations are addressed with specific tests
