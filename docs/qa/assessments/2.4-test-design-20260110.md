# Test Design: Story 2.4

Date: 2026-01-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 22
- Unit tests: 10 (45%)
- Integration tests: 6 (27%)
- Widget tests: 5 (23%)
- E2E tests: 1 (5%)
- Priority distribution: P0: 6, P1: 10, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: "Export Filtered Data" button in bottom bar

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-WIDGET-001 | Widget | P1 | Export button exists in bottom bar | UI presence validation |
| 2.4-WIDGET-002 | Widget | P1 | Button positioned on right side after stretch | Layout verification |
| 2.4-WIDGET-003 | Widget | P1 | Button initially disabled | State validation |
| 2.4-WIDGET-004 | Widget | P1 | Button enabled when filtered data available | Reactive state |

### AC2: Save dialog with suggested filename

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-001 | Unit | P1 | Suggested filename follows pattern `lumen_export_{timestamp}.csv` | Pure string logic |
| 2.4-INT-001 | Integration | P2 | QFileDialog shows with suggested filename | OS integration |
| 2.4-INT-002 | Integration | P2 | Export cancelled when user dismisses dialog | Flow verification |

### AC3: Export all columns, only filtered rows, CSV format

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-002 | Unit | P0 | Export includes all DataFrame columns | Core requirement |
| 2.4-UNIT-003 | Unit | P0 | Export row count matches filtered DataFrame | Core requirement |
| 2.4-UNIT-004 | Unit | P1 | Export produces valid CSV format | Format validation |
| 2.4-UNIT-005 | Unit | P1 | Export handles empty DataFrame | Edge case |
| 2.4-UNIT-006 | Unit | P2 | Export handles special characters in data | Edge case |
| 2.4-INT-003 | Integration | P0 | Full workflow: load → filter → export → verify CSV | Critical path |

### AC4: Include metadata comment with filter summary

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-007 | Unit | P1 | Metadata header starts with `# Lumen Export` | Format validation |
| 2.4-UNIT-008 | Unit | P1 | Metadata includes timestamp | Traceability |
| 2.4-UNIT-009 | Unit | P1 | Metadata includes filter column/operator/values | Filter context |
| 2.4-UNIT-010 | Unit | P1 | Metadata includes first-trigger state (ON/OFF) | Toggle state |
| 2.4-INT-004 | Integration | P1 | Export with first-trigger ON shows in metadata | End-to-end metadata |

### AC5: Success toast notification

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-WIDGET-005 | Widget | P1 | Toast shows message on export success | Feedback verification |
| 2.4-WIDGET-006 | Widget | P2 | Success toast uses cyan (SIGNAL_CYAN) color | Visual correctness |
| 2.4-WIDGET-007 | Widget | P2 | Error toast uses coral (SIGNAL_CORAL) color | Visual correctness |
| 2.4-WIDGET-008 | Widget | P2 | Toast auto-dismisses after duration | UX behavior |
| 2.4-INT-005 | Integration | P2 | Error toast shown on permission denied | Error handling flow |

### AC6: Export completes in < 2 seconds for 100k rows

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-PERF-001 | E2E | P0 | Export 100k rows completes < 2 seconds | NFR validation |

## Risk Coverage

| Risk ID | Risk | Mitigating Tests |
|---------|------|------------------|
| PERF-001 | Export exceeds 2s | 2.4-PERF-001 |
| SEC-001 | CSV injection | 2.4-UNIT-006 |
| DATA-001 | Partial write | 2.4-UNIT-ERR-001 (implied by exception handling) |
| OPS-001 | Permission denied | 2.4-INT-005 |
| OPS-002 | Disk full | 2.4-UNIT-ERR-002 (implied by OSError handling) |
| TECH-001 | Cross-platform paths | 2.4-UNIT-002, 2.4-UNIT-003 (using tmp_path) |

## Additional Error Handling Tests

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 2.4-UNIT-ERR-001 | Unit | P1 | PermissionError raises ExportError | Exception mapping |
| 2.4-UNIT-ERR-002 | Unit | P1 | OSError raises ExportError | Exception mapping |

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on core logic)
   - 2.4-UNIT-002: All columns exported
   - 2.4-UNIT-003: Row count matches

2. **P0 Integration tests**
   - 2.4-INT-003: Full export workflow

3. **P0 E2E/Performance tests**
   - 2.4-PERF-001: 100k row export < 2s

4. **P1 Unit tests**
   - Metadata tests (2.4-UNIT-007 through 2.4-UNIT-010)
   - Error handling tests (2.4-UNIT-ERR-001, 2.4-UNIT-ERR-002)
   - Edge cases (2.4-UNIT-004, 2.4-UNIT-005)

5. **P1 Widget tests**
   - Button presence and state (2.4-WIDGET-001 through 2.4-WIDGET-004)
   - Toast functionality (2.4-WIDGET-005)

6. **P2 tests as time permits**
   - Visual/color tests
   - Additional integration scenarios

## Test File Mapping

| Test File | Test IDs | Focus |
|-----------|----------|-------|
| `tests/unit/test_export_manager.py` | 2.4-UNIT-001 to 2.4-UNIT-010, ERR tests | ExportManager logic |
| `tests/widget/test_toast.py` | 2.4-WIDGET-005 to 2.4-WIDGET-008 | Toast component |
| `tests/widget/test_feature_explorer.py` | 2.4-WIDGET-001 to 2.4-WIDGET-004 | Export button |
| `tests/integration/test_export_workflow.py` | 2.4-INT-001 to 2.4-INT-005 | Export workflow |
| `tests/integration/test_performance.py` | 2.4-PERF-001 | Performance NFR |

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for logic, widget for UI, integration for flow)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (P0 for core export, NFR)
- [x] Test IDs follow naming convention `{story}-{LEVEL}-{SEQ}`
- [x] Scenarios are atomic and independent
- [x] Risk mitigations mapped to specific tests

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 22
  by_level:
    unit: 10
    widget: 5
    integration: 6
    e2e: 1
  by_priority:
    p0: 6
    p1: 10
    p2: 6
  coverage_gaps: []
```

## Trace References

Test design matrix: docs/qa/assessments/2.4-test-design-20260110.md
P0 tests identified: 6
