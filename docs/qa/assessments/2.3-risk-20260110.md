# Risk Profile: Story 2.3

Date: 2026-01-10
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 1
- Risk Score: 77/100

## Risk Matrix

| Risk ID   | Description                                  | Probability | Impact     | Score | Priority |
|-----------|----------------------------------------------|-------------|------------|-------|----------|
| PERF-001  | Toggle response exceeds 200ms NFR            | Medium (2)  | High (3)   | 6     | High     |
| TECH-001  | Toggle state desynchronization with AppState | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-002  | DataFrame view vs copy mutation bugs         | Low (1)     | High (3)   | 3     | Low      |
| DATA-001  | Edge case: empty/no-match data handling      | Medium (2)  | Low (1)    | 2     | Low      |
| TECH-003  | Signal connection race conditions            | Low (1)     | Medium (2) | 2     | Low      |
| OPS-001   | Missing animation constant definition        | Low (1)     | Low (1)    | 1     | Minimal  |

## High Risks Requiring Attention

### PERF-001: Toggle response exceeds 200ms NFR

**Score: 6 (High)**

**Probability**: Medium - The `apply_filtered` method replicates `apply()` logic which involves groupby/sort/drop_duplicates operations. For datasets approaching 100k rows, these vectorized pandas operations can approach the 200ms threshold, especially when combined with chart re-rendering.

**Impact**: High - Performance is explicitly stated as AC4 requirement. Failing this NFR degrades user experience significantly as the toggle is a frequently-used interactive control.

**Affected Components**:
- `FirstTriggerEngine.apply_filtered()`
- `FeatureExplorerTab._on_first_trigger_toggled()`
- `ChartCanvas` update path

**Mitigation**:
- Ensure vectorized pandas operations (no Python loops)
- Profile with realistic 100k row datasets during development
- Consider early-exit optimization for already-processed data
- Add performance test to CI pipeline

**Testing Focus**: 
- Performance benchmark with 100k rows (Task 12)
- Profile actual toggle-to-chart-update latency

---

## Risk Distribution

### By Category

| Category      | Count | Highest Score |
|---------------|-------|---------------|
| Performance   | 1     | 6 (High)      |
| Technical     | 3     | 4 (Medium)    |
| Data          | 1     | 2 (Low)       |
| Operational   | 1     | 1 (Minimal)   |
| Security      | 0     | -             |
| Business      | 0     | -             |

### By Component

| Component              | Risk Count |
|------------------------|------------|
| FirstTriggerEngine     | 2          |
| FeatureExplorerTab     | 2          |
| ToggleSwitch           | 1          |
| FilterPanel            | 1          |

---

## Detailed Risk Register

### TECH-001: Toggle state desynchronization with AppState

**Score: 4 (Medium)**

**Probability**: Medium - Multiple code paths can modify filter state (filters applied, filters cleared, toggle changed). If signal connections are incorrect or state updates happen in wrong order, the toggle visual state may not reflect actual `AppState.first_trigger_enabled`.

**Impact**: Medium - User confusion, incorrect data display, but no data loss.

**Affected Components**:
- `FilterPanel._first_trigger_toggle`
- `AppState.first_trigger_enabled`
- `FeatureExplorerTab._on_first_trigger_toggled()`

**Mitigation**:
- Use single source of truth pattern (AppState is authoritative)
- Ensure toggle `setChecked()` doesn't re-emit signal (confirmed in spec)
- Add integration tests verifying toggle-state synchronization

**Testing Focus**: Integration tests for toggle workflow (Task 11)

---

### TECH-002: DataFrame view vs copy mutation bugs

**Score: 3 (Low)**

**Probability**: Low - The specification explicitly requires `.copy()` on return, but developers may forget or use chained assignment that creates views.

**Impact**: High - Silent data corruption where modifications to `filtered_df` affect `raw_df`, causing non-deterministic behavior and difficult-to-debug issues.

**Affected Components**:
- `FirstTriggerEngine.apply_filtered()` return value
- `FeatureExplorerTab._apply_current_filters()`

**Mitigation**:
- Code review emphasis on `.copy()` usage
- Unit test that verifies returned DataFrame is independent copy
- Use pandas `SettingWithCopyWarning` in test environment

**Testing Focus**: `test_apply_filtered_returns_copy` (Task 9)

---

### DATA-001: Edge case: empty/no-match data handling

**Score: 2 (Low)**

**Probability**: Medium - Users may apply filters that result in zero matches, or toggle first-trigger when no data matches filters.

**Impact**: Low - Poor UX with cryptic errors, but no data loss or security issue.

**Affected Components**:
- `FeatureExplorerTab._apply_current_filters()`
- `_update_chart()` bottom bar messages
- Task 7 edge case handling

**Mitigation**:
- Explicit empty DataFrame checks before operations
- User-friendly messages for each empty state
- Disable toggle when no data is loaded

**Testing Focus**: Edge case tests in Task 11

---

### TECH-003: Signal connection race conditions

**Score: 2 (Low)**

**Probability**: Low - Qt signal-slot mechanism is generally reliable, but complex signal chains (toggle → AppState → filtered_data_updated → chart) could have ordering issues during rapid toggling.

**Impact**: Medium - Chart shows stale data briefly, but self-corrects on next interaction.

**Affected Components**:
- Signal chain: `first_trigger_toggled` → `filtered_data_updated` → `ChartCanvas`

**Mitigation**:
- Use `Qt.ConnectionType.QueuedConnection` if needed for ordering
- Debounce rapid toggle changes (if users double-click)
- Verify signal emission order in integration tests

**Testing Focus**: Rapid toggle tests, signal ordering verification

---

### OPS-001: Missing animation constant definition

**Score: 1 (Minimal)**

**Probability**: Low - `Animation.DEBOUNCE_INPUT` (150ms) is documented but may not be defined in constants.py.

**Impact**: Low - Build error or fallback to hardcoded value.

**Affected Components**:
- `ToggleSwitch._setup_animation()`
- `src/ui/constants.py`

**Mitigation**:
- Verify `Animation` class has `DEBOUNCE_INPUT = 150` defined
- Add to constants if missing

**Testing Focus**: Basic widget test will fail if constant undefined

---

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests

| Risk ID  | Test Type   | Scenario                                    |
|----------|-------------|---------------------------------------------|
| PERF-001 | Performance | Toggle response < 200ms for 100k rows       |
| PERF-001 | Performance | First trigger application < 200ms           |

### Priority 2: Medium Risk Tests

| Risk ID   | Test Type   | Scenario                                   |
|-----------|-------------|-------------------------------------------|
| TECH-001  | Integration | Toggle ON/OFF syncs with AppState          |
| TECH-001  | Integration | Filter apply + toggle state consistency    |

### Priority 3: Low Risk Tests

| Risk ID   | Test Type | Scenario                                     |
|-----------|-----------|----------------------------------------------|
| TECH-002  | Unit      | apply_filtered returns DataFrame copy        |
| DATA-001  | Integration | Empty DataFrame handling                   |
| DATA-001  | Integration | No matches after filter                    |
| TECH-003  | Integration | Rapid toggle stress test                   |

---

## Risk Acceptance Criteria

### Must Fix Before Production

- PERF-001: Performance requirement is explicit AC - must meet 200ms threshold

### Can Deploy with Mitigation

- TECH-001: Integration tests provide sufficient confidence
- TECH-002: Unit test coverage mitigates risk adequately

### Accepted Risks

- DATA-001: Edge cases have explicit handling tasks (Task 7)
- TECH-003: Qt's signal mechanism is well-proven
- OPS-001: Will surface immediately in development

---

## Monitoring Requirements

Post-deployment monitoring:

1. **Performance Metrics**: Track toggle response latency distribution
2. **Error Rates**: Monitor for empty data state errors
3. **Usage Analytics**: Toggle usage frequency to inform optimization priority

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 1
    low: 4
  highest:
    id: PERF-001
    score: 6
    title: 'Toggle response exceeds 200ms NFR'
  recommendations:
    must_fix:
      - 'Ensure vectorized pandas operations for < 200ms response'
      - 'Add performance benchmark test to CI'
    monitor:
      - 'Track toggle response latency in production'
```

---

Risk profile: docs/qa/assessments/2.3-risk-20260110.md
