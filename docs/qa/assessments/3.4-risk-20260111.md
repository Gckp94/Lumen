# Risk Profile: Story 3.4

Date: 2026-01-11
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 0
- Risk Score: 82/100 (Good - Low to Medium risk)

## Risk Matrix

| Risk ID   | Description                                      | Probability | Impact     | Score | Priority |
|-----------|--------------------------------------------------|-------------|------------|-------|----------|
| DATA-001  | Division by zero in DD% when peak equity is 0    | Medium (2)  | Medium (2) | 4     | Medium   |
| PERF-001  | Equity curve calculation with 100k+ trades       | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-001  | Incorrect drawdown duration algorithm            | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-002  | Edge cases: empty series, single trade           | Medium (2)  | Low (1)    | 2     | Low      |
| TECH-002  | Mixed type handling (int|str) for DD Duration    | Low (1)     | Low (1)    | 1     | Minimal  |
| OPS-001   | "Not recovered" color styling consistency        | Low (1)     | Low (1)    | 1     | Minimal  |

## Risk Distribution

### By Category

- Technical: 2 risks (0 critical)
- Performance: 1 risk (0 critical)
- Data: 2 risks (0 critical)
- Operational: 1 risk (0 critical)
- Security: 0 risks
- Business: 0 risks

### By Component

- Backend (src/core/equity.py): 4 risks
- Frontend (src/ui/components/metrics_grid.py): 2 risks

## Detailed Risk Register

### DATA-001: Division by Zero in DD% Calculation

**Score: 4 (Medium)**
**Probability**: Medium - Can occur when first trade is a loser (peak = 0)
**Impact**: Medium - Would cause calculation error or display incorrect percentage

**Affected Components:**
- `EquityCalculator.calculate_drawdown_metrics()`

**Detection Method:** Code analysis of drawdown percentage formula

**Mitigation:**
- Strategy: Preventive
- Actions:
  - Return `None` for `max_dd_pct` when `peak_at_max_dd <= 0`
  - Add explicit guard clause before division
- Testing Requirements:
  - Unit test with all-loser scenario
  - Unit test with first trade being a loser
- Residual Risk: Minimal after guard clause implementation
- Owner: Dev
- Timeline: During implementation

---

### PERF-001: Equity Curve Performance with Large Datasets

**Score: 4 (Medium)**
**Probability**: Medium - Architecture specifies 100k row target
**Impact**: Medium - Slow recalculation would degrade UX on flat_stake change

**Affected Components:**
- `EquityCalculator.calculate_flat_stake()`
- `PnLStatsTab._recalculate_metrics()`

**Detection Method:** Architecture requirement analysis (200ms target for 100k rows)

**Mitigation:**
- Strategy: Preventive
- Actions:
  - Use vectorized pandas operations (cumsum, cummax)
  - Avoid Python loops over trades
  - Leverage existing 300ms debounce on input changes
- Testing Requirements:
  - Performance test with 100k trade dataset
  - Verify calculation completes < 200ms
- Residual Risk: Low - pandas vectorization is efficient
- Owner: Dev
- Timeline: During implementation

---

### TECH-001: Incorrect Drawdown Duration Algorithm

**Score: 4 (Medium)**
**Probability**: Medium - Algorithm has multiple edge cases
**Impact**: Medium - Incorrect metric display would mislead user

**Affected Components:**
- `EquityCalculator.calculate_drawdown_metrics()`

**Detection Method:** Algorithm complexity analysis

**Mitigation:**
- Strategy: Preventive + Detective
- Actions:
  - Implement clear algorithm from Dev Notes (search forward from max_dd_idx)
  - Add comprehensive unit tests with known expected values
  - Use sample data table from story for verification
- Testing Requirements:
  - Test recovered scenario (returns int days)
  - Test not recovered scenario (returns "Not recovered")
  - Test multiple drawdowns (use worst by percentage)
- Residual Risk: Low after thorough testing
- Owner: Dev
- Timeline: During implementation

---

### DATA-002: Edge Cases for Empty/Single Trade Data

**Score: 2 (Low)**
**Probability**: Medium - Users may have incomplete data
**Impact**: Low - Would return None/empty, not crash

**Affected Components:**
- `EquityCalculator.calculate_flat_stake()`
- `EquityCalculator.calculate_flat_stake_metrics()`

**Detection Method:** Input variation analysis

**Mitigation:**
- Strategy: Preventive
- Actions:
  - Handle empty pandas Series gracefully (return empty DataFrame)
  - Handle single trade (no drawdown possible)
  - Return None for metrics when insufficient data
- Testing Requirements:
  - Unit test with empty Series
  - Unit test with single trade
  - Unit test with two trades (minimum for drawdown)
- Residual Risk: Minimal
- Owner: Dev
- Timeline: During implementation

---

### TECH-002: Mixed Type Handling for DD Duration Field

**Score: 1 (Minimal)**
**Probability**: Low - Well-defined in type hints (int | str | None)
**Impact**: Low - Display issue only

**Affected Components:**
- `TradingMetrics.flat_stake_dd_duration`
- `MetricsGrid.update_metrics()`
- `MetricCard.update_value()`

**Detection Method:** Type system analysis

**Mitigation:**
- Strategy: Preventive
- Actions:
  - Use explicit type checking in MetricCard formatting
  - Handle int (display as "X days"), str (display as-is), None (display "-")
- Testing Requirements:
  - Widget test for int display format
  - Widget test for "Not recovered" string display
- Residual Risk: Minimal
- Owner: Dev
- Timeline: During implementation

---

### OPS-001: "Not Recovered" Color Styling Consistency

**Score: 1 (Minimal)**
**Probability**: Low - Theme constants are well-defined
**Impact**: Low - Visual inconsistency only

**Affected Components:**
- `MetricCard` styling
- `Colors.SIGNAL_CORAL` usage

**Detection Method:** UI consistency review

**Mitigation:**
- Strategy: Preventive
- Actions:
  - Use existing `Colors.SIGNAL_CORAL` constant (#FF4757)
  - Follow existing negative value color pattern
- Testing Requirements:
  - Widget test verifying coral color applied
  - Manual visual verification
- Residual Risk: Minimal
- Owner: Dev
- Timeline: During implementation

---

## Risk-Based Testing Strategy

### Priority 1: Medium Risk Tests

1. **DATA-001 Mitigation**: Test division by zero guard
   - Input: gains = [-5.0, -3.0] (all losers, peak never > 0)
   - Expected: max_dd_pct = None

2. **PERF-001 Mitigation**: Performance benchmark
   - Input: 100,000 random trades
   - Expected: Calculation < 200ms

3. **TECH-001 Mitigation**: Drawdown duration accuracy
   - Input: Known test data from Dev Notes
   - Expected: Exact match to manual calculation

### Priority 2: Low Risk Tests

4. **DATA-002 Mitigation**: Edge case handling
   - Test empty, single, two-trade scenarios

5. **TECH-002 Mitigation**: Type display formatting
   - Test int → "X days", str → as-is, None → "-"

6. **OPS-001 Mitigation**: Visual styling
   - Manual verification of coral color

## Risk Acceptance Criteria

### Must Fix Before Production

- None (no critical or high risks)

### Can Deploy with Mitigation

- All Medium risks (DATA-001, PERF-001, TECH-001) with unit test coverage
- Low risks with basic test coverage

### Accepted Risks

- OPS-001: Minor visual styling - acceptable with manual verification

## Monitoring Requirements

Post-deployment monitoring for:

- Calculation errors logged for debugging
- Performance metrics via existing debounce pattern

## Risk Review Triggers

Review and update risk profile when:

- Story 3.5 (Kelly metrics) implementation begins (shares EquityCalculator)
- Performance issues reported with large datasets
- Edge cases discovered in production

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 0
    medium: 3
    low: 3
  highest:
    id: DATA-001
    score: 4
    title: 'Division by zero in DD% when peak equity is 0'
  recommendations:
    must_fix:
      - 'Add guard clause for peak_at_max_dd <= 0 in DD% calculation'
      - 'Use vectorized pandas operations for performance'
      - 'Implement clear forward-search algorithm for DD duration'
    monitor:
      - 'Log calculation errors for edge case debugging'
```

---

Risk profile: docs/qa/assessments/3.4-risk-20260111.md
