# Test Design: Story 1.6

Date: 2026-01-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 31
- Unit tests: 20 (65%)
- Integration tests: 4 (13%)
- Widget tests: 7 (22%)
- Priority distribution: P0: 12, P1: 15, P2: 4

## Test Scenarios by Acceptance Criteria

### AC1: Calculate 7 core metrics (Number of Trades, Win Rate, Avg Winner, Avg Loser, R:R Ratio, EV, Kelly)

#### Scenarios

| ID           | Level | Priority | Test                                    | Justification                           |
|--------------|-------|----------|-----------------------------------------|-----------------------------------------|
| 1.6-UNIT-001 | Unit  | P0       | Calculate num_trades as len(df)         | Pure counting logic                     |
| 1.6-UNIT-002 | Unit  | P0       | Calculate win_rate as percentage        | Core metric, formula validation         |
| 1.6-UNIT-003 | Unit  | P0       | Calculate avg_winner correctly          | Mean of positive gains                  |
| 1.6-UNIT-004 | Unit  | P0       | Calculate avg_loser correctly           | Mean of negative gains (negative value) |
| 1.6-UNIT-005 | Unit  | P0       | Calculate R:R ratio as abs(avg_win/avg_lose) | Division formula with abs()         |
| 1.6-UNIT-006 | Unit  | P0       | Calculate EV formula correctly          | Complex formula: (wr*aw)+(lr*al)        |
| 1.6-UNIT-007 | Unit  | P0       | Calculate Kelly criterion correctly     | Formula: wr - (lr/rr), convert to %     |
| 1.6-UNIT-008 | Unit  | P1       | All 7 metrics in single calculation     | Integrated calculation flow             |

**Mitigates Risks**: TECH-001, BUS-001

---

### AC2: Win Rate uses mapped Win/Loss column or derives from Gain %

#### Scenarios

| ID           | Level | Priority | Test                                     | Justification                          |
|--------------|-------|----------|------------------------------------------|----------------------------------------|
| 1.6-UNIT-009 | Unit  | P0       | Derive win/loss from gain_pct > 0        | Default derivation logic               |
| 1.6-UNIT-010 | Unit  | P0       | Use explicit Win/Loss column ("W"/"L")   | Explicit column mapping                |
| 1.6-UNIT-011 | Unit  | P1       | Handle Win/Loss variants (Win/WIN/1/True)| Flexible string matching               |
| 1.6-UNIT-012 | Unit  | P1       | breakeven_is_win=True treats 0 as win    | Configuration option                   |
| 1.6-UNIT-013 | Unit  | P1       | breakeven_is_win=False treats 0 as loss  | Default behavior                       |

**Mitigates Risks**: TECH-001

---

### AC3: Prepare distribution data (winner/loser arrays with statistics)

#### Scenarios

| ID           | Level | Priority | Test                                     | Justification                          |
|--------------|-------|----------|------------------------------------------|----------------------------------------|
| 1.6-UNIT-014 | Unit  | P1       | winner_gains contains positive gains     | Array population                       |
| 1.6-UNIT-015 | Unit  | P1       | loser_gains contains negative gains      | Array population                       |
| 1.6-UNIT-016 | Unit  | P1       | winner_std calculated for 2+ winners     | Std requires multiple values           |
| 1.6-UNIT-017 | Unit  | P1       | loser_std calculated for 2+ losers       | Std requires multiple values           |
| 1.6-UNIT-018 | Unit  | P2       | Single winner returns winner_std=None    | Edge case for std                      |
| 1.6-UNIT-019 | Unit  | P2       | winner_count/loser_count accurate        | Count verification                     |

---

### AC4: Display metrics in styled cards with appropriate formatting

#### Scenarios

| ID           | Level  | Priority | Test                                    | Justification                          |
|--------------|--------|----------|-----------------------------------------|----------------------------------------|
| 1.6-WIDG-001 | Widget | P1       | MetricCard displays label correctly     | UI component rendering                 |
| 1.6-WIDG-002 | Widget | P1       | MetricCard displays formatted value     | Format spec application                |
| 1.6-WIDG-003 | Widget | P1       | MetricsPanel displays all 7 cards       | Panel composition                      |
| 1.6-WIDG-004 | Widget | P2       | Integer values use thousands separator  | "{:,}" formatting                      |
| 1.6-INT-001  | Int    | P1       | MetricsPanel updates from TradingMetrics| Widget receives and displays metrics   |

---

### AC5: Color coding (positive=plasma-cyan, negative=solar-coral)

#### Scenarios

| ID           | Level  | Priority | Test                                    | Justification                          |
|--------------|--------|----------|-----------------------------------------|----------------------------------------|
| 1.6-WIDG-005 | Widget | P1       | Positive values display in SIGNAL_CYAN  | Color coding rule                      |
| 1.6-WIDG-006 | Widget | P1       | Negative values display in SIGNAL_CORAL | Color coding rule                      |
| 1.6-WIDG-007 | Widget | P1       | None/zero values display in TEXT_PRIMARY| Neutral color                          |

---

### AC6: Edge case handling (no winners, no losers, empty dataset)

#### Scenarios

| ID           | Level | Priority | Test                                     | Justification                          |
|--------------|-------|----------|------------------------------------------|----------------------------------------|
| 1.6-UNIT-020 | Unit  | P0       | Empty DataFrame returns TradingMetrics.empty() | Critical edge case               |
| 1.6-UNIT-021 | Unit  | P0       | No winners: win_rate=0, avg_winner=None  | All-loss edge case                     |
| 1.6-UNIT-022 | Unit  | P0       | No losers: win_rate=100, avg_loser=None  | All-win edge case                      |
| 1.6-UNIT-023 | Unit  | P1       | No winners: rr_ratio=None, kelly=None    | Downstream None propagation            |
| 1.6-UNIT-024 | Unit  | P1       | Single trade calculates correctly        | Minimum viable data                    |
| 1.6-UNIT-025 | Unit  | P2       | TradingMetrics.empty() has correct defaults | Factory method validation           |

**Mitigates Risks**: DATA-001, DATA-002

---

### AC7: Calculation completes in < 100ms for 100k rows

#### Scenarios

| ID           | Level | Priority | Test                                     | Justification                          |
|--------------|-------|----------|------------------------------------------|----------------------------------------|
| 1.6-UNIT-026 | Unit  | P1       | Performance < 100ms for 100k rows        | NFR validation (@pytest.mark.slow)     |

**Mitigates Risks**: PERF-001

---

### Integration Tests (Cross-component)

| ID           | Level       | Priority | Test                                     | Justification                          |
|--------------|-------------|----------|------------------------------------------|----------------------------------------|
| 1.6-INT-002  | Integration | P1       | DataInputTab emits baseline_calculated   | Signal flow verification               |
| 1.6-INT-003  | Integration | P1       | AppState stores baseline_metrics         | State management                       |
| 1.6-INT-004  | Integration | P1       | MetricsPanel connects to signal          | Signal-slot connection                 |

---

## Test File Mapping

| Test File                           | Scenarios                           | Count |
|-------------------------------------|-------------------------------------|-------|
| `tests/unit/test_metrics.py`        | 1.6-UNIT-001 through 1.6-UNIT-026   | 20    |
| `tests/widget/test_metric_card.py`  | 1.6-WIDG-001 through 1.6-WIDG-007   | 7     |
| `tests/widget/test_metrics_panel.py`| 1.6-INT-001                         | 1     |
| `tests/integration/test_data_flow.py` | 1.6-INT-002 through 1.6-INT-004   | 3     |

---

## Risk Coverage Matrix

| Risk ID   | Covered By Scenarios                    | Coverage |
|-----------|-----------------------------------------|----------|
| TECH-001  | 1.6-UNIT-001 to 008, 009 to 013         | Full     |
| BUS-001   | 1.6-UNIT-006 (EV specifically)          | Full     |
| DATA-001  | 1.6-UNIT-021, 022, 023                  | Full     |
| DATA-002  | 1.6-UNIT-007, 023                       | Full     |
| PERF-001  | 1.6-UNIT-026                            | Full     |

---

## Recommended Execution Order

### Phase 1: P0 Tests (Fail Fast)
1. 1.6-UNIT-001 through 007 (individual metric calculations)
2. 1.6-UNIT-009, 010 (win/loss classification)
3. 1.6-UNIT-020, 021, 022 (edge cases)

### Phase 2: P1 Tests (Core Functionality)
4. 1.6-UNIT-008, 011-017, 023-024 (integrated calculation, classification variants)
5. 1.6-WIDG-001 through 007 (widget rendering and color coding)
6. 1.6-INT-001 through 004 (integration tests)
7. 1.6-UNIT-026 (performance test - marked slow)

### Phase 3: P2 Tests (If Time Permits)
8. 1.6-UNIT-018, 019, 025 (minor edge cases)
9. 1.6-WIDG-004 (formatting details)

---

## Test Data Requirements

### Sample Balanced Dataset
```python
# 50% win rate, known values
df = pd.DataFrame({
    "gain_pct": [2.0, -1.0, 3.0, -2.0, 1.5, -0.5]
})
# Expected: num_trades=6, win_rate=50.0, avg_winner=2.167, avg_loser=-1.167
```

### Sample for EV/Kelly Validation
```python
# 60% win rate, 2:1 R:R
df = pd.DataFrame({
    "gain_pct": [2.0, 2.0, 2.0, -1.0, -1.0]
})
# Expected: EV = (0.6 * 2.0) + (0.4 * -1.0) = 0.8
# Expected: Kelly = 0.6 - (0.4 / 2.0) = 0.4 (40%)
```

### Edge Case Datasets
```python
# Empty
df_empty = pd.DataFrame(columns=["gain_pct"])

# All winners
df_all_win = pd.DataFrame({"gain_pct": [1.0, 2.0, 3.0]})

# All losers
df_all_lose = pd.DataFrame({"gain_pct": [-1.0, -2.0, -3.0]})

# Single trade
df_single = pd.DataFrame({"gain_pct": [2.5]})
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (unit for logic, widget for UI, integration for flow)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (EV calculation is P0)
- [x] Test IDs follow naming convention (1.6-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] All identified risks have test coverage

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 31
  by_level:
    unit: 20
    widget: 7
    integration: 4
  by_priority:
    p0: 12
    p1: 15
    p2: 4
  coverage_gaps: []
```

---

Test design matrix: docs/qa/assessments/1.6-test-design-20260110.md
P0 tests identified: 12
