# Test Design: Story 4.4 - PnL Equity Charts

Date: 2026-01-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 28
- Unit tests: 12 (43%)
- Integration tests: 6 (21%)
- Widget tests: 7 (25%)
- E2E/Manual tests: 3 (11%)
- Priority distribution: P0: 6, P1: 14, P2: 8

## Test Scenarios by Acceptance Criteria

### AC1: Two charts - Flat Stake PnL, Compounded Kelly

| ID             | Level       | Priority | Test                                      | Justification                        |
|----------------|-------------|----------|-------------------------------------------|--------------------------------------|
| 4.4-UNIT-001   | Unit        | P0       | EquityChart initializes with two curves   | Core component structure validation  |
| 4.4-UNIT-002   | Unit        | P1       | set_baseline() updates baseline curve     | Data flow to component               |
| 4.4-UNIT-003   | Unit        | P1       | set_filtered() updates filtered curve     | Data flow to component               |
| 4.4-UNIT-004   | Unit        | P1       | set_baseline(None) clears baseline        | Edge case handling                   |
| 4.4-UNIT-005   | Unit        | P1       | set_filtered(None) hides filtered curve   | Edge case handling                   |
| 4.4-UNIT-006   | Unit        | P1       | clear() resets both series                | Reset functionality                  |
| 4.4-INT-001    | Integration | P1       | PnLStatsTab contains two chart panels     | Layout integration                   |
| 4.4-INT-002    | Integration | P1       | Chart titles show correct labels          | "Flat Stake PnL" / "Compounded Kelly"|

### AC2: Baseline (stellar-blue) and filtered (plasma-cyan) curves

| ID             | Level       | Priority | Test                                      | Justification                        |
|----------------|-------------|----------|-------------------------------------------|--------------------------------------|
| 4.4-WIDGET-001 | Widget      | P0       | Baseline curve uses SIGNAL_BLUE color     | Visual correctness                   |
| 4.4-WIDGET-002 | Widget      | P0       | Filtered curve uses SIGNAL_CYAN color     | Visual correctness                   |
| 4.4-WIDGET-003 | Widget      | P1       | Legend displays "Baseline" and "Filtered" | User clarity                         |
| 4.4-UNIT-007   | Unit        | P2       | Curve width is 2px                        | Style consistency                    |

### AC3: Interactive - pan, zoom, crosshair

| ID             | Level       | Priority | Test                                      | Justification                        |
|----------------|-------------|----------|-------------------------------------------|--------------------------------------|
| 4.4-WIDGET-004 | Widget      | P1       | Crosshair appears on mouse hover          | Interaction feedback                 |
| 4.4-WIDGET-005 | Widget      | P1       | Coordinate label shows Trade/Equity       | Data readability                     |
| 4.4-WIDGET-006 | Widget      | P1       | Double-click triggers auto-range          | View reset functionality             |
| 4.4-UNIT-008   | Unit        | P2       | range_changed signal emits on zoom        | Event propagation                    |
| 4.4-MANUAL-001 | Manual      | P2       | Mouse wheel zoom works both axes          | Complex interaction                  |
| 4.4-MANUAL-002 | Manual      | P2       | Right-click drag creates zoom rectangle   | Complex interaction                  |

### AC4: Optional drawdown visualization

| ID             | Level       | Priority | Test                                      | Justification                        |
|----------------|-------------|----------|-------------------------------------------|--------------------------------------|
| 4.4-UNIT-009   | Unit        | P1       | show_drawdown property defaults False     | Initial state                        |
| 4.4-UNIT-010   | Unit        | P1       | set_drawdown_visible(True) shows fill     | Toggle functionality                 |
| 4.4-UNIT-011   | Unit        | P1       | set_drawdown_visible(False) hides fill    | Toggle functionality                 |
| 4.4-WIDGET-007 | Widget      | P1       | Drawdown fill uses semi-transparent coral | Visual correctness                   |
| 4.4-INT-003    | Integration | P2       | Checkbox toggles drawdown visibility      | UI control integration               |

### AC5: Consistent Observatory styling

| ID             | Level       | Priority | Test                                      | Justification                        |
|----------------|-------------|----------|-------------------------------------------|--------------------------------------|
| 4.4-UNIT-012   | Unit        | P2       | Background uses BG_SURFACE color          | Theme consistency                    |
| 4.4-INT-004    | Integration | P2       | Axis labels use correct fonts             | Theme consistency                    |

### AC6: Render 10k+ points < 500ms

| ID             | Level       | Priority | Test                                      | Justification                        |
|----------------|-------------|----------|-------------------------------------------|--------------------------------------|
| 4.4-PERF-001   | Integration | P0       | 10k points renders in < 500ms             | Explicit AC requirement              |
| 4.4-PERF-002   | Integration | P1       | 83k points renders in < 1000ms            | Stretch goal from tech stack         |

### Cross-AC: Signal Flow Integration

| ID             | Level       | Priority | Test                                      | Justification                        |
|----------------|-------------|----------|-------------------------------------------|--------------------------------------|
| 4.4-INT-005    | Integration | P0       | equity_curve_updated triggers chart update| End-to-end data flow                 |
| 4.4-INT-006    | Integration | P0       | Filter removal clears filtered curves     | State consistency                    |

## Risk Coverage

| Risk ID   | Test IDs                         | Coverage      |
|-----------|----------------------------------|---------------|
| PERF-001  | 4.4-PERF-001, 4.4-PERF-002      | Full          |
| TECH-001  | 4.4-UNIT-009/10/11, 4.4-WIDGET-007 | Full       |
| DATA-001  | 4.4-UNIT-002/003/004/005        | Full          |
| DATA-002  | 4.4-UNIT-004/005/006            | Full          |
| TECH-002  | 4.4-WIDGET-004/005              | Full          |
| BUS-001   | 4.4-WIDGET-001/002/003          | Full          |
| TECH-003  | 4.4-INT-005/006                 | Full          |
| PERF-002  | 4.4-PERF-001 (with drawdown)    | Partial       |

## Detailed Test Specifications

### Unit Tests (tests/unit/test_equity_chart.py)

```python
# 4.4-UNIT-001: EquityChart initializes with two curves
def test_equity_chart_has_baseline_and_filtered_curves():
    chart = EquityChart()
    assert chart._baseline_curve is not None
    assert chart._filtered_curve is not None

# 4.4-UNIT-002: set_baseline() updates baseline curve
def test_set_baseline_updates_curve_data():
    chart = EquityChart()
    df = create_test_equity_df(100)  # Helper creates valid DataFrame
    chart.set_baseline(df)
    x, y = chart._baseline_curve.getData()
    assert len(x) == 100
    assert len(y) == 100

# 4.4-UNIT-003: set_filtered() updates filtered curve
def test_set_filtered_updates_curve_data():
    chart = EquityChart()
    df = create_test_equity_df(50)
    chart.set_filtered(df)
    x, y = chart._filtered_curve.getData()
    assert len(x) == 50

# 4.4-UNIT-004: set_baseline(None) clears baseline
def test_set_baseline_none_clears_curve():
    chart = EquityChart()
    chart.set_baseline(create_test_equity_df(10))
    chart.set_baseline(None)
    x, y = chart._baseline_curve.getData()
    assert len(x) == 0

# 4.4-UNIT-005: set_filtered(None) hides filtered curve
def test_set_filtered_none_clears_curve():
    chart = EquityChart()
    chart.set_filtered(create_test_equity_df(10))
    chart.set_filtered(None)
    x, y = chart._filtered_curve.getData()
    assert len(x) == 0

# 4.4-UNIT-006: clear() resets both series
def test_clear_resets_both_curves():
    chart = EquityChart()
    chart.set_baseline(create_test_equity_df(10))
    chart.set_filtered(create_test_equity_df(10))
    chart.clear()
    bx, _ = chart._baseline_curve.getData()
    fx, _ = chart._filtered_curve.getData()
    assert len(bx) == 0
    assert len(fx) == 0

# 4.4-UNIT-007: Curve width is 2px
def test_curve_pen_width():
    chart = EquityChart()
    assert chart._baseline_curve.opts['pen'].width() == 2
    assert chart._filtered_curve.opts['pen'].width() == 2

# 4.4-UNIT-008: range_changed signal emits
def test_range_changed_signal_emits(qtbot):
    chart = EquityChart()
    with qtbot.waitSignal(chart.range_changed, timeout=1000):
        chart._plot_widget.setRange(xRange=(0, 100), yRange=(0, 1000))

# 4.4-UNIT-009: show_drawdown defaults False
def test_show_drawdown_default_false():
    chart = EquityChart()
    assert chart.show_drawdown is False

# 4.4-UNIT-010: set_drawdown_visible(True) shows fill
def test_set_drawdown_visible_true_shows_fill():
    chart = EquityChart()
    chart.set_baseline(create_test_equity_df(100))
    chart.set_drawdown_visible(True)
    assert chart._drawdown_fill.isVisible()

# 4.4-UNIT-011: set_drawdown_visible(False) hides fill
def test_set_drawdown_visible_false_hides_fill():
    chart = EquityChart()
    chart.set_drawdown_visible(True)
    chart.set_drawdown_visible(False)
    assert not chart._drawdown_fill.isVisible()

# 4.4-UNIT-012: Background uses BG_SURFACE
def test_background_color():
    chart = EquityChart()
    bg = chart._plot_widget.backgroundBrush().color().name()
    assert bg.upper() == Colors.BG_SURFACE.upper()
```

### Widget Tests (tests/widget/test_equity_chart.py)

```python
# 4.4-WIDGET-001: Baseline curve uses SIGNAL_BLUE
def test_baseline_curve_color(qtbot):
    chart = EquityChart()
    qtbot.addWidget(chart)
    pen_color = chart._baseline_curve.opts['pen'].color().name()
    assert pen_color.upper() == Colors.SIGNAL_BLUE.upper()

# 4.4-WIDGET-002: Filtered curve uses SIGNAL_CYAN
def test_filtered_curve_color(qtbot):
    chart = EquityChart()
    qtbot.addWidget(chart)
    pen_color = chart._filtered_curve.opts['pen'].color().name()
    assert pen_color.upper() == Colors.SIGNAL_CYAN.upper()

# 4.4-WIDGET-003: Legend displays labels
def test_legend_displays_labels(qtbot):
    chart = EquityChart()
    qtbot.addWidget(chart)
    legend = chart._plot_widget.getPlotItem().legend
    assert legend is not None
    # Verify legend items contain expected labels

# 4.4-WIDGET-004: Crosshair appears on hover
def test_crosshair_visible_on_hover(qtbot):
    chart = EquityChart()
    qtbot.addWidget(chart)
    chart.set_baseline(create_test_equity_df(100))
    # Simulate mouse move
    # Assert crosshair lines become visible

# 4.4-WIDGET-005: Coordinate label format
def test_coordinate_label_format(qtbot):
    chart = EquityChart()
    qtbot.addWidget(chart)
    chart.set_baseline(create_test_equity_df(100))
    # Simulate mouse at known position
    # Assert label format matches "Trade: X, Equity: $Y.YY"

# 4.4-WIDGET-006: Double-click auto-range
def test_double_click_auto_range(qtbot):
    chart = EquityChart()
    qtbot.addWidget(chart)
    chart.set_baseline(create_test_equity_df(100))
    chart._plot_widget.setRange(xRange=(0, 10))  # Zoom in
    qtbot.mouseDClick(chart, Qt.MouseButton.LeftButton)
    # Assert view range covers all data

# 4.4-WIDGET-007: Drawdown fill color
def test_drawdown_fill_color(qtbot):
    chart = EquityChart()
    qtbot.addWidget(chart)
    chart.set_baseline(create_test_equity_df(100))
    chart.set_drawdown_visible(True)
    brush = chart._drawdown_fill.brush()
    color = brush.color()
    assert color.alpha() == 128  # Semi-transparent
    # Verify base color is SIGNAL_CORAL
```

### Integration Tests

```python
# tests/integration/test_performance.py

# 4.4-PERF-001: 10k points < 500ms
@pytest.mark.slow
def test_equity_chart_10k_points_performance(qtbot):
    from time import perf_counter
    chart = EquityChart()
    qtbot.addWidget(chart)
    df = create_test_equity_df(10000)
    
    start = perf_counter()
    chart.set_baseline(df)
    qtbot.wait(10)  # Allow render
    elapsed = perf_counter() - start
    
    assert elapsed < 0.5, f"Rendering took {elapsed:.3f}s, expected < 0.5s"

# 4.4-PERF-002: 83k points < 1000ms (stretch)
@pytest.mark.slow
def test_equity_chart_83k_points_performance(qtbot):
    from time import perf_counter
    chart = EquityChart()
    qtbot.addWidget(chart)
    df = create_test_equity_df(83000)
    
    start = perf_counter()
    chart.set_baseline(df)
    qtbot.wait(10)
    elapsed = perf_counter() - start
    
    assert elapsed < 1.0, f"Rendering took {elapsed:.3f}s, expected < 1.0s"

# tests/integration/test_filter_workflow.py

# 4.4-INT-001: PnLStatsTab contains two chart panels
def test_pnl_stats_tab_has_two_charts(app_state, qtbot):
    tab = PnLStatsTab(app_state)
    qtbot.addWidget(tab)
    assert hasattr(tab, '_flat_stake_chart_panel')
    assert hasattr(tab, '_kelly_chart_panel')

# 4.4-INT-002: Chart titles
def test_chart_panel_titles(app_state, qtbot):
    tab = PnLStatsTab(app_state)
    qtbot.addWidget(tab)
    assert tab._flat_stake_chart_panel._title.text() == "Flat Stake PnL"
    assert tab._kelly_chart_panel._title.text() == "Compounded Kelly PnL"

# 4.4-INT-005: Signal triggers chart update
def test_equity_curve_signal_updates_chart(app_state, qtbot):
    tab = PnLStatsTab(app_state)
    qtbot.addWidget(tab)
    df = create_test_equity_df(100)
    
    app_state.equity_curve_updated.emit(df)
    
    x, _ = tab._flat_stake_chart_panel._chart._baseline_curve.getData()
    assert len(x) == 100

# 4.4-INT-006: Filter removal clears filtered curves
def test_filter_removal_clears_filtered(app_state, qtbot):
    tab = PnLStatsTab(app_state)
    qtbot.addWidget(tab)
    
    # Add filtered data
    app_state.filtered_equity_curve_updated.emit(create_test_equity_df(50))
    # Remove filter (emit None)
    app_state.filtered_equity_curve_updated.emit(None)
    
    x, _ = tab._flat_stake_chart_panel._chart._filtered_curve.getData()
    assert len(x) == 0
```

### Manual Test Cases

| ID             | Scenario                                      | Steps                                                          | Expected Result                      |
|----------------|-----------------------------------------------|----------------------------------------------------------------|--------------------------------------|
| 4.4-MANUAL-001 | Mouse wheel zoom                              | 1. Load data 2. Hover over chart 3. Scroll mouse wheel         | Chart zooms in/out on both axes      |
| 4.4-MANUAL-002 | Zoom rectangle                                | 1. Load data 2. Right-click drag rectangle 3. Release          | View zooms to selected region        |
| 4.4-MANUAL-003 | Visual verification                           | 1. Load data 2. Apply filter 3. Enable drawdown 4. Verify look | Matches design spec, no visual bugs  |

## Recommended Execution Order

1. **P0 Unit tests** - Fail fast on core functionality
   - 4.4-UNIT-001 (initialization)
2. **P0 Widget tests** - Verify visual correctness
   - 4.4-WIDGET-001, 4.4-WIDGET-002 (colors)
3. **P0 Integration tests** - Verify end-to-end flow
   - 4.4-INT-005, 4.4-INT-006 (signal flow)
   - 4.4-PERF-001 (performance requirement)
4. **P1 tests** - Core user functionality
   - All unit tests for data handling
   - Widget tests for interactions
5. **P2 tests** - Style and polish
   - Background color, fonts, axis styling
6. **Manual tests** - Complex interactions

## Coverage Gaps

None identified - all acceptance criteria have test coverage.

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (favoring unit over integration)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] Risk mitigations addressed

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 28
  by_level:
    unit: 12
    widget: 7
    integration: 6
    e2e: 3
  by_priority:
    p0: 6
    p1: 14
    p2: 8
  coverage_gaps: []
```

---

Test design matrix: docs/qa/assessments/4.4-test-design-20260111.md
P0 tests identified: 6
