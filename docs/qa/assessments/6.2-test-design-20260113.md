# Test Design: Story 6.2

Date: 2026-01-13
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 32
- Unit tests: 18 (56%)
- Integration tests: 6 (19%)
- Widget tests: 8 (25%)
- Priority distribution: P0: 10, P1: 14, P2: 8

## Test Scenarios by Acceptance Criteria

### AC1: Bin assignment algorithm correctly categorizes rows using `<`, `>`, `range`, and `nulls` operators

#### Scenarios

| ID             | Level | Priority | Test                                          | Justification                      |
|----------------|-------|----------|-----------------------------------------------|------------------------------------|
| 6.2-UNIT-001   | Unit  | P0       | `<` operator assigns values below threshold   | Core algorithm - pure logic        |
| 6.2-UNIT-002   | Unit  | P0       | `<` operator excludes values at threshold     | Boundary validation                |
| 6.2-UNIT-003   | Unit  | P0       | `>` operator assigns values above threshold   | Core algorithm - pure logic        |
| 6.2-UNIT-004   | Unit  | P0       | `>` operator excludes values at threshold     | Boundary validation                |
| 6.2-UNIT-005   | Unit  | P0       | `range` operator includes boundary values     | Range semantics: value1 <= x <= value2 |
| 6.2-UNIT-006   | Unit  | P0       | `range` operator excludes outside values      | Range boundary test                |
| 6.2-UNIT-007   | Unit  | P0       | `nulls` operator assigns NaN/None values      | Null handling - core feature       |
| 6.2-UNIT-008   | Unit  | P1       | First matching bin wins with overlapping defs | Spec requirement for overlap       |
| 6.2-UNIT-009   | Unit  | P1       | Unmatched rows assigned to "Uncategorized"    | Edge case handling                 |
| 6.2-UNIT-010   | Unit  | P1       | Empty DataFrame returns empty Series          | Edge case - no data                |
| 6.2-UNIT-011   | Unit  | P2       | All-null column assigns all to "Nulls" bin    | Edge case coverage                 |

---

### AC2: Four horizontal bar charts display: Average, Median, Count, and Win Rate per bin

#### Scenarios

| ID             | Level   | Priority | Test                                          | Justification                      |
|----------------|---------|----------|-----------------------------------------------|------------------------------------|
| 6.2-UNIT-012   | Unit    | P0       | Average calculation correct per bin           | Core metric - pure calculation     |
| 6.2-UNIT-013   | Unit    | P0       | Median calculation correct per bin            | Core metric - pure calculation     |
| 6.2-UNIT-014   | Unit    | P0       | Count calculation correct per bin             | Core metric - pure calculation     |
| 6.2-UNIT-015   | Unit    | P0       | Win rate = (positive_rows / total) * 100      | Core metric - formula verification |
| 6.2-UNIT-016   | Unit    | P1       | Empty bin returns None/NaN for metrics        | Edge case - no data in bin         |
| 6.2-UNIT-017   | Unit    | P1       | Win rate handles all-negative bin (0%)        | Division edge case                 |
| 6.2-WIDG-001   | Widget  | P1       | BinChartPanel renders 4 chart sections        | UI structure verification          |
| 6.2-WIDG-002   | Widget  | P2       | Charts display correct number of bars per bin | Visual verification                |

---

### AC3: Toggle allows switching between `gain_pct` and `adjusted_gain_pct`

#### Scenarios

| ID             | Level   | Priority | Test                                          | Justification                      |
|----------------|---------|----------|-----------------------------------------------|------------------------------------|
| 6.2-WIDG-003   | Widget  | P1       | Toggle switch present in chart panel header   | UI structure verification          |
| 6.2-INT-001    | Integ   | P1       | Toggle change recalculates all metrics        | Component interaction              |
| 6.2-INT-002    | Integ   | P1       | Default to adjusted_gain_pct if column exists | Default behavior                   |
| 6.2-UNIT-018   | Unit    | P2       | Metric calc works with both column names      | Algorithm flexibility              |

---

### AC4: Gradient coloring indicates relative magnitude (darker = higher values)

#### Scenarios

| ID             | Level   | Priority | Test                                          | Justification                      |
|----------------|---------|----------|-----------------------------------------------|------------------------------------|
| 6.2-WIDG-004   | Widget  | P2       | Bars have different colors based on value     | Visual behavior verification       |
| 6.2-UNIT-019   | Unit    | P2       | Gradient function returns darker for higher values | Color calculation logic        |
| 6.2-UNIT-020   | Unit    | P2       | Gradient handles min=max case (uniform color) | Edge case - single value           |

---

### AC5: Tooltips show exact values when hovering over chart bars

#### Scenarios

| ID             | Level   | Priority | Test                                          | Justification                      |
|----------------|---------|----------|-----------------------------------------------|------------------------------------|
| 6.2-WIDG-005   | Widget  | P1       | Tooltip appears on bar hover                  | UI interaction                     |
| 6.2-WIDG-006   | Widget  | P2       | Tooltip displays bin label and exact value    | Content verification               |

---

### AC6: Chart area is scrollable when bins exceed visible area

#### Scenarios

| ID             | Level   | Priority | Test                                          | Justification                      |
|----------------|---------|----------|-----------------------------------------------|------------------------------------|
| 6.2-WIDG-007   | Widget  | P1       | QScrollArea wraps chart content               | UI structure verification          |
| 6.2-INT-003    | Integ   | P2       | Scroll appears with many bins (>10)           | Overflow behavior                  |

---

### AC7: Charts update automatically when bin configuration changes

#### Scenarios

| ID             | Level   | Priority | Test                                          | Justification                      |
|----------------|---------|----------|-----------------------------------------------|------------------------------------|
| 6.2-INT-004    | Integ   | P0       | `bin_config_changed` signal triggers chart update | Signal-slot connection         |
| 6.2-INT-005    | Integ   | P1       | Debouncing prevents excessive recalculations  | Performance optimization           |
| 6.2-WIDG-008   | Widget  | P1       | Chart content changes after config update     | End-to-end signal flow             |

---

### AC8: Empty state shown when no bins are configured or no data is loaded

#### Scenarios

| ID             | Level   | Priority | Test                                          | Justification                      |
|----------------|---------|----------|-----------------------------------------------|------------------------------------|
| 6.2-INT-006    | Integ   | P1       | EmptyState shown with no data loaded          | State management                   |
| 6.2-INT-007    | Integ   | P1       | EmptyState shown with no bins configured      | State management                   |
| 6.2-INT-008    | Integ   | P1       | EmptyState hidden when data and bins present  | State transition                   |

---

### AC9: Performance - Chart rendering completes in < 500ms for datasets up to 100k rows

#### Scenarios

| ID             | Level   | Priority | Test                                          | Justification                      |
|----------------|---------|----------|-----------------------------------------------|------------------------------------|
| 6.2-PERF-001   | Unit    | P0       | Bin assignment < 500ms for 100k rows          | Explicit AC requirement            |
| 6.2-PERF-002   | Unit    | P1       | Metric calculation < 100ms for 100k rows      | Component of total budget          |

---

## Risk Coverage Mapping

| Risk ID   | Mitigated By Tests                              |
|-----------|-------------------------------------------------|
| PERF-001  | 6.2-PERF-001, 6.2-PERF-002                      |
| TECH-001  | 6.2-UNIT-001 to 6.2-UNIT-011                    |
| DATA-001  | 6.2-UNIT-015, 6.2-UNIT-016, 6.2-UNIT-017        |
| TECH-002  | 6.2-WIDG-001, 6.2-WIDG-002, 6.2-WIDG-004        |
| DATA-002  | 6.2-UNIT-012 to 6.2-UNIT-016                    |
| TECH-003  | 6.2-INT-005                                     |
| OPS-001   | 6.2-INT-006, 6.2-INT-007, 6.2-INT-008           |

---

## Recommended Execution Order

### Phase 1: P0 Unit Tests (Fail Fast)

Run first to validate core algorithm before integration:

1. 6.2-UNIT-001 to 6.2-UNIT-007 (bin operators)
2. 6.2-UNIT-012 to 6.2-UNIT-015 (metric calculations)
3. 6.2-PERF-001 (performance gate)

### Phase 2: P0 Integration Tests

4. 6.2-INT-004 (signal-slot connection)

### Phase 3: P1 Unit Tests

5. 6.2-UNIT-008 to 6.2-UNIT-011 (edge cases)
6. 6.2-UNIT-016, 6.2-UNIT-017 (empty bin handling)
7. 6.2-PERF-002 (metric performance)

### Phase 4: P1 Widget/Integration Tests

8. 6.2-WIDG-001 to 6.2-WIDG-003 (UI structure)
9. 6.2-INT-001, 6.2-INT-002 (toggle behavior)
10. 6.2-INT-005 to 6.2-INT-008 (state management)
11. 6.2-WIDG-005, 6.2-WIDG-007, 6.2-WIDG-008 (interactions)

### Phase 5: P2 Tests (As Time Permits)

12. All remaining P2 tests

---

## Test Implementation Notes

### File Locations

- Unit tests: `tests/unit/test_binning_engine.py`
- Widget tests: `tests/widget/test_data_binning.py` (extend existing)
- Performance tests: `tests/unit/test_binning_engine.py` (mark with `@pytest.mark.slow`)

### Test Data Requirements

| Test Category      | Data Needed                                      |
|--------------------|--------------------------------------------------|
| Bin assignment     | DataFrame with numeric column, various values    |
| Metric calculation | DataFrame with `gain_pct` and `adjusted_gain_pct`|
| Performance        | 100k row DataFrame with random values            |
| Edge cases         | Empty DataFrame, all-null column, single row     |

### Example Test Implementations

#### 6.2-UNIT-001: Less-than operator

```python
def test_less_than_operator_assigns_below_threshold():
    """< operator assigns values below threshold to bin."""
    engine = BinningEngine()
    df = pd.DataFrame({"value": [5, 10, 15, 20]})
    bins = [BinDefinition(operator="<", value1=15, label="Low")]
    
    result = engine.assign_bins(df, "value", bins)
    
    assert result.iloc[0] == "Low"  # 5 < 15
    assert result.iloc[1] == "Low"  # 10 < 15
    assert result.iloc[2] == "Uncategorized"  # 15 not < 15
    assert result.iloc[3] == "Uncategorized"  # 20 not < 15
```

#### 6.2-PERF-001: Performance test

```python
@pytest.mark.slow
def test_bin_assignment_performance_100k_rows():
    """Bin assignment completes in < 500ms for 100k rows."""
    engine = BinningEngine()
    df = pd.DataFrame({"value": np.random.randn(100_000)})
    bins = [
        BinDefinition(operator="<", value1=-1, label="Low"),
        BinDefinition(operator="range", value1=-1, value2=1, label="Mid"),
        BinDefinition(operator=">", value1=1, label="High"),
    ]
    
    start = time.perf_counter()
    engine.assign_bins(df, "value", bins)
    elapsed = time.perf_counter() - start
    
    assert elapsed < 0.5, f"Took {elapsed:.3f}s, exceeds 500ms limit"
```

#### 6.2-INT-004: Signal connection test

```python
def test_bin_config_changed_triggers_chart_update(qtbot):
    """bin_config_changed signal triggers chart recalculation."""
    tab = DataBinningTab()
    qtbot.addWidget(tab)
    
    # Set up data
    tab.set_data(sample_dataframe)
    
    with qtbot.waitSignal(tab.bin_config_changed, timeout=1000):
        tab._on_bin_row_changed()
    
    # Verify chart was updated
    assert tab._chart_panel._last_update_time is not None
```

---

## Coverage Summary

| Acceptance Criteria | Test Count | Levels Covered        |
|---------------------|------------|----------------------|
| AC1 (Bin assignment)| 11         | Unit                 |
| AC2 (Four charts)   | 8          | Unit, Widget         |
| AC3 (Toggle)        | 4          | Unit, Widget, Integ  |
| AC4 (Gradient)      | 3          | Unit, Widget         |
| AC5 (Tooltips)      | 2          | Widget               |
| AC6 (Scrollable)    | 2          | Widget, Integ        |
| AC7 (Auto-update)   | 3          | Widget, Integ        |
| AC8 (Empty state)   | 3          | Integ                |
| AC9 (Performance)   | 2          | Unit (perf)          |

**Coverage Gaps**: None - all ACs have at least one test scenario.

---

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 32
  by_level:
    unit: 18
    integration: 6
    widget: 8
  by_priority:
    p0: 10
    p1: 14
    p2: 8
  coverage_gaps: []
```

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (shift-left: 56% unit)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk (performance/algorithm = P0)
- [x] Test IDs follow naming convention (6.2-LEVEL-SEQ)
- [x] Scenarios are atomic and independent
- [x] Risk coverage mapped to tests

---

Test design matrix: docs/qa/assessments/6.2-test-design-20260113.md
P0 tests identified: 10
