# Risk Profile: Story 3.2

**Story:** Core Statistics & Distribution Data (Metrics 1-12, 24-25 prep)  
**Date:** 2026-01-11  
**Reviewer:** Quinn (Test Architect)

## Executive Summary

- **Total Risks Identified:** 8
- **Critical Risks:** 0
- **High Risks:** 1
- **Medium Risks:** 4
- **Low Risks:** 3
- **Risk Score:** 73/100

## Risk Matrix

| Risk ID   | Description                                      | Probability | Impact     | Score | Priority |
|-----------|--------------------------------------------------|-------------|------------|-------|----------|
| PERF-001  | Calculation exceeds 100ms for large datasets     | Medium (2)  | High (3)   | 6     | High     |
| TECH-001  | Kelly/EG formula implementation errors           | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-002  | Signal connection race conditions                | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001  | Division by zero in edge calculations            | Medium (2)  | Medium (2) | 4     | Medium   |
| TECH-003  | Debounce timing causing UI lag                   | Low (1)     | Medium (2) | 4     | Medium   |
| DATA-002  | Empty/null array handling in statistics          | Low (1)     | Low (1)    | 2     | Low      |
| TECH-004  | MetricCard color coding edge cases               | Low (1)     | Low (1)    | 2     | Low      |
| OPS-001   | Missing tooltip content                          | Low (1)     | Low (1)    | 1     | Low      |

## Critical Risks Requiring Immediate Attention

*No critical risks identified for this story.*

## High Risk Details

### PERF-001: Calculation exceeds 100ms for large datasets

**Score: 6 (High)**

**Probability:** Medium - The story adds 5 new calculations (Edge, Fractional Kelly, Expected Growth, Median Winner, Median Loser) plus min/max for distribution arrays. While pandas operations are vectorized, the cumulative overhead may approach the threshold.

**Impact:** High - AC6 explicitly requires "Calculation < 100ms for 100k rows". Failure means acceptance criteria not met and degraded user experience during input changes.

**Affected Components:**
- `src/core/metrics.py` - MetricsCalculator.calculate()

**Detection Method:** Performance testing with 100k row dataset

**Mitigation:**
- Strategy: Preventive
- Actions:
  - Use vectorized pandas operations exclusively (no Python loops)
  - Use `pd.Series.median()` instead of manual calculation
  - Profile calculation time and log with `logger.debug()`
  - Consider caching intermediate results if needed
- Testing Requirements:
  - Performance test with `@pytest.mark.slow` decorator
  - Assert elapsed_ms < 100
  - Test with realistic 100k row dataset
- Residual Risk: Low - Pandas vectorized operations handle 100k rows efficiently

---

## Medium Risk Details

### TECH-001: Kelly/EG formula implementation errors

**Score: 4 (Medium)**

**Probability:** Medium - Expected Growth formula (`kelly * EV - (kellyÂ² * variance / 2)`) involves multiple terms that must be correctly combined.

**Impact:** Medium - Incorrect values displayed to users; affects trading decisions but doesn't crash application.

**Affected Components:**
- `src/core/metrics.py` - Expected Growth calculation

**Mitigation:**
- Strategy: Preventive + Detective
- Actions:
  - Implement formulas exactly as specified in Dev Notes
  - Create unit tests with known inputs/outputs
  - Cross-validate against external calculator
- Testing Requirements:
  - Unit tests verifying each formula component
  - Edge case tests (negative Kelly, zero variance)

---

### TECH-002: Signal connection race conditions

**Score: 4 (Medium)**

**Probability:** Medium - Multiple signals (`baseline_calculated`, `metrics_user_inputs_changed`, `adjustment_params_changed`) updating the same MetricsGrid widget could cause state inconsistency.

**Impact:** Medium - Display shows stale or incorrect metrics temporarily.

**Affected Components:**
- `src/tabs/pnl_stats.py` - Signal connections
- `src/ui/components/metrics_grid.py` - update_metrics()

**Mitigation:**
- Strategy: Preventive
- Actions:
  - Use QTimer debouncing (300ms) for recalculation
  - Ensure single-threaded UI updates
  - Clear previous state before update
- Testing Requirements:
  - Integration tests for rapid input changes
  - Widget tests for signal emission/handling

---

### DATA-001: Division by zero in edge calculations

**Score: 4 (Medium)**

**Probability:** Medium - Edge = EV * num_trades; if EV calculation encounters zero divisors (avg_loser = 0), cascading None values occur.

**Impact:** Medium - Metrics display "N/A" or None values unexpectedly.

**Affected Components:**
- `src/core/metrics.py` - All dependent calculations

**Mitigation:**
- Strategy: Preventive
- Actions:
  - Check for None/zero before each calculation
  - Propagate None values gracefully
  - Document None semantics in docstrings
- Testing Requirements:
  - Unit tests with edge case datasets (all winners, all losers, single trade)

---

### TECH-003: Debounce timing causing UI lag

**Score: 4 (Medium)**

**Probability:** Low - 300ms debounce is reasonable, but accumulation of multiple input changes could feel sluggish.

**Impact:** Medium - Poor user experience during rapid adjustments.

**Affected Components:**
- `src/tabs/pnl_stats.py` - _recalculate_metrics()

**Mitigation:**
- Strategy: Detective
- Actions:
  - Use Animation.DEBOUNCE_METRICS constant (300ms)
  - Test responsiveness during manual verification
- Testing Requirements:
  - Manual testing of responsiveness
  - Widget test for debounce behavior

---

## Low Risk Details

### DATA-002: Empty/null array handling in statistics

**Score: 2 (Low)**

**Probability:** Low - Empty arrays only occur with no trades or all one-sided trades.

**Impact:** Low - Graceful None values already handled by existing code pattern.

**Mitigation:**
- Unit tests for empty winner_gains/loser_gains arrays
- Verify TradingMetrics.empty() returns correct defaults

---

### TECH-004: MetricCard color coding edge cases

**Score: 2 (Low)**

**Probability:** Low - Existing MetricCard.update_value() handles color coding.

**Impact:** Low - Visual inconsistency, not functional issue.

**Mitigation:**
- Widget tests verifying SIGNAL_CYAN for positive, SIGNAL_CORAL for negative
- Verify Kelly can display red when negative

---

### OPS-001: Missing tooltip content

**Score: 1 (Minimal)**

**Probability:** Low - Static content defined in METRIC_TOOLTIPS constant.

**Impact:** Low - Cosmetic issue only.

**Mitigation:**
- Code review to ensure all 12 metrics have tooltips
- Widget test checking tooltip presence

---

## Risk Distribution

### By Category

| Category    | Count | High+ |
|-------------|-------|-------|
| Performance | 1     | 1     |
| Technical   | 4     | 0     |
| Data        | 2     | 0     |
| Operational | 1     | 0     |
| Security    | 0     | 0     |
| Business    | 0     | 0     |

### By Component

| Component               | Count |
|-------------------------|-------|
| MetricsCalculator       | 3     |
| PnLStatsTab             | 2     |
| MetricsGrid             | 2     |
| TradingMetrics model    | 1     |

---

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- **PERF-001:** Performance test with 100k rows, assert < 100ms
- Test data: Generate synthetic DataFrame with realistic distribution

### Priority 2: Medium Risk Tests
- **TECH-001:** Formula correctness unit tests
- **TECH-002:** Signal integration tests with rapid state changes
- **DATA-001:** Edge case datasets (empty, single trade, all winners)
- **TECH-003:** Debounce behavior verification

### Priority 3: Low Risk Tests
- **DATA-002:** Empty array handling
- **TECH-004:** Color coding widget tests
- **OPS-001:** Tooltip presence tests

---

## Risk Acceptance Criteria

### Must Fix Before Production
- All high risks (PERF-001) must pass performance requirements

### Can Deploy with Mitigation
- Medium risks acceptable with comprehensive unit test coverage
- Debounce timing can be tuned post-deployment

### Accepted Risks
- Low risks accepted with monitoring
- Tooltip content issues can be fixed in patch releases

---

## Monitoring Requirements

Post-deployment monitoring for:
- **Performance:** Log calculation times, alert if > 100ms
- **Errors:** Monitor for None/NaN values in metrics display
- **User Experience:** Track user input change frequency

---

## Gate YAML Block

```yaml
# risk_summary (paste into gate file):
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 4
    low: 3
  highest:
    id: PERF-001
    score: 6
    title: 'Calculation exceeds 100ms for large datasets'
  recommendations:
    must_fix:
      - 'Ensure vectorized pandas operations for all new calculations'
      - 'Add performance test asserting < 100ms for 100k rows'
    monitor:
      - 'Log calculation times in production'
      - 'Monitor for None/NaN display values'
```

---

**Risk profile:** docs/qa/assessments/3.2-risk-20260111.md
