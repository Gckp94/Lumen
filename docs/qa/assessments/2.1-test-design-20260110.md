# Test Design: Story 2.1

Date: 2026-01-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 24
- Unit tests: 8 (33%)
- Integration tests: 6 (25%)
- E2E tests: 4 (17%)
- Widget tests: 6 (25%)
- Priority distribution: P0: 8, P1: 10, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: Tab Layout (25% sidebar, 75% chart, bottom bar)

| ID             | Level      | Priority | Test                                      | Justification                  |
|----------------|------------|----------|-------------------------------------------|--------------------------------|
| 2.1-WIDG-001   | Widget     | P1       | Layout contains sidebar, chart, bottom bar| UI structure validation        |
| 2.1-WIDG-002   | Widget     | P2       | Sidebar is ~25% of tab width              | Layout proportions             |
| 2.1-WIDG-003   | Widget     | P2       | QSplitter allows resize between panels    | Interactive layout requirement |

### AC2: Column Selector Dropdown

| ID             | Level      | Priority | Test                                      | Justification                  |
|----------------|------------|----------|-------------------------------------------|--------------------------------|
| 2.1-WIDG-004   | Widget     | P0       | Column selector shows numeric columns only| Core filtering logic           |
| 2.1-UNIT-001   | Unit       | P0       | _get_numeric_columns returns correct list | Pure function logic            |
| 2.1-WIDG-005   | Widget     | P1       | Column selector excludes string columns   | Negative case validation       |

### AC3: PyQtGraph Scatter Plot

| ID             | Level      | Priority | Test                                      | Justification                  |
|----------------|------------|----------|-------------------------------------------|--------------------------------|
| 2.1-UNIT-002   | Unit       | P0       | update_data() sets scatter plot data      | Core component functionality   |
| 2.1-UNIT-003   | Unit       | P1       | Empty DataFrame renders empty chart       | Edge case handling             |
| 2.1-UNIT-004   | Unit       | P1       | Single data point renders correctly       | Edge case handling             |
| 2.1-INT-001    | Integration| P0       | Column change triggers chart data update  | Component interaction          |

### AC4: Observatory Theme Styling

| ID             | Level      | Priority | Test                                      | Justification                  |
|----------------|------------|----------|-------------------------------------------|--------------------------------|
| 2.1-UNIT-005   | Unit       | P1       | Chart background is Colors.BG_SURFACE     | Theme compliance               |
| 2.1-UNIT-006   | Unit       | P1       | Scatter points use Colors.SIGNAL_CYAN     | Theme compliance               |

### AC5: Baseline First-Trigger Data Default

| ID             | Level      | Priority | Test                                      | Justification                  |
|----------------|------------|----------|-------------------------------------------|--------------------------------|
| 2.1-INT-002    | Integration| P0       | data_loaded signal populates column selector| Signal integration            |
| 2.1-INT-003    | Integration| P0       | baseline_calculated signal refreshes chart| Signal integration             |
| 2.1-WIDG-006   | Widget     | P1       | Default column is first numeric column    | Default behavior               |

### AC6: Bottom Bar Data Point Count

| ID             | Level      | Priority | Test                                      | Justification                  |
|----------------|------------|----------|-------------------------------------------|--------------------------------|
| 2.1-INT-004    | Integration| P1       | Bottom bar shows correct data point count | Display accuracy               |
| 2.1-UNIT-007   | Unit       | P2       | Count formatted with comma separators     | Localization requirement       |

### AC7: Chart Update < 200ms

| ID             | Level      | Priority | Test                                      | Justification                  |
|----------------|------------|----------|-------------------------------------------|--------------------------------|
| 2.1-PERF-001   | Integration| P0       | Column change completes within 200ms      | Performance requirement        |
| 2.1-INT-005    | Integration| P1       | Debounce prevents rapid-fire updates      | Performance optimization       |

### AC8: Handle 83k+ Points Without Lag

| ID             | Level      | Priority | Test                                      | Justification                  |
|----------------|------------|----------|-------------------------------------------|--------------------------------|
| 2.1-PERF-002   | Unit       | P0       | ChartCanvas renders 100k points           | Performance requirement        |
| 2.1-UNIT-008   | Unit       | P2       | OpenGL acceleration is enabled            | Performance config validation  |

## Edge Case & Error Handling Tests

| ID             | Level      | Priority | Test                                      | Justification                  |
|----------------|------------|----------|-------------------------------------------|--------------------------------|
| 2.1-E2E-001    | E2E        | P1       | Empty state shows message when no data    | User experience                |
| 2.1-E2E-002    | E2E        | P2       | No numeric columns shows appropriate state| Edge case UX                   |
| 2.1-INT-006    | Integration| P2       | NaN values in data handled gracefully     | Data integrity                 |
| 2.1-E2E-003    | E2E        | P2       | render_failed signal emits on error       | Error handling                 |

## Risk Coverage

| Risk ID   | Covered By                        | Coverage Level |
|-----------|-----------------------------------|----------------|
| PERF-001  | 2.1-PERF-002, 2.1-UNIT-008        | Full           |
| PERF-002  | 2.1-PERF-001, 2.1-INT-005         | Full           |
| TECH-001  | 2.1-UNIT-008, 2.1-E2E-003         | Partial        |
| TECH-002  | 2.1-INT-002, 2.1-INT-003          | Full           |
| DATA-001  | 2.1-INT-006                       | Full           |
| DATA-002  | 2.1-E2E-002                       | Full           |

## Test Implementation Reference

### Unit Tests: `tests/unit/test_chart_canvas.py`

```python
import pytest
import pandas as pd
import numpy as np
from src.ui.components.chart_canvas import ChartCanvas

class TestChartCanvasUnit:
    """Unit tests for ChartCanvas component."""

    def test_update_data_sets_scatter_data(self, qtbot):
        """2.1-UNIT-002: update_data() sets scatter plot data correctly."""
        canvas = ChartCanvas()
        qtbot.addWidget(canvas)
        df = pd.DataFrame({"gain_pct": [1.0, 2.0, 3.0, 4.0, 5.0]})
        canvas.update_data(df, "gain_pct")
        assert canvas._scatter.data is not None
        assert len(canvas._scatter.data) == 5

    def test_empty_dataframe_handled(self, qtbot):
        """2.1-UNIT-003: Empty DataFrame renders empty chart."""
        canvas = ChartCanvas()
        qtbot.addWidget(canvas)
        df = pd.DataFrame(columns=["gain_pct"])
        canvas.update_data(df, "gain_pct")
        # Should not raise

    def test_single_point_renders(self, qtbot):
        """2.1-UNIT-004: Single data point renders correctly."""
        canvas = ChartCanvas()
        qtbot.addWidget(canvas)
        df = pd.DataFrame({"gain_pct": [1.5]})
        canvas.update_data(df, "gain_pct")
        assert len(canvas._scatter.data) == 1

    @pytest.mark.slow
    def test_large_dataset_renders(self, qtbot):
        """2.1-PERF-002: ChartCanvas handles 100k+ points."""
        canvas = ChartCanvas()
        qtbot.addWidget(canvas)
        np.random.seed(42)
        df = pd.DataFrame({"gain_pct": np.random.normal(0.5, 3, 100_000)})
        canvas.update_data(df, "gain_pct")
        assert len(canvas._scatter.data) == 100_000
```

### Widget Tests: `tests/widget/test_feature_explorer.py`

```python
import pytest
import pandas as pd
from src.tabs.feature_explorer import FeatureExplorerTab
from src.core.app_state import AppState

class TestFeatureExplorerWidget:
    """Widget tests for FeatureExplorerTab."""

    def test_layout_components_exist(self, qtbot):
        """2.1-WIDG-001: Layout contains sidebar, chart, and bottom bar."""
        app_state = AppState()
        tab = FeatureExplorerTab(app_state=app_state)
        qtbot.addWidget(tab)
        assert tab._sidebar is not None
        assert tab._chart_canvas is not None
        assert tab._bottom_bar is not None

    def test_column_selector_numeric_only(self, qtbot):
        """2.1-WIDG-004: Column selector shows numeric columns only."""
        app_state = AppState()
        tab = FeatureExplorerTab(app_state=app_state)
        qtbot.addWidget(tab)
        df = pd.DataFrame({
            "ticker": ["AAPL", "GOOGL"],
            "gain_pct": [1.5, 2.3],
            "volume": [100, 200],
        })
        app_state.baseline_df = df
        app_state.data_loaded.emit(df)
        items = [tab._column_selector.itemText(i)
                 for i in range(tab._column_selector.count())]
        assert "gain_pct" in items
        assert "volume" in items
        assert "ticker" not in items
```

### Performance Tests: `tests/integration/test_performance.py`

```python
import pytest
import time
import pandas as pd
import numpy as np
from src.tabs.feature_explorer import FeatureExplorerTab
from src.core.app_state import AppState

class TestChartPerformance:
    """Performance tests for chart operations."""

    @pytest.mark.slow
    def test_column_change_under_200ms(self, qtbot):
        """2.1-PERF-001: Column change completes within 200ms."""
        app_state = AppState()
        tab = FeatureExplorerTab(app_state=app_state)
        qtbot.addWidget(tab)

        np.random.seed(42)
        df = pd.DataFrame({
            "col_a": np.random.normal(0, 1, 83_000),
            "col_b": np.random.normal(0, 1, 83_000),
        })
        app_state.baseline_df = df
        app_state.data_loaded.emit(df)

        start = time.perf_counter()
        tab._column_selector.setCurrentText("col_b")
        qtbot.wait(50)  # Allow signal processing
        elapsed = (time.perf_counter() - start) * 1000

        assert elapsed < 200, f"Column change took {elapsed:.1f}ms (>200ms)"
```

## Recommended Execution Order

1. **P0 Unit tests** (fail fast on core logic)
   - 2.1-UNIT-001, 2.1-UNIT-002
2. **P0 Widget tests** (validate structure)
   - 2.1-WIDG-004
3. **P0 Integration tests** (signal flow)
   - 2.1-INT-001, 2.1-INT-002, 2.1-INT-003
4. **P0 Performance tests** (critical requirements)
   - 2.1-PERF-001, 2.1-PERF-002
5. **P1 tests in order by level**
6. **P2 tests as time permits**

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
- [x] Risk mitigations are addressed

## Key Testing Notes

1. **PyQtGraph Testing**: Tests require `qtbot` fixture from pytest-qt for proper Qt event loop handling
2. **Performance Tests**: Mark with `@pytest.mark.slow` to allow filtering in CI
3. **OpenGL Tests**: May need environment variable setup on headless CI (`QT_QPA_PLATFORM=offscreen`)
4. **Signal Testing**: Use `qtbot.waitSignal()` for async signal verification
