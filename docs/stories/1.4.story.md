# Story 1.4: Column Configuration Panel

## Status

Done

## Story

**As a** user,
**I want** to verify and adjust column mappings,
**so that** the analysis uses the correct data even if auto-detection fails.

## Acceptance Criteria

1. Auto-detection for required columns (Ticker, Date, Time, Gain %, MAE %) with case-insensitive pattern matching
2. Auto-detection for optional Win/Loss column
3. If ALL required columns detected: show success summary with "Edit Mappings" option
4. If ANY required column missing: show blocking configuration panel
5. Column configuration panel shows dropdowns with status indicators (✓ detected, ⚠ guessed, ✗ missing)
6. Preview shows first 3 values from selected column
7. Win/Loss can be explicit column OR derived from Gain % with breakeven handling option
8. Validation: all required fields mapped, no duplicates
9. Persist mappings to `.lumen_cache/{file_hash}_mappings.json`
10. On "Continue", store mappings in app state and proceed

## Tasks / Subtasks

- [x] Task 1: Create ColumnMapping Data Model (AC: 1, 2, 7, 8)
  - [x] Create `src/core/models.py` with `ColumnMapping` dataclass
  - [x] Required fields: `ticker`, `date`, `time`, `gain_pct`, `mae_pct` (all `str`)
  - [x] Optional fields: `win_loss: str | None`, `win_loss_derived: bool`, `breakeven_is_win: bool`
  - [x] Implement `validate(df_columns: list[str]) -> list[str]` method returning validation errors
  - [x] Add docstrings and type hints

- [x] Task 2: Create ColumnMapper Core Class (AC: 1, 2, 9)
  - [x] Create `src/core/column_mapper.py` with `ColumnMapper` class
  - [x] Define `PATTERNS` dict for case-insensitive column matching:
    - `ticker`: ["ticker", "symbol", "stock", "security"]
    - `date`: ["date", "trade_date", "entry_date"]
    - `time`: ["time", "trade_time", "entry_time"]
    - `gain_pct`: ["gain", "return", "pnl", "profit", "%"]
    - `mae_pct`: ["mae", "max_adverse", "adverse", "drawdown", "mae_pct"]
    - `win_loss`: ["win", "loss", "result", "outcome"]
  - [x] Implement `auto_detect(columns: list[str]) -> tuple[ColumnMapping | None, dict[str, str]]`
    - Returns tuple of (mapping_if_complete, detection_status_dict)
    - Status dict values: "detected", "guessed", "missing"
  - [x] Implement `_match_column(columns: list[str], patterns: list[str]) -> tuple[str | None, str]`
    - Case-insensitive substring matching
    - Returns (matched_column, status)
  - [x] Implement `save_mapping(file_path: Path, mapping: ColumnMapping) -> None`
    - Generate file hash using MD5 of file path string
    - Save to `.lumen_cache/{file_hash}_mappings.json`
  - [x] Implement `load_mapping(file_path: Path) -> ColumnMapping | None`
    - Load persisted mapping if exists, else return None

- [x] Task 3: Create DetectionResult Dataclass (AC: 3, 4, 5)
  - [x] Add `DetectionResult` to `src/core/models.py`:
    ```python
    @dataclass
    class DetectionResult:
        mapping: ColumnMapping | None
        statuses: dict[str, str]  # column_type -> "detected" | "guessed" | "missing"
        all_required_detected: bool
    ```

- [x] Task 4: Create Column Configuration Panel UI (AC: 3, 4, 5, 6, 7)
  - [x] Create `ColumnConfigPanel` widget in `src/tabs/data_input.py`
  - [x] Create layout with:
    - Header: "Column Mappings" with status summary
    - 5 required dropdowns: Ticker, Date, Time, Gain %, MAE %
    - 1 optional dropdown: Win/Loss
    - Checkbox: "Derive Win/Loss from Gain %" (toggles Win/Loss dropdown)
    - Checkbox: "Count 0% as Win" (only visible when deriving)
    - "Continue" button (disabled until validation passes)
  - [x] Add status indicators next to each dropdown:
    - ✓ (SIGNAL_CYAN) for detected
    - ⚠ (SIGNAL_AMBER) for guessed
    - ✗ (SIGNAL_CORAL) for missing
  - [x] Style using `Colors`, `Spacing`, `Fonts` from `src/ui/constants.py`

- [x] Task 5: Implement Column Preview (AC: 6)
  - [x] Add `QLabel` below each dropdown showing first 3 values
  - [x] Format: "Values: AAPL, GOOGL, MSFT" (truncate if > 3)
  - [x] Update preview when dropdown selection changes
  - [x] Use `TEXT_SECONDARY` color for preview text

- [x] Task 6: Implement Success Summary View (AC: 3)
  - [x] Create `ColumnMappingSuccessPanel` widget
  - [x] Show: "✓ All columns detected automatically"
  - [x] Display detected mappings in compact format
  - [x] Add "Edit Mappings" link/button to switch to full config panel
  - [x] Use `SIGNAL_CYAN` accent color for success state

- [x] Task 7: Implement Validation Logic (AC: 8)
  - [x] Validate all required fields are mapped
  - [x] Check for duplicate column selections
  - [x] Show validation error messages inline
  - [x] Disable "Continue" button until valid
  - [x] Error messages use `SIGNAL_CORAL` color

- [x] Task 8: Integrate with DataInputTab Flow (AC: 9, 10)
  - [x] After successful file load, call `ColumnMapper.auto_detect()`
  - [x] Check for existing persisted mapping first (cache hit)
  - [x] Show success panel if all required detected, else show config panel
  - [x] On "Continue" click:
    - [x] Call `ColumnMapper.save_mapping()` to persist
    - [x] Emit signal or call method to proceed to next step
    - [x] Log mapping completion at INFO level
  - [x] Connect to `data_loaded` signal from Story 1.3

- [x] Task 9: Write Unit Tests for ColumnMapper (AC: 1, 2, 8, 9)
  - [x] Create `tests/unit/test_column_mapper.py`
  - [x] Test `auto_detect()` with standard column names returns complete mapping
  - [x] Test `auto_detect()` with non-standard names returns partial/None
  - [x] Test case-insensitive matching ("TICKER", "Ticker", "ticker")
  - [x] Test `save_mapping()` creates JSON file in cache
  - [x] Test `load_mapping()` returns saved mapping
  - [x] Test `load_mapping()` returns None for non-existent
  - [x] Test duplicate column validation fails

- [x] Task 10: Write Unit Tests for ColumnMapping Model
  - [x] Create `tests/unit/test_models.py`
  - [x] Test `validate()` with valid columns returns empty list
  - [x] Test `validate()` with missing column returns error
  - [x] Test `validate()` with invalid win_loss column returns error
  - [x] Test dataclass field defaults

- [x] Task 11: Write Widget Tests for ColumnConfigPanel
  - [x] Create `tests/widget/test_column_config_panel.py`
  - [x] Test panel has 5 required dropdowns (including MAE %)
  - [x] Test panel has Win/Loss dropdown
  - [x] Test "Derive Win/Loss" checkbox toggles dropdown visibility
  - [x] Test status indicators display correctly
  - [x] Test preview updates on selection change
  - [x] Test "Continue" button disabled when invalid
  - [x] Test "Continue" button enabled when valid

- [x] Task 12: Verify Integration (AC: 1-10)
  - [x] Run `uv run python -m src.main` and verify:
    - [x] Load file triggers auto-detection
    - [x] Success summary shown for standard column names
    - [x] Config panel shown for non-standard names
    - [x] Dropdowns show all DataFrame columns
    - [x] Status indicators correct per detection result
    - [x] Preview shows actual column values
    - [x] Continue persists mapping and proceeds
  - [x] Run `make lint` and fix any issues
  - [x] Run `make typecheck` and fix any issues
  - [x] Run `make test` and verify all tests pass

## Dev Notes

### Previous Story Insights
[Source: Story 1.3 Dev Agent Record]

- `data_loaded` signal exists: After successful file load, Story 1.3 emits signal to trigger column detection
- DataInputTab has `_df: pd.DataFrame | None` storing loaded data
- FileLoadWorker emits `finished(object)` with DataFrame on success
- `.lumen_cache/` directory may already exist from future cache story; create if needed
- QtBot type annotations required: `from pytestqt.qtbot import QtBot`
- ruff config uses `[tool.ruff.lint]` section

### ColumnMapping Data Model
[Source: architecture/4-data-models.md#ColumnMapping]

```python
# src/core/models.py
from dataclasses import dataclass

@dataclass
class ColumnMapping:
    """Mapping of required columns to DataFrame column names."""

    ticker: str
    date: str
    time: str
    gain_pct: str
    mae_pct: str  # Required for stop loss calculations
    win_loss: str | None = None  # None = derive from gain_pct
    win_loss_derived: bool = False
    breakeven_is_win: bool = False  # When deriving, is 0% gain a win?

    def validate(self, df_columns: list[str]) -> list[str]:
        """Validate mapping against DataFrame columns. Returns list of errors."""
        errors = []
        required = [self.ticker, self.date, self.time, self.gain_pct, self.mae_pct]
        for col in required:
            if col not in df_columns:
                errors.append(f"Column '{col}' not found in data")
        if self.win_loss and self.win_loss not in df_columns:
            errors.append(f"Win/Loss column '{self.win_loss}' not found")
        return errors
```

### ColumnMapper Component
[Source: architecture/5-components.md#ColumnMapper]

```python
# src/core/column_mapper.py
class ColumnMapper:
    """Auto-detect and manage column mappings."""

    PATTERNS = {
        "ticker": ["ticker", "symbol", "stock", "security"],
        "date": ["date", "trade_date", "entry_date"],
        "time": ["time", "trade_time", "entry_time"],
        "gain_pct": ["gain", "return", "pnl", "profit", "%"],
        "mae_pct": ["mae", "max_adverse", "adverse", "drawdown", "mae_pct"],
        "win_loss": ["win", "loss", "result", "outcome"],
    }

    def auto_detect(self, columns: list[str]) -> ColumnMapping | None:
        """Attempt auto-detection of column mapping."""
        ...

    def save_mapping(self, file_path: Path, mapping: ColumnMapping) -> None:
        """Persist mapping to cache."""
        ...

    def load_mapping(self, file_path: Path) -> ColumnMapping | None:
        """Load persisted mapping if exists."""
        ...
```

### File Hash for Cache Key
[Source: architecture/5-components.md#CacheManager]

Use MD5 hash of file path + sheet name for cache key:
```python
import hashlib

def _get_file_hash(file_path: Path, sheet: str | None = None) -> str:
    key = str(file_path) + (sheet or "")
    return hashlib.md5(key.encode()).hexdigest()
```

### UI Constants Available
[Source: src/ui/constants.py - from Story 1.2]

```python
class Colors:
    BG_BASE = "#0C0C12"
    BG_SURFACE = "#141420"
    BG_ELEVATED = "#1E1E2C"
    BG_BORDER = "#2A2A3A"
    SIGNAL_CYAN = "#00FFD4"   # Success / detected
    SIGNAL_CORAL = "#FF4757"  # Error / missing
    SIGNAL_AMBER = "#FFAA00"  # Warning / guessed
    SIGNAL_BLUE = "#4A9EFF"   # Reference
    TEXT_PRIMARY = "#F4F4F8"
    TEXT_SECONDARY = "#9898A8"
    TEXT_DISABLED = "#5C5C6C"

class Spacing:
    XS = 4
    SM = 8
    MD = 12
    LG = 16
    XL = 24
    XXL = 32

class Fonts:
    DATA = "Azeret Mono"
    UI = "Geist"
```

### AppState Integration
[Source: architecture/4-data-models.md#AppState]

AppState has `column_mapping: ColumnMapping | None` property and `column_mapping_changed` signal:
```python
class AppState(QObject):
    column_mapping_changed = Signal(object)  # ColumnMapping

    def __init__(self) -> None:
        self.column_mapping: ColumnMapping | None = None
```

Note: AppState class does NOT exist yet - will be created in a later story. For Story 1.4, store mapping in DataInputTab temporarily and emit signal for future integration.

### Error Handling
[Source: architecture/10-error-handling-resilience.md]

| Error Case | User Message |
|------------|--------------|
| Column missing | "Required column not mapped: {column}" |

Use existing `ColumnMappingError` from `src/core/exceptions.py` for validation failures.

### Coding Standards
[Source: architecture/9-coding-standards.md]

- **Line length**: 100 characters
- **Python version**: 3.11+
- **Naming**:
  - Modules: snake_case (e.g., `column_mapper.py`)
  - Classes: PascalCase (e.g., `ColumnMapper`)
  - Functions: snake_case (e.g., `auto_detect()`)
  - Qt Signals: snake_case (e.g., `mapping_completed`)
  - Qt Slots: on_noun_verb (e.g., `on_continue_clicked`)
- **Type hints**: Required for all public APIs
- **Logging**: Use `logging.getLogger(__name__)` pattern

### Logging Pattern
[Source: architecture/9-coding-standards.md#logging-guidelines]

```python
import logging
logger = logging.getLogger(__name__)

# INFO: User actions, workflow milestones
logger.info("Column mapping completed: ticker=%s, date=%s, time=%s, gain=%s",
            mapping.ticker, mapping.date, mapping.time, mapping.gain_pct)

# WARNING: Recoverable issues
logger.warning("Could not auto-detect column: %s", column_type)

# DEBUG: Internal state
logger.debug("Detection status: %s", statuses)
```

### File Locations
[Source: architecture/2-high-level-architecture.md#repository-structure]

| File | Purpose |
|------|---------|
| `src/core/models.py` | ColumnMapping, DetectionResult dataclasses |
| `src/core/column_mapper.py` | Auto-detection + manual mapping logic |
| `src/tabs/data_input.py` | Extended with ColumnConfigPanel widget |
| `.lumen_cache/{hash}_mappings.json` | Persisted column mappings |
| `tests/unit/test_column_mapper.py` | ColumnMapper unit tests |
| `tests/unit/test_models.py` | Data model unit tests |
| `tests/widget/test_column_config_panel.py` | Widget tests |

### Core Workflow Reference
[Source: architecture/6-core-workflows.md#workflow-1]

Story 1.4 continues Workflow 1 after file load:
1. File loaded (Story 1.3) -> raw_df available
2. Auto-detect columns -> ColumnMapper
3. [If mapping incomplete] Show Config Panel
4. User completes mapping
5. Persist mapping to cache
6. Proceed to first trigger (Story 1.5)

### Project Structure Notes

Files to CREATE:
- `src/core/models.py` - New file for data models
- `src/core/column_mapper.py` - New file for column mapping logic
- `tests/unit/test_column_mapper.py` - New test file
- `tests/unit/test_models.py` - New test file
- `tests/widget/test_column_config_panel.py` - New test file

Files to MODIFY:
- `src/tabs/data_input.py` - Add ColumnConfigPanel, ColumnMappingSuccessPanel widgets

## Testing

### Test File Locations
[Source: architecture/8-testing-strategy.md]

- Unit tests: `tests/unit/`
- Widget tests: `tests/widget/`

### Testing Standards
[Source: architecture/8-testing-strategy.md]

- Use pytest as test framework
- Use pytest-qt for widget testing
- Shared fixtures in `tests/conftest.py`
- Add `qtbot: QtBot` type annotation to widget test methods
- Import: `from pytestqt.qtbot import QtBot`

### Test Cases for Story 1.4

**Unit Tests** (`tests/unit/test_column_mapper.py`):
```python
import pytest
from pathlib import Path
from src.core.column_mapper import ColumnMapper
from src.core.models import ColumnMapping

def test_auto_detect_standard_columns():
    """Auto-detect returns complete mapping for standard column names."""
    mapper = ColumnMapper()
    columns = ["ticker", "date", "time", "gain_pct", "win_loss"]
    result = mapper.auto_detect(columns)
    assert result.mapping is not None
    assert result.all_required_detected is True
    assert result.mapping.ticker == "ticker"

def test_auto_detect_case_insensitive():
    """Auto-detect is case-insensitive."""
    mapper = ColumnMapper()
    columns = ["TICKER", "Date", "TIME", "Gain_Pct"]
    result = mapper.auto_detect(columns)
    assert result.mapping is not None
    assert result.mapping.ticker == "TICKER"

def test_auto_detect_partial_match():
    """Auto-detect returns partial result for missing columns."""
    mapper = ColumnMapper()
    columns = ["ticker", "date", "other_column"]
    result = mapper.auto_detect(columns)
    assert result.mapping is None  # Required columns missing
    assert result.all_required_detected is False
    assert result.statuses["time"] == "missing"

def test_save_and_load_mapping(tmp_path):
    """Save and load mapping from cache."""
    mapper = ColumnMapper(cache_dir=tmp_path)
    mapping = ColumnMapping(
        ticker="ticker",
        date="date",
        time="time",
        gain_pct="gain_pct"
    )
    file_path = Path("/fake/path/data.csv")
    mapper.save_mapping(file_path, mapping)

    loaded = mapper.load_mapping(file_path)
    assert loaded is not None
    assert loaded.ticker == "ticker"

def test_load_mapping_not_found(tmp_path):
    """Load returns None for non-existent mapping."""
    mapper = ColumnMapper(cache_dir=tmp_path)
    loaded = mapper.load_mapping(Path("/nonexistent/file.csv"))
    assert loaded is None
```

**Unit Tests** (`tests/unit/test_models.py`):
```python
import pytest
from src.core.models import ColumnMapping, DetectionResult

def test_column_mapping_validate_success():
    """Validate returns empty list for valid columns."""
    mapping = ColumnMapping(
        ticker="ticker",
        date="date",
        time="time",
        gain_pct="gain_pct"
    )
    errors = mapping.validate(["ticker", "date", "time", "gain_pct"])
    assert errors == []

def test_column_mapping_validate_missing():
    """Validate returns errors for missing columns."""
    mapping = ColumnMapping(
        ticker="ticker",
        date="date",
        time="time",
        gain_pct="gain_pct"
    )
    errors = mapping.validate(["ticker", "date"])  # missing time, gain_pct
    assert len(errors) == 2
    assert "time" in errors[0]

def test_column_mapping_defaults():
    """Dataclass defaults are correct."""
    mapping = ColumnMapping(
        ticker="t", date="d", time="ti", gain_pct="g"
    )
    assert mapping.win_loss is None
    assert mapping.win_loss_derived is False
    assert mapping.breakeven_is_win is False
```

**Widget Tests** (`tests/widget/test_column_config_panel.py`):
```python
import pytest
from pytestqt.qtbot import QtBot
from PyQt6.QtWidgets import QComboBox, QPushButton, QCheckBox
from src.tabs.data_input import ColumnConfigPanel

def test_panel_has_required_dropdowns(qtbot: QtBot):
    """Panel has 4 required column dropdowns."""
    panel = ColumnConfigPanel()
    qtbot.addWidget(panel)

    ticker_combo = panel.findChild(QComboBox, "ticker_combo")
    date_combo = panel.findChild(QComboBox, "date_combo")
    time_combo = panel.findChild(QComboBox, "time_combo")
    gain_combo = panel.findChild(QComboBox, "gain_combo")

    assert ticker_combo is not None
    assert date_combo is not None
    assert time_combo is not None
    assert gain_combo is not None

def test_derive_checkbox_toggles_winloss(qtbot: QtBot):
    """Derive Win/Loss checkbox toggles Win/Loss dropdown visibility."""
    panel = ColumnConfigPanel()
    qtbot.addWidget(panel)

    checkbox = panel.findChild(QCheckBox, "derive_winloss_checkbox")
    winloss_combo = panel.findChild(QComboBox, "winloss_combo")

    assert checkbox is not None
    assert winloss_combo is not None

    # Initially not checked, combo visible
    assert winloss_combo.isVisible()

    # Check the box, combo should hide
    checkbox.setChecked(True)
    assert not winloss_combo.isVisible()

def test_continue_button_initially_disabled(qtbot: QtBot):
    """Continue button is disabled until valid."""
    panel = ColumnConfigPanel()
    qtbot.addWidget(panel)

    button = panel.findChild(QPushButton, "continue_button")
    assert button is not None
    assert not button.isEnabled()
```

### Fixtures to Add to conftest.py

```python
# tests/conftest.py additions
from src.core.models import ColumnMapping

@pytest.fixture
def sample_column_mapping() -> ColumnMapping:
    """Standard column mapping for testing."""
    return ColumnMapping(
        ticker="ticker",
        date="date",
        time="time",
        gain_pct="gain_pct",
        win_loss_derived=True,
    )

@pytest.fixture
def sample_columns() -> list[str]:
    """Standard DataFrame columns for testing."""
    return ["ticker", "date", "time", "gain_pct", "win_loss", "volume", "price"]
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-10 | 0.1 | Initial draft | SM Agent (Bob) |
| 2026-01-10 | 1.0 | Implementation complete - all tasks done, tests passing | Dev Agent (James) |
| 2026-01-11 | 1.1 | **RETROFIT REQUIRED**: Added mae_pct as required column per Sprint Change Proposal | PM Agent (John) |

## Retrofit Notes (2026-01-11)

**Retrofit Complete (2026-01-11)**

**Changes implemented:**
1. ✓ Added `mae_pct: str` field to `ColumnMapping` dataclass in `src/core/models.py`
2. ✓ Added `mae_pct` to `PATTERNS` dict in `src/core/column_mapper.py`
3. ✓ Updated `validate()` method to include `mae_pct` in required columns
4. ✓ Added 5th dropdown for MAE % in `ColumnConfigPanel`
5. ✓ Updated unit tests for new required field
6. ✓ Updated widget tests for 5 required dropdowns

**Reference:** `docs/sprint-change-proposal-efficiency-stoploss.md`

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered.

### Completion Notes List

- All 12 tasks completed successfully
- 80 tests passing (26 unit tests for ColumnMapper/Models, 18 widget tests for panels, plus existing tests)
- Lint (ruff) and typecheck (mypy) pass with no errors
- `ColumnMapping` and `DetectionResult` dataclasses created in `src/core/models.py`
- `ColumnMapper` class handles auto-detection, caching, and persistence
- `ColumnConfigPanel` provides full configuration UI with validation
- `ColumnMappingSuccessPanel` provides quick-continue for auto-detected columns
- Integration complete: `DataInputTab` now flows from file load → column detection → mapping panel
- Emits `mapping_completed` signal when user confirms mapping

**Retrofit Completion Notes (2026-01-11):**
- mae_pct added as required field to ColumnMapping dataclass
- PATTERNS dict updated with mae_pct patterns: ["mae", "max_adverse", "adverse", "drawdown", "mae_pct"]
- validate() method updated to check mae_pct in required columns
- ColumnConfigPanel updated to show 5 required dropdowns including MAE %
- All tests updated to include mae_pct in ColumnMapping instantiations
- 424 tests passing, lint and typecheck pass

### File List

**Created:**
- `src/core/models.py` - ColumnMapping and DetectionResult dataclasses
- `src/core/column_mapper.py` - Auto-detection and persistence logic
- `tests/unit/test_column_mapper.py` - 17 unit tests for ColumnMapper
- `tests/unit/test_models.py` - 9 unit tests for data models
- `tests/widget/test_column_config_panel.py` - 18 widget tests for UI panels

**Modified:**
- `src/tabs/data_input.py` - Added ColumnConfigPanel, ColumnMappingSuccessPanel, integration logic
- `tests/conftest.py` - Added fixtures: sample_column_mapping, sample_columns, sample_dataframe

---

## QA Results

### Review Date: 2026-01-10

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent**

The implementation demonstrates high code quality with well-structured dataclasses, clean separation of concerns, and comprehensive UI components. The codebase follows Python best practices including:
- Proper type hints throughout (using `str | None` union syntax)
- Comprehensive docstrings on all public methods
- Appropriate logging at INFO/DEBUG/WARNING levels
- Clean dataclass design with proper defaults
- Well-structured Qt widgets following the project's styling conventions

### Refactoring Performed

None required. The implementation is clean and well-organized.

### Compliance Check

- Coding Standards: ✓ All files pass ruff linting, 100-char line limit respected
- Project Structure: ✓ Files in correct locations per architecture docs
- Testing Strategy: ✓ Unit tests for core logic, widget tests for UI, fixtures in conftest.py
- All ACs Met: ✓ All 10 acceptance criteria verified (see traceability below)

### Acceptance Criteria Traceability

| AC | Description | Implementation | Test Coverage |
|----|-------------|----------------|---------------|
| 1 | Auto-detection for required columns with case-insensitive matching | `ColumnMapper.auto_detect()` with PATTERNS dict | test_auto_detect_* (6 tests) |
| 2 | Auto-detection for optional Win/Loss column | `PATTERNS["win_loss"]` in column_mapper.py:26-27 | test_auto_detect_win_loss_optional |
| 3 | Success summary with "Edit Mappings" option | `ColumnMappingSuccessPanel` widget | test_panel_has_edit_button, test_edit_requested_signal |
| 4 | Blocking config panel if any required missing | `_on_data_loaded()` shows config panel when `all_required_detected=False` | test_status_indicators_display |
| 5 | Dropdowns with status indicators (✓/⚠/✗) | `_update_status_indicators()` in ColumnConfigPanel | test_status_indicators_display |
| 6 | Preview shows first 3 values | `_update_preview()` gets first 3 values from df | test_preview_updates_on_selection |
| 7 | Win/Loss can be explicit or derived | `_derive_checkbox` toggles, `breakeven_is_win` option | test_derive_checkbox_toggles_winloss, test_breakeven_checkbox_visibility |
| 8 | Validation: required mapped, no duplicates | `_validate()` checks required and duplicates | test_validation_error_on_duplicate, test_continue_button_* |
| 9 | Persist mappings to cache | `ColumnMapper.save_mapping()` to `.lumen_cache/{hash}_mappings.json` | test_save_and_load_mapping (6 tests) |
| 10 | On Continue, store mappings and proceed | `_on_mapping_continue()` saves and emits signal | test_mapping_completed_signal |

### Improvements Checklist

All implemented correctly, no changes required:

- [x] ColumnMapping dataclass with proper validation
- [x] DetectionResult dataclass with status tracking
- [x] ColumnMapper with auto-detection, caching, and persistence
- [x] ColumnConfigPanel with full configuration UI
- [x] ColumnMappingSuccessPanel for auto-detected success case
- [x] DataInputTab integration with file load workflow
- [x] Comprehensive test coverage (44 tests)

### Security Review

No security concerns identified:
- No user input is used in file paths without sanitization
- Cache files use MD5 hash of file path as key (not user input)
- JSON parsing has proper exception handling

### Performance Considerations

No performance issues identified:
- Auto-detection is O(n*m) where n=columns, m=patterns - negligible for typical data
- Cache lookup is O(1) file read
- UI updates are minimal and well-contained

### Files Modified During Review

None. No refactoring was needed.

### Gate Status

Gate: PASS → docs/qa/gates/1.4-column-configuration-panel.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria are met with comprehensive test coverage. The implementation follows project standards and demonstrates excellent code quality.

---

### Retrofit Review Date: 2026-01-11

### Reviewed By: Quinn (Test Architect)

### Retrofit Code Quality Assessment

**Overall: Excellent** - The mae_pct retrofit was implemented cleanly with minimal changes.

**Verified Changes:**
1. ✓ `mae_pct: str` field added to `ColumnMapping` dataclass (models.py:31)
2. ✓ `mae_pct` patterns added: `["mae", "max_adverse", "adverse", "drawdown", "mae_pct"]` (column_mapper.py:26)
3. ✓ `REQUIRED_COLUMNS` updated to include `mae_pct` (column_mapper.py:30)
4. ✓ `validate()` method checks `mae_pct` in required columns (models.py:46)
5. ✓ Auto-detect creates mapping with `mae_pct` field (column_mapper.py:69)
6. ✓ Logging includes `mae_pct` column (column_mapper.py:73-78)

### Retrofit Test Verification

| Test File | Tests | Status |
|-----------|-------|--------|
| test_column_mapper.py | 17 tests | ✓ All pass |
| test_models.py | 22 tests | ✓ All pass |
| test_column_config_panel.py | 18 tests | ✓ All pass |
| **Total** | **57 tests** | **✓ PASS** |

### Retrofit Compliance Check

- Coding Standards: ✓ Lint passes (ruff)
- Type Safety: ✓ Type check passes (mypy)
- Backward Compatibility: ✓ All existing tests updated
- All Retrofit ACs Met: ✓ mae_pct fully integrated

### Retrofit Gate Status

Gate: **PASS** → docs/qa/gates/1.4-column-configuration-panel.yml (updated)

### Retrofit Recommended Status

✓ **Ready for Done** - Retrofit successfully integrates mae_pct as a required column with full test coverage.
