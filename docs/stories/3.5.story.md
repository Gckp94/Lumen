# Story 3.5: Compounded Kelly Metrics (20-23)

## Status

Done

## Story

**As a** user,
**I want** to see performance with Kelly position sizing,
**so that** I can evaluate optimal growth strategy.

## Acceptance Criteria

1. Calculate: Compounded Kelly PnL, Max DD ($), Max DD (%), DD Duration
2. Reuse equity module from Story 3.4
3. Handle negative Kelly (warning), blown account
4. Store equity curve for charts
5. Recalculate on start_capital or fractional_kelly change

## Tasks / Subtasks

- [ ] Task 1: Extend TradingMetrics Dataclass (AC: 1)
  - [ ] Add new fields to `src/core/models.py` TradingMetrics:
    - [ ] `kelly_pnl: float | None` - Final portfolio value (compounded Kelly)
    - [ ] `kelly_max_dd: float | None` - Maximum drawdown in dollars
    - [ ] `kelly_max_dd_pct: float | None` - Maximum drawdown as percentage of peak
    - [ ] `kelly_dd_duration: int | str | None` - Drawdown duration (int days or "Not recovered")
  - [ ] Update `TradingMetrics.empty()` to include new fields with None defaults
  - [ ] Update TradingMetrics docstring to document new Kelly metrics fields

- [ ] Task 2: Implement calculate_kelly Method in EquityCalculator (AC: 1, 2)
  - [ ] Add method to `src/core/equity.py` EquityCalculator matching architecture spec:
    ```python
    def calculate_kelly(
        self,
        df: pd.DataFrame,
        gain_col: str,
        start_capital: float,
        kelly_fraction: float,
        kelly_pct: float,
    ) -> pd.DataFrame:
        """Calculate compounded Kelly equity curve.

        Args:
            df: DataFrame containing trade data
            gain_col: Column name containing gain percentages (e.g., 5.0 = 5%)
            start_capital: Starting capital in dollars
            kelly_fraction: Kelly fraction as percentage (e.g., 25 = 25% of Kelly)
            kelly_pct: Base Kelly percentage from core metrics (e.g., 12.5 = 12.5%)

        Returns:
            DataFrame with columns: trade_num, pnl, equity, peak, drawdown, position_size

        Raises:
            EquityCalculationError: If gain_col not found or calculation fails
        """
    ```
  - [ ] **NOTE:** kelly_pct is passed from MetricsCalculator (see Task 6 data flow)
  - [ ] Implement Kelly compounding algorithm:
    - [ ] Calculate effective Kelly: `effective_kelly = kelly_pct * (kelly_fraction / 100)`
    - [ ] Position size for each trade = equity * (effective_kelly / 100)
    - [ ] Trade PnL = position_size * (gain_pct / 100)
    - [ ] New equity = previous equity + trade PnL
    - [ ] Track running peak and drawdown (reuse pattern from flat stake)
  - [ ] Add `position_size` column to track bet size for each trade

- [ ] Task 3: Add Blown Account Detection (AC: 3)
  - [ ] In calculate_kelly(), check if equity <= 0 at any point
  - [ ] If equity <= 0:
    - [ ] Log warning with format specifiers: `logger.warning("Account blown at trade %d, equity=%.2f", trade_num, equity)`
    - [ ] Set all remaining equity values to 0
    - [ ] Stop processing further trades
    - [ ] Set dd_duration to "Blown" (special string indicator)
  - [ ] Return results up to the blown point with remaining trades set to equity=0

- [ ] Task 4: Add Negative Kelly Warning (AC: 3)
  - [ ] In calculate_kelly_metrics(), check kelly_pct parameter before calculation
  - [ ] If kelly_pct is negative (passed from MetricsCalculator):
    - [ ] Log warning with format specifiers: `logger.warning("Negative Kelly detected: %.2f%%, strategy has negative expectancy", kelly_pct)`
    - [ ] Return dict with all None values and `warning="negative_kelly"` flag
    - [ ] Do NOT call calculate_kelly() - early return

- [ ] Task 5: Create calculate_kelly_metrics Method (AC: 1, 2)
  - [ ] Add method to EquityCalculator:
    ```python
    def calculate_kelly_metrics(
        self,
        df: pd.DataFrame,
        gain_col: str,
        start_capital: float,
        kelly_fraction: float,
        kelly_pct: float | None,
    ) -> dict[str, float | int | str | pd.DataFrame | None]:
        """Calculate all compounded Kelly metrics.

        Args:
            df: DataFrame containing trade data
            gain_col: Column name containing gain percentages
            start_capital: Starting capital in dollars
            kelly_fraction: Fractional Kelly as percentage (e.g., 25 = 25%)
            kelly_pct: Base Kelly percentage from core metrics (e.g., 12.5).
                       Passed from TradingMetrics.kelly calculated by MetricsCalculator.

        Returns:
            Dict with keys: pnl, max_dd, max_dd_pct, dd_duration, equity_curve, warning
            - warning: None if OK, "negative_kelly" if kelly_pct < 0
        """
    ```
  - [ ] Check for negative Kelly (kelly_pct < 0 or None) and return early with warning if so
  - [ ] Chain: calculate_kelly() → calculate_drawdown_metrics()
  - [ ] Calculate final PnL as: final_equity - start_capital
  - [ ] Return dict for easy unpacking into TradingMetrics

- [ ] Task 6: Integrate Kelly Metrics into MetricsCalculator (AC: 1, 4)
  - [ ] **DATA FLOW for kelly_pct:**
    ```
    MetricsCalculator.calculate()
      → calculates TradingMetrics.kelly (base Kelly % - already done in Story 3.2)
      → passes TradingMetrics.kelly as kelly_pct to EquityCalculator.calculate_kelly_metrics()
      → Kelly equity calculations use this value
    ```
  - [ ] In `src/core/metrics.py` MetricsCalculator.calculate():
    - [ ] Add parameters to method signature:
      ```python
      start_capital: float | None = None,
      fractional_kelly_pct: float | None = None,
      ```
    - [ ] After calculating base Kelly (the `kelly` variable already exists from Story 3.2):
      ```python
      # Kelly metrics (Story 3.5)
      kelly_pnl = None
      kelly_max_dd = None
      kelly_max_dd_pct = None
      kelly_dd_duration = None
      kelly_equity_curve = None
      
      if start_capital is not None and fractional_kelly_pct is not None and num_trades > 0:
          kelly_result = equity_calculator.calculate_kelly_metrics(
              df, gain_col, start_capital, fractional_kelly_pct, kelly  # kelly is base Kelly %
          )
          # ... unpack kelly_result into variables
      ```
    - [ ] Populate TradingMetrics kelly_* fields from returned dict
  - [ ] **RETURN TYPE CHANGE:** Update from 2-tuple to 3-tuple:
    - Current: `tuple[TradingMetrics, pd.DataFrame | None]`
    - New: `tuple[TradingMetrics, pd.DataFrame | None, pd.DataFrame | None]`
    ```python
    return (metrics, flat_stake_equity_curve, kelly_equity_curve)
    ```
  - [ ] **BREAKING CHANGE:** All callers must be updated in same commit (Tasks 10, 11)

- [ ] Task 7: Store Kelly Equity Curve in AppState (AC: 4)
  - [ ] Add to `src/core/app_state.py`:
    ```python
    # Equity curves for charts (Story 3.4 + Story 3.5)
    kelly_equity_curve: pd.DataFrame | None = None
    ```
  - [ ] Add signal for Kelly equity curve updates:
    ```python
    kelly_equity_curve_updated = pyqtSignal(object)  # pd.DataFrame
    ```
  - [ ] Update PnLStatsTab._recalculate_metrics() to:
    - [ ] Handle 3-tuple return from MetricsCalculator.calculate()
    - [ ] Store Kelly equity curve in app_state.kelly_equity_curve
    - [ ] Emit kelly_equity_curve_updated signal

- [ ] Task 8: Add Kelly Metrics to MetricsGrid (AC: 1, 3)
  - [ ] Update `src/ui/components/metrics_grid.py` METRIC_CONFIG:
    ```python
    # Compounded Kelly (Story 3.5 - metrics 20-23)
    ("Kelly PnL", "kelly_pnl", ",.2f"),
    ("Kelly Max DD ($)", "kelly_max_dd", ",.2f"),
    ("Kelly Max DD (%)", "kelly_max_dd_pct", ".2f"),
    ("Kelly DD Duration", "kelly_dd_duration", None),  # Special formatting
    ```
  - [ ] Update METRIC_TOOLTIPS:
    - [ ] "Kelly PnL": "Total profit/loss with compounded Kelly position sizing"
    - [ ] "Kelly Max DD ($)": "Maximum drawdown in dollars (Kelly sizing)"
    - [ ] "Kelly Max DD (%)": "Maximum drawdown as percentage of peak (Kelly sizing)"
    - [ ] "Kelly DD Duration": "Trading days to recover from max drawdown (Kelly sizing)"
  - [ ] Handle special formatting for Kelly DD Duration (same pattern as flat stake):
    - [ ] If int: display as "{value} days"
    - [ ] If "Not recovered": display in coral color
    - [ ] If "Blown": display in coral color with special styling

- [ ] Task 9: Handle Blown Account Display (AC: 3)
  - [ ] In MetricsGrid.update_metrics(), add special case for "Blown":
    ```python
    if field_name == "kelly_dd_duration":
        value = getattr(metrics, field_name)
        if value == "Blown":
            card.update_value("Blown", format_spec=None, color=Colors.SIGNAL_CORAL)
            continue
        # ... existing "Not recovered" and days handling
    ```
  - [ ] Consider adding a warning indicator/tooltip for negative Kelly scenario

- [ ] Task 10: Update PnLStatsTab to Pass Kelly Parameters (AC: 5)
  - [ ] In `src/tabs/pnl_stats.py` `_recalculate_metrics()`:
    ```python
    # Get Kelly parameters from metrics inputs
    start_capital = metrics_inputs.starting_capital if metrics_inputs else 10000.0
    fractional_kelly = metrics_inputs.fractional_kelly if metrics_inputs else 25.0

    # Pass to calculator
    metrics, flat_equity, kelly_equity = self._metrics_calculator.calculate(
        # ... existing params ...
        flat_stake=flat_stake,
        start_capital=start_capital,
        fractional_kelly_pct=fractional_kelly,
    )

    # Store both equity curves
    if flat_equity is not None:
        self._app_state.flat_stake_equity_curve = flat_equity
        self._app_state.equity_curve_updated.emit(flat_equity)
    if kelly_equity is not None:
        self._app_state.kelly_equity_curve = kelly_equity
        self._app_state.kelly_equity_curve_updated.emit(kelly_equity)
    ```

- [ ] Task 11: Update data_input.py for New Return Type (AC: 4)
  - [ ] In `src/tabs/data_input.py`, update any calls to MetricsCalculator.calculate()
  - [ ] Handle 3-tuple return: `(metrics, flat_equity, kelly_equity)`
  - [ ] Use tuple unpacking with explicit ignore: `metrics, flat_equity, _ = calculator.calculate(...)`
  - [ ] **IMPORTANT:** This must be done in same commit as Task 6 to avoid breaking builds

- [ ] Task 12: Verify Recalculation on Parameter Changes (AC: 5)
  - [ ] Verify existing signal chain handles starting_capital changes:
    - [ ] UserInputsPanel.metrics_inputs_changed signal
    - [ ] AppState.metrics_user_inputs_changed signal
    - [ ] PnLStatsTab._on_panel_metrics_changed() handler
    - [ ] PnLStatsTab._schedule_recalculation() debounce
  - [ ] Verify same chain handles fractional_kelly changes
  - [ ] Ensure both parameters flow through to EquityCalculator

- [ ] Task 13: Write Unit Tests for Kelly Calculations (AC: 1, 2, 3)
  - [ ] Add to `tests/unit/test_equity.py`:
    - [ ] TestEquityCalculatorKelly class:
      - [ ] test_kelly_basic - known gains with known Kelly produce expected equity curve
      - [ ] test_kelly_empty_dataframe - returns empty DataFrame
      - [ ] test_kelly_single_trade - edge case
      - [ ] test_kelly_compounding - verify equity compounds correctly
      - [ ] test_kelly_negative_kelly_returns_warning - AC: 3
      - [ ] test_kelly_blown_account - equity goes to zero, "Blown" returned (AC: 3)
      - [ ] test_kelly_blown_stops_processing - no trades after blown
  - [ ] Add drawdown tests specific to Kelly:
    - [ ] test_kelly_max_dd_dollars
    - [ ] test_kelly_max_dd_pct
    - [ ] test_kelly_dd_duration_recovered
    - [ ] test_kelly_dd_duration_not_recovered

- [ ] Task 14: Write Unit Tests for MetricsCalculator Integration (AC: 1, 4)
  - [ ] Add to `tests/unit/test_metrics.py`:
    - [ ] test_kelly_metrics_populated - Kelly fields in TradingMetrics
    - [ ] test_kelly_none_when_no_start_capital
    - [ ] test_kelly_none_when_empty_data
    - [ ] test_kelly_equity_curve_returned
    - [ ] test_negative_kelly_returns_none_metrics

- [ ] Task 15: Write Widget Tests for MetricsGrid Updates (AC: 1, 3)
  - [ ] Add to `tests/widget/test_metrics_grid.py`:
    - [ ] test_metrics_grid_displays_kelly_metrics
    - [ ] test_kelly_dd_duration_displays_days_format
    - [ ] test_kelly_dd_duration_not_recovered_displays_coral
    - [ ] test_kelly_dd_duration_blown_displays_coral

- [ ] Task 16: Manual Verification (AC: 1-5)
  - [ ] Run `make lint` and fix any issues
  - [ ] Run `make typecheck` and fix any issues
  - [ ] Run `make test` and verify all tests pass
  - [ ] Manually verify Kelly metrics display correctly
  - [ ] Manually test changing starting_capital triggers recalculation
  - [ ] Manually test changing fractional_kelly triggers recalculation
  - [ ] Verify "Blown" displays for blown account scenarios
  - [ ] Verify negative Kelly shows warning/empty state

## Dev Notes

### Previous Story Insights
[Source: Story 3.4 Dev Agent Record]

- `EquityCalculator` created in `src/core/equity.py` with flat stake methods
- calculate_flat_stake() returns DataFrame with: trade_num, pnl, equity, peak, drawdown
- calculate_drawdown_metrics() returns tuple: (max_dd_dollars, max_dd_pct, dd_duration)
- MetricsCalculator.calculate() returns tuple: `(metrics, equity_curve)`
- AppState has `flat_stake_equity_curve` and `equity_curve_updated` signal
- Special DD Duration formatting implemented in MetricsGrid.update_metrics()
- MetricCard.update_value() accepts optional `color` parameter for override
- "Not recovered" string handled in dd_duration field

### Architecture: EquityCalculator Design
[Source: docs/architecture/5-components.md - EquityCalculator section]

The architecture specifies `calculate_kelly` method signature. **NOTE:** This story extends the
signature with `kelly_pct` parameter to receive the base Kelly percentage from MetricsCalculator:

```python
# src/core/equity.py
class EquityCalculator:
    """Calculate equity curves for flat stake and Kelly."""

    def calculate_kelly(
        self,
        df: pd.DataFrame,
        gain_col: str,
        start_capital: float,
        kelly_fraction: float,
        kelly_pct: float,  # Added: base Kelly % from TradingMetrics.kelly
    ) -> pd.DataFrame:
        """Calculate compounded Kelly equity curve."""
        ...
```

**Rationale for kelly_pct parameter:** The Kelly percentage must be calculated from win/loss
statistics (which MetricsCalculator already computes). Passing it as a parameter avoids
duplicate calculation and ensures consistency with displayed Kelly metric.

### Kelly Data Flow Diagram
[Source: Story 3.5 design decision]

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        MetricsCalculator.calculate()                    │
├─────────────────────────────────────────────────────────────────────────┤
│  1. Calculate base Kelly % (Story 3.2 - already implemented)            │
│     kelly = (win_rate/100) - ((1 - win_rate/100) / rr_ratio) * 100     │
│                                    │                                    │
│                                    ▼                                    │
│  2. If start_capital and fractional_kelly provided:                     │
│     ┌────────────────────────────────────────────────────────────┐     │
│     │  EquityCalculator.calculate_kelly_metrics(                 │     │
│     │      df, gain_col, start_capital, fractional_kelly,        │     │
│     │      kelly_pct=kelly  ◄── Pass calculated Kelly here       │     │
│     │  )                                                         │     │
│     └────────────────────────────────────────────────────────────┘     │
│                                    │                                    │
│                                    ▼                                    │
│  3. Returns: (TradingMetrics, flat_equity, kelly_equity)               │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                   EquityCalculator.calculate_kelly_metrics()            │
├─────────────────────────────────────────────────────────────────────────┤
│  1. Check if kelly_pct < 0 → return warning, skip calculation          │
│  2. effective_kelly = kelly_pct * (kelly_fraction / 100)               │
│  3. Call calculate_kelly() with effective_kelly                        │
│  4. Call calculate_drawdown_metrics() on equity curve                  │
│  5. Return dict with pnl, max_dd, max_dd_pct, dd_duration, equity_curve│
└─────────────────────────────────────────────────────────────────────────┘
```

### Kelly Compounding Algorithm
[Source: Standard trading mathematics]

**Compounded Kelly Position Sizing:**
```python
# Initial state
equity_0 = start_capital

# For each trade i:
# 1. Calculate position size based on current equity and Kelly fraction
effective_kelly = base_kelly_pct * (fractional_kelly / 100)
position_size_i = equity_{i-1} * (effective_kelly / 100)

# 2. Calculate trade PnL
trade_pnl_i = position_size_i * (gain_pct_i / 100)

# 3. Update equity
equity_i = equity_{i-1} + trade_pnl_i

# 4. Track peak and drawdown (same as flat stake)
peak_i = max(peak_{i-1}, equity_i)
drawdown_i = equity_i - peak_i
```

**Final Kelly PnL:**
```python
kelly_pnl = final_equity - start_capital
```

### Edge Cases to Handle
[Source: Epic 3 Story 3.5 AC: 3]

1. **Negative Kelly**: When base Kelly percentage is negative (kelly_pct < 0):
   - Strategy has negative expectancy
   - Log: `logger.warning("Negative Kelly detected: %.2f%%, strategy has negative expectancy", kelly_pct)`
   - Return dict with all None values and `warning="negative_kelly"` flag
   - Do NOT call calculate_kelly() - early return from calculate_kelly_metrics()

2. **Blown Account**: When equity reaches zero or below at trade N:
   - Log: `logger.warning("Account blown at trade %d, equity=%.2f", trade_num, equity)`
   - Set equity[N:] = 0 for all remaining trades
   - Stop processing further trades
   - Set dd_duration to "Blown" (not "Not recovered")
   - Display "Blown" in coral color in UI (same styling as "Not recovered")

### Current TradingMetrics Structure
[Source: src/core/models.py lines 69-182]

Existing fields through Story 3.4 (19 metrics implemented):
- Core Statistics (1-12): num_trades, win_rate, avg_winner, avg_loser, rr_ratio, ev, kelly, edge, fractional_kelly, expected_growth, median_winner, median_loser
- Distribution Data: winner_count, loser_count, winner_std, loser_std, winner_gains, loser_gains, winner_min, winner_max, loser_min, loser_max
- Streak & Loss (13-15): max_consecutive_wins, max_consecutive_losses, max_loss_pct
- Flat Stake (16-19): flat_stake_pnl, flat_stake_max_dd, flat_stake_max_dd_pct, flat_stake_dd_duration

**NEW Fields for Story 3.5 (metrics 20-23):**
```python
# Compounded Kelly Metrics (Story 3.5 - metrics 20-23)
kelly_pnl: float | None = None           # Final portfolio value minus start capital
kelly_max_dd: float | None = None        # Maximum drawdown in dollars
kelly_max_dd_pct: float | None = None    # Maximum drawdown as percentage of peak
kelly_dd_duration: int | str | None = None  # Days, "Not recovered", or "Blown"
```

### MetricsUserInputs Structure
[Source: src/core/models.py lines 235-291]

Already contains all needed fields:
```python
@dataclass
class MetricsUserInputs:
    flat_stake: float = 1000.0          # Used by Story 3.4
    starting_capital: float = 10000.0   # Used by Story 3.5
    fractional_kelly: float = 25.0      # Used by Story 3.5 (and Story 3.2 for fractional_kelly metric)
```

### MetricsGrid METRIC_CONFIG Update
[Source: src/ui/components/metrics_grid.py lines 34-54]

Add after existing 19 metrics:
```python
METRIC_CONFIG = [
    # ... existing 19 metrics (through flat stake) ...
    # Compounded Kelly (Story 3.5 - metrics 20-23)
    ("Kelly PnL", "kelly_pnl", ",.2f"),
    ("Kelly Max DD ($)", "kelly_max_dd", ",.2f"),
    ("Kelly Max DD (%)", "kelly_max_dd_pct", ".2f"),
    ("Kelly DD Duration", "kelly_dd_duration", None),  # Special handling
]
```

**Special Formatting for Kelly DD Duration:**
Same pattern as flat_stake_dd_duration, plus "Blown" handling:
- If value is int: display as "{value} days"
- If value is "Not recovered": display in coral color
- If value is "Blown": display in coral color (account was wiped out)

### File Locations
[Source: architecture/2-high-level-architecture.md#repository-structure]

| File | Purpose | Status |
|------|---------|--------|
| `src/core/models.py` | Add 4 new Kelly TradingMetrics fields | MODIFY |
| `src/core/equity.py` | Add calculate_kelly() and calculate_kelly_metrics() methods | MODIFY |
| `src/core/metrics.py` | Integrate Kelly calculation, update return tuple | MODIFY |
| `src/core/app_state.py` | Add kelly_equity_curve storage + signal | MODIFY |
| `src/ui/components/metrics_grid.py` | Add 4 Kelly metrics to METRIC_CONFIG | MODIFY |
| `src/tabs/pnl_stats.py` | Pass Kelly params, store Kelly equity curve | MODIFY |
| `src/tabs/data_input.py` | Handle 3-tuple return from calculate() | MODIFY |
| `tests/unit/test_equity.py` | Add Kelly unit tests | MODIFY |
| `tests/unit/test_metrics.py` | Add Kelly integration tests | MODIFY |
| `tests/widget/test_metrics_grid.py` | Add Kelly display tests | MODIFY |

### Coding Standards
[Source: architecture/9-coding-standards.md]

- **Line length**: 100 characters
- **Type hints**: Required for all public APIs
- **Naming**:
  - Private methods: Leading underscore (`_check_blown_account()`)
  - Constants: SCREAMING_SNAKE (`METRIC_TOOLTIPS`)
- **Logging**: Use module-level logger
  ```python
  logger.warning("Negative Kelly detected: %.2f%%, strategy has negative expectancy", kelly_pct)
  logger.warning("Account blown at trade %d, equity=%.2f", trade_num, equity)
  ```

### Theme Constants Reference
[Source: src/ui/constants.py]

```python
Colors.SIGNAL_CYAN = "#00FFD4"   # Positive values (PnL gains)
Colors.SIGNAL_CORAL = "#FF4757"  # Negative values (drawdowns, "Not recovered", "Blown")
Colors.TEXT_PRIMARY = "#F4F4F8"  # Neutral values
```

### Sample Test Data with Expected Values
[Source: Manual calculation for test verification]

**Basic Kelly Compounding Test:**

Given:
- start_capital = $10,000
- base_kelly = 10% (meaning bet 10% of equity per trade)
- fractional_kelly = 50% (so effective_kelly = 5%)

| Trade # | Gain % | Position Size | Trade PnL | Equity | Peak | Drawdown |
|---------|--------|---------------|-----------|--------|------|----------|
| 1 | +10.0 | $500 | +$50 | $10,050 | $10,050 | $0 |
| 2 | +5.0 | $502.50 | +$25.13 | $10,075.13 | $10,075.13 | $0 |
| 3 | -15.0 | $503.76 | -$75.56 | $9,999.57 | $10,075.13 | -$75.56 |
| 4 | +8.0 | $499.98 | +$40.00 | $10,039.57 | $10,075.13 | -$35.56 |
| 5 | +6.0 | $501.98 | +$30.12 | $10,069.69 | $10,075.13 | -$5.44 |

Expected Results:
- Kelly PnL: **$69.69** (final equity - start capital)
- Max DD ($): **$75.56** (at trade 3)
- Max DD (%): **0.75%** (75.56 / 10,075.13)
- DD Duration: **Not recovered** (never returns to peak of $10,075.13)

**Blown Account Test:**

Given:
- start_capital = $1,000
- base_kelly = 100% (full Kelly for test)
- fractional_kelly = 100% (so effective_kelly = 100% - very aggressive)

**Scenario: Gradual decline (equity never goes negative):**

| Trade # | Gain % | Position Size | Trade PnL | Equity | Peak | Drawdown |
|---------|--------|---------------|-----------|--------|------|----------|
| 1 | +20.0 | $1,000 | +$200 | $1,200 | $1,200 | $0 |
| 2 | -50.0 | $1,200 | -$600 | $600 | $1,200 | -$600 |
| 3 | -50.0 | $600 | -$300 | $300 | $1,200 | -$900 |
| 4 | -50.0 | $300 | -$150 | $150 | $1,200 | -$1,050 |

This approaches zero but never triggers "Blown" (equity > 0).

**Scenario: Actual account blow (equity <= 0):**

| Trade # | Gain % | Position Size | Trade PnL | Equity | Status |
|---------|--------|---------------|-----------|--------|--------|
| 1 | +10.0 | $1,000 | +$100 | $1,100 | OK |
| 2 | -120.0 | $1,100 | -$1,320 | **-$220** | **BLOWN** |
| 3+ | N/A | 0 | 0 | 0 | Stopped |

Expected Results for Blown Test:
- Kelly PnL: **-$1,000** (lost entire starting capital)
- Max DD ($): **$1,320** (the loss that blew the account)
- Max DD (%): **120%** (exceeded 100% of peak)
- DD Duration: **"Blown"** (special string indicator)

**Detection Logic:** When equity <= 0 at trade N:
1. Log: `logger.warning("Account blown at trade %d, equity=%.2f", N, equity)`
2. Set equity[N:] = 0 for all remaining trades
3. Stop processing further trades
4. Return dd_duration = "Blown"

## Testing

### Test File Locations
- Unit tests: `tests/unit/test_equity.py` (MODIFY - add Kelly tests)
- Unit tests: `tests/unit/test_metrics.py` (MODIFY - add Kelly integration tests)
- Widget tests: `tests/widget/test_metrics_grid.py` (MODIFY - add Kelly display tests)

### Testing Standards
[Source: architecture/8-testing-strategy.md]

- Use pytest as test framework
- Use pytest-qt for widget testing (`qtbot` fixture)
- Test pyramid: 60% unit, 20% widget, 15% integration, 5% manual
- Performance: calculations < 200ms for 100k rows

### Key Test Cases

**Unit Tests (test_equity.py):**
```python
import pytest
import pandas as pd
from src.core.equity import EquityCalculator

class TestEquityCalculatorKelly:
    """Tests for Kelly equity calculations."""

    def test_kelly_basic(self):
        """Basic Kelly equity curve calculation."""
        df = pd.DataFrame({"gain_pct": [10.0, 5.0, -15.0, 8.0, 6.0]})
        calc = EquityCalculator()
        result = calc.calculate_kelly(
            df, gain_col="gain_pct", start_capital=10000.0, kelly_fraction=50.0, kelly_pct=10.0
        )
        assert result["equity"].iloc[0] > 10000.0  # First winning trade
        assert len(result) == 5

    def test_kelly_empty_dataframe(self):
        """Empty DataFrame returns empty result."""
        df = pd.DataFrame({"gain_pct": []})
        calc = EquityCalculator()
        result = calc.calculate_kelly(
            df, gain_col="gain_pct", start_capital=10000.0, kelly_fraction=25.0, kelly_pct=10.0
        )
        assert len(result) == 0

    def test_kelly_compounding(self):
        """Verify Kelly compounds correctly."""
        df = pd.DataFrame({"gain_pct": [10.0, 10.0, 10.0]})
        calc = EquityCalculator()
        result = calc.calculate_kelly(
            df, gain_col="gain_pct", start_capital=10000.0, kelly_fraction=100.0, kelly_pct=10.0
        )
        # With 10% Kelly and 10% gains, equity should compound
        assert result["equity"].iloc[-1] > 10300.0  # More than 3x $100 due to compounding

    def test_kelly_negative_returns_warning(self):
        """Negative Kelly returns None metrics with warning."""
        df = pd.DataFrame({"gain_pct": [5.0, -3.0]})
        calc = EquityCalculator()
        result = calc.calculate_kelly_metrics(
            df, gain_col="gain_pct", start_capital=10000.0,
            kelly_fraction=25.0, kelly_pct=-5.0  # Negative Kelly
        )
        assert result["pnl"] is None
        assert result.get("warning") == "negative_kelly"

    def test_kelly_blown_account(self):
        """Account blown when equity <= 0."""
        # Create scenario where equity goes negative
        df = pd.DataFrame({"gain_pct": [10.0, -200.0]})  # -200% wipes out
        calc = EquityCalculator()
        result = calc.calculate_kelly_metrics(
            df, gain_col="gain_pct", start_capital=1000.0,
            kelly_fraction=100.0, kelly_pct=100.0  # Full Kelly
        )
        assert result["dd_duration"] == "Blown"


class TestKellyDrawdownMetrics:
    """Tests for Kelly drawdown metrics."""

    def test_kelly_max_dd_dollars(self):
        """Max DD in dollars calculated correctly for Kelly."""
        df = pd.DataFrame({"gain_pct": [10.0, -20.0, 5.0]})
        calc = EquityCalculator()
        metrics = calc.calculate_kelly_metrics(
            df, gain_col="gain_pct", start_capital=10000.0,
            kelly_fraction=50.0, kelly_pct=10.0
        )
        assert metrics["max_dd"] > 0

    def test_kelly_dd_duration_recovered(self):
        """Duration returned when Kelly drawdown is recovered."""
        df = pd.DataFrame({"gain_pct": [10.0, -5.0, 10.0, 10.0]})
        calc = EquityCalculator()
        metrics = calc.calculate_kelly_metrics(
            df, gain_col="gain_pct", start_capital=10000.0,
            kelly_fraction=50.0, kelly_pct=10.0
        )
        # Should recover from small drawdown
        if isinstance(metrics["dd_duration"], int):
            assert metrics["dd_duration"] > 0
```

**Widget Tests (test_metrics_grid.py):**
```python
def test_metrics_grid_displays_kelly_metrics(qtbot):
    """Grid includes Kelly metrics."""
    grid = MetricsGrid()
    qtbot.addWidget(grid)
    assert "kelly_pnl" in grid._cards
    assert "kelly_max_dd" in grid._cards
    assert "kelly_max_dd_pct" in grid._cards
    assert "kelly_dd_duration" in grid._cards

def test_kelly_dd_duration_displays_blown(qtbot):
    """Kelly DD Duration 'Blown' displays correctly."""
    grid = MetricsGrid()
    qtbot.addWidget(grid)
    metrics = TradingMetrics(
        num_trades=10, win_rate=50.0, avg_winner=5.0, avg_loser=-5.0,
        rr_ratio=1.0, ev=0.0, kelly=0.0,
        kelly_pnl=-5000.0,
        kelly_max_dd=10000.0,
        kelly_max_dd_pct=100.0,
        kelly_dd_duration="Blown",
    )
    grid.update_metrics(metrics)
    # Verify "Blown" is displayed in coral
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 0.1 | Initial draft | SM Agent (Bob) |
| 2026-01-11 | 0.2 | PO validation fixes: Added kelly_pct parameter to method signatures, clarified data flow with diagram, documented 3-tuple return type change, improved blown account test data with expected values, standardized warning log messages with format specifiers | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

---

## QA Results

### Review Date: 2026-01-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is **high quality** and follows the story specification precisely. The Kelly compounding algorithm is correctly implemented with proper position sizing based on current equity. All edge cases (negative Kelly, blown account, empty data) are handled appropriately with clear warning messages.

**Key Implementation Strengths:**
- Clean separation of concerns: `calculate_kelly()` for the curve, `calculate_kelly_metrics()` for the wrapper
- Proper reuse of `calculate_drawdown_metrics()` from Story 3.4
- Consistent logging with format specifiers as per coding standards
- Type hints on all public methods

### Refactoring Performed

No refactoring was performed. The implementation is clean and follows established patterns from Story 3.4.

### Compliance Check

- Coding Standards: ✓ (Minor linting issues noted below - not blocking)
- Project Structure: ✓ All files in correct locations
- Testing Strategy: ✓ 93 tests passing, comprehensive coverage
- All ACs Met: ✓ See validation below

### Improvements Checklist

- [x] Kelly compounding algorithm implemented correctly
- [x] Negative Kelly warning with early return
- [x] Blown account detection with "Blown" dd_duration
- [x] 3-tuple return from MetricsCalculator.calculate()
- [x] Both callers updated (data_input.py, pnl_stats.py)
- [x] Kelly equity curve storage in AppState
- [x] MetricsGrid displays 4 Kelly metrics (20-23)
- [x] Coral color for "Blown" and "Not recovered" states
- [ ] Fix line length in equity.py:287 (102 > 100) - minor style issue
- [ ] Fix line length in pnl_stats.py:267 (101 > 100) - minor style issue
- [ ] Update isinstance() calls in metrics.py to use `X | Y` syntax (UP038) - minor style issue

### Security Review

No security concerns. The implementation handles numerical calculations for trading metrics with no external input validation requirements beyond what already exists.

### Performance Considerations

The Kelly calculation uses efficient numpy operations with O(n) complexity for n trades. The implementation follows the same performant patterns as flat stake calculations from Story 3.4.

### Acceptance Criteria Validation

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | Calculate: Compounded Kelly PnL, Max DD ($), Max DD (%), DD Duration | ✓ PASS | `calculate_kelly_metrics()` returns all 4 values, stored in TradingMetrics |
| 2 | Reuse equity module from Story 3.4 | ✓ PASS | `calculate_drawdown_metrics()` reused, same EquityCalculator class |
| 3 | Handle negative Kelly (warning), blown account | ✓ PASS | Tests: `test_kelly_negative_kelly_returns_warning`, `test_kelly_blown_account` |
| 4 | Store equity curve for charts | ✓ PASS | `AppState.kelly_equity_curve` + `kelly_equity_curve_updated` signal |
| 5 | Recalculate on start_capital or fractional_kelly change | ✓ PASS | Signal chain verified in PnLStatsTab |

### Test Coverage Summary

| Test Class | Tests | Description |
|------------|-------|-------------|
| TestEquityCalculatorKelly | 8 | Kelly curve calculation, edge cases |
| TestKellyDrawdownMetrics | 5 | DD metrics for Kelly curves |
| TestMetricsCalculatorKellyIntegration | 8 | Full integration with MetricsCalculator |

All 93 unit tests passing in 0.38s.

### Files Modified During Review

None - no modifications made during review.

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/3.5-compounded-kelly-metrics.yml

Minor linting issues found (10 total: 2 line length, 8 isinstance syntax). These are non-blocking style issues that should be addressed but do not affect functionality.

### Recommended Status

✓ Ready for Done (with minor cleanup suggested)

The implementation is complete and functional. The linting issues are cosmetic and can be addressed in a follow-up cleanup commit.
