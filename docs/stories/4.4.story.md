# Story 4.4: PnL Equity Charts

## Status

Done

## Story

**As a** user,
**I want** to visualize my equity curves,
**so that** I can see portfolio growth over time.

## Acceptance Criteria

1. Two charts: Flat Stake PnL, Compounded Kelly
2. Each shows baseline (stellar-blue) and filtered (plasma-cyan) curves
3. Interactive: pan, zoom, crosshair
4. Optional drawdown visualization
5. Consistent Observatory styling
6. Render 10k+ points < 500ms

## Tasks / Subtasks

- [ ] Task 1: Create EquityChart Component (AC: 1, 2, 3, 5)
  - [ ] Create `src/ui/components/equity_chart.py` with `EquityChart` class
  - [ ] Extend PyQtGraph line chart (not scatter like ChartCanvas)
  - [ ] Configure plot widget with Observatory theme:
    - Background: `Colors.BG_SURFACE`
    - Axis pen: `Colors.BG_BORDER`
    - Axis text: `Colors.TEXT_SECONDARY`
  - [ ] Create baseline PlotDataItem with `Colors.SIGNAL_BLUE` (stellar-blue), 2px width
  - [ ] Create filtered PlotDataItem with `Colors.SIGNAL_CYAN` (plasma-cyan), 2px width
  - [ ] Add legend showing "Baseline" and "Filtered" with appropriate colors
  - [ ] Set Y-axis label: "Equity ($)" with `Fonts.DATA` (Azeret Mono)
  - [ ] Set X-axis label: "Trade #"
  - [ ] Add `render_failed` signal (emit `ChartRenderError` message on failure)
  - [ ] Wrap data operations in try/except to emit `render_failed` on error

- [ ] Task 2: Implement EquityChart Crosshair (AC: 3)
  - [ ] Add vertical and horizontal crosshair lines (dashed, `TEXT_SECONDARY`)
  - [ ] Create coordinate label showing "Trade: X, Equity: $Y.YY"
  - [ ] Connect `sigMouseMoved` to update crosshair position
  - [ ] Hide crosshair when mouse leaves chart area
  - [ ] Adjust label anchor to prevent clipping at edges (like ChartCanvas)

- [ ] Task 3: Implement EquityChart Pan/Zoom Interactions (AC: 3)
  - [ ] Enable mouse wheel zoom on both axes
  - [ ] Enable left-click drag for pan
  - [ ] Implement right-click drag for zoom rectangle selection
  - [ ] Double-click to reset view (auto-range)
  - [ ] Emit `range_changed` signal for potential sync between charts
  - [ ] Support keyboard shortcuts: Home key to reset view, +/- for zoom (accessibility)

- [ ] Task 4: Implement Drawdown Visualization Toggle (AC: 4)
  - [ ] Add `show_drawdown` property (bool, default False)
  - [ ] Create `_drawdown_fill` FillBetweenItem below equity curve
  - [ ] Use semi-transparent `SIGNAL_CORAL` (e.g., 50% opacity) for drawdown fill
  - [ ] Fill between equity curve and peak curve (shows drawdown area)
  - [ ] Add `set_drawdown_visible(visible: bool)` method
  - [ ] Update fill when data changes

- [ ] Task 5: Implement EquityChart Data Methods (AC: 1, 2)
  - [ ] Implement `set_baseline(equity_df: pd.DataFrame | None)` method:
    - Extract `trade_num` for X, `equity` for Y from DataFrame
    - Update baseline PlotDataItem
    - Handle None by clearing baseline series
    - Auto-range after update
  - [ ] Implement `set_filtered(equity_df: pd.DataFrame | None)` method:
    - Similar to baseline but for filtered curve
    - Hide series if None (show "—" or just baseline)
  - [ ] Implement `clear()` method to reset both series
  - [ ] Log data updates: `logger.debug("EquityChart updated: %d baseline, %d filtered points", ...)`

- [ ] Task 6: Create _ChartPanel Container Widget (AC: 1, 4)
  - [ ] Create `_ChartPanel` private class in equity_chart.py
  - [ ] Contains: title label, EquityChart, drawdown toggle checkbox
  - [ ] Title styled with `Fonts.UI`, `FontSizes.H2`, `TEXT_PRIMARY`
  - [ ] Checkbox label: "Show Drawdown" with `TEXT_SECONDARY`
  - [ ] Connect checkbox to `EquityChart.set_drawdown_visible()`

- [ ] Task 7: Replace Charts Placeholder in PnLStatsTab (AC: 1, 5)
  - [ ] Import `EquityChart` in `src/tabs/pnl_stats.py`
  - [ ] Remove `_charts_placeholder` EmptyState
  - [ ] Create horizontal layout with two `_ChartPanel` instances:
    - `self._flat_stake_chart_panel` with title "Flat Stake PnL"
    - `self._kelly_chart_panel` with title "Compounded Kelly PnL"
  - [ ] Add to main layout at index 10 (after Charts header)
  - [ ] Set minimum height 250px per chart
  - [ ] Set stretch factor so charts resize proportionally with window
  - [ ] Charts should maintain aspect ratio on window resize (auto-range preserves data visibility)

- [ ] Task 8: Connect Equity Curve Signals in PnLStatsTab (AC: 1, 2)
  - [ ] Connect `app_state.equity_curve_updated` to `_on_equity_curve_updated`
  - [ ] Connect `app_state.kelly_equity_curve_updated` to `_on_kelly_equity_curve_updated`
  - [ ] Connect `app_state.filtered_equity_curve_updated` to `_on_filtered_equity_curve_updated`
  - [ ] Connect `app_state.filtered_kelly_equity_curve_updated` to `_on_filtered_kelly_equity_curve_updated`
  - [ ] Implement slot methods following `_on_noun_verb` pattern to call `set_baseline()` / `set_filtered()` on charts

- [ ] Task 9: Initialize Charts from AppState (AC: 1)
  - [ ] In `_initialize_from_state()`, check if equity curves exist:
    - If `app_state.flat_stake_equity_curve` exists, call `set_baseline()`
    - If `app_state.kelly_equity_curve` exists, call `set_baseline()`
    - If filtered curves exist, call `set_filtered()`
  - [ ] Handle tab switch: refresh charts when tab becomes visible (showEvent)

- [ ] Task 10: Export EquityChart from Components Package (AC: 1)
  - [ ] Add `from src.ui.components.equity_chart import EquityChart` to `__init__.py`
  - [ ] Add `"EquityChart"` to `__all__` list

- [ ] Task 11: Write Unit Tests for EquityChart Data Handling (AC: 1, 2)
  - [ ] Create `tests/unit/test_equity_chart.py`
  - [ ] Test: `set_baseline()` updates baseline PlotDataItem with correct data
  - [ ] Test: `set_filtered()` updates filtered PlotDataItem
  - [ ] Test: `set_baseline(None)` clears baseline series
  - [ ] Test: `set_filtered(None)` hides filtered series
  - [ ] Test: `clear()` resets both series
  - [ ] Test: drawdown fill updates when `set_drawdown_visible(True)`
  - [ ] Test: `render_failed` signal emits on invalid data input

- [ ] Task 12: Write Widget Tests for EquityChart Interactions (AC: 3)
  - [ ] Create `tests/widget/test_equity_chart.py`
  - [ ] Test: chart renders baseline curve with correct color
  - [ ] Test: chart renders filtered curve with correct color
  - [ ] Test: crosshair appears on mouse hover
  - [ ] Test: double-click triggers auto-range
  - [ ] Test: `range_changed` signal emits on zoom
  - [ ] Test: Home key triggers auto-range (accessibility)
  - [ ] Test: +/- keys trigger zoom in/out (accessibility)
  - [ ] Use `qtbot` fixture for widget testing

- [ ] Task 13: Write Performance Tests (AC: 6)
  - [ ] Add to `tests/integration/test_performance.py`
  - [ ] Test: render 10k points in < 500ms
  - [ ] Test: render 83k points in < 1000ms (stretch goal per tech stack)
  - [ ] Use `perf_counter` for timing assertions

- [ ] Task 14: Write Integration Tests for Signal Flow (AC: 1, 2)
  - [ ] Add tests to `tests/integration/test_filter_workflow.py`
  - [ ] Test: `equity_curve_updated` signal triggers chart update
  - [ ] Test: `filtered_equity_curve_updated` adds filtered series
  - [ ] Test: filter removal clears filtered series (shows baseline only)

- [ ] Task 15: Manual Verification (AC: 1-6)
  - [ ] Run `make lint` - verify no errors
  - [ ] Run `make typecheck` - verify no type errors
  - [ ] Run `make test` - all tests pass
  - [ ] Launch application, load sample data
  - [ ] Navigate to PnL Stats tab
  - [ ] Verify Flat Stake chart shows baseline curve (stellar-blue)
  - [ ] Verify Kelly chart shows baseline curve (stellar-blue)
  - [ ] Apply a filter in Feature Explorer
  - [ ] Return to PnL Stats tab - verify filtered curves appear (plasma-cyan)
  - [ ] Test pan (left-drag), zoom (mouse wheel), crosshair (mouse move)
  - [ ] Test zoom rectangle (right-drag)
  - [ ] Double-click to reset view
  - [ ] Enable "Show Drawdown" checkbox - verify coral fill appears
  - [ ] Remove filter - verify filtered curves disappear
  - [ ] Verify charts render smoothly with large dataset (10k+ trades)

## Dev Notes

### Previous Story Insights
[Source: Story 4.3 Dev Agent Record]

- Use `set_values()` instead of `update()` to avoid Qt `QWidget.update()` method conflict
- `metrics_updated` signal emits `(baseline: TradingMetrics, filtered: TradingMetrics | None)` tuple
- Guard clauses for None values prevent crashes
- All tests pass including signal flow verification

### AppState Equity Curve Properties
[Source: src/core/app_state.py]

```python
# Equity curves for charts (Story 3.4 + Story 3.5)
self.flat_stake_equity_curve: pd.DataFrame | None = None
self.kelly_equity_curve: pd.DataFrame | None = None
# Filtered equity curves (Story 4.1)
self.filtered_flat_stake_equity_curve: pd.DataFrame | None = None
self.filtered_kelly_equity_curve: pd.DataFrame | None = None
```

### AppState Equity Curve Signals
[Source: src/core/app_state.py]

```python
equity_curve_updated = pyqtSignal(object)  # pd.DataFrame (Story 3.4)
kelly_equity_curve_updated = pyqtSignal(object)  # pd.DataFrame (Story 3.5)
filtered_equity_curve_updated = pyqtSignal(object)  # pd.DataFrame (filtered flat stake)
filtered_kelly_equity_curve_updated = pyqtSignal(object)  # pd.DataFrame (filtered Kelly)
```

### Equity Curve DataFrame Structure
[Source: src/core/equity.py - EquityCalculator]

Both `calculate_flat_stake()` and `calculate_kelly()` return DataFrames with columns:
- `trade_num`: int (1-indexed trade number, use as X-axis)
- `pnl`: float (per-trade PnL)
- `equity`: float (cumulative equity, use as Y-axis)
- `peak`: float (running peak for drawdown calculation)
- `drawdown`: float (equity - peak, always <= 0)

Kelly also includes:
- `position_size`: float (position size for each trade)

**Note:** The `position_size` column is not visualized in this story. A future story may add position size visualization as a secondary axis or tooltip. For now, only `trade_num`, `equity`, `peak`, and `drawdown` columns are used.

### Drawdown Visualization Logic
[Source: src/core/equity.py]

To visualize drawdown area:
- Fill between `equity` curve and `peak` curve
- The area represents the current drawdown from peak
- Use `FillBetweenItem` from PyQtGraph with semi-transparent coral color

### Current PnL Stats Tab Layout
[Source: src/tabs/pnl_stats.py]

Current layout order (after Story 4.3):
1. Index 0: "Comparison" header
2. Index 1: ComparisonRibbon (4 key metrics)
3. Index 2: Top row layout ("Configuration" header + CalculationStatusIndicator)
4. Index 3: UserInputsPanel (fixed 100px height)
5. Index 4: "Trading Metrics" header
6. Index 5: QStackedWidget (EmptyState | ComparisonGrid)
7. Index 6: "Distribution Statistics" header
8. Index 7: Distribution cards layout
9. Index 8: "Charts" header
10. Index 9: Charts placeholder (EmptyState) - **REPLACE THIS**

**Replace index 9** with two `_ChartPanel` widgets in horizontal layout.

### Existing ChartCanvas for Reference
[Source: src/ui/components/chart_canvas.py]

ChartCanvas is a **scatter plot** widget with:
- PyQtGraph PlotWidget with Observatory styling
- Crosshair with InfiniteLine (vertical + horizontal)
- Coordinate label with adaptive anchor
- Pan mode (left-click drag)
- Zoom rectangle (right-click drag)
- Auto-range on double-click
- Signals: `point_clicked`, `render_failed`, `range_changed`, `view_reset`

**EquityChart differences:**
- Line chart (PlotCurveItem or PlotDataItem) instead of ScatterPlotItem
- Two series (baseline + filtered) instead of one
- Drawdown fill visualization (FillBetweenItem)
- Y-axis as dollar values, X-axis as trade number

### PyQtGraph Line Chart Setup
[Source: PyQtGraph documentation]

```python
# Line chart with PlotDataItem
baseline_curve = pg.PlotDataItem(
    pen=pg.mkPen(color=Colors.SIGNAL_BLUE, width=2),
    antialias=True,
)
plot_widget.addItem(baseline_curve)

# Update data
baseline_curve.setData(x=trade_nums, y=equity_values)

# Drawdown fill
fill = pg.FillBetweenItem(
    curve1=equity_curve,
    curve2=peak_curve,
    brush=pg.mkBrush(color=(255, 71, 87, 128)),  # SIGNAL_CORAL with alpha
)
```

### Color Constants
[Source: src/ui/constants.py]

```python
class Colors:
    SIGNAL_CYAN = "#00FFD4"   # Filtered curves (plasma-cyan)
    SIGNAL_BLUE = "#4A9EFF"   # Baseline curves (stellar-blue)
    SIGNAL_CORAL = "#FF4757"  # Drawdown fill (semi-transparent)
    BG_SURFACE = "#141420"    # Chart background
    BG_BORDER = "#2A2A3A"     # Axis lines
    TEXT_SECONDARY = "#9898A8" # Axis labels, crosshair
    TEXT_PRIMARY = "#F4F4F8"  # Chart title
```

### Coding Standards
[Source: docs/architecture/9-coding-standards.md]

- **Line length:** 100 characters
- **Type hints:** Required for all public APIs
- **Signals:** Past tense naming (`range_changed`, `view_reset`)
- **Slots:** `on_noun_verb` naming (`_on_equity_updated`)
- **Private classes:** Leading underscore (`_ChartPanel`)
- **Constants:** SCREAMING_SNAKE
- **Logging:** Use module-level logger
  ```python
  logger.debug("EquityChart updated: %d baseline, %d filtered points", ...)
  ```

### File Locations
[Source: docs/architecture/2-high-level-architecture.md]

| File | Purpose | Action |
|------|---------|--------|
| `src/ui/components/equity_chart.py` | New EquityChart widget | CREATE |
| `src/ui/components/__init__.py` | Export EquityChart | MODIFY |
| `src/tabs/pnl_stats.py` | Integrate EquityChart | MODIFY |
| `tests/unit/test_equity_chart.py` | Data handling unit tests | CREATE |
| `tests/widget/test_equity_chart.py` | Widget interaction tests | CREATE |
| `tests/integration/test_performance.py` | Performance tests | MODIFY |
| `tests/integration/test_filter_workflow.py` | Integration tests | MODIFY |

### Required Imports for EquityChart
[Source: Project conventions]

```python
# equity_chart.py imports
from __future__ import annotations

import logging
from typing import TYPE_CHECKING

import numpy as np
import pyqtgraph as pg
from PyQt6.QtCore import Qt, pyqtSignal
from PyQt6.QtWidgets import (
    QCheckBox,
    QHBoxLayout,
    QLabel,
    QVBoxLayout,
    QWidget,
)

from src.ui.constants import Colors, Fonts, FontSizes, Spacing

if TYPE_CHECKING:
    import pandas as pd
    from PyQt6.QtCore import QPointF

logger = logging.getLogger(__name__)
```

## Testing

### Test File Locations
- Unit tests: `tests/unit/test_equity_chart.py` (CREATE)
- Widget tests: `tests/widget/test_equity_chart.py` (CREATE)
- Performance tests: `tests/integration/test_performance.py` (MODIFY)
- Integration tests: `tests/integration/test_filter_workflow.py` (MODIFY)

### Testing Standards
[Source: docs/architecture/8-testing-strategy.md]

- Use pytest as test framework
- Use pytest-qt for widget testing (`qtbot` fixture)
- Test pyramid: 60% unit, 20% widget, 15% integration, 5% manual
- Performance tests marked with `@pytest.mark.slow`

### Key Test Cases Summary

| Test File | Test Function | Purpose |
|-----------|---------------|---------|
| `tests/unit/test_equity_chart.py` | test_set_baseline_updates_curve | Baseline data populates curve |
| `tests/unit/test_equity_chart.py` | test_set_filtered_updates_curve | Filtered data populates curve |
| `tests/unit/test_equity_chart.py` | test_set_baseline_none_clears | None clears baseline |
| `tests/unit/test_equity_chart.py` | test_drawdown_fill_visibility | Drawdown toggle works |
| `tests/widget/test_equity_chart.py` | test_baseline_curve_color | Uses SIGNAL_BLUE |
| `tests/widget/test_equity_chart.py` | test_filtered_curve_color | Uses SIGNAL_CYAN |
| `tests/widget/test_equity_chart.py` | test_crosshair_on_hover | Crosshair appears |
| `tests/widget/test_equity_chart.py` | test_double_click_auto_range | Resets view |
| `tests/widget/test_equity_chart.py` | test_home_key_auto_range | Home key resets view (accessibility) |
| `tests/unit/test_equity_chart.py` | test_render_failed_signal | Error handling emits signal |
| `tests/integration/test_performance.py` | test_equity_chart_10k_points | < 500ms for 10k points |
| `tests/integration/test_filter_workflow.py` | test_equity_chart_signal_flow | Signal triggers update |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 0.1 | Initial draft | SM Agent (Bob) |
| 2026-01-11 | 0.2 | Applied validation fixes: slot naming conventions, error handling, accessibility, responsive behavior, test file naming consistency, position_size column note | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

### Review Date: 2026-01-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Implementation demonstrates strong adherence to project standards with well-structured code, comprehensive error handling, and proper separation of concerns.

**equity_chart.py (370 LOC):**
- Clean widget architecture with `_setup_*` initialization pattern
- Proper PyQtGraph configuration (OpenGL enabled, antialiasing)
- Comprehensive crosshair implementation with adaptive label anchor
- Proper error handling with `render_failed` signal emission
- Well-documented with docstrings and type hints

**pnl_stats.py Integration:**
- Correct signal connections to all four equity curve signals
- Proper initialization from AppState with null checks
- showEvent correctly refreshes charts on tab visibility
- Debounced filtered equity curve calculation preserves UI responsiveness

### Refactoring Performed

None required - implementation is clean and follows project patterns.

### Compliance Check

- Coding Standards: ✓ Follows all naming conventions (signals past-tense, slots `_on_noun_verb`, private class `_ChartPanel`)
- Project Structure: ✓ Files in correct locations, proper exports in `__init__.py`
- Testing Strategy: ✓ Pyramid structure maintained (27 unit, 19 widget, 5+ integration, performance tests)
- All ACs Met: ✓ All 6 acceptance criteria have corresponding implementation and tests

### Requirements Traceability

| AC | Description | Test Coverage | Status |
|----|-------------|---------------|--------|
| 1 | Two charts: Flat Stake PnL, Compounded Kelly | `test_chart_panel_has_chart`, integration tests | ✓ |
| 2 | Baseline (stellar-blue) and filtered (plasma-cyan) curves | `test_baseline_curve_uses_signal_blue`, `test_filtered_curve_uses_signal_cyan` | ✓ |
| 3 | Interactive: pan, zoom, crosshair | 7+ interaction tests including keyboard accessibility | ✓ |
| 4 | Optional drawdown visualization | `TestEquityChartDrawdown` class (5 tests) | ✓ |
| 5 | Consistent Observatory styling | Color constant usage verified in widget tests | ✓ |
| 6 | Render 10k+ points < 500ms | `test_equity_chart_10k_points_under_500ms`, 83k stretch goal test | ✓ |

### Improvements Checklist

- [x] All unit tests pass (27 tests in test_equity_chart.py)
- [x] All widget tests pass (19 tests in test_equity_chart.py)
- [x] Performance tests verify <500ms for 10k points, <1000ms for 83k points
- [x] Integration tests verify signal flow (5 tests in TestEquityChartSignalFlow)
- [x] EquityChart exported in `__init__.py`
- [ ] Manual UI verification with live data (Task 15 items 4-16 pending user testing)

### Security Review

No security concerns - component is a pure visualization widget with no external data access, authentication, or sensitive data handling.

### Performance Considerations

- OpenGL rendering enabled (`pg.setConfigOptions(useOpenGL=True)`)
- Antialiasing enabled for visual quality
- Performance targets met:
  - 10k points: <500ms ✓
  - 83k points: <1000ms (stretch goal) ✓
- Debounce timer (300ms) prevents excessive recalculation during filter changes

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: PASS → docs/qa/gates/4.4-pnl-equity-charts.yml
Quality Score: 100

### Recommended Status

✓ Ready for Done

All automated tests pass (835 total). Manual UI verification items (Task 15:4-16) are marked pending in the story and represent standard user acceptance testing that should be performed before deployment.
