# Story 1.3: File Selection & Data Loading

## Status

Done

## Story

**As a** user,
**I want** to select and load my trading data file,
**so that** I can begin analyzing my trades.

## Acceptance Criteria

1. Data Input tab contains file loading section with styled controls
2. "Select File" button opens native file dialog (Excel, CSV filters)
3. File path display shows selected file
4. Sheet selector dropdown for Excel files (populated with sheet names)
5. "Load Data" button triggers loading with progress indicator
6. Success message: "✓ Loaded {n:,} rows from {filename}"
7. Error handling with plain English messages
8. Load completes in < 3 seconds for 100k rows
9. After successful load, trigger column auto-detection

## Tasks / Subtasks

- [x] Task 1: Create Core Exception Classes (AC: 7)
  - [x] Create `src/core/exceptions.py` with exception hierarchy:
    - `LumenError(Exception)` - Base exception
    - `FileLoadError(LumenError)` - File loading failures
    - `ColumnMappingError(LumenError)` - Column mapping issues
  - [x] Add docstrings to each exception class

- [x] Task 2: Create FileLoader Core Class (AC: 2, 5, 8)
  - [x] Create `src/core/file_loader.py` with `FileLoader` class
  - [x] Implement `SUPPORTED_EXTENSIONS = {".xlsx", ".xls", ".csv", ".parquet"}`
  - [x] Implement `get_sheet_names(path: Path) -> list[str]` for Excel files
  - [x] Implement `load(path: Path, sheet: str | None = None) -> pd.DataFrame`
  - [x] Handle file extension detection and appropriate loader selection
  - [x] Use `openpyxl` engine for `.xlsx`, `xlrd` for `.xls`, pandas for `.csv`
  - [x] Wrap I/O errors in `FileLoadError` with user-friendly messages
  - [x] Add logging at INFO level for successful loads, ERROR for failures

- [x] Task 3: Create FileLoadWorker QThread (AC: 5, 8)
  - [x] Create `src/core/file_load_worker.py` with `FileLoadWorker(QThread)` class
  - [x] Define signals: `progress = Signal(int)`, `finished = Signal(object)`, `error = Signal(str)`
  - [x] Implement `run()` method that calls `FileLoader.load()` in background
  - [x] Emit progress at 10% (started), 100% (complete)
  - [x] Emit `finished` with DataFrame on success
  - [x] Emit `error` with user-friendly message on failure

- [x] Task 4: Create Data Input Tab UI Layout (AC: 1, 2, 3, 4, 5)
  - [x] Update `src/tabs/data_input.py` with full UI implementation
  - [x] Create file loading section with:
    - [x] QLabel "Select Data File" section header
    - [x] QPushButton "Select File" styled with theme
    - [x] QLineEdit (read-only) for file path display
    - [x] QComboBox for sheet selection (initially hidden)
    - [x] QPushButton "Load Data" (initially disabled)
  - [x] Apply styling using `Colors` from `src/ui/constants.py`
  - [x] Use proper spacing from `Spacing` constants

- [x] Task 5: Implement File Selection Logic (AC: 2, 3, 4)
  - [x] Connect "Select File" button to slot `_on_select_file_clicked`
  - [x] Use `QFileDialog.getOpenFileName()` with filters:
    - "Excel Files (*.xlsx *.xls)"
    - "CSV Files (*.csv)"
    - "All Supported Files (*.xlsx *.xls *.csv)"
  - [x] On file selection:
    - [x] Update file path display
    - [x] If Excel file: show sheet selector, populate with sheet names
    - [x] If CSV: hide sheet selector
    - [x] Enable "Load Data" button
  - [x] Handle file dialog cancellation gracefully

- [x] Task 6: Implement Data Loading with Progress (AC: 5, 6, 7, 8)
  - [x] Connect "Load Data" button to slot `_on_load_data_clicked`
  - [x] Create and start `FileLoadWorker` with selected file and sheet
  - [x] Show loading indicator (disable buttons, show progress)
  - [x] Connect worker signals:
    - [x] `progress` -> update progress indicator
    - [x] `finished` -> call `_on_load_complete`
    - [x] `error` -> call `_on_load_error`
  - [x] On success: display success message "✓ Loaded {n:,} rows from {filename}"
  - [x] On error: display error toast with plain English message

- [x] Task 7: Create Success/Error Feedback UI (AC: 6, 7)
  - [x] Create styled QLabel for status messages in Data Input tab
  - [x] Success message: "✓ Loaded {n:,} rows from {filename}" in green/cyan text
  - [x] Error message: coral text with clear description
  - [x] Use `TEXT_PRIMARY` for success count, `SIGNAL_CORAL` for errors
  - [x] Format row count with thousands separator: `f"{n:,}"`

- [x] Task 8: Trigger Column Auto-Detection (AC: 9)
  - [x] After successful load, emit signal or call method to trigger column detection
  - [x] Store loaded DataFrame in tab or pass to next story's component
  - [x] Log successful load with row count

- [x] Task 9: Write Unit Tests for FileLoader
  - [x] Create `tests/unit/test_file_loader.py`
  - [x] Test `get_sheet_names()` returns list of sheet names
  - [x] Test `load()` with CSV file returns DataFrame
  - [x] Test `load()` with Excel file and sheet name
  - [x] Test `load()` with invalid file raises `FileLoadError`
  - [x] Test `load()` with missing file raises `FileLoadError`
  - [x] Test supported extensions constant

- [x] Task 10: Write Widget Tests for DataInputTab
  - [x] Create `tests/widget/test_data_input_tab.py`
  - [x] Test tab contains "Select File" button
  - [x] Test file path display is read-only
  - [x] Test "Load Data" button is initially disabled
  - [x] Test sheet selector is initially hidden
  - [x] Import `QtBot` from `pytestqt.qtbot` and type annotate fixtures

- [x] Task 11: Verify Integration (AC: 1-9)
  - [x] Run `uv run python -m src.main` and verify:
    - [x] Data Input tab has styled file loading controls
    - [x] Can select Excel/CSV file via dialog
    - [x] Sheet selector appears for Excel files
    - [x] Loading shows progress and success message
    - [x] Error messages are plain English
  - [x] Run `make lint` and fix any issues
  - [x] Run `make typecheck` and fix any issues
  - [x] Run `make test` and verify all tests pass

## Dev Notes

### Previous Story Insights
[Source: Story 1.2 Dev Agent Record]

- Theme system complete: `src/ui/constants.py` has Colors, Fonts, FontSizes, Spacing, Animation classes
- `src/ui/theme.py` provides `apply_theme()` function
- DataInputTab placeholder exists at `src/tabs/data_input.py` (empty class)
- `src/core/` directory exists with only `__init__.py` - needs new files
- ruff config uses `[tool.ruff.lint]` section (not deprecated `[tool.ruff]`)
- QtBot type annotations required: `from pytestqt.qtbot import QtBot` and `def test_foo(qtbot: QtBot):`

### FileLoader Component Specification
[Source: architecture/5-components.md#FileLoader]

```python
# src/core/file_loader.py
class FileLoader:
    """Load Excel, CSV, and Parquet files."""

    SUPPORTED_EXTENSIONS = {".xlsx", ".xls", ".csv", ".parquet"}

    def load(self, path: Path, sheet: str | None = None) -> pd.DataFrame:
        """Load file into DataFrame."""
        ...

    def get_sheet_names(self, path: Path) -> list[str]:
        """Get sheet names from Excel file."""
        ...
```

### FileLoadWorker QThread Pattern
[Source: architecture/9-coding-standards.md#qt-patterns]

```python
# src/core/file_load_worker.py
from PyQt6.QtCore import QThread, Signal

class FileLoadWorker(QThread):
    progress = Signal(int)
    finished = Signal(object)
    error = Signal(str)

    def __init__(self, path: Path, sheet: str | None = None) -> None:
        super().__init__()
        self.path = path
        self.sheet = sheet

    def run(self) -> None:
        try:
            self.progress.emit(10)
            df = self._load_file()
            self.progress.emit(100)
            self.finished.emit(df)
        except Exception as e:
            self.error.emit(str(e))
```

### Exception Hierarchy
[Source: architecture/9-coding-standards.md#exception-hierarchy]

```python
# src/core/exceptions.py
class LumenError(Exception):
    """Base exception for Lumen application."""

class FileLoadError(LumenError):
    """Raised when file loading fails."""

class ColumnMappingError(LumenError):
    """Raised when column mapping is invalid."""
```

### Error Messages
[Source: architecture/10-error-handling-resilience.md#error-messages]

| Error Case | User Message |
|------------|--------------|
| File not found | "File not found: {filename}" |
| Permission denied | "Cannot access file. Check permissions." |
| Corrupt file | "Unable to read file. The file may be corrupted." |

### Tech Stack for File I/O
[Source: architecture/3-tech-stack.md]

| Technology | Version | Purpose |
|------------|---------|---------|
| Pandas | 2.1+ | DataFrame operations |
| PyArrow | 14.0+ | Parquet read/write |
| openpyxl | 3.1+ | .xlsx file support |

### File Locations
[Source: architecture/2-high-level-architecture.md#repository-structure]

| File | Purpose |
|------|---------|
| `src/core/exceptions.py` | Custom exceptions |
| `src/core/file_loader.py` | Excel/CSV/Parquet loading |
| `src/core/file_load_worker.py` | Background loading QThread |
| `src/tabs/data_input.py` | Tab 1: File loading, column config |
| `tests/unit/test_file_loader.py` | FileLoader unit tests |
| `tests/widget/test_data_input_tab.py` | DataInputTab widget tests |

### UI Constants Available
[Source: src/ui/constants.py - from Story 1.2]

```python
class Colors:
    BG_BASE = "#0C0C12"
    BG_SURFACE = "#141420"
    BG_ELEVATED = "#1E1E2C"
    BG_BORDER = "#2A2A3A"
    SIGNAL_CYAN = "#00FFD4"   # Success
    SIGNAL_CORAL = "#FF4757"  # Error
    TEXT_PRIMARY = "#F4F4F8"
    TEXT_SECONDARY = "#9898A8"
    TEXT_DISABLED = "#5C5C6C"

class Spacing:
    XS = 4
    SM = 8
    MD = 12
    LG = 16
    XL = 24
    XXL = 32
```

### Coding Standards
[Source: architecture/9-coding-standards.md]

- **Line length**: 100 characters
- **Python version**: 3.11+
- **Naming**:
  - Modules: snake_case (e.g., `file_loader.py`)
  - Classes: PascalCase (e.g., `FileLoader`)
  - Functions: snake_case (e.g., `get_sheet_names()`)
  - Qt Signals: snake_case (e.g., `data_loaded`)
  - Qt Slots: on_noun_verb (e.g., `on_load_complete`)
- **Type hints**: Required for all public APIs
- **Logging**: Use `logging.getLogger(__name__)` pattern

### Logging Pattern
[Source: architecture/9-coding-standards.md#logging-guidelines]

```python
import logging
logger = logging.getLogger(__name__)

# INFO: User actions, workflow milestones
logger.info("Loaded %d rows from %s", len(df), path.name)

# WARNING: Recoverable issues
logger.warning("Sheet not specified, using first sheet")

# ERROR: Failures that stop operation
logger.error("Failed to load file: %s", error)
```

### Core Workflow Reference
[Source: architecture/6-core-workflows.md#workflow-1]

Story 1.3 implements the first part of Workflow 1:
1. User selects file -> DataInputTab
2. Load file -> FileLoader
3. Return raw_df to tab

Story 1.4 will continue with column auto-detection and mapping.

### Performance Requirements
[Source: PRD Epic 1 Story 1.3 AC 8]

- Load completes in < 3 seconds for 100k rows (NFR1)
- Use QThread to prevent UI freeze during load

## Testing

### Test File Locations
[Source: architecture/8-testing-strategy.md]

- Unit tests: `tests/unit/`
- Widget tests: `tests/widget/`

### Testing Standards
[Source: architecture/8-testing-strategy.md]

- Use pytest as test framework
- Use pytest-qt for widget testing
- Shared fixtures in `tests/conftest.py`
- Add `qtbot: QtBot` type annotation to widget test methods

### Test Cases for Story 1.3

**Unit Tests** (`tests/unit/test_file_loader.py`):
```python
import pytest
from pathlib import Path
from src.core.file_loader import FileLoader
from src.core.exceptions import FileLoadError

def test_supported_extensions():
    """FileLoader supports xlsx, xls, csv, parquet."""
    loader = FileLoader()
    assert ".xlsx" in loader.SUPPORTED_EXTENSIONS
    assert ".csv" in loader.SUPPORTED_EXTENSIONS

def test_get_sheet_names_returns_list(tmp_path):
    """get_sheet_names returns list of sheet names."""
    # Create test Excel file
    ...

def test_load_csv_returns_dataframe(tmp_path):
    """Load CSV file returns pandas DataFrame."""
    csv_file = tmp_path / "test.csv"
    csv_file.write_text("ticker,date,time,gain\nAAPL,2024-01-01,09:30:00,1.5\n")
    loader = FileLoader()
    df = loader.load(csv_file)
    assert len(df) == 1
    assert "ticker" in df.columns

def test_load_missing_file_raises_error():
    """Loading missing file raises FileLoadError."""
    loader = FileLoader()
    with pytest.raises(FileLoadError):
        loader.load(Path("/nonexistent/file.csv"))

def test_load_invalid_extension_raises_error(tmp_path):
    """Loading unsupported extension raises FileLoadError."""
    bad_file = tmp_path / "test.txt"
    bad_file.write_text("data")
    loader = FileLoader()
    with pytest.raises(FileLoadError):
        loader.load(bad_file)
```

**Widget Tests** (`tests/widget/test_data_input_tab.py`):
```python
import pytest
from pytestqt.qtbot import QtBot
from PyQt6.QtWidgets import QPushButton, QLineEdit, QComboBox
from src.tabs.data_input import DataInputTab

def test_tab_has_select_file_button(qtbot: QtBot):
    """DataInputTab contains Select File button."""
    tab = DataInputTab()
    qtbot.addWidget(tab)
    button = tab.findChild(QPushButton, "select_file_button")
    assert button is not None
    assert "Select File" in button.text()

def test_file_path_display_is_readonly(qtbot: QtBot):
    """File path display is read-only."""
    tab = DataInputTab()
    qtbot.addWidget(tab)
    line_edit = tab.findChild(QLineEdit, "file_path_display")
    assert line_edit is not None
    assert line_edit.isReadOnly()

def test_load_button_initially_disabled(qtbot: QtBot):
    """Load Data button is disabled until file selected."""
    tab = DataInputTab()
    qtbot.addWidget(tab)
    button = tab.findChild(QPushButton, "load_data_button")
    assert button is not None
    assert not button.isEnabled()

def test_sheet_selector_initially_hidden(qtbot: QtBot):
    """Sheet selector is hidden until Excel file selected."""
    tab = DataInputTab()
    qtbot.addWidget(tab)
    combo = tab.findChild(QComboBox, "sheet_selector")
    assert combo is not None
    assert not combo.isVisible()
```

### Fixtures to Add to conftest.py

```python
# tests/conftest.py additions
import pandas as pd
from pathlib import Path

@pytest.fixture
def sample_csv_file(tmp_path) -> Path:
    """Create sample CSV file for testing."""
    csv_file = tmp_path / "trades.csv"
    df = pd.DataFrame({
        "ticker": ["AAPL", "GOOGL", "MSFT"],
        "date": ["2024-01-01", "2024-01-01", "2024-01-02"],
        "time": ["09:30:00", "10:00:00", "09:35:00"],
        "gain_pct": [1.5, -0.8, 2.1],
    })
    df.to_csv(csv_file, index=False)
    return csv_file
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-10 | 0.1 | Initial draft | SM Agent (Bob) |
| 2026-01-10 | 0.2 | Added checkmark to AC6 per Epic specification | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None required - all implementations completed without blockers.

### Completion Notes List

- Added `xlrd>=2.0.0` to dependencies in `pyproject.toml` for .xls file support (required by story spec)
- Fixed pandas `read_excel` behavior: when `sheet_name=None`, pandas returns dict of all sheets; changed to use index `0` for first sheet when no sheet specified
- Fixed B904 lint errors by adding `from None` to exception re-raises
- All 36 tests pass (13 new FileLoader tests + 8 new DataInputTab widget tests + 15 existing)
- Mypy strict mode passes with no errors
- Ruff lint passes with no errors

### File List

| File | Status | Description |
|------|--------|-------------|
| `src/core/exceptions.py` | Created | Exception hierarchy (LumenError, FileLoadError, ColumnMappingError) |
| `src/core/file_loader.py` | Created | FileLoader class for Excel/CSV/Parquet loading |
| `src/core/file_load_worker.py` | Created | QThread worker for background file loading |
| `src/tabs/data_input.py` | Modified | Full UI implementation with file selection, loading, feedback |
| `tests/conftest.py` | Modified | Added fixtures: sample_csv_file, sample_excel_file, sample_parquet_file |
| `tests/unit/test_file_loader.py` | Created | 13 unit tests for FileLoader class |
| `tests/widget/test_data_input_tab.py` | Created | 8 widget tests for DataInputTab |
| `pyproject.toml` | Modified | Added xlrd>=2.0.0 dependency |

---

## QA Results

### Review Date: 2026-01-10

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent implementation.** The code is well-structured, follows established patterns, and demonstrates strong adherence to coding standards. The developer made thoughtful decisions including:
- Proper use of QThread pattern for non-blocking file operations
- Comprehensive error handling with user-friendly messages
- Clean signal/slot architecture for component communication
- Appropriate logging at INFO/ERROR levels

The implementation correctly handles edge cases like file dialog cancellation, missing sheets, and various error conditions.

### Refactoring Performed

None required. The code quality is high and follows established patterns.

### Compliance Check

- Coding Standards: ✓ Naming conventions, type hints, line length all compliant
- Project Structure: ✓ Files placed in correct locations per architecture spec
- Testing Strategy: ✓ Unit and widget tests present; see gaps below
- All ACs Met: ✓ All 9 acceptance criteria implemented correctly

### Improvements Checklist

[Items for team consideration - not blockers]

- [ ] Add performance test for AC8 (100k rows < 3s load time) per NFR1
- [ ] Add integration test verifying success message format matches AC6 spec
- [ ] Add test for `data_loaded` signal emission after successful load (AC9)
- [ ] Consider adding `.xlsb` support in future if users request it

### Security Review

No security concerns. This story handles local file I/O only with no network or authentication components.

### Performance Considerations

- QThread pattern correctly prevents UI blocking during file operations
- AC8 requires < 3s load for 100k rows - implementation uses efficient pandas I/O
- **Note**: Performance test coverage missing; NFR should be validated before production

### Files Modified During Review

None. No refactoring was necessary.

### Requirements Traceability

| AC | Description | Test Coverage |
|----|-------------|---------------|
| 1 | Data Input tab with styled controls | ✓ 4 widget tests |
| 2 | Select File opens native dialog | ⚠ Manual test only |
| 3 | File path display shows selected file | ✓ 2 widget tests |
| 4 | Sheet selector for Excel files | ✓ 3 tests |
| 5 | Load Data triggers with progress | ✓ 2 widget tests |
| 6 | Success message format | ⚠ Implementation verified, no direct test |
| 7 | Error handling plain English | ✓ 3 unit tests |
| 8 | Load < 3s for 100k rows | ✗ No performance test |
| 9 | Trigger column auto-detection | ⚠ Signal implemented, no test |

**Coverage**: 6/9 ACs have direct test coverage; 3 rely on manual verification or lack specific tests.

### Gate Status

Gate: **CONCERNS** → docs/qa/gates/1.3-file-selection-data-loading.yml

**Reason**: Missing performance test for NFR1 (AC8). All functionality is correctly implemented and passing tests, but the 100k row load time requirement lacks automated verification. This is a test coverage gap, not an implementation defect.

### Recommended Status

✓ **Ready for Done** — All functionality implemented correctly. The missing performance test is a recommended improvement but should not block story completion. Team should prioritize adding NFR1 performance test before release.

(Story owner decides final status)
