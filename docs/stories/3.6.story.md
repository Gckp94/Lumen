# Story 3.6: Distribution Statistics Display (24-25)

## Status

Done

## Story

**As a** user,
**I want** to see summary statistics for winners and losers,
**so that** I understand the spread of outcomes.

## Acceptance Criteria

1. Display winner/loser distribution statistics (count, range, mean, median, std)
2. Winner card with plasma-cyan border, loser card with solar-coral border
3. "View Histogram" link (histograms in Epic 4)
4. Calculate suggested bin size

## Tasks / Subtasks

- [x] Task 1: Create DistributionCard Component (AC: 1, 2, 3)
  - [x] Create new file `src/ui/components/distribution_card.py`
  - [x] Define DistributionCard class extending QFrame
  - [x] Apply border color based on card_type (WINNER: cyan, LOSER: coral)
  - [x] Layout structure (vertical) with header, stats grid, histogram link
  - [x] Add `_suggested_bins` property to store calculated bin count
  - [x] Set `objectName` on all value labels for test access
  - [x] Style "View Histogram" link with proper click handling

- [x] Task 2: Add Bin Size Calculation Utility (AC: 4)
  - [x] Add `calculate_suggested_bins()` function to `src/core/metrics.py`
  - [x] Implement Freedman-Diaconis rule with min 5, max 50 cap
  - [x] Handle edge cases: empty list, single value, identical values

- [x] Task 3: Integrate DistributionCards into PnLStatsTab (AC: 1, 2, 3)
  - [x] Import DistributionCard and calculate_suggested_bins
  - [x] Add two DistributionCard instances to layout (below MetricsGrid)
  - [x] Create horizontal layout for distribution cards (side by side)
  - [x] Connect view_histogram_clicked signals to placeholder handlers
  - [x] Update _on_baseline_calculated() and _recalculate_metrics() to populate cards
  - [x] Add _update_distribution_cards() helper method

- [x] Task 4: Export DistributionCard from Components Package (AC: 1)
  - [x] Update `src/ui/components/__init__.py` with import and __all__ export

- [x] Task 5: Write Unit Tests for Bin Size Calculation (AC: 4)
  - [x] Add TestCalculateSuggestedBins class to tests/unit/test_metrics.py
  - [x] 8 tests covering normal data, empty list, single value, identical values, caps

- [x] Task 6: Write Widget Tests for DistributionCard (AC: 1, 2, 3)
  - [x] Create tests/widget/test_distribution_card.py with 20 tests
  - [x] Cover display, stats, signals, properties, styling, None handling

- [x] Task 7: Integration Test - Distribution Cards in Tab (AC: 1, 2)
  - [x] Add TestPnLStatsTabDistributionCards class to tests/widget/test_pnl_stats.py
  - [x] 6 tests covering card existence, types, updates, clearing, handlers, header

- [x] Task 8: Manual Verification (AC: 1-4)
  - [x] Run `make lint` - passed (only pre-existing issues in equity.py)
  - [x] Run `make typecheck` - passed (no issues in 39 files)
  - [x] Run `make test` - passed (623 tests)
  - [ ] Launch application and load sample data (requires manual testing)
  - [ ] Verify winner card shows cyan border, stats, link
  - [ ] Verify loser card shows coral border, stats, link
  - [ ] Click "View Histogram" and verify debug log
  - [ ] Verify cards clear when no data loaded

## Dev Notes

### Previous Story Insights
[Source: Story 3.5 Dev Agent Record - QA Results]

- All 23 metrics (1-23) now display in MetricsGrid
- TradingMetrics already contains distribution data fields (winner_count, loser_count, winner_std, loser_std, winner_gains, loser_gains, winner_min, winner_max, loser_min, loser_max, median_winner, median_loser)
- MetricCard.update_value() supports optional color parameter for override
- Special string handling implemented for DD Duration fields

### Current TradingMetrics Distribution Fields
[Source: src/core/models.py lines 122-140]

The following fields are ALREADY calculated by MetricsCalculator (Story 3.2):

```python
# Distribution Data (Story 1.6)
winner_count: int | None = None
loser_count: int | None = None
winner_std: float | None = None
loser_std: float | None = None
winner_gains: list[float] = field(default_factory=list)  # Raw data for histogram
loser_gains: list[float] = field(default_factory=list)

# Extended Distribution Data (Story 3.2 - metrics 24-25 prep)
winner_min: float | None = None
winner_max: float | None = None
loser_min: float | None = None  # Most negative (worst loss)
loser_max: float | None = None  # Least negative (smallest loss)
```

**Key Insight:** This story does NOT need to modify TradingMetrics or MetricsCalculator. All distribution data is already calculated. This story is purely about DISPLAY in specialized distribution cards.

### Architecture: Component Hierarchy
[Source: docs/architecture/5-components.md - UI Components]

The DistributionCard should follow existing component patterns:
- Extend QFrame like MetricCard
- Emit signals for user interaction
- Use theme constants for colors

**Placement in Layout:**
The distribution cards should go BELOW the MetricsGrid in PnLStatsTab, displayed side-by-side in a horizontal layout.

### Theme Constants Reference
[Source: docs/architecture/9-coding-standards.md - Theme Constants]

```python
# src/ui/constants.py
Colors.SIGNAL_CYAN = "#00FFD4"   # Winner card border
Colors.SIGNAL_CORAL = "#FF4757"  # Loser card border
Colors.SIGNAL_BLUE = "#4A9EFF"   # "View Histogram" link
Colors.TEXT_PRIMARY = "#F4F4F8"  # Stat values
Colors.TEXT_SECONDARY = "#9898A8"  # Stat labels
Colors.BG_ELEVATED = "#1E1E2C"   # Card background

FontSizes.BODY = 13             # Stat labels and values
FontSizes.H2 = 18               # Card header ("Winners"/"Losers")

Spacing.SM = 8                  # Internal padding
Spacing.MD = 12                 # Between stat rows
```

### Freedman-Diaconis Rule for Bin Size
[Source: Statistical best practice]

The Freedman-Diaconis rule is a standard method for determining histogram bin width:

```
bin_width = 2 * IQR * n^(-1/3)
```

Where:
- IQR = Interquartile Range (Q3 - Q1)
- n = number of data points

Then: `num_bins = ceil(data_range / bin_width)`

Apply caps: minimum 5 bins, maximum 50 bins.

### File Locations
[Source: docs/architecture/2-high-level-architecture.md#repository-structure]

| File | Purpose | Status |
|------|---------|--------|
| `src/ui/components/distribution_card.py` | New DistributionCard widget | CREATE |
| `src/ui/components/__init__.py` | Export DistributionCard | MODIFY |
| `src/core/metrics.py` | Add calculate_suggested_bins() utility | MODIFY |
| `src/tabs/pnl_stats.py` | Integrate distribution cards | MODIFY |
| `tests/unit/test_metrics.py` | Add bin calculation tests | MODIFY |
| `tests/widget/test_distribution_card.py` | New widget tests | CREATE |
| `tests/widget/test_pnl_stats.py` | Add integration tests | MODIFY |

### DistributionCard Layout Mockup
[Source: AC 1, 2 design interpretation]

```
┌─────────────────────────────────────────────┐
│  ╭────────────── CYAN BORDER ──────────────╮│
│  │          WINNERS                        ││
│  │                                         ││
│  │   Count:      100                       ││
│  │   Range:      0.50% to 25.00%          ││
│  │   Mean:       5.50%                    ││
│  │   Median:     4.20%                    ││
│  │   Std Dev:    3.10%                    ││
│  │                                         ││
│  │            View Histogram →             ││
│  ╰─────────────────────────────────────────╯│
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│  ╭───────────── CORAL BORDER ──────────────╮│
│  │          LOSERS                         ││
│  │                                         ││
│  │   Count:      75                        ││
│  │   Range:      -15.00% to -0.25%        ││
│  │   Mean:       -4.80%                   ││
│  │   Median:     -3.50%                   ││
│  │   Std Dev:    2.90%                    ││
│  │                                         ││
│  │            View Histogram →             ││
│  ╰─────────────────────────────────────────╯│
└─────────────────────────────────────────────┘
```

### Coding Standards
[Source: docs/architecture/9-coding-standards.md]

- **Line length**: 100 characters
- **Type hints**: Required for all public APIs
- **Naming**:
  - Private methods: Leading underscore (`_setup_ui()`)
  - Constants: SCREAMING_SNAKE (`WINNER`, `LOSER`)
  - Signals: snake_case (`view_histogram_clicked`)
- **Logging**: Use module-level logger
  ```python
  logger.debug("View winner histogram clicked - placeholder for Epic 4")
  ```

## Testing

### Test File Locations
- Unit tests: `tests/unit/test_metrics.py` (MODIFY - add bin calculation tests)
- Widget tests: `tests/widget/test_distribution_card.py` (CREATE)
- Widget tests: `tests/widget/test_pnl_stats.py` (MODIFY - add integration tests)

### Testing Standards
[Source: docs/architecture/8-testing-strategy.md]

- Use pytest as test framework
- Use pytest-qt for widget testing (`qtbot` fixture)
- Test pyramid: 60% unit, 20% widget, 15% integration, 5% manual

### Key Test Cases Summary

| Test File | Test Class/Function | Purpose |
|-----------|---------------------|---------|
| test_metrics.py | TestCalculateSuggestedBins | Bin size calculation edge cases |
| test_distribution_card.py | TestDistributionCard | Widget appearance and behavior |
| test_pnl_stats.py | test_pnl_stats_tab_has_distribution_cards | Integration verification |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 0.1 | Initial draft | SM Agent (Bob) |
| 2026-01-11 | 0.2 | PO validation: Merged Task 4 into Task 1, added card_type property, objectName for labels, QLabel import in tests, improved bin calc edge case handling | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No issues requiring debug log entries.

### Completion Notes List

1. Created DistributionCard component with _ClickableLabel inner class for proper type-safe signal handling
2. Used PyQt6 (project standard) instead of PySide6 mentioned in story
3. Implemented Freedman-Diaconis rule for histogram bin calculation with 5-50 bin caps
4. Added "Distribution Statistics" section header between MetricsGrid and Charts sections
5. All 623 tests pass, typecheck clean, lint clean for new/modified files

### File List

| File | Action |
|------|--------|
| src/ui/components/distribution_card.py | CREATE |
| src/ui/components/__init__.py | MODIFY |
| src/core/metrics.py | MODIFY |
| src/tabs/pnl_stats.py | MODIFY |
| tests/unit/test_metrics.py | MODIFY |
| tests/widget/test_distribution_card.py | CREATE |
| tests/widget/test_pnl_stats.py | MODIFY |

---

## QA Results

### Review Date: 2026-01-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The DistributionCard component follows established patterns from MetricCard, with clean separation of concerns between UI (distribution_card.py) and calculation logic (calculate_suggested_bins in metrics.py). The _ClickableLabel inner class for type-safe signal handling is a particularly elegant solution.

### Refactoring Performed

None required - code is clean and follows project patterns.

### Compliance Check

- Coding Standards: ✓ All new code complies with 9-coding-standards.md
- Project Structure: ✓ Files in correct locations per architecture
- Testing Strategy: ✓ Follows test pyramid (8 unit, 20 widget, 6 integration)
- All ACs Met: ✓ All 4 acceptance criteria fully implemented

### Requirements Traceability

| AC | Requirement | Implementation | Tests |
|----|-------------|----------------|-------|
| 1 | Display distribution statistics | `DistributionCard.update_stats()` displays count, range, mean, median, std | `TestDistributionCardStats` (5 tests) |
| 2 | Winner=cyan, Loser=coral borders | `_apply_style()` uses `Colors.SIGNAL_CYAN/CORAL` | `test_winner_card_has_cyan_border`, `test_loser_card_has_coral_border` |
| 3 | "View Histogram" link | `_ClickableLabel` with `view_histogram_clicked` signal | `test_view_histogram_signal_emitted`, `test_histogram_link_exists` |
| 4 | Suggested bin size calculation | `calculate_suggested_bins()` with Freedman-Diaconis rule | `TestCalculateSuggestedBins` (8 tests) |

### Improvements Checklist

All items completed by developer - no outstanding issues.

- [x] DistributionCard component with themed styling
- [x] Bin size calculation with edge case handling
- [x] Integration into PnLStatsTab with section header
- [x] Signal handlers for histogram clicks (placeholder for Epic 4)
- [x] Comprehensive test coverage (34 tests)

### Security Review

No security concerns - display-only component with no user input processing.

### Performance Considerations

No performance concerns. Freedman-Diaconis calculation uses numpy for optimized percentile/IQR computation.

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.6-distribution-statistics-display.yml

### Test Summary

| Category | Tests | Status |
|----------|-------|--------|
| Unit (bin calculation) | 8 | ✓ All passing |
| Widget (DistributionCard) | 20 | ✓ All passing |
| Integration (PnLStatsTab) | 6 | ✓ All passing |
| **Total** | **34** | **✓ All passing** |

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, clean implementation following project patterns.
