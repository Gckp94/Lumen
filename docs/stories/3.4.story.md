# Story 3.4: Flat Stake Metrics (16-19)

## Status

Done

## Story

**As a** user,
**I want** to see performance with fixed position size,
**so that** I can evaluate my strategy without compounding.

## Acceptance Criteria

1. Calculate: Flat Stake PnL, Max DD ($), Max DD (%), DD Duration
2. Create equity calculation module (`src/core/equity.py`)
3. Store equity curve in app state for charts
4. Display "Not recovered" if drawdown ongoing
5. Recalculate on flat_stake change

## Tasks / Subtasks

- [x] Task 1: Extend TradingMetrics Dataclass (AC: 1)
  - [x] Add new fields to `src/core/models.py` TradingMetrics:
    - [x] `flat_stake_pnl: float | None` - Total PnL in dollars
    - [x] `flat_stake_max_dd: float | None` - Maximum drawdown in dollars
    - [x] `flat_stake_max_dd_pct: float | None` - Maximum drawdown as percentage of peak
    - [x] `flat_stake_dd_duration: int | str | None` - Drawdown duration (int days or "Not recovered")
  - [x] Update `TradingMetrics.empty()` to include new fields with None defaults
  - [x] Update TradingMetrics docstring to document new fields

- [x] Task 2: Create EquityCalculator Module (AC: 2)
  - [x] Create new file `src/core/equity.py`
  - [x] Add module docstring and imports (pandas, logging, typing)
  - [x] Add `EquityCalculationError` to `src/core/exceptions.py`:
    ```python
    class EquityCalculationError(LumenError):
        """Raised when equity curve calculation fails."""
    ```
  - [x] Create `EquityCalculator` class with architecture-compliant signature:
    ```python
    class EquityCalculator:
        """Calculate equity curves for flat stake and Kelly position sizing.
        
        Reusable for Story 3.5 (Kelly metrics).
        """
        
        def calculate_flat_stake(
            self,
            df: pd.DataFrame,
            gain_col: str,
            stake: float,
        ) -> pd.DataFrame:
            """Calculate flat stake equity curve.
            
            Args:
                df: DataFrame containing trade data
                gain_col: Column name containing gain percentages (e.g., 5.0 = 5%)
                stake: Fixed stake amount in dollars
                
            Returns:
                DataFrame with columns: trade_num, pnl, equity, peak, drawdown
                
            Raises:
                EquityCalculationError: If gain_col not found or calculation fails
            """
    ```
  - [x] Implement equity curve calculation:
    - [x] Extract gains series: `gains = df[gain_col]`
    - [x] pnl = stake * (gain_pct / 100) for each trade
    - [x] equity = cumsum(pnl)
    - [x] peak = running maximum of equity
    - [x] drawdown = equity - peak (always <= 0)

- [x] Task 3: Add Drawdown Metrics Calculation to EquityCalculator (AC: 1, 4)
  - [x] Add method to calculate drawdown metrics:
    ```python
    def calculate_drawdown_metrics(
        self,
        equity_df: pd.DataFrame,
    ) -> tuple[float | None, float | None, int | str | None]:
        """Calculate max drawdown and duration.
        
        Returns:
            Tuple of (max_dd_dollars, max_dd_pct, dd_duration)
            - max_dd_dollars: Absolute value of maximum drawdown in dollars
            - max_dd_pct: Maximum drawdown as percentage of peak at that point
            - dd_duration: int (trading days) or "Not recovered"
            
        Note:
            Returns (None, None, None) if no drawdown occurred (equity only increased)
            or if peak is zero/negative (edge case - no valid percentage).
        """
    ```
  - [x] Max DD ($) = min(drawdown column) → absolute value
  - [x] Max DD (%) calculation with edge case handling:
    - [x] If peak_at_max_dd <= 0: return None for max_dd_pct (cannot calculate percentage)
    - [x] Otherwise: max_dd_pct = (max_dd_dollars / peak_at_max_dd) * 100
  - [x] DD Duration algorithm:
    - [x] Find index where max drawdown **percentage** occurs (not dollar amount)
    - [x] Search forward for recovery (equity >= peak_at_max_dd)
    - [x] If recovered: duration = recovery_idx - max_dd_idx
    - [x] If not recovered: return "Not recovered" string (AC: 4)

- [x] Task 4: Create FlatStakeMetrics Calculation Method (AC: 1)
  - [x] Add method to EquityCalculator:
    ```python
    def calculate_flat_stake_metrics(
        self,
        df: pd.DataFrame,
        gain_col: str,
        stake: float,
    ) -> dict:
        """Calculate all flat stake metrics.
        
        Args:
            df: DataFrame containing trade data
            gain_col: Column name containing gain percentages
            stake: Fixed stake amount in dollars
        
        Returns:
            Dict with keys: pnl, max_dd, max_dd_pct, dd_duration, equity_curve
        """
    ```
  - [x] Chain: calculate_flat_stake() → calculate_drawdown_metrics()
  - [x] Return dict for easy unpacking into TradingMetrics

- [x] Task 5: Integrate EquityCalculator into MetricsCalculator (AC: 1, 3)
  - [x] Import EquityCalculator in `src/core/metrics.py`
  - [x] Add parameters to MetricsCalculator.calculate():
    ```python
    flat_stake: float | None = None,  # From MetricsUserInputs
    ```
  - [x] If flat_stake provided and data exists:
    - [x] Call EquityCalculator.calculate_flat_stake_metrics()
    - [x] Populate TradingMetrics flat_stake_* fields

- [x] Task 6: Store Equity Curve in AppState (AC: 3)
  - [x] Add to `src/core/app_state.py`:
    ```python
    # Equity curves for charts (Story 3.4)
    flat_stake_equity_curve: pd.DataFrame | None = None
    ```
  - [x] Add signal for equity curve updates:
    ```python
    equity_curve_updated = pyqtSignal(object)  # pd.DataFrame
    ```
  - [x] Update PnLStatsTab._recalculate_metrics() to:
    - [x] Pass flat_stake from metrics_user_inputs to calculator
    - [x] Store returned equity curve in app_state
    - [x] **Emit signal after storing**: `self._app_state.equity_curve_updated.emit(equity_curve)`

- [x] Task 7: Add Flat Stake Metrics to MetricsGrid (AC: 1, 4)
  - [x] Update `src/ui/components/metrics_grid.py` METRIC_CONFIG:
    ```python
    # Flat Stake (Story 3.4 - metrics 16-19)
    ("Flat Stake PnL", "flat_stake_pnl", ",.2f"),
    ("Max DD ($)", "flat_stake_max_dd", ",.2f"),
    ("Max DD (%)", "flat_stake_max_dd_pct", ".2f"),
    ("DD Duration", "flat_stake_dd_duration", None),  # Special formatting
    ```
  - [x] Update METRIC_TOOLTIPS:
    - [x] "Flat Stake PnL": "Total profit/loss with fixed stake size"
    - [x] "Max DD ($)": "Maximum drawdown in dollars"
    - [x] "Max DD (%)": "Maximum drawdown as percentage of peak equity"
    - [x] "DD Duration": "Trading days to recover from max drawdown"
  - [x] Handle special formatting for DD Duration (int or "Not recovered")
  - [x] Layout: 19 metrics in 7 rows (some rows will have fewer than 3)

- [x] Task 8: Handle Special Formatting for DD Duration (AC: 4)
  - [x] **Implement in MetricsGrid.update_metrics()** (preferred - keeps story-specific logic in MetricsGrid):
    - [ ] Add special case handling before calling MetricCard.update_value():
      ```python
      # In update_metrics(), before updating DD Duration card:
      if field_name == "flat_stake_dd_duration":
          value = getattr(metrics, field_name)
          if isinstance(value, int):
              # Format as "X days"
              card.update_value(f"{value} days", format_spec=None, color=Colors.TEXT_PRIMARY)
          elif value == "Not recovered":
              # Display in coral color
              card.update_value(value, format_spec=None, color=Colors.SIGNAL_CORAL)
          else:
              card.update_value(value)
          continue  # Skip normal processing
      ```
  - [x] Ensure MetricCard.update_value() accepts optional `color` parameter for override

- [x] Task 9: Verify Recalculation on flat_stake Change (AC: 5)
  - [x] **Verify existing signal chain:**
    - [x] UserInputsPanel.metrics_inputs_changed signal
    - [x] AppState.metrics_user_inputs_changed signal
    - [x] PnLStatsTab._on_panel_metrics_changed() handler
    - [x] PnLStatsTab._schedule_recalculation() debounce
  - [x] Ensure flat_stake from MetricsUserInputs flows through to EquityCalculator

- [x] Task 10: Write Unit Tests for EquityCalculator (AC: 1, 2, 4)
  - [x] Create `tests/unit/test_equity.py`
  - [x] Test cases for calculate_flat_stake():
    - [x] test_flat_stake_basic - known gains produce expected equity curve
    - [x] test_flat_stake_empty_series - returns empty DataFrame
    - [x] test_flat_stake_single_trade - edge case
    - [x] test_flat_stake_all_winners - no drawdown
    - [x] test_flat_stake_all_losers - continuous drawdown
  - [x] Test cases for calculate_drawdown_metrics():
    - [x] test_max_dd_calculation - verify dollar amount
    - [x] test_max_dd_pct_calculation - verify percentage
    - [x] test_dd_duration_recovered - returns int days
    - [x] test_dd_duration_not_recovered - returns "Not recovered" (AC: 4)
    - [x] test_no_drawdown - all zeros when equity only increases

- [x] Task 11: Write Unit Tests for MetricsCalculator Integration (AC: 1)
  - [x] Add to `tests/unit/test_metrics.py`:
    - [x] test_flat_stake_metrics_populated
    - [x] test_flat_stake_none_when_no_stake_provided
    - [x] test_flat_stake_none_when_empty_data

- [x] Task 12: Write Widget Tests for MetricsGrid Updates (AC: 1, 4)
  - [x] Add to `tests/widget/test_metrics_grid.py`:
    - [x] test_metrics_grid_displays_flat_stake_metrics
    - [x] test_dd_duration_displays_days_format
    - [x] test_dd_duration_not_recovered_displays_coral

- [x] Task 13: Update PnLStatsTab to Pass flat_stake (AC: 5)
  - [x] In `_recalculate_metrics()`:
    ```python
    # Get flat_stake from metrics inputs
    flat_stake = metrics_inputs.flat_stake if metrics_inputs else 1000.0
    
    # Pass to calculator
    metrics = self._metrics_calculator.calculate(
        # ... existing params ...
        flat_stake=flat_stake,
    )
    ```
  - [x] Store equity_curve in app_state (if returned)

- [x] Task 14: Manual Verification (AC: 1-5)
  - [x] Run `make lint` and fix any issues
  - [x] Run `make typecheck` and fix any issues
  - [x] Run `make test` and verify all tests pass
  - [x] Manually verify flat stake metrics display correctly
  - [x] Manually test changing flat_stake triggers recalculation
  - [x] Verify "Not recovered" displays for ongoing drawdowns

## Dev Notes

### Previous Story Insights
[Source: Story 3.3 Dev Agent Record]

- `MetricsGrid` in `src/ui/components/metrics_grid.py` uses METRIC_CONFIG list for dynamic card creation
- MetricCard.update_value() already implements color coding for positive/negative values
- Debounce pattern: `QTimer.setSingleShot(True)` with 300ms delay (`Animation.DEBOUNCE_METRICS` in `src/ui/constants.py:63`)
- `PnLStatsTab._recalculate_metrics()` gets adjustment_params and metrics_user_inputs from app_state
- MetricsUserInputs already contains flat_stake field (default 1000.0)
- Chronological sorting available via date_col/time_col parameters

### Architecture: EquityCalculator Design
[Source: docs/architecture/5-components.md - EquityCalculator section]

The architecture specifies `src/core/equity.py` as a new module for equity curve calculations:

```python
# src/core/equity.py
class EquityCalculator:
    """Calculate equity curves for flat stake and Kelly."""

    def calculate_flat_stake(
        self,
        df: pd.DataFrame,
        gain_col: str,
        stake: float,
    ) -> pd.DataFrame:
        """Calculate flat stake equity curve."""
        ...

    def calculate_kelly(
        self,
        df: pd.DataFrame,
        gain_col: str,
        start_capital: float,
        kelly_fraction: float,
    ) -> pd.DataFrame:
        """Calculate compounded Kelly equity curve."""
        ...
```

**Note:** This story implements `calculate_flat_stake()` and `calculate_flat_stake_metrics()`. Story 3.5 will add `calculate_kelly()`.

### Current TradingMetrics Structure
[Source: src/core/models.py lines 69-168]

Current fields through Story 3.3:
- Core Statistics (1-12): num_trades, win_rate, avg_winner, avg_loser, rr_ratio, ev, kelly, edge, fractional_kelly, expected_growth, median_winner, median_loser
- Streak & Loss (13-15): max_consecutive_wins, max_consecutive_losses, max_loss_pct
- Distribution Data: winner_count, loser_count, winner_std, loser_std, winner_gains, loser_gains, winner_min, winner_max, loser_min, loser_max

**NEW Fields for Story 3.4 (metrics 16-19):**
```python
# Flat Stake Metrics (Story 3.4 - metrics 16-19)
flat_stake_pnl: float | None = None      # Total PnL in dollars
flat_stake_max_dd: float | None = None   # Max drawdown in dollars
flat_stake_max_dd_pct: float | None = None  # Max drawdown as percentage
flat_stake_dd_duration: int | str | None = None  # Days or "Not recovered"
```

### MetricsUserInputs Structure
[Source: src/core/models.py lines 221-277]

Already contains:
```python
@dataclass
class MetricsUserInputs:
    flat_stake: float = 1000.0
    starting_capital: float = 10000.0
    fractional_kelly: float = 25.0
```

The flat_stake field is already available - just need to pass it through to EquityCalculator.

### Data Flow for Recalculation
[Source: src/tabs/pnl_stats.py + src/core/app_state.py]

Existing recalculation flow:

```
UserInputsPanel
    ↓ emits metrics_inputs_changed(MetricsUserInputs)
PnLStatsTab._on_panel_metrics_changed()
    ↓ stores in app_state.metrics_user_inputs
    ↓ emits app_state.metrics_user_inputs_changed
PnLStatsTab._schedule_recalculation() [debounced 300ms]
    ↓ QTimer timeout
PnLStatsTab._recalculate_metrics()
    ↓ calls MetricsCalculator.calculate(..., flat_stake=flat_stake)
MetricsCalculator
    ↓ calls EquityCalculator.calculate_flat_stake_metrics()
    ↓ populates TradingMetrics flat_stake_* fields
MetricsGrid.update_metrics(metrics)
```

### Equity Curve Calculation Algorithm
[Source: Standard trading metrics definitions]

**Flat Stake Equity Curve:**
```python
# For each trade with gain_pct and fixed stake:
pnl_i = stake * (gain_pct_i / 100)

# Equity curve:
equity_0 = 0  # Start at 0 (gains only)
equity_i = equity_{i-1} + pnl_i

# Peak tracking:
peak_i = max(peak_{i-1}, equity_i)

# Drawdown:
drawdown_i = equity_i - peak_i  # Always <= 0
```

**Max Drawdown Calculation:**
```python
# Calculate drawdown percentage at each point
drawdown_pct = np.where(peak > 0, (drawdown / peak) * -100, 0)  # Positive percentage

# Find index of maximum percentage drawdown (not dollar amount)
max_dd_pct_idx = np.argmax(drawdown_pct)
max_dd_pct = drawdown_pct[max_dd_pct_idx]

# Get dollar amount at that point
max_dd_dollars = abs(drawdown[max_dd_pct_idx])
peak_at_max_dd = peak[max_dd_pct_idx]

# Edge case: if peak is zero or negative, percentage is undefined
if peak_at_max_dd <= 0:
    max_dd_pct = None
```

**Drawdown Duration:**
```python
# Find recovery point (first index after max_dd where equity >= peak_at_max_dd)
for i in range(max_dd_idx + 1, len(equity)):
    if equity[i] >= peak_at_max_dd:
        duration = i - max_dd_idx
        return duration

# If loop completes without finding recovery:
return "Not recovered"
```

### MetricsGrid METRIC_CONFIG Update
[Source: src/ui/components/metrics_grid.py]

Add after existing 15 metrics:
```python
METRIC_CONFIG = [
    # ... existing 15 metrics ...
    # Flat Stake (Story 3.4 - metrics 16-19)
    ("Flat Stake PnL", "flat_stake_pnl", ",.2f"),
    ("Max DD ($)", "flat_stake_max_dd", ",.2f"),
    ("Max DD (%)", "flat_stake_max_dd_pct", ".2f"),
    ("DD Duration", "flat_stake_dd_duration", None),  # Special handling
]
```

**Special Formatting for DD Duration:**
The format_spec=None signals that special formatting is needed:
- If value is int: display as "{value} days"
- If value is "Not recovered": display in coral color

### File Locations
[Source: architecture/2-high-level-architecture.md#repository-structure]

| File | Purpose | Status |
|------|---------|--------|
| `src/core/equity.py` | NEW - Equity curve calculations | CREATE |
| `src/core/models.py` | Add 4 new TradingMetrics fields | MODIFY |
| `src/core/metrics.py` | Integrate EquityCalculator | MODIFY |
| `src/core/app_state.py` | Add equity curve storage + signal | MODIFY |
| `src/ui/components/metrics_grid.py` | Add 4 new metrics to METRIC_CONFIG | MODIFY |
| `src/tabs/pnl_stats.py` | Pass flat_stake to calculator, store equity curve | MODIFY |
| `tests/unit/test_equity.py` | NEW - EquityCalculator unit tests | CREATE |
| `tests/unit/test_metrics.py` | Add flat stake integration tests | MODIFY |
| `tests/widget/test_metrics_grid.py` | Add flat stake display tests | MODIFY |

### Coding Standards
[Source: architecture/9-coding-standards.md]

- **Line length**: 100 characters
- **Type hints**: Required for all public APIs
- **Naming**:
  - Private methods: Leading underscore (`_calculate_drawdown()`)
  - Constants: SCREAMING_SNAKE (`METRIC_TOOLTIPS`)
- **Logging**: Use module-level logger
  ```python
  logger.debug("Calculated equity curve: %d trades, final equity=%.2f", len(gains), equity[-1])
  ```

### Exception Handling
[Source: architecture/9-coding-standards.md#exception-hierarchy]

```python
class EquityCalculationError(LumenError):
    """Raised when equity curve calculation fails."""
```

Add to `src/core/exceptions.py` (already defined in architecture).

### Theme Constants Reference
[Source: src/ui/constants.py]

```python
Colors.SIGNAL_CYAN = "#00FFD4"   # Positive values (PnL gains)
Colors.SIGNAL_CORAL = "#FF4757"  # Negative values (drawdowns, "Not recovered")
Colors.TEXT_PRIMARY = "#F4F4F8"  # Neutral values
```

### Sample Test Data with Expected Values
[Source: Manual calculation for test verification]

Use this reference data to verify equity calculations:

| Trade # | Gain % | PnL ($1000 stake) | Equity | Peak | Drawdown |
|---------|--------|-------------------|--------|------|----------|
| 1 | +5.0 | +50 | 50 | 50 | 0 |
| 2 | +3.0 | +30 | 80 | 80 | 0 |
| 3 | -4.0 | -40 | 40 | 80 | -40 |
| 4 | -2.0 | -20 | 20 | 80 | -60 |
| 5 | +8.0 | +80 | 100 | 100 | 0 |
| 6 | -6.0 | -60 | 40 | 100 | -60 |
| 7 | +4.0 | +40 | 80 | 100 | -20 |
| 8 | +3.0 | +30 | 110 | 110 | 0 |

Expected Results with $1000 stake:
- Flat Stake PnL: **$110** (final equity)
- Max DD ($): **$60** (same dollar amount at trades 4 and 6)
- Max DD (%): **75%** (60/80 at trade 4)
  - **Clarification**: Max DD % is determined by the highest *percentage* drawdown, not dollar amount.
  - Trade 4: $60 drawdown from $80 peak = 75%
  - Trade 6: $60 drawdown from $100 peak = 60%
  - **Answer: 75% at trade 4** (higher percentage wins)
- DD Duration: From trade 4 (max DD %), recovery to peak ($80) occurs at trade 5 → **1 day**

For "Not recovered" test:
| Trade # | Gain % | PnL | Equity | Peak | Drawdown |
|---------|--------|-----|--------|------|----------|
| 1 | +5.0 | +50 | 50 | 50 | 0 |
| 2 | -10.0 | -100 | -50 | 50 | -100 |
| 3 | +3.0 | +30 | -20 | 50 | -70 |

Expected: DD Duration = **"Not recovered"** (equity never returns to peak of 50)

## Testing

### Test File Locations
- Unit tests: `tests/unit/test_equity.py` (CREATE)
- Unit tests: `tests/unit/test_metrics.py` (MODIFY)
- Widget tests: `tests/widget/test_metrics_grid.py` (MODIFY)

### Testing Standards
[Source: architecture/8-testing-strategy.md]

- Use pytest as test framework
- Use pytest-qt for widget testing (`qtbot` fixture)
- Test pyramid: 60% unit, 20% widget, 15% integration, 5% manual
- Performance: calculations < 200ms for 100k rows

### Key Test Cases

**Unit Tests (test_equity.py):**
```python
import pytest
import pandas as pd
from src.core.equity import EquityCalculator

class TestEquityCalculatorFlatStake:
    """Tests for flat stake equity calculations."""

    def test_flat_stake_basic(self):
        """Basic equity curve calculation."""
        df = pd.DataFrame({"gain_pct": [5.0, 3.0, -4.0, -2.0, 8.0]})
        calc = EquityCalculator()
        result = calc.calculate_flat_stake(df, gain_col="gain_pct", stake=1000.0)
        assert result["equity"].iloc[-1] == pytest.approx(100.0, abs=0.01)

    def test_flat_stake_empty_dataframe(self):
        """Empty DataFrame returns empty result."""
        df = pd.DataFrame({"gain_pct": []})
        calc = EquityCalculator()
        result = calc.calculate_flat_stake(df, gain_col="gain_pct", stake=1000.0)
        assert len(result) == 0

    def test_flat_stake_all_winners(self):
        """All winners means no drawdown."""
        df = pd.DataFrame({"gain_pct": [5.0, 3.0, 2.0, 4.0]})
        calc = EquityCalculator()
        result = calc.calculate_flat_stake(df, gain_col="gain_pct", stake=1000.0)
        assert (result["drawdown"] == 0).all()
    
    def test_flat_stake_invalid_column_raises(self):
        """Invalid gain column raises EquityCalculationError."""
        from src.core.exceptions import EquityCalculationError
        df = pd.DataFrame({"other_col": [5.0, 3.0]})
        calc = EquityCalculator()
        with pytest.raises(EquityCalculationError):
            calc.calculate_flat_stake(df, gain_col="gain_pct", stake=1000.0)


class TestDrawdownMetrics:
    """Tests for drawdown metric calculations."""

    def test_max_dd_dollars(self):
        """Max DD in dollars calculated correctly."""
        df = pd.DataFrame({"gain_pct": [5.0, -10.0, 3.0]})
        calc = EquityCalculator()
        metrics = calc.calculate_flat_stake_metrics(df, gain_col="gain_pct", stake=1000.0)
        # Peak at 50, drops to -50, max_dd = 100
        assert metrics["max_dd"] == pytest.approx(100.0, abs=0.01)

    def test_dd_duration_recovered(self):
        """Duration returned when drawdown is recovered."""
        df = pd.DataFrame({"gain_pct": [5.0, 3.0, -4.0, -2.0, 8.0]})
        calc = EquityCalculator()
        metrics = calc.calculate_flat_stake_metrics(df, gain_col="gain_pct", stake=1000.0)
        # Max DD at trade 4, recovered at trade 5
        assert isinstance(metrics["dd_duration"], int)

    def test_dd_duration_not_recovered(self):
        """'Not recovered' returned when drawdown ongoing."""
        df = pd.DataFrame({"gain_pct": [5.0, -10.0, 3.0]})
        calc = EquityCalculator()
        metrics = calc.calculate_flat_stake_metrics(df, gain_col="gain_pct", stake=1000.0)
        # Peak at 50, never returns to 50
        assert metrics["dd_duration"] == "Not recovered"
    
    def test_max_dd_pct_zero_peak_returns_none(self):
        """Zero peak edge case returns None for max_dd_pct."""
        df = pd.DataFrame({"gain_pct": [-5.0, -3.0]})  # Equity never positive
        calc = EquityCalculator()
        metrics = calc.calculate_flat_stake_metrics(df, gain_col="gain_pct", stake=1000.0)
        # Peak is 0, cannot calculate percentage
        assert metrics["max_dd_pct"] is None
```

**Widget Tests (test_metrics_grid.py):**
```python
def test_metrics_grid_displays_flat_stake_metrics(qtbot):
    """Grid includes flat stake metrics."""
    grid = MetricsGrid()
    qtbot.addWidget(grid)
    assert "flat_stake_pnl" in grid._cards
    assert "flat_stake_max_dd" in grid._cards
    assert "flat_stake_max_dd_pct" in grid._cards
    assert "flat_stake_dd_duration" in grid._cards

def test_dd_duration_displays_not_recovered(qtbot):
    """DD Duration 'Not recovered' displays correctly."""
    grid = MetricsGrid()
    qtbot.addWidget(grid)
    metrics = TradingMetrics(
        num_trades=10, win_rate=50.0, avg_winner=5.0, avg_loser=-5.0,
        rr_ratio=1.0, ev=0.0, kelly=0.0,
        flat_stake_pnl=100.0,
        flat_stake_max_dd=50.0,
        flat_stake_max_dd_pct=25.0,
        flat_stake_dd_duration="Not recovered",
    )
    grid.update_metrics(metrics)
    # Verify "Not recovered" is displayed
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 0.1 | Initial draft | SM Agent (Bob) |
| 2026-01-11 | 0.2 | PO validation fixes: aligned method signatures with architecture, added exception class task, clarified signal emission, specified DD Duration formatting location, added edge case handling, improved test cases | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No debugging issues encountered.

### Completion Notes List

- Extended TradingMetrics with 4 new flat stake fields
- Created EquityCalculator module in src/core/equity.py
- Added EquityCalculationError to exceptions.py
- Integrated EquityCalculator into MetricsCalculator (returns tuple now)
- Added equity curve storage and signal in AppState
- Updated MetricsGrid with 4 new flat stake metrics (19 total)
- Implemented special DD Duration formatting ("X days" or "Not recovered" in coral)
- Updated MetricCard.update_value() to accept color override and string values
- Updated PnLStatsTab._recalculate_metrics() to pass flat_stake and store equity curve
- Updated data_input.py calls to handle tuple return from calculate()
- All unit tests, widget tests pass
- Linting and type checking pass

### File List

| File | Action |
|------|--------|
| `src/core/models.py` | MODIFIED - Added 4 flat stake fields to TradingMetrics |
| `src/core/exceptions.py` | MODIFIED - Added EquityCalculationError |
| `src/core/equity.py` | CREATED - EquityCalculator class |
| `src/core/metrics.py` | MODIFIED - Integrated EquityCalculator, returns tuple |
| `src/core/app_state.py` | MODIFIED - Added flat_stake_equity_curve and equity_curve_updated signal |
| `src/ui/components/metrics_grid.py` | MODIFIED - Added 4 flat stake metrics, special DD Duration formatting |
| `src/ui/components/metric_card.py` | MODIFIED - update_value accepts color override and string values |
| `src/tabs/pnl_stats.py` | MODIFIED - Pass flat_stake, store equity curve |
| `src/tabs/data_input.py` | MODIFIED - Handle tuple return from calculate() |
| `tests/unit/test_equity.py` | CREATED - EquityCalculator unit tests |
| `tests/unit/test_metrics.py` | MODIFIED - Added flat stake integration tests, updated for tuple return |
| `tests/widget/test_metrics_grid.py` | MODIFIED - Added flat stake widget tests |

---

## QA Results

### Review Date: 2026-01-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - Clean, well-structured implementation that follows architecture guidelines and coding standards. The EquityCalculator module is well-designed with proper separation of concerns and excellent reusability for Story 3.5 (Kelly metrics).

**Strengths:**
- Vectorized numpy operations for performance
- Comprehensive edge case handling (empty data, zero/negative peaks, ongoing drawdowns)
- Clean integration with existing MetricsCalculator
- Well-documented code with proper type hints
- Special UI formatting for "Not recovered" state handled elegantly

### Refactoring Performed

None required - implementation is clean and follows all standards.

### Compliance Check

- Coding Standards: ✓ Line length (100), type hints, naming conventions, logging
- Project Structure: ✓ Files placed correctly (src/core/equity.py, tests/unit/test_equity.py)
- Testing Strategy: ✓ 60% unit tests achieved with comprehensive coverage
- All ACs Met: ✓ All 5 acceptance criteria verified with tests

### Requirements Traceability

| AC | Test Coverage | Status |
|----|---------------|--------|
| AC1: Calculate metrics | test_flat_stake_pnl, test_max_dd_dollars, test_max_dd_pct_calculation, test_dd_duration_* | ✓ |
| AC2: Create equity module | TestEquityCalculatorFlatStake class (11 tests) | ✓ |
| AC3: Store equity curve | Verified in PnLStatsTab._recalculate_metrics() | ✓ |
| AC4: "Not recovered" display | test_dd_duration_not_recovered, test_dd_duration_not_recovered_displays_coral | ✓ |
| AC5: Recalculate on change | Signal chain verified in code + existing debounce tests | ✓ |

### Improvements Checklist

All items handled - no remaining work required:

- [x] EquityCalculator implementation with proper exception handling
- [x] TradingMetrics extended with 4 new flat stake fields
- [x] MetricsCalculator integration returns tuple (metrics, equity_curve)
- [x] AppState stores equity curve and emits signal
- [x] MetricsGrid displays 19 metrics with special DD Duration formatting
- [x] MetricCard accepts color override for "Not recovered" coral styling
- [x] Comprehensive unit tests (11 tests in test_equity.py)
- [x] Integration tests in test_metrics.py (5 flat stake tests)
- [x] Widget tests in test_metrics_grid.py (10 flat stake tests)

### Security Review

No security concerns - this story adds financial calculations with no external inputs, authentication, or sensitive data handling.

### Performance Considerations

- Vectorized numpy operations ensure O(n) complexity
- Performance test exists: <100ms for 100k rows (test_performance_100k_rows)
- No memory leaks - equity curve stored as single DataFrame reference

### Files Modified During Review

None - no refactoring was necessary.

### Gate Status

Gate: **PASS** → docs/qa/gates/3.4-flat-stake-metrics.yml
Quality Score: **100/100**

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, tests comprehensive, code quality excellent.
