# Story 4.2: Comparison Ribbon (Validation Checkpoint)

## Status

Done

## Story

**As a** user,
**I want** to see key metrics with baseline comparison at a glance,
**so that** I can quickly assess my filter's impact.

## Acceptance Criteria

1. Fixed ribbon at top of PnL Stats tab
2. Display 4 metrics: Trades, Win Rate, EV, Kelly
3. Large filtered value, delta indicator, baseline reference
4. Delta colors: plasma-cyan (improvement), solar-coral (decline), moon-gray (neutral)
5. Empty state: "— (no filter applied)"
6. **Validation:** verify calculation logic before building full grid

## Tasks / Subtasks

- [x] Task 1: Create ComparisonRibbon Component (AC: 1, 2, 3, 4, 5)
  - [x] Create `src/ui/components/comparison_ribbon.py` with `ComparisonRibbon` class
  - [x] Define `METRICS = ["trades", "win_rate", "ev", "kelly"]` constant
  - [x] Create 4 `RibbonCard` internal widgets (one per metric)
  - [x] Each RibbonCard displays: large filtered value (48px), delta indicator, baseline reference (small text)
  - [x] Use `QFrame` with `QHBoxLayout` containing 4 equally-spaced cards
  - [x] Apply fixed height (~120px) with `BG_ELEVATED` background

- [x] Task 2: Create RibbonCard Internal Widget (AC: 3, 4, 5)
  - [x] Create `_RibbonCard` class (private helper in same file) with QVBoxLayout
  - [x] Set fixed card dimensions: width ~200px, height ~100px (4 cards fit in 120px ribbon with padding)
  - [x] Display metric label at top (`TEXT_SECONDARY`, 12px Geist)
  - [x] Display filtered value large center (`TEXT_PRIMARY`, 48px Azeret Mono) - uses `KPI_HERO` intentionally, not MetricCard's 56px HERO variant
  - [x] Display delta indicator with arrow: `▲ +X.X%` or `▼ -X.X%` or `— 0%`
  - [x] Display baseline reference small below (`TEXT_SECONDARY`, 12px: "Baseline: X.XX")
  - [x] Apply semantic colors: `SIGNAL_CYAN` (improvement), `SIGNAL_CORAL` (decline), `TEXT_SECONDARY` (neutral)
  - [x] Implement `update(filtered_value, baseline_value, format_spec)` method
  - [x] Implement `clear()` method showing "—" with "(no filter applied)" subtitle
  - [x] Note: Component is display-only; no keyboard focus handling required

- [x] Task 3: Implement Delta Calculation Logic (AC: 4, 6)
  - [x] Add `_calculate_delta(filtered, baseline, metric_name) -> tuple[float, str]` helper
  - [x] For `trades`: delta = filtered - baseline (absolute difference)
  - [x] For `win_rate`: delta = filtered - baseline (percentage point difference, display "pp")
  - [x] For `ev`: delta = filtered - baseline (percentage point difference)
  - [x] For `kelly`: delta = filtered - baseline (percentage point difference)
  - [x] Return delta value and formatted display string with proper suffix
  - [x] Add `_get_improvement_direction(metric_name) -> str` helper ("higher" or "lower")
  - [x] All 4 metrics use "higher is better" logic for coloring

- [x] Task 4: Implement ComparisonRibbon.update() Method (AC: 2, 3, 4)
  - [x] Accept `baseline: TradingMetrics, filtered: TradingMetrics` parameters (both required)
  - [x] **Design decision:** Callers must use `clear()` for empty state; `update()` requires valid filtered metrics
  - [x] Extract `num_trades`, `win_rate`, `ev`, `kelly` from both metrics objects
  - [x] For each metric: calculate delta, determine color, update corresponding card
  - [x] Handle edge case: individual metric field is None (show "N/A" for that specific metric)
  - [x] Log comparison update: `logger.debug("Ribbon updated: %d trades filtered", filtered.num_trades)`

- [x] Task 5: Implement ComparisonRibbon.clear() Method (AC: 5)
  - [x] Call `clear()` on all 4 RibbonCard widgets
  - [x] Show empty state: "—" value with "(no filter applied)" subtitle

- [x] Task 6: Integrate ComparisonRibbon into PnLStatsTab (AC: 1)
  - [x] Import `ComparisonRibbon` in `src/tabs/pnl_stats.py`:
    ```python
    from src.ui.components import ComparisonRibbon
    ```
  - [x] Add `self._comparison_ribbon = ComparisonRibbon()` in `_setup_ui()`
  - [x] Insert ribbon section at TOP using `insertWidget()`/`insertLayout()` at index 0:
    ```python
    # Create comparison section (header + ribbon)
    comparison_header = QLabel("Comparison")
    comparison_header.setProperty("class", "sectionHeader")
    main_layout.insertWidget(0, comparison_header)
    main_layout.insertWidget(1, self._comparison_ribbon)
    ```
  - [x] Connect `app_state.metrics_updated` signal to `_on_metrics_updated()` slot in `_connect_signals()`
  - [x] In `_on_metrics_updated(baseline, filtered)`: call `update()` if filtered exists, else `clear()`
  - [x] In `_initialize_from_state()`: call `clear()` if no filtered_metrics, else update with current values

- [x] Task 7: Export ComparisonRibbon from Components Package (AC: 1)
  - [x] Add `from src.ui.components.comparison_ribbon import ComparisonRibbon` to `src/ui/components/__init__.py`
  - [x] Add `"ComparisonRibbon"` to `__all__` list

- [x] Task 8: Write Unit Tests for Delta Calculation (AC: 4, 6)
  - [x] Create `tests/unit/test_comparison_ribbon.py`
  - [x] Test: `_calculate_delta` returns correct value for trades (absolute)
  - [x] Test: `_calculate_delta` returns correct value for win_rate (pp difference)
  - [x] Test: `_calculate_delta` handles None values gracefully
  - [x] Test: positive delta returns "higher" direction for all 4 metrics
  - [x] Test: delta color mapping: positive → SIGNAL_CYAN, negative → SIGNAL_CORAL, zero → TEXT_SECONDARY
  - [x] Test: zero delta case explicitly (filtered == baseline → neutral color, "— 0%" display)

- [x] Task 9: Write Widget Tests for ComparisonRibbon (AC: 2, 3, 5)
  - [x] Create `tests/widget/test_comparison_ribbon.py`
  - [x] Test: ribbon displays all 4 metrics (trades, win_rate, ev, kelly)
  - [x] Test: `update()` shows filtered values and deltas
  - [x] Test: `clear()` shows empty state with "—" values
  - [x] Test: delta colors match improvement/decline semantics
  - [x] Test: baseline reference shows correct value
  - [x] Use `qtbot` fixture for widget testing

- [x] Task 10: Write Integration Tests for Ribbon Update Flow (AC: 1, 6)
  - [x] Add tests to `tests/integration/test_filter_workflow.py`
  - [x] Test: `metrics_updated` signal triggers ribbon update
  - [x] Test: ribbon shows correct values after filter applied
  - [x] Test: ribbon clears when filters removed (filtered_metrics = None)

- [x] Task 11: Manual Verification (AC: 1-6)
  - [x] Run `make lint` - verify no errors
  - [x] Run `make typecheck` - verify no type errors
  - [x] Run `make test` - all tests pass
  - [x] Launch application, load sample data
  - [x] Apply a filter in Feature Explorer (e.g., gain_pct > 0 to show only winners)
  - [x] Switch to PnL Stats tab - verify Comparison Ribbon visible at top
  - [x] Verify 4 metrics display: Trades, Win Rate, EV, Kelly
  - [x] Verify delta colors: cyan for improvements, coral for declines
  - [x] Verify baseline reference shows correct values
  - [x] Remove all filters - verify ribbon shows empty state
  - [x] **Expected values example** (for reference during manual testing):
    - Baseline: 12,847 trades, 58.2% win rate, 1.87% EV, 12.1% Kelly
    - Filtered (winners only): 7,484 trades, 100% win rate, higher EV, higher Kelly
    - Deltas: trades negative (fewer), win rate positive (higher), EV positive, Kelly positive

## Dev Notes

### Previous Story Insights
[Source: Story 4.1 Dev Agent Record]

- `metrics_updated` signal already emits `(baseline: TradingMetrics, filtered: TradingMetrics)` tuple
- Filtered metrics calculation triggered by `filtered_data_updated` signal
- AppState has `filtered_metrics` property storing calculated filtered metrics
- Signal flow: filter applied → `filtered_data_updated` → calculate metrics → `metrics_updated`

### Current PnL Stats Tab Layout
[Source: src/tabs/pnl_stats.py - lines 67-152]

Current layout order (main_layout indices after setup):
1. Index 0: Top row layout ("Configuration" header + CalculationStatusIndicator)
2. Index 1: UserInputsPanel (fixed 100px height)
3. Index 2: "Trading Metrics" header
4. Index 3: MetricsGrid (QStackedWidget, stretches)
5. Index 4: "Distribution Statistics" header
6. Index 5: Distribution cards layout
7. Index 6: "Charts" header
8. Index 7: Charts placeholder

**Ribbon should be inserted at indices 0-1** (before "Configuration") to be at the very top as per AC 1. Use `insertWidget()` to push existing items down.

### ComparisonRibbon Component Specification
[Source: docs/architecture/5-components.md#ComparisonRibbon]

```python
class ComparisonRibbon(QFrame):
    """Signature element: 4 key metrics with large numbers and deltas."""

    METRICS = ["trades", "win_rate", "ev", "kelly"]

    def update(
        self,
        baseline: TradingMetrics,
        filtered: TradingMetrics,  # Required - callers use clear() for empty state
    ) -> None:
        """Update all 4 metric cards with comparison data."""
        ...

    def clear(self) -> None:
        """Show empty state (no filters applied)."""
        ...
```

### Required Imports for ComparisonRibbon
[Source: Project conventions]

```python
# comparison_ribbon.py imports
from __future__ import annotations

import logging
from typing import TYPE_CHECKING

from PyQt6.QtWidgets import QFrame, QHBoxLayout, QLabel, QVBoxLayout

from src.ui.constants import Colors, Fonts, FontSizes, Spacing

if TYPE_CHECKING:
    from src.core.models import TradingMetrics

logger = logging.getLogger(__name__)
```

### Existing MetricCard Component
[Source: src/ui/components/metric_card.py]

MetricCard exists but does NOT have delta indicator support. The ComparisonRibbon needs a specialized `RibbonCard` internal widget that extends this pattern with:
- Delta indicator (arrow + value + color)
- Baseline reference text
- Empty state handling

Consider creating `RibbonCard` as a private class within `comparison_ribbon.py` rather than modifying MetricCard (single responsibility).

### TradingMetrics Fields for Ribbon
[Source: src/core/models.py - TradingMetrics class]

| Display Label | Field Name | Format | Delta Unit |
|---------------|------------|--------|------------|
| Trades | `num_trades` | `,d` (e.g., "4,231") | absolute |
| Win Rate | `win_rate` | `.1f%` (e.g., "67.1%") | pp |
| EV | `ev` | `.2f%` (e.g., "3.21%") | pp |
| Kelly | `kelly` | `.1f%` (e.g., "15.4%") | pp |

### Delta Color Logic
[Source: docs/architecture/9-coding-standards.md - Theme Constants]

```python
# All 4 metrics: higher is better
if delta > 0:
    color = Colors.SIGNAL_CYAN   # Improvement (plasma-cyan)
elif delta < 0:
    color = Colors.SIGNAL_CORAL  # Decline (solar-coral)
else:
    color = Colors.TEXT_SECONDARY  # Neutral (moon-gray/nebula-gray)
```

### Theme Constants
[Source: src/ui/constants.py]

```python
Colors.SIGNAL_CYAN = "#00FFD4"    # Improvement
Colors.SIGNAL_CORAL = "#FF4757"   # Decline
Colors.TEXT_SECONDARY = "#9898A8" # Neutral / labels
Colors.TEXT_PRIMARY = "#F4F4F8"   # Main values
Colors.BG_ELEVATED = "#1E1E2C"    # Card background

Fonts.DATA = "Azeret Mono"        # Numbers
Fonts.UI = "Geist"                # Labels

FontSizes.KPI_HERO = 48           # Large filtered value
FontSizes.BODY = 13               # Labels and baseline reference
```

### Signal Connection Pattern
[Source: src/tabs/pnl_stats.py - _connect_signals method]

Follow existing pattern. Add import at top of file:
```python
from src.core.models import TradingMetrics  # Already imported, verify present
```

In `_connect_signals()`:
```python
def _connect_signals(self) -> None:
    # ... existing connections ...

    # Add ribbon update connection (Story 4.2)
    self._app_state.metrics_updated.connect(self._on_metrics_updated)

def _on_metrics_updated(
    self,
    baseline: TradingMetrics,
    filtered: TradingMetrics | None,
) -> None:
    """Update comparison ribbon with new metrics."""
    if filtered is not None:
        self._comparison_ribbon.update(baseline, filtered)
    else:
        self._comparison_ribbon.clear()
```

### File Locations
[Source: docs/architecture/2-high-level-architecture.md#repository-structure]

| File | Purpose | Action |
|------|---------|--------|
| `src/ui/components/comparison_ribbon.py` | New ComparisonRibbon widget | CREATE |
| `src/ui/components/__init__.py` | Export ComparisonRibbon | MODIFY |
| `src/tabs/pnl_stats.py` | Integrate ribbon at top | MODIFY |
| `tests/unit/test_comparison_ribbon.py` | Delta calculation unit tests | CREATE |
| `tests/widget/test_comparison_ribbon.py` | Widget behavior tests | CREATE |
| `tests/integration/test_filter_workflow.py` | Integration tests | MODIFY |

### Coding Standards
[Source: docs/architecture/9-coding-standards.md]

- **Line length:** 100 characters
- **Type hints:** Required for all public APIs
- **Signals:** Past tense naming (`metrics_updated`)
- **Slots:** `on_noun_verb` naming (`_on_metrics_updated`)
- **Private classes:** Leading underscore (`_RibbonCard`)
- **Constants:** SCREAMING_SNAKE (`METRICS = [...]`)
- **Logging:** Use module-level logger
  ```python
  logger.debug("Ribbon updated: %d filtered trades", filtered.num_trades)
  ```

## Testing

### Test File Locations
- Unit tests: `tests/unit/test_comparison_ribbon.py` (CREATE)
- Widget tests: `tests/widget/test_comparison_ribbon.py` (CREATE)
- Integration tests: `tests/integration/test_filter_workflow.py` (MODIFY)

### Testing Standards
[Source: docs/architecture/8-testing-strategy.md]

- Use pytest as test framework
- Use pytest-qt for widget testing (`qtbot` fixture)
- Test pyramid: 60% unit, 20% widget, 15% integration, 5% manual
- Widget tests should verify:
  - Component renders correctly
  - Signal/slot connections work
  - State changes reflected in UI

### Key Test Cases Summary

| Test File | Test Class/Function | Purpose |
|-----------|---------------------|---------|
| test_comparison_ribbon.py (unit) | test_calculate_delta_trades | Delta = filtered - baseline (absolute) |
| test_comparison_ribbon.py (unit) | test_calculate_delta_win_rate | Delta in percentage points |
| test_comparison_ribbon.py (unit) | test_delta_color_positive | Positive delta → SIGNAL_CYAN |
| test_comparison_ribbon.py (unit) | test_delta_color_negative | Negative delta → SIGNAL_CORAL |
| test_comparison_ribbon.py (unit) | test_delta_color_zero | Zero delta → TEXT_SECONDARY (neutral) |
| test_comparison_ribbon.py (widget) | test_ribbon_displays_four_metrics | All 4 metrics visible |
| test_comparison_ribbon.py (widget) | test_ribbon_update_shows_values | Values display correctly |
| test_comparison_ribbon.py (widget) | test_ribbon_clear_shows_empty | Empty state shows "—" |
| test_filter_workflow.py | test_metrics_updated_triggers_ribbon | Signal → ribbon update |

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-11 | 0.1 | Initial draft | SM Agent (Bob) |
| 2026-01-11 | 0.2 | PO validation fixes: clarified update() vs clear() responsibility, added Qt insertWidget() guidance, added required imports section, specified RibbonCard dimensions, added zero delta test case, clarified 48px font size choice, added accessibility note | PO Agent (Sarah) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

N/A - No debug log entries required

### Completion Notes List

- Renamed `update()` method to `set_values()` on both `_RibbonCard` and `ComparisonRibbon` to avoid conflict with `QWidget.update()`
- Added `str()` cast for QLabel metric label to satisfy mypy type checking
- Added guard in `_on_metrics_updated()` for baseline being None to handle edge cases in tests
- All 731 tests pass after implementation
- Linting and type checking both pass

### File List

| File | Action |
|------|--------|
| `src/ui/components/comparison_ribbon.py` | CREATE |
| `src/ui/components/__init__.py` | MODIFY |
| `src/tabs/pnl_stats.py` | MODIFY |
| `tests/unit/test_comparison_ribbon.py` | CREATE |
| `tests/widget/test_comparison_ribbon.py` | CREATE |
| `tests/integration/test_filter_workflow.py` | MODIFY |

---

## QA Results

### Review Date: 2026-01-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. The ComparisonRibbon component demonstrates clean architecture with proper separation of concerns between the main ribbon widget and the internal `_RibbonCard` helper class. The code follows established patterns in the codebase and uses appropriate Qt idioms.

Key strengths:
- Smart method naming (`set_values` instead of `update`) to avoid Qt method conflicts
- Comprehensive None/null value handling throughout
- Proper TYPE_CHECKING guard for type hints
- Module-level constants following SCREAMING_SNAKE_CASE convention
- Clean delta calculation logic with clear "higher is better" semantics

### Refactoring Performed

None required. The implementation is clean and follows project conventions.

### Compliance Check

- Coding Standards: ✓ Type hints on all public APIs, proper naming conventions
- Project Structure: ✓ Component in correct location, properly exported
- Testing Strategy: ✓ Unit/widget/integration test pyramid followed
- All ACs Met: ✓ All 6 acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] All acceptance criteria implemented
- [x] Unit tests cover delta calculation logic
- [x] Widget tests verify component behavior
- [x] Integration tests verify signal flow
- [x] Component properly integrated into PnLStatsTab
- [x] Export added to components package __init__.py

No outstanding items.

### Security Review

N/A - Display-only component with no user input handling, data storage, or authentication concerns.

### Performance Considerations

No concerns. The component is display-only with O(1) update operations. All metric calculations happen upstream before being passed to the ribbon.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/4.2-comparison-ribbon.yml

### Recommended Status

✓ Ready for Done

### Requirements Traceability (Given-When-Then)

| AC | Test Coverage |
|----|---------------|
| AC1: Fixed ribbon at top | Integration: `test_metrics_updated_signal_triggers_ribbon_update`; pnl_stats.py:154-159 insertion |
| AC2: Display 4 metrics | Widget: `test_ribbon_displays_four_metrics`, `test_ribbon_has_correct_metrics_labels` |
| AC3: Large value, delta, baseline | Widget: `test_update_shows_filtered_values`, `test_update_shows_delta_indicators`, `test_update_shows_baseline_reference` |
| AC4: Delta colors | Unit: `TestGetDeltaColor` class; Widget: `TestComparisonRibbonDeltaColors` class |
| AC5: Empty state | Widget: `test_clear_shows_empty_state`, `test_clear_shows_no_filter_message` |
| AC6: Validation | Unit: `TestCalculateDelta` class (17 test methods covering all scenarios) |

All acceptance criteria have comprehensive test coverage.
