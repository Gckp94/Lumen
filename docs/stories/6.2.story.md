# Story 6.2: Binning Engine & Chart Visualization

## Status
Done

## Story
**As a** trader analyzing my trade data,
**I want** to see horizontal bar charts showing average, median, count, and win rate for each bin,
**so that** I can understand how my trading performance varies across different ranges of any numeric column.

## Acceptance Criteria

1. Bin assignment algorithm correctly categorizes rows using `<`, `>`, `range`, and `nulls` operators
2. Four horizontal bar charts display: Average, Median, Count, and Win Rate per bin
3. Toggle allows switching between `gain_pct` and `adjusted_gain_pct` for metric calculations
4. Gradient coloring indicates relative magnitude (darker = higher values)
5. Tooltips show exact values when hovering over chart bars
6. Chart area is scrollable when bins exceed visible area
7. Charts update automatically when bin configuration changes (via `bin_config_changed` signal)
8. Empty state shown when no bins are configured or no data is loaded
9. Performance: Chart rendering completes in < 500ms for datasets up to 100k rows

## Tasks / Subtasks

- [x] Task 1: Create BinningEngine class for bin assignment (AC: 1)
  - [x] Create `src/core/binning_engine.py` with `BinningEngine` class
  - [x] Implement `assign_bins(df, column, bin_definitions) -> pd.Series` method
  - [x] Handle `<` operator: value < threshold
  - [x] Handle `>` operator: value > threshold
  - [x] Handle `range` operator: value1 <= value <= value2
  - [x] Handle `nulls` operator: pd.isna(value)
  - [x] Return Series with bin labels for each row
  - [x] Handle edge case: row matches no bin (assign to "Uncategorized")
  - [x] Handle edge case: row matches multiple bins (first match wins)

- [x] Task 2: Implement bin metrics calculation (AC: 2, 3)
  - [x] Add `BinMetrics` dataclass to `src/core/models.py` (after `BinDefinition`)
  - [x] Create `calculate_bin_metrics(df, bin_col, metric_col) -> dict` method in BinningEngine
  - [x] Calculate per-bin: average, median, count, win_rate
  - [x] Win rate = (rows where metric_col > 0) / total rows * 100
  - [x] Support both `gain_pct` and `adjusted_gain_pct` columns
  - [x] Handle empty bins gracefully (return None/NaN for metrics)

- [x] Task 3: Create BinChartPanel widget for chart visualization (AC: 2, 4, 5, 6)
  - [x] Create `BinChartPanel` class in `src/tabs/data_binning.py`
  - [x] Implement 4 horizontal bar chart sections: Average, Median, Count, Win Rate
  - [x] Use custom QPainter for bar chart rendering (simpler control for this use case)
  - [x] Implement gradient coloring using `_calculate_gradient_color(value, min_val, max_val)`
  - [x] Add scrollable container (`QScrollArea`) for overflow handling
  - [x] Configure chart styling: use `Colors.SIGNAL_CYAN` for positive, `Colors.SIGNAL_CORAL` for negative

- [x] Task 4: Add tooltip support for bar charts (AC: 5)
  - [x] Implement hover detection on bar items
  - [x] Display tooltip with: bin label, exact value, percentage of total (for count)
  - [x] Use `QToolTip` for tooltip support
  - [x] Format numbers consistently: percentages with 2 decimals, counts with commas

- [x] Task 5: Implement gain_pct / adjusted_gain_pct toggle (AC: 3)
  - [x] Add toggle buttons to chart panel header
  - [x] Default to `adjusted_gain_pct` if column exists in data
  - [x] Emit signal when toggle changes to trigger chart recalculation
  - [x] Update all 4 charts when toggle changes

- [x] Task 6: Connect DataBinningTab to BinChartPanel (AC: 7, 8)
  - [x] Connect `bin_config_changed` signal to chart update method
  - [x] Connect `column_selected` signal to chart update method
  - [x] Implement `_on_bin_config_changed()` slot
  - [x] Add debouncing (300ms) to prevent excessive recalculations
  - [x] Show `EmptyState` when: no data loaded, no column selected, or no bins configured

- [x] Task 7: Unit tests for BinningEngine (`tests/unit/test_binning_engine.py`) (AC: 1, 9)
  - [x] Test `<` operator bin assignment
  - [x] Test `>` operator bin assignment
  - [x] Test `range` operator bin assignment
  - [x] Test `nulls` operator bin assignment
  - [x] Test bin metrics calculation accuracy
  - [x] Test bin assignment performance with 100k rows (< 250ms)
  - [x] Test metrics calculation performance with 100k rows (< 250ms)
  - [x] Test combined operation performance (< 500ms total)
  - [x] Test edge cases: empty DataFrame, all nulls, no matching bins

- [x] Task 8: Widget tests for BinChartPanel (`tests/widget/test_data_binning.py`)
  - [x] Test chart panel creation
  - [x] Test chart updates on bin config change
  - [x] Test toggle switch functionality
  - [x] Test empty state display
  - [x] Test scrollable container behavior

## Dev Notes

### Previous Story (6.1) Key Insights
[Source: docs/stories/6.1.story.md#dev-agent-record]

Story 6.1 established the foundation:
- `DataBinningTab` with sidebar + content area layout
- `BinConfigRow` widget for individual bin definitions
- Signals defined: `column_selected`, `bin_config_changed`, `analyze_requested`
- `BinDefinition` dataclass in `src/core/models.py`
- Time column detection and HHMMSS parsing implemented
- Tab already registered in MainWindow at position 5 (after Monte Carlo)

### Data Flow
[Source: docs/stories/epic-6-data-binning.md#technical-notes]

```
AppState.raw_df
    -> Apply stop_loss/efficiency (via AdjustmentParams)
    -> Column selection (user picks numeric column)
    -> Bin assignment (BinningEngine.assign_bins)
    -> Metric calculation per bin
    -> Chart rendering (BinChartPanel)
```

**Important:** Use `app_state.baseline_df` (not `raw_df`) as the data source. This DataFrame already has:
- First trigger applied (if enabled)
- `adjusted_gain_pct` column calculated via `AdjustmentParams`

### BinDefinition Dataclass
[Source: src/core/models.py:383-397]

```python
@dataclass
class BinDefinition:
    """Single bin definition for data binning."""
    operator: Literal["<", ">", "range", "nulls"]
    value1: float | None = None  # For <, >, or range start
    value2: float | None = None  # For range end only
    label: str = ""  # User-friendly label (auto-generated if empty)
```

### BinningEngine Design

Create in `src/core/binning_engine.py`:

```python
class BinningEngine:
    """Assign DataFrame rows to bins and calculate per-bin metrics."""

    def assign_bins(
        self,
        df: pd.DataFrame,
        column: str,
        bin_definitions: list[BinDefinition],
    ) -> pd.Series:
        """Assign each row to a bin based on column value.

        Args:
            df: Source DataFrame
            column: Column name to bin on
            bin_definitions: List of bin definitions

        Returns:
            Series with bin labels for each row
        """
        ...

    def calculate_bin_metrics(
        self,
        df: pd.DataFrame,
        bin_labels: pd.Series,
        metric_column: str,
    ) -> dict[str, BinMetrics]:
        """Calculate metrics for each bin.

        Returns:
            Dict mapping bin label to BinMetrics dataclass
        """
        ...
```

### BinMetrics Dataclass (New)

Add to `src/core/models.py`:

```python
@dataclass
class BinMetrics:
    """Metrics calculated for a single bin."""
    label: str
    count: int
    average: float | None
    median: float | None
    win_rate: float | None  # Percentage 0-100
```

### Existing Signals to Connect
[Source: src/tabs/data_binning.py, lines 119-121]

```python
class DataBinningTab(QWidget):
    column_selected = Signal(str)  # column_name: str
    bin_config_changed = Signal(str, list)  # column_name: str, bins: list[BinDefinition]
    analyze_requested = Signal()
```

**Signal Type Details:**
- `column_selected`: Emits the column name string when user selects a column
- `bin_config_changed`: Emits tuple of (column_name, list of `BinDefinition` objects)
- `analyze_requested`: Parameterless signal for triggering analysis

Connect these in `_connect_signals()` to trigger chart updates.

### Chart Rendering Approach

[Source: architecture/3-tech-stack.md]

**Recommended Approach:** Use custom QWidget with QPainter for horizontal bar charts. This provides simpler control over:
- Text label positioning beside bars
- Gradient fill rendering
- Tooltip hit-testing
- Consistent styling with the rest of Lumen UI

```python
class HorizontalBarChart(QWidget):
    """Custom horizontal bar chart with labels and gradients."""
    
    def __init__(self, parent: QWidget | None = None) -> None:
        super().__init__(parent)
        self._data: list[tuple[str, float]] = []  # (label, value)
        self.setMinimumHeight(150)
    
    def set_data(self, data: list[tuple[str, float]]) -> None:
        """Update chart data and trigger repaint."""
        self._data = data
        self.update()
    
    def paintEvent(self, event: QPaintEvent) -> None:
        """Render horizontal bars with gradient fills."""
        painter = QPainter(self)
        painter.setRenderHint(QPainter.RenderHint.Antialiasing)
        # ... render bars with gradient colors
```

**Alternative (PyQtGraph):** For consistency with other charts in the app, PyQtGraph can be used:

```python
import pyqtgraph as pg

bar_item = pg.BarGraphItem(
    x0=0,
    y=y_positions,
    height=bar_height,
    width=values,
    brush=gradient_colors,
)
```

Choose based on complexity: QPainter for simple labeled bars, PyQtGraph if needing interactivity features.

### Gradient Color Calculation

```python
def _calculate_gradient_color(
    value: float,
    min_val: float,
    max_val: float,
    base_color: str = Colors.SIGNAL_CYAN,
) -> str:
    """Calculate gradient color based on relative value.

    Args:
        value: Current value
        min_val: Minimum value in dataset
        max_val: Maximum value in dataset
        base_color: Base color for gradient

    Returns:
        Hex color string with adjusted lightness
    """
    if max_val == min_val:
        return base_color

    # Normalize to 0-1 range
    normalized = (value - min_val) / (max_val - min_val)

    # Adjust alpha/lightness based on normalized value
    # Higher values = more opaque/darker
    alpha = 0.3 + (normalized * 0.7)  # Range: 0.3 to 1.0

    # Parse hex color and apply alpha
    ...
```

### UI Layout for Chart Area
[Source: docs/stories/epic-6-data-binning.md#ui-layout-proposed]

```
+----------------------------------------------------------+
|  Chart Area (Scrollable)                                  |
|  +------------------------------------------------------+ |
|  | [adjusted_gain_pct v]  Toggle: [gain_pct / adjusted] | |
|  +------------------------------------------------------+ |
|  |                                                      | |
|  |  Average                                             | |
|  |  ████████████████████ < 1M: 2.45%                   | |
|  |  ████████████ 1M-10M: 1.89%                         | |
|  |  ████████ 10M-50M: 1.23%                            | |
|  |  ██████████████████████████ > 50M: 3.12%           | |
|  |  ██ Nulls: 0.15%                                    | |
|  |                                                      | |
|  |  Median                                              | |
|  |  ...                                                 | |
|  |                                                      | |
|  |  Count                                               | |
|  |  ...                                                 | |
|  |                                                      | |
|  |  Win Rate                                            | |
|  |  ...                                                 | |
|  +------------------------------------------------------+ |
+----------------------------------------------------------+
```

### AppState Integration
[Source: architecture/4-data-models.md#appstate]

Access data via:
- `app_state.baseline_df` - DataFrame with first trigger and adjustments applied
- `app_state.column_mapping.gain_pct` - Column name for raw gain
- Check for `adjusted_gain_pct` column presence in baseline_df

### Debounce Pattern
[Source: architecture/9-coding-standards.md#qt-patterns]

```python
from PyQt6.QtCore import QTimer
from src.ui.constants import Animation

class BinChartPanel(QWidget):
    def __init__(self):
        super().__init__()
        self._debounce_timer = QTimer()
        self._debounce_timer.setSingleShot(True)
        self._debounce_timer.timeout.connect(self._recalculate_charts)

    def _on_config_changed(self):
        self._debounce_timer.start(Animation.DEBOUNCE_METRICS)  # 300ms
```

### Empty State Patterns
[Source: architecture/5-components.md#emptystate]

```python
from src.ui.components.empty_state import EmptyState

# In BinChartPanel
self._empty_state = EmptyState()
self._empty_state.set_message(
    icon="chart",
    title="No Bins Configured",
    description="Add bin definitions in the sidebar to see analysis charts",
)
```

**Empty State Messages by Scenario:**

| Scenario | Title | Description |
|----------|-------|-------------|
| No data loaded | "No Data Loaded" | "Load trade data from Data Input tab to begin analysis" |
| No column selected | "Select a Column" | "Choose a numeric column to configure bins" |
| No bins configured | "No Bins Configured" | "Add bin definitions in the sidebar to see analysis charts" |
| All rows uncategorized | "No Matching Data" | "All rows fell outside defined bin ranges. Adjust bin thresholds." |
| Column all nulls | "No Valid Data" | "Selected column contains only null values" |

### File Locations
[Source: architecture/2-high-level-architecture.md#repository-structure]

- New file: `src/core/binning_engine.py`
- Modify: `src/tabs/data_binning.py` (add BinChartPanel)
- Modify: `src/core/models.py` (add BinMetrics dataclass)
- New tests: `tests/unit/test_binning_engine.py`
- Modify tests: `tests/widget/test_data_binning.py`

### UI Constants
[Source: architecture/9-coding-standards.md#theme-constants]

```python
from src.ui.constants import Colors, Fonts, FontSizes, Spacing

# Chart colors
Colors.SIGNAL_CYAN = "#00FFD4"   # Positive values
Colors.SIGNAL_CORAL = "#FF4757"  # Negative values
Colors.BG_ELEVATED = "#1E1E2C"   # Chart background

# Text
Fonts.DATA = "Azeret Mono"  # For numeric values
Fonts.UI = "Geist"  # For labels

# Spacing
Spacing.MD = 12  # Between chart sections
Spacing.LG = 16  # Chart padding
```

### Testing

**Test file locations:**
- Unit tests: `tests/unit/test_binning_engine.py`
- Widget tests: `tests/widget/test_data_binning.py` (extend existing)

**Test standards:**
[Source: architecture/8-testing-strategy.md]

- Use pytest + pytest-qt for widget tests
- Use `qtbot.addWidget(widget)` for proper cleanup
- Test signal emissions with `qtbot.waitSignal()`
- Performance tests: use `time.perf_counter()` to verify < 500ms

**Required fixtures from conftest.py:**
- `sample_dataframe` - for testing bin assignment
- `sample_trades` - alternative DataFrame with numeric columns

**Example unit test:**
```python
def test_bin_assignment_less_than():
    """< operator assigns values correctly."""
    engine = BinningEngine()
    df = pd.DataFrame({"value": [5, 10, 15, 20, 25]})
    bins = [BinDefinition(operator="<", value1=15, label="Low")]

    result = engine.assign_bins(df, "value", bins)

    assert result.iloc[0] == "Low"  # 5 < 15
    assert result.iloc[1] == "Low"  # 10 < 15
    assert result.iloc[2] == "Uncategorized"  # 15 not < 15
```

**Example performance test:**
```python
@pytest.mark.slow
def test_bin_assignment_performance():
    """Bin assignment completes in < 500ms for 100k rows."""
    engine = BinningEngine()
    df = pd.DataFrame({"value": np.random.randn(100_000)})
    bins = [
        BinDefinition(operator="<", value1=-1, label="Low"),
        BinDefinition(operator="range", value1=-1, value2=1, label="Mid"),
        BinDefinition(operator=">", value1=1, label="High"),
    ]

    start = time.perf_counter()
    engine.assign_bins(df, "value", bins)
    elapsed = time.perf_counter() - start

    assert elapsed < 0.5, f"Took {elapsed:.3f}s, exceeds 500ms limit"
```

### Coding Standards
[Source: architecture/9-coding-standards.md]

- Line length: 100 characters (Black formatter)
- Naming: snake_case for methods, PascalCase for classes
- Qt signals: snake_case (e.g., `chart_updated`)
- Qt slots: on_noun_verb (e.g., `_on_bin_config_changed`)
- Type hints required for all public APIs
- Use explicit `.copy()` when modifying DataFrames

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

**New Files:**
- `src/core/binning_engine.py` - BinningEngine class for bin assignment and metrics calculation
- `tests/unit/test_binning_engine.py` - Unit tests for BinningEngine (25 tests)

**Modified Files:**
- `src/core/models.py` - Added BinMetrics dataclass after BinDefinition
- `src/tabs/data_binning.py` - Added HorizontalBarChart and BinChartPanel classes, updated DataBinningTab
- `tests/widget/test_data_binning.py` - Added tests for HorizontalBarChart, BinChartPanel, and integration tests

### Debug Log References
None

### Completion Notes
- All 8 tasks completed successfully
- 25 unit tests for BinningEngine pass (including 3 performance tests)
- 44 widget tests pass for data binning components
- Used custom QPainter for bar charts instead of PyQtGraph (simpler control as recommended in Dev Notes)
- Toggle buttons used instead of ToggleSwitch for metric selection (simpler UI)
- Performance tests verify < 500ms for 100k rows (actual: ~250ms combined)
- 2 pre-existing performance test failures in test_performance.py are unrelated to this story (FeatureExplorer)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-13 | 1.0 | Initial story creation | Bob (SM Agent) |
| 2026-01-13 | 1.1 | PO validation: Added BinMetrics task, chart rendering recommendation, performance test breakdown, empty state edge cases, signal type clarification | Sarah (PO Agent) |
| 2026-01-13 | 1.2 | Implementation complete: BinningEngine, BinChartPanel, HorizontalBarChart, all tests passing | James (Dev Agent) |

## QA Results

### Review Date: 2026-01-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is **high quality** and follows project coding standards. Key observations:

- **Architecture**: Clean separation between BinningEngine (core logic) and UI components (HorizontalBarChart, BinChartPanel)
- **Type Safety**: Full type hints on all public APIs
- **Qt Patterns**: Correct Signal/Slot naming conventions, proper debounce implementation using QTimer
- **Performance**: Vectorized pandas operations for efficient bin assignment
- **Test Coverage**: 69 tests (25 unit + 44 widget) all passing

### Requirements Traceability

| AC | Requirement | Test Coverage | Status |
|----|-------------|---------------|--------|
| 1 | Bin assignment (<, >, range, nulls) | 15 tests covering all operators and edge cases | ✓ |
| 2 | Four horizontal bar charts | test_chart_panel_has_four_charts | ✓ |
| 3 | Toggle gain_pct/adjusted_gain_pct | test_toggle_switch_functionality | ✓ |
| 4 | Gradient coloring | _calculate_gradient_color() implemented | ✓ |
| 5 | Tooltips with exact values | test_get_tooltip_text | ✓ |
| 6 | Scrollable chart area | test_scrollable_chart_container | ✓ |
| 7 | Auto-update on config change | test_chart_updates_on_column_selection | ✓ |
| 8 | Empty state display | test_empty_state_shown_when_no_data | ✓ |
| 9 | Performance < 500ms | 3 performance tests pass | ✓ |

### Refactoring Performed

None required - implementation is clean and follows standards.

### Compliance Check

- Coding Standards: ✓ snake_case functions, PascalCase classes, type hints
- Project Structure: ✓ Files in correct locations (core/, tabs/, tests/)
- Testing Strategy: ✓ Unit tests for core logic, widget tests for UI
- All ACs Met: ✓ All 9 acceptance criteria implemented and verified

### Improvements Checklist

- [x] All acceptance criteria implemented
- [x] Unit tests for BinningEngine (25 tests)
- [x] Widget tests for UI components (44 tests)
- [x] Performance tests verify < 500ms requirement
- [ ] Consider adding direct unit test for _calculate_gradient_color() (low priority)

### Security Review

No security concerns - local data processing only.

### Performance Considerations

Performance requirements **exceeded**: Combined operation ~250ms (requirement: < 500ms).

### Files Modified During Review

None - implementation meets all requirements.

### Gate Status

Gate: **PASS** → docs/qa/gates/6.2-binning-engine-chart-visualization.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, all tests passing, no blocking issues.
